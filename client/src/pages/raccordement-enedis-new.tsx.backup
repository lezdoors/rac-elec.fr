import { useState, useEffect, useRef } from "react";
import { Helmet } from "react-helmet";
import { 
  ChevronRight, MapPin, Mail, Phone, User, Send, X, MessageSquare, Info, Clock,
  Home, Building, Bolt, FileText, Calendar, CheckCircle, InfoIcon, Loader2
} from "lucide-react";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter, DialogClose } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { toast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { z } from "zod";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from "@/components/ui/form";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Switch } from "@/components/ui/switch";
import { Tooltip, TooltipProvider, TooltipTrigger, TooltipContent } from "@/components/ui/tooltip";


// Schéma de validation pour le formulaire
const requestFormSchema = z.object({
  // Informations personnelles
  clientType: z.enum(["particulier", "professionnel", "collectivite"], {
    errorMap: () => ({ message: "Veuillez sélectionner un type de client" }),
  }).default("particulier"),
  nom: z.string().min(2, "Le nom est requis"),
  prenom: z.string().min(2, "Le prénom est requis"),
  email: z.string().email("Email invalide"),
  telephone: z.string().min(10, "Numéro de téléphone invalide"),
  societe: z.string().min(1, "Le nom de la société est requis").optional(),
  siren: z.string().regex(/^[0-9]{9}$/, "Le SIREN doit contenir exactement 9 chiffres").optional().or(z.literal("")),
  
  // Détails techniques
  typeRaccordement: z.enum([
    "new_connection", 
    "power_upgrade", 
    "temporary_connection", 
    "meter_relocation",
    "other"
  ], {
    errorMap: () => ({ message: "Veuillez sélectionner un type de raccordement" }),
  }).default("new_connection"),
  dateRaccordementProvisoire: z.string().optional(),
  numeroPDL: z.string().optional(),
  pdlInconnu: z.boolean().optional().default(false),
  autreTypeDescription: z.string().optional(),
  typeBatiment: z.enum([
    "individual_house", 
    "apartment_building", 
    "commercial", 
    "industrial",
    "agricultural",
    "public",
    "terrain"
  ], {
    errorMap: () => ({ message: "Veuillez sélectionner un type de bâtiment" }),
  }).default("individual_house"),
  terrainViabilise: z.enum(["viabilise", "non_viabilise"]).optional(),
  etatProjet: z.enum([
    "planning", 
    "permit_pending", 
    "permit_approved", 
    "construction_started"
  ], {
    errorMap: () => ({ message: "Veuillez sélectionner l'état du projet" }),
  }).default("planning"),
  numeroPermis: z.string().optional(),
  datePermis: z.string().optional(),
  puissanceDemandee: z.string(),
  typePhase: z.enum(["monophase", "triphase"]).default("monophase"),
  delaiRaccordement: z.enum(["less-1.5m", "1.5m", "1.5-3m", "3-6m", "6m+"]).default("1.5-3m"),
  
  // Adresse et facturation
  adresse: z.string().min(5, "L'adresse est requise"),
  complementAdresse: z.string().optional(),
  codePostal: z.string().min(5, "Code postal invalide"),
  ville: z.string().min(2, "La ville est requise"),
  referenceCadastrale: z.string().optional(),
  adresseFacturationDifferente: z.boolean().default(false),
  adresseFacturation: z.string().optional(),
  villeFacturation: z.string().optional(),
  codePostalFacturation: z.string().optional(),
  
  // Autres informations
  avezVousArchitecte: z.boolean().default(false),
  nomArchitecte: z.string().optional(),
  telephoneArchitecte: z.string().optional(),
  emailArchitecte: z.string().email("Email de l'architecte invalide").optional(),
  commentaires: z.string().optional(),
  accepteConditions: z.boolean().default(false)
});

type RequestFormValues = z.infer<typeof requestFormSchema>;

export default function RaccordementEnedisPage() {
  const topRef = useRef<HTMLDivElement>(null);
  const [contactModalOpen, setContactModalOpen] = useState(false);
  const [contactForm, setContactForm] = useState({
    name: '',
    email: '',
    phone: '',
    message: '',
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  // État du formulaire à étapes
  const [currentStep, setCurrentStep] = useState(1);
  const [formProgress, setFormProgress] = useState(33);
  const [cityList, setCityList] = useState<Array<{nom: string, code: string}>>([]);
  const [isLoadingCity, setIsLoadingCity] = useState(false);
  
  // État pour la saisie manuelle des villes
  const [isSaisingVilleManually, setIsSaisingVilleManually] = useState(false);
  const [isFacturationVilleManually, setIsFacturationVilleManually] = useState(false);
  
  // État pour la recherche SIREN
  const [companyInfo, setCompanyInfo] = useState<{name: string, address: string} | null>(null);
  const [isLoadingSiren, setIsLoadingSiren] = useState(false);
  const [sirenError, setSirenError] = useState<string | null>(null);
  const [isSearchingCompanySiren, setIsSearchingCompanySiren] = useState(false);
  
  // Récupération des données sauvegardées localement
  const getSavedFormData = () => {
    try {
      const savedData = localStorage.getItem('raccordementFormData');
      if (savedData) {
        return JSON.parse(savedData);
      }
    } catch (error) {
      console.error("Erreur lors de la récupération des données sauvegardées:", error);
    }
    return null;
  };
  
  // Fonction pour sauvegarder les données du formulaire
  const saveFormData = (data: any) => {
    try {
      localStorage.setItem('raccordementFormData', JSON.stringify(data));
      // Pour le débogage, décommenter cette ligne
      // console.log("Données sauvegardées:", data);
    } catch (error) {
      console.error("Erreur lors de la sauvegarde des données:", error);
    }
  };
  
  const savedFormData = getSavedFormData();

  // Initialisation du formulaire
  const form = useForm<RequestFormValues>({
    resolver: zodResolver(requestFormSchema),
    defaultValues: savedFormData || {
      // Informations personnelles
      clientType: "particulier",
      nom: "",
      prenom: "",
      email: "",
      telephone: "",
      societe: "",
      siren: "",
      
      // Détails techniques
      typeRaccordement: "new_connection",
      dateRaccordementProvisoire: "",
      numeroPDL: "",
      pdlInconnu: false,
      autreTypeDescription: "",
      typeBatiment: "individual_house",
      terrainViabilise: "viabilise",
      etatProjet: "planning",
      numeroPermis: "",
      datePermis: "",
      puissanceDemandee: "9",
      typePhase: "monophase",
      delaiRaccordement: "1.5-3m",
      
      // Adresse et facturation
      adresse: "",
      complementAdresse: "",
      codePostal: "",
      ville: "",
      referenceCadastrale: "",
      adresseFacturationDifferente: false,
      adresseFacturation: "",
      villeFacturation: "",
      codePostalFacturation: "",
      
      // Autres informations
      avezVousArchitecte: false,
      nomArchitecte: "",
      telephoneArchitecte: "",
      emailArchitecte: "",
      commentaires: "",
      accepteConditions: false
    },
  });
  
  // Si des données ont été récupérées, on affiche un toast pour informer l'utilisateur
  useEffect(() => {
    if (savedFormData) {
      toast({
        title: "Formulaire restauré",
        description: "Vos données précédemment saisies ont été restaurées",
        duration: 3000,
      });
    }
  }, []);
  
  // Auto-sauvegarde des champs importants
  const importantFields = [
    'clientType', 'nom', 'prenom', 'email', 'telephone', 
    'societe', 'siren', 'typeRaccordement', 'adresse',
    'codePostal', 'ville'
  ];
  
  // Écouter les changements de champs importants et sauvegarder
  useEffect(() => {
    const subscription = form.watch((value, { name, type }) => {
      // On vérifie si le champ modifié fait partie des champs importants
      if (type === 'change' && name && importantFields.includes(name)) {
        // On ajoute un délai pour ne pas sauvegarder à chaque frappe
        const timeoutId = setTimeout(() => {
          saveFormData(form.getValues());
        }, 1000);
        
        return () => clearTimeout(timeoutId);
      }
    });
    
    return () => subscription.unsubscribe();
  }, [form.watch]);
  
  // Fonction pour passer à l'étape suivante
  const goToNextStep = async () => {
    const currentFields = getCurrentStepFields();
    const result = await form.trigger(currentFields as any);
    
    if (result) {
      // Sauvegarde automatique des données 
      const tempData = form.getValues();
      saveFormData(tempData);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      const nextStep = currentStep + 1;
      setCurrentStep(nextStep);
      
      // Calcul de la progression
      if (nextStep === 2) {
        setFormProgress(66);
      } else if (nextStep === 3) {
        setFormProgress(100);
      }
      
      // Si les champs de l'étape 1 sont remplis, on crée le lead en arrière-plan
      if (currentStep === 1) {
        try {
          const formData = form.getValues();
          const response = await apiRequest('POST', '/api/leads/create', {
            firstName: formData.prenom,
            lastName: formData.nom,
            email: formData.email,
            phone: formData.telephone,
            clientType: formData.clientType,
            company: formData.societe || "",
            siren: formData.siren || "",
            serviceType: "electricity",
            requestType: formData.typeRaccordement || "new_connection"
          });
          
          if (response.ok) {
            const data = await response.json();
            console.log("Lead créé avec succès, token:", data.token);
            
            // On n'affiche pas de toast ici pour ne pas perturber l'expérience
            // mais on pourrait afficher un toast silencieux
            toast({
              title: "Vos données sont sauvegardées",
              description: "Vous pouvez continuer à remplir le formulaire",
              duration: 3000,
            });
          }
        } catch (error) {
          console.error("Erreur lors de la création du lead:", error);
          // Pas d'alerte à l'utilisateur pour ne pas perturber l'expérience
        }
      }
    } else {
      // On notifie l'utilisateur qu'il y a des erreurs
      toast({
        title: "Champs incomplets",
        description: "Veuillez remplir tous les champs obligatoires",
        variant: "destructive",
        duration: 3000,
      });
    }
  };
  
  // Recherche d'informations d'entreprise à partir du SIREN
  const searchSirenInfo = async (siren: string) => {
    if (siren.length !== 9) {
      setSirenError("Le SIREN doit contenir exactement 9 chiffres");
      setCompanyInfo(null);
      return;
    }
    
    setIsLoadingSiren(true);
    setSirenError(null);
    
    try {
      // Appel à l'API open-data française pour les entreprises
      const response = await fetch(`https://api.insee.fr/entreprises/sirene/V3/siren/${siren}`, {
        headers: {
          'Accept': 'application/json'
        }
      });
      
      // Si l'API n'est pas accessible (cas courant), nous simulons une réponse
      if (!response.ok) {
        // Simulation de réponse après échec de l'API
        if (siren === "123456789") {
          setCompanyInfo({
            name: "ENTREPRISE EXEMPLE SARL",
            address: "18 AVENUE DES CHAMPS ELYSÉES 75008 PARIS"
          });
        } else {
          // Vérifier si c'est juste un problème d'API ou si le SIREN n'existe pas
          setSirenError("Impossible de vérifier ce SIREN. Veuillez vérifier le numéro ou continuer manuellement.");
          setCompanyInfo(null);
        }
      } else {
        const data = await response.json();
        setCompanyInfo({
          name: data.uniteLegale.denominationUniteLegale || data.uniteLegale.denominationUsuelle1UniteLegale || '',
          address: data.adressePostale || 'Adresse non disponible'
        });
      }
    } catch (error) {
      console.error("Erreur lors de la recherche SIREN:", error);
      setSirenError("Service temporairement indisponible. Veuillez continuer manuellement.");
      setCompanyInfo(null);
    } finally {
      setIsLoadingSiren(false);
    }
  };
  
  // Recherche du SIREN à partir du nom de l'entreprise
  const searchCompanyForSiren = async (companyName: string) => {
    if (!companyName || companyName.length < 3) {
      return;
    }
    
    setIsSearchingCompanySiren(true);
    setSirenError(null);
    
    try {
      // Appel à l'API open-data française pour les entreprises
      const response = await fetch(`https://api.insee.fr/entreprises/sirene/V3/siret?q=denominationUniteLegale:"${encodeURIComponent(companyName)}"`, {
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        // API indisponible ou erreur
        setSirenError("Service de recherche SIREN momentanément indisponible. Veuillez saisir le numéro SIREN manuellement.");
      } else {
        const data = await response.json();
        
        if (data.etablissements && data.etablissements.length > 0) {
          const siren = data.etablissements[0].siren;
          form.setValue('siren', siren);
          
          // Récupérer les informations détaillées
          searchSirenInfo(siren);
        } else {
          setSirenError("Aucune entreprise trouvée avec ce nom. Veuillez saisir le SIREN manuellement.");
        }
      }
    } catch (error) {
      console.error("Erreur lors de la recherche d'entreprise:", error);
      setSirenError("Service temporairement indisponible. Veuillez saisir le SIREN manuellement.");
    } finally {
      setIsSearchingCompanySiren(false);
    }
  };
  
  // Fonction pour revenir à l'étape précédente
  const goToPrevStep = () => {
    const prevStep = Math.max(1, currentStep - 1);
    setCurrentStep(prevStep);
    
    // Mise à jour de la progression
    if (prevStep === 1) {
      setFormProgress(33);
    } else if (prevStep === 2) {
      setFormProgress(66);
    }
  };
  
  // Fonction pour obtenir les champs de l'étape courante
  const getCurrentStepFields = () => {
    switch (currentStep) {
      case 1:
        // Étape 1: Informations personnelles
        const step1Fields = ['clientType', 'nom', 'prenom', 'email', 'telephone'];
        
        // Ajout des champs spécifiques aux professionnels et collectivités
        if (form.watch('clientType') !== 'particulier') {
          step1Fields.push('societe', 'siren');
        }
        
        return step1Fields;
      
      case 2:
        // Étape 2: Adresse du projet et détails techniques
        const step2Fields = ['adresse', 'complementAdresse', 'codePostal', 'ville', 'referenceCadastrale'];
        
        // Ajout des champs spécifiques en fonction du type de demande
        step2Fields.push('typeRaccordement', 'typeBatiment');
        
        if (form.watch('typeBatiment') === 'terrain') {
          step2Fields.push('terrainViabilise');
        }
        
        if (form.watch('typeRaccordement') === 'temporary_connection') {
          step2Fields.push('dateRaccordementProvisoire');
        }
        
        if (form.watch('typeRaccordement') === 'meter_relocation') {
          step2Fields.push('numeroPDL', 'pdlInconnu');
        }
        
        if (form.watch('typeRaccordement') === 'other') {
          step2Fields.push('autreTypeDescription');
        }
        
        // Informations techniques supplémentaires
        step2Fields.push('etatProjet', 'puissanceDemandee', 'typePhase', 'delaiRaccordement');
        
        if (['permit_pending', 'permit_approved', 'construction_started'].includes(form.watch('etatProjet'))) {
          step2Fields.push('numeroPermis', 'datePermis');
        }
        
        return step2Fields;
      
      case 3:
        // Étape 3: Validation et informations complémentaires
        const step3Fields = ['accepteConditions'];
        
        // Ajout des champs d'architecte si nécessaire
        if (form.watch('avezVousArchitecte')) {
          step3Fields.push('nomArchitecte', 'telephoneArchitecte', 'emailArchitecte');
        }
        
        // Ajout des champs d'adresse de facturation si différente
        if (form.watch('adresseFacturationDifferente')) {
          step3Fields.push('adresseFacturation', 'villeFacturation', 'codePostalFacturation');
        }
        
        step3Fields.push('commentaires');
        
        return step3Fields;
      
      default:
        return [];
    }
  };
  
  // Fonction de soumission finale du formulaire
  // Fonction pour rechercher les villes à partir d'un code postal
  const fetchCities = async (postalCode: string) => {
    if (postalCode.length !== 5) return;
    
    setIsLoadingCity(true);
    // Réinitialiser la ville quand on change le code postal
    form.setValue('ville', '');
    
    try {
      const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${postalCode}&fields=nom,code`);
      if (!response.ok) throw new Error('Erreur lors de la récupération des villes');
      
      const cities = await response.json();
      
      if (cities.length === 0) {
        toast({
          title: "Aucune ville trouvée",
          description: "Aucune ville n'a été trouvée avec ce code postal",
          variant: "destructive",
        });
        setCityList([]);
        return;
      }
      
      setCityList(cities);
      
      // Si une seule ville est trouvée, on la sélectionne automatiquement
      if (cities.length === 1) {
        form.setValue('ville', cities[0].nom);
        toast({
          title: "Ville trouvée",
          description: `La ville ${cities[0].nom} a été automatiquement sélectionnée`,
          duration: 3000,
        });
      }
    } catch (error) {
      console.error('Erreur API:', error);
      toast({
        title: "Erreur",
        description: "Impossible de récupérer les villes pour ce code postal",
        variant: "destructive",
      });
      setCityList([]);
    } finally {
      setIsLoadingCity(false);
    }
  };
  
  const onSubmit = async (data: RequestFormValues) => {
    try {
      setIsSubmitting(true);
      
      // Afficher un toast pour indiquer que la demande est en cours
      toast({
        title: "Envoi en cours",
        description: "Veuillez patienter pendant le traitement de votre demande...",
        duration: 10000, // Long duration to show it's loading
      });
      
      // Conversion des données pour l'API
      const requestData = {
        // Informations personnelles
        firstName: data.prenom,
        lastName: data.nom,
        email: data.email,
        phone: data.telephone,
        clientType: data.clientType,
        company: data.societe || "",
        siren: data.siren || "",
        
        // Adresse
        address: data.adresse,
        addressComplement: data.complementAdresse || "",
        postalCode: data.codePostal,
        city: data.ville,
        cadastralReference: data.referenceCadastrale || "",
        
        // Type de service
        serviceType: "electricity",
        requestType: data.typeRaccordement,
        temporaryConnectionDate: data.dateRaccordementProvisoire || "",
        pdlNumber: data.numeroPDL || "",
        pdlUnknown: data.pdlInconnu || false,
        otherRequestTypeDesc: data.autreTypeDescription || "",
        
        // Détails du bâtiment
        buildingType: data.typeBatiment,
        terrainViabilise: data.terrainViabilise || "",
        projectStatus: data.etatProjet,
        permitNumber: data.numeroPermis || "",
        permitDeliveryDate: data.datePermis || "",
        
        // Puissance et phase
        powerRequired: data.puissanceDemandee,
        phaseType: data.typePhase,
        
        // Planning
        connectionDelay: data.delaiRaccordement,
        
        // Facturation
        useDifferentBillingAddress: data.adresseFacturationDifferente,
        billingAddress: data.adresseFacturation || "",
        billingCity: data.villeFacturation || "",
        billingPostalCode: data.codePostalFacturation || "",
        
        // Architecte
        hasArchitect: data.avezVousArchitecte,
        architectName: data.nomArchitecte || "",
        architectPhone: data.telephoneArchitecte || "",
        architectEmail: data.emailArchitecte || "",
        
        // Commentaires
        comments: data.commentaires || "",
        
        // Termes et conditions
        termsAccepted: data.accepteConditions,
      };
      
      // Envoi des données à l'API
      let response;
      try {
        response = await apiRequest('POST', '/api/service-requests', requestData);
      } catch (networkError) {
        console.error("Erreur réseau:", networkError);
        throw new Error("Impossible de connecter au serveur. Veuillez vérifier votre connexion internet et réessayer.");
      }
      
      if (!response.ok) {
        let errorMessage = "Erreur lors de la soumission du formulaire";
        try {
          const errorData = await response.json();
          if (errorData && errorData.message) {
            errorMessage = errorData.message;
          }
        } catch (e) {
          // Si la réponse n'est pas du JSON valide, on garde le message d'erreur par défaut
        }
        throw new Error(errorMessage);
      }
      
      let result;
      try {
        result = await response.json();
      } catch (jsonError) {
        console.error("Erreur de parsing JSON:", jsonError);
        throw new Error("Format de réponse invalide du serveur");
      }
      
      // Pas besoin de supprimer le toast de chargement, il disparaîtra automatiquement
      
      // Afficher un toast de succès
      toast({
        title: "Demande envoyée avec succès!",
        description: "Votre numéro de référence: " + result.referenceNumber,
        variant: "default",
        duration: 5000,
      });
      
      // Effacer les données temporaires après soumission réussie
      try {
        localStorage.removeItem('raccordementFormData');
        console.log("Données temporaires supprimées après soumission réussie");
      } catch (e) {
        console.error("Erreur lors de la suppression des données temporaires:", e);
      }
      
      // Redirection vers la page de paiement
      setTimeout(() => {
        window.location.href = `/confirmation/${result.referenceNumber}`;
      }, 2000);
    } catch (error) {
      console.error("Erreur:", error);
      toast({
        title: "Erreur",
        description: error instanceof Error ? error.message : "Une erreur est survenue lors de l'envoi de votre demande. Veuillez réessayer.",
        variant: "destructive",
        duration: 5000,
      });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  // Gestionnaire de modification des champs du formulaire de contact
  const handleContactInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setContactForm(prev => ({ ...prev, [name]: value }));
  };
  
  // Gestionnaire de soumission du formulaire de contact
  const handleContactSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation simple du formulaire
    if (!contactForm.name || !contactForm.email || !contactForm.message) {
      toast({
        title: "Erreur",
        description: "Veuillez remplir tous les champs obligatoires.",
        variant: "destructive",
      });
      return;
    }
    
    try {
      // Envoi du formulaire de contact
      const response = await apiRequest('POST', '/api/contact', contactForm);
      
      if (!response.ok) {
        throw new Error("Erreur lors de l'envoi du message");
      }
      
      toast({
        title: "Message envoyé",
        description: "Nous vous répondrons dans les plus brefs délais.",
      });
      
      // Fermeture de la modal et réinitialisation du formulaire
      setContactModalOpen(false);
      setContactForm({
        name: '',
        email: '',
        phone: '',
        message: '',
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Une erreur est survenue lors de l'envoi de votre message.",
        variant: "destructive",
      });
    }
  };

  return (
    <div ref={topRef} className="min-h-screen bg-gray-50">
      <Helmet>
        <title>Demande de Raccordement Électrique - Raccordement Enedis</title>
        <meta name="description" content="Formulaire de demande de raccordement électrique Enedis. Service rapide et accompagnement personnalisé pour votre raccordement." />
      </Helmet>
      
      <div className="container mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <div className="max-w-6xl mx-auto">
          <div className="bg-white rounded-lg shadow-md p-8 relative overflow-hidden">
            <div className="absolute top-0 left-0 right-0 h-[1cm] bg-blue-600 shadow-md"></div>
            <div className="pt-10">
              <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" className="mr-3 text-blue-600" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 20V10"></path>
                <path d="M12 20V4"></path>
                <path d="M6 20v-6"></path>
              </svg>
              Demande de raccordement électrique
            </h1>
            <p className="text-gray-600 mb-8 text-lg max-w-3xl">
              Complétez ce formulaire en 3 étapes simples pour démarrer votre procédure de raccordement Enedis. 
              Notre équipe d'experts vous accompagnera tout au long du processus.
            </p>
            
            <div className="flex flex-col lg:flex-row mb-8">
              <div className="w-full lg:w-2/3 pr-0 lg:pr-8 transition-all duration-300 ease-in-out">
                <Form {...form}>
                  <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                    {/* Affichage conditionnel des étapes du formulaire */}
                    {currentStep === 1 && (
                      <div className="space-y-6 animate-fadeIn">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <FormField
                            control={form.control}
                            name="clientType"
                            render={({ field }) => (
                              <FormItem className="col-span-2">
                                <FormLabel className="flex items-center gap-2 font-medium">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                  </svg>
                                  Type de client *
                                </FormLabel>
                                <FormControl>
                                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-2">
                                    <div 
                                      className={`
                                        border rounded-lg p-4 flex flex-col items-center cursor-pointer transition-all
                                        ${field.value === 'particulier' 
                                          ? 'border-blue-500 bg-blue-50 shadow-md' 
                                          : 'border-gray-200 hover:border-blue-200 hover:bg-blue-50/30'}
                                      `}
                                      onClick={() => field.onChange('particulier')}
                                    >
                                      <div className="flex items-center justify-center mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'particulier' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                          <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                        </svg>
                                      </div>
                                      <div className={`w-5 h-5 rounded-full mb-2 flex items-center justify-center ${field.value === 'particulier' ? 'bg-blue-500' : 'border border-gray-300'}`}>
                                        {field.value === 'particulier' && (
                                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 6L9 17l-5-5"/>
                                          </svg>
                                        )}
                                      </div>
                                      <span className={`font-medium ${field.value === 'particulier' ? 'text-blue-700' : 'text-gray-700'}`}>Particulier</span>
                                      <span className="text-xs text-gray-500 mt-1 text-center">Logement personnel</span>
                                    </div>
                                    
                                    <div 
                                      className={`
                                        border rounded-lg p-4 flex flex-col items-center cursor-pointer transition-all
                                        ${field.value === 'professionnel' 
                                          ? 'border-blue-500 bg-blue-50 shadow-md' 
                                          : 'border-gray-200 hover:border-blue-200 hover:bg-blue-50/30'}
                                      `}
                                      onClick={() => field.onChange('professionnel')}
                                    >
                                      <div className="flex items-center justify-center mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'professionnel' ? 'text-blue-500' : 'text-gray-500'}>
                                          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                        </svg>
                                      </div>
                                      <div className={`w-5 h-5 rounded-full mb-2 flex items-center justify-center ${field.value === 'professionnel' ? 'bg-blue-500' : 'border border-gray-300'}`}>
                                        {field.value === 'professionnel' && (
                                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 6L9 17l-5-5"/>
                                          </svg>
                                        )}
                                      </div>
                                      <span className={`font-medium ${field.value === 'professionnel' ? 'text-blue-700' : 'text-gray-700'}`}>Professionnel</span>
                                      <span className="text-xs text-gray-500 mt-1 text-center">Entreprise, commerce</span>
                                    </div>
                                    
                                    <div 
                                      className={`
                                        border rounded-lg p-4 flex flex-col items-center cursor-pointer transition-all
                                        ${field.value === 'collectivite' 
                                          ? 'border-blue-500 bg-blue-50 shadow-md' 
                                          : 'border-gray-200 hover:border-blue-200 hover:bg-blue-50/30'}
                                      `}
                                      onClick={() => field.onChange('collectivite')}
                                    >
                                      <div className="flex items-center justify-center mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'collectivite' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M2 22V7a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v15"></path>
                                          <path d="M2 14h20"></path>
                                          <path d="M12 2v5"></path>
                                          <path d="M8 7v.01"></path>
                                          <path d="M16 7v.01"></path>
                                          <path d="M7 22v-3"></path>
                                          <path d="M17 22v-3"></path>
                                          <path d="M12 22v-3"></path>
                                        </svg>
                                      </div>
                                      <div className={`w-5 h-5 rounded-full mb-2 flex items-center justify-center ${field.value === 'collectivite' ? 'bg-blue-500' : 'border border-gray-300'}`}>
                                        {field.value === 'collectivite' && (
                                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 6L9 17l-5-5"/>
                                          </svg>
                                        )}
                                      </div>
                                      <span className={`font-medium ${field.value === 'collectivite' ? 'text-blue-700' : 'text-gray-700'}`}>Collectivité</span>
                                      <span className="text-xs text-gray-500 mt-1 text-center">Mairie, établissement public</span>
                                    </div>
                                  </div>
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <FormField
                            control={form.control}
                            name="nom"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2 font-medium">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                  </svg>
                                  Nom <span className="text-red-500">*</span>
                                  <span 
                                    className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150"
                                    title="Votre nom de famille"
                                  >
                                    ?
                                  </span>
                                </FormLabel>
                                <FormControl>
                                  <div className="relative">
                                    <Input 
                                      placeholder="Votre nom" 
                                      {...field} 
                                      className="pl-10 transition-all duration-200 focus:ring-2 focus:ring-blue-100" 
                                    />
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                      </svg>
                                    </div>
                                  </div>
                                </FormControl>
                                <FormMessage className="text-red-500 font-medium text-sm animate-fadeIn" />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="prenom"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2 font-medium">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                  </svg>
                                  Prénom <span className="text-red-500">*</span>
                                </FormLabel>
                                <FormControl>
                                  <div className="relative">
                                    <Input 
                                      placeholder="Votre prénom" 
                                      {...field} 
                                      className="pl-10 transition-all duration-200 focus:ring-2 focus:ring-blue-100" 
                                    />
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M6 22V4a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v18H6Z"/>
                                        <path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/>
                                        <path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/>
                                        <path d="M10 6h4"/>
                                        <path d="M10 10h4"/>
                                        <path d="M10 14h4"/>
                                        <path d="M10 18h4"/>
                                      </svg>
                                    </div>
                                  </div>
                                </FormControl>
                                <FormMessage className="text-red-500 font-medium text-sm animate-fadeIn" />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="email"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2 font-medium">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                    <rect width="20" height="16" x="2" y="4" rx="2"/>
                                    <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                                  </svg>
                                  Email <span className="text-red-500">*</span>
                                </FormLabel>
                                <FormControl>
                                  <Input 
                                    placeholder="votre@email.com" 
                                    type="email"
                                    {...field} 
                                    className="transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    autoComplete="email"
                                  />
                                </FormControl>
                                <FormMessage className="text-red-500 font-medium text-sm animate-fadeIn" />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="telephone"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="font-medium">Téléphone *</FormLabel>
                                <FormControl>
                                  <Input 
                                    placeholder="0123456789" 
                                    {...field} 
                                    className="transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    type="tel"
                                    autoComplete="tel"
                                    onChange={(e) => {
                                      // Format le numéro de téléphone
                                      const value = e.target.value.replace(/\D/g, '');
                                      field.onChange(value);
                                    }}
                                    maxLength={10}
                                  />
                                </FormControl>
                                <FormMessage className="text-red-500 font-medium text-sm animate-fadeIn" />
                              </FormItem>
                            )}
                          />
                          
                          {form.watch('clientType') !== 'particulier' && (
                            <div className="animate-fadeIn space-y-4 p-4 border border-blue-100 rounded-lg bg-blue-50/50 col-span-2 w-full">
                              <div className="text-sm text-blue-800 mb-4 bg-blue-100 p-3 rounded-md shadow-sm">
                                <p className="font-medium text-blue-800">{form.watch('clientType') === 'professionnel' ? 'Informations professionnelles' : 'Informations de la collectivité'}</p>
                                <p className="text-xs mt-1">
                                  {form.watch('clientType') === 'professionnel' 
                                    ? "Ces informations nous permettront d'identifier votre entreprise et d'adapter notre service à vos besoins professionnels." 
                                    : "Ces informations nous permettront d'identifier votre collectivité locale et d'adapter notre service aux besoins spécifiques des établissements publics."}
                                </p>
                              </div>
                              
                              <FormField
                                control={form.control}
                                name="societe"
                                render={({ field }) => (
                                  <FormItem className="relative">
                                    <FormLabel className="flex items-center gap-1">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                        <path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z"/>
                                        <path d="M3 9V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4"/>
                                      </svg>
                                      {form.watch('clientType') === 'professionnel' ? 'Raison sociale *' : 'Nom de la collectivité *'}
                                      <span className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150" 
                                        title={form.watch('clientType') === 'professionnel' 
                                          ? "Nom légal complet de votre entreprise tel qu'il apparaît sur votre KBIS"
                                          : "Nom officiel de votre collectivité (mairie, conseil départemental, etc.)"}>
                                        ?
                                      </span>
                                    </FormLabel>
                                    <FormControl>
                                      <div className="relative">
                                        <div className="flex">
                                          <Input 
                                            placeholder={form.watch('clientType') === 'professionnel' 
                                              ? "Nom de votre entreprise" 
                                              : "Nom de votre collectivité"}
                                            className="pl-8 transition-all focus:ring-2 focus:ring-blue-100 rounded-r-none"
                                            {...field} 
                                            onChange={(e) => {
                                              field.onChange(e);
                                              // Réinitialiser les informations de l'entreprise lors de la modification
                                              if (companyInfo) {
                                                setCompanyInfo(null);
                                              }
                                              if (sirenError) {
                                                setSirenError(null);
                                              }
                                            }}
                                          />
                                          <Button 
                                            type="button"
                                            variant="outline"
                                            className="rounded-l-none border-l-0 px-3"
                                            onClick={() => {
                                              if (field.value && field.value.length >= 3) {
                                                searchCompanyForSiren(field.value);
                                              }
                                            }}
                                            disabled={!field.value || field.value.length < 3 || isSearchingCompanySiren}
                                          >
                                            {isSearchingCompanySiren ? (
                                              <svg className="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                              </svg>
                                            ) : (
                                              <span className="flex items-center">
                                                <svg className="mr-1 h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                  <circle cx="11" cy="11" r="8"></circle>
                                                  <path d="m21 21-4.3-4.3"></path>
                                                </svg>
                                                Siren
                                              </span>
                                            )}
                                          </Button>
                                        </div>
                                        <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-gray-400">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                            <path d="M7 7h10"/>
                                            <path d="M7 12h10"/>
                                            <path d="M7 17h10"/>
                                          </svg>
                                        </div>
                                      </div>
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                              
                              <FormField
                                control={form.control}
                                name="siren"
                                render={({ field }) => (
                                  <FormItem className="relative">
                                    <FormLabel className="flex items-center gap-1">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <circle cx="15.5" cy="8.5" r="1.5"/>
                                        <circle cx="15.5" cy="15.5" r="1.5"/>
                                        <circle cx="8.5" cy="15.5" r="1.5"/>
                                      </svg>
                                      {form.watch('clientType') === 'professionnel' ? 'SIREN' : 'SIREN de la collectivité'}
                                      <span className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150" 
                                        title={form.watch('clientType') === 'professionnel' 
                                          ? "Le numéro SIREN est composé de 9 chiffres et correspond aux 9 premiers chiffres du SIRET. Vous pouvez le trouver sur votre KBIS." 
                                          : "Le numéro SIREN est composé de 9 chiffres. Pour les collectivités, vous pouvez le trouver sur vos documents officiels."}>
                                        ?
                                      </span>
                                    </FormLabel>
                                    {companyInfo && (
                                      <div className="bg-green-50 border border-green-200 rounded-md p-2 mb-2 text-xs text-green-700">
                                        <p className="font-medium">Entreprise vérifiée</p>
                                        <p>{companyInfo.name}</p>
                                        <p className="text-green-600">{companyInfo.address}</p>
                                      </div>
                                    )}
                                    {sirenError && (
                                      <div className="bg-red-50 border border-red-200 rounded-md p-2 mb-2 text-xs text-red-700">
                                        <p className="font-medium">Erreur de vérification</p>
                                        <p>{sirenError}</p>
                                      </div>
                                    )}
                                    <FormControl>
                                      <div className="relative">
                                        <div className="flex">
                                          <Input 
                                            placeholder={form.watch('clientType') === 'professionnel' 
                                              ? "Numéro SIREN (9 chiffres)" 
                                              : "SIREN de la collectivité (9 chiffres)"}
                                            className="pl-8 transition-all focus:ring-2 focus:ring-blue-100 rounded-r-none"
                                            maxLength={9}
                                            onKeyPress={(e) => {
                                              if (!/[0-9]/.test(e.key)) {
                                                e.preventDefault();
                                              }
                                            }}
                                            {...field} 
                                            onChange={(e) => {
                                              field.onChange(e);
                                              // Réinitialiser les informations de l'entreprise lors de la modification
                                              if (companyInfo) {
                                                setCompanyInfo(null);
                                              }
                                              if (sirenError) {
                                                setSirenError(null);
                                              }
                                            }}
                                          />
                                          <Button 
                                            type="button"
                                            variant="outline"
                                            className="rounded-l-none border-l-0 px-3"
                                            onClick={() => {
                                              if (field.value && field.value.length === 9) {
                                                searchSirenInfo(field.value);
                                              }
                                            }}
                                            disabled={!field.value || field.value.length !== 9 || isLoadingSiren}
                                          >
                                            {isLoadingSiren ? (
                                              <svg className="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                              </svg>
                                            ) : (
                                              <span className="flex items-center">
                                                <svg className="mr-1 h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                  <circle cx="12" cy="12" r="10"></circle>
                                                  <line x1="12" y1="16" x2="12" y2="12"></line>
                                                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                                </svg>
                                                Vérifier
                                              </span>
                                            )}
                                          </Button>
                                        </div>
                                        <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-gray-400">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M4 9h16"/>
                                            <path d="M4 15h16"/>
                                            <path d="M10 3v18"/>
                                            <path d="M14 3v18"/>
                                          </svg>
                                        </div>
                                      </div>
                                    </FormControl>
                                    <FormDescription className="text-xs text-gray-500">
                                      <span>
                                        {(() => {
                                          const sirenValue = form.watch('siren');
                                          if (sirenValue && sirenValue.length > 0 && sirenValue.length < 9) {
                                            return (
                                              <span className="text-amber-600 font-medium">
                                                Il manque {9 - sirenValue.length} chiffres
                                              </span>
                                            );
                                          }
                                          return "Le SIREN est composé de 9 chiffres (les 9 premiers chiffres du SIRET)";
                                        })()}
                                      </span>
                                    </FormDescription>
                                    
                                    {/* Affichage des erreurs SIREN */}
                                    {sirenError && (
                                      <div className="mt-2 text-sm text-red-500 animate-fadeIn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block mr-1">
                                          <circle cx="12" cy="12" r="10"/>
                                          <line x1="12" y1="8" x2="12" y2="12"/>
                                          <line x1="12" y1="16" x2="12.01" y2="16"/>
                                        </svg>
                                        {sirenError}
                                      </div>
                                    )}
                                    
                                    {/* Affichage des informations de l'entreprise si récupérées */}
                                    {companyInfo && (
                                      <div className="mt-2 p-3 bg-green-50 border border-green-100 rounded-md animate-fadeIn">
                                        <div className="flex items-start gap-2">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-600 mt-0.5">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                            <polyline points="22 4 12 14.01 9 11.01"/>
                                          </svg>
                                          <div>
                                            <p className="text-sm font-medium text-green-700">{companyInfo.name}</p>
                                            <p className="text-xs text-green-600">{companyInfo.address}</p>
                                            <Button
                                              type="button"
                                              variant="ghost"
                                              size="sm"
                                              className="h-6 mt-1 text-xs text-green-700 hover:text-green-800 hover:bg-green-100 p-0"
                                              onClick={() => {
                                                form.setValue('societe', companyInfo.name);
                                                toast({
                                                  title: "Informations importées",
                                                  description: "Le nom de la société a été automatiquement rempli.",
                                                  duration: 3000,
                                                });
                                              }}
                                            >
                                              Utiliser ces informations
                                            </Button>
                                          </div>
                                        </div>
                                      </div>
                                    )}
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {currentStep === 2 && (
                      <div className="space-y-6 animate-fadeIn">
                        <div className="space-y-4">
                          <h3 className="text-lg font-medium">Adresse du projet</h3>
                          <FormField
                            control={form.control}
                            name="adresse"
                            render={({ field }) => (
                              <FormItem>
                                <div className="flex items-center justify-between">
                                  <FormLabel>Adresse *</FormLabel>
                                  <div className="flex items-center">
                                    <InfoIcon className="h-4 w-4 text-blue-500 mr-1" />
                                    <span className="text-xs text-blue-500">Info</span>
                                  </div>
                                </div>
                                <FormControl>
                                  <Input placeholder="Saisissez une adresse..." {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="complementAdresse"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Complément d'adresse</FormLabel>
                                <FormControl>
                                  <Input placeholder="Étage, bâtiment, etc." {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormField
                              control={form.control}
                              name="codePostal"
                              render={({ field }) => (
                                <FormItem className="relative">
                                  <FormLabel className="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                      <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                    </svg>
                                    Code postal *
                                    <span className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150" title="Le code postal permet de rechercher automatiquement votre ville">
                                      ?
                                    </span>
                                  </FormLabel>
                                  <FormControl>
                                    <div className="relative">
                                      <Input 
                                        placeholder="Exemple: 75001" 
                                        className="pl-10 transition-all focus:ring-2 focus:ring-blue-100"
                                        maxLength={5}
                                        onKeyPress={(e) => {
                                          if (!/[0-9]/.test(e.key)) {
                                            e.preventDefault();
                                          }
                                        }}
                                        {...field}
                                        onChange={(e) => {
                                          field.onChange(e);
                                          if (e.target.value.length === 5) {
                                            fetchCities(e.target.value);
                                          }
                                        }}
                                      />
                                      <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                          <path d="M21.2 8.4c.5.38.8.96.8 1.6v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V10a2 2 0 0 1 2-2h16a2 2 0 0 1 1.2.4"/>
                                          <path d="M2 10h20"/>
                                          <path d="M7 15h.01"/>
                                          <path d="M11 15h2"/>
                                          <path d="M5 10V6a3 3 0 0 1 3-3h8a3 3 0 0 1 3 3v4"/>
                                        </svg>
                                      </div>
                                    </div>
                                  </FormControl>
                                  <FormDescription className="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
                                    <span className="text-xs text-gray-500">
                                      {field.value && field.value.length > 0 && field.value.length < 5 ? (
                                        <span className="text-amber-600 font-medium">
                                          Il manque {5 - field.value.length} chiffres
                                        </span>
                                      ) : (
                                        <span>Entrez votre code postal à 5 chiffres</span>
                                      )}
                                    </span>
                                    
                                    <div className="flex items-center space-x-2">
                                      <Checkbox 
                                        id="saisieManuelleVille" 
                                        checked={isSaisingVilleManually}
                                        onCheckedChange={(checked) => {
                                          setIsSaisingVilleManually(checked === true);
                                          if (checked === false && cityList.length === 1) {
                                            form.setValue('ville', cityList[0].nom);
                                          }
                                        }}
                                      />
                                      <label
                                        htmlFor="saisieManuelleVille"
                                        className="text-xs text-blue-600 font-medium cursor-pointer"
                                      >
                                        Saisir la ville manuellement
                                      </label>
                                    </div>
                                  </FormDescription>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            
                            <FormField
                              control={form.control}
                              name="ville"
                              render={({ field }) => (
                                <FormItem className="relative">
                                  <FormLabel className="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                      <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/>
                                      <circle cx="12" cy="10" r="3"/>
                                    </svg>
                                    Ville *
                                  </FormLabel>
                                  <FormControl>
                                    <div className="relative">
                                      {isLoadingCity ? (
                                        <div className="w-full h-10 border rounded-md pl-10 flex items-center bg-gray-50">
                                          <span className="animate-spin h-4 w-4 mr-2 border-2 border-blue-500 border-t-transparent rounded-full inline-block ml-2"></span>
                                          <span className="text-gray-500">Recherche des villes...</span>
                                        </div>
                                      ) : isSaisingVilleManually ? (
                                        <Input 
                                          placeholder="Saisissez manuellement votre ville"
                                          className="pl-10 transition-all focus:ring-2 focus:ring-blue-100"
                                          {...field} 
                                        />
                                      ) : cityList.length > 1 ? (
                                        <Select
                                          onValueChange={(value) => field.onChange(value)}
                                          value={field.value}
                                        >
                                          <SelectTrigger className="w-full pl-10">
                                            <SelectValue placeholder="Sélectionnez votre ville" />
                                          </SelectTrigger>
                                          <SelectContent>
                                            {cityList.map((city) => (
                                              <SelectItem key={city.code} value={city.nom}>
                                                {city.nom}
                                              </SelectItem>
                                            ))}
                                          </SelectContent>
                                        </Select>
                                      ) : (
                                        <Input 
                                          placeholder={form.watch('codePostal')?.length === 5 ? "Aucune ville trouvée" : "Saisissez d'abord un code postal"}
                                          className="pl-10 transition-all focus:ring-2 focus:ring-blue-100"
                                          {...field} 
                                          disabled={!isSaisingVilleManually && form.watch('codePostal')?.length !== 5}
                                        />
                                      )}
                                      <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                          <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/>
                                          <path d="M18 14h-8"/>
                                          <path d="M15 18h-5"/>
                                          <path d="M10 6h8v4h-8V6Z"/>
                                        </svg>
                                      </div>
                                      {isLoadingCity && (
                                        <div className="absolute inset-y-0 right-0 pr-3 flex items-center">
                                          <svg className="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                          </svg>
                                        </div>
                                      )}
                                    </div>
                                  </FormControl>
                                  {cityList.length > 0 && (
                                    <FormDescription className="text-xs text-green-600 font-medium">
                                      {cityList.length === 1 
                                        ? "Ville trouvée automatiquement" 
                                        : `${cityList.length} villes trouvées pour ce code postal`}
                                    </FormDescription>
                                  )}
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>
                          
                          <FormField
                            control={form.control}
                            name="referenceCadastrale"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Référence cadastrale</FormLabel>
                                <FormControl>
                                  <Input placeholder="Référence cadastrale (facultatif)" {...field} />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        </div>
                        
                        <div className="space-y-4 mt-8">
                          <h3 className="text-lg font-medium">Détails techniques</h3>
                          
                          <FormField
                            control={form.control}
                            name="typeRaccordement"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2 font-medium">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                    <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"></path>
                                    <line x1="6" x2="18" y1="17" y2="17"></line>
                                  </svg>
                                  Type de raccordement <span className="text-red-500">*</span>
                                  <span 
                                    className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150"
                                    title="Choisissez le type de raccordement qui correspond à votre besoin"
                                  >
                                    ?
                                  </span>
                                </FormLabel>
                                <FormControl>
                                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow flex flex-col items-center ${field.value === 'new_connection' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('new_connection')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'new_connection' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"></path>
                                          <line x1="6" x2="18" y1="17" y2="17"></line>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Nouveau raccordement</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow flex flex-col items-center ${field.value === 'power_upgrade' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('power_upgrade')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'power_upgrade' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M12 17V3"></path>
                                          <path d="m6 11 6-6 6 6"></path>
                                          <path d="M19 21H5"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Augmentation de puissance</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow flex flex-col items-center ${field.value === 'temporary_connection' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('temporary_connection')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'temporary_connection' ? 'text-blue-500' : 'text-gray-500'}>
                                          <rect width="18" height="12" x="3" y="8" rx="2"></rect>
                                          <path d="M12 8v12"></path>
                                          <path d="M3 14h18"></path>
                                          <path d="M14 4a2 2 0 0 0-2-2H8.5a2.5 2.5 0 0 0 0 5H10"></path>
                                          <path d="M12 5a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Raccordement provisoire</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow flex flex-col items-center ${field.value === 'meter_relocation' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('meter_relocation')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'meter_relocation' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M8 21h8"></path>
                                          <path d="M12 21v-5"></path>
                                          <path d="M12 3v5"></path>
                                          <path d="M20.5 9.5 16 16"></path>
                                          <path d="m4 16 4.5-6.5"></path>
                                          <path d="M20.5 14.5 16 8"></path>
                                          <path d="m4 8 4.5 6.5"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Déplacement de compteur</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow flex flex-col items-center ${field.value === 'other' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('other')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'other' ? 'text-blue-500' : 'text-gray-500'}>
                                          <circle cx="12" cy="12" r="10"></circle>
                                          <path d="M12 16v-4"></path>
                                          <path d="M12 8h.01"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Autre demande</div>
                                    </div>
                                  </div>
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          {form.watch('typeRaccordement') === 'temporary_connection' && (
                            <FormField
                              control={form.control}
                              name="dateRaccordementProvisoire"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Date de raccordement provisoire souhaitée *</FormLabel>
                                  <FormControl>
                                    <Input type="date" {...field} />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          )}
                          
                          {form.watch('typeRaccordement') === 'meter_relocation' && (
                            <>
                              <FormField
                                control={form.control}
                                name="numeroPDL"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Numéro PDL actuel</FormLabel>
                                    <FormControl>
                                      <Input placeholder="Point de livraison à 14 chiffres" {...field} disabled={form.watch('pdlInconnu')} />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                              
                              <FormField
                                control={form.control}
                                name="pdlInconnu"
                                render={({ field }) => (
                                  <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                                    <FormControl>
                                      <Checkbox 
                                        checked={field.value} 
                                        onCheckedChange={field.onChange} 
                                        id="pdl-inconnu" 
                                      />
                                    </FormControl>
                                    <div className="space-y-1 leading-none">
                                      <FormLabel htmlFor="pdl-inconnu">
                                        Je ne connais pas mon numéro PDL
                                      </FormLabel>
                                    </div>
                                  </FormItem>
                                )}
                              />
                            </>
                          )}
                          
                          {form.watch('typeRaccordement') === 'other' && (
                            <FormField
                              control={form.control}
                              name="autreTypeDescription"
                              render={({ field }) => (
                                <FormItem className="bg-blue-50 p-4 rounded-lg border border-blue-100 animate-fadeIn">
                                  <FormLabel className="flex items-center gap-2 font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                      <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                      <path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2Z"></path>
                                      <path d="M9 9h1"></path>
                                      <path d="M9 13h6"></path>
                                      <path d="M9 17h6"></path>
                                    </svg>
                                    Description de votre demande <span className="text-red-500">*</span>
                                    <span 
                                      className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150"
                                      title="Décrivez précisément votre demande spécifique pour que nous puissions vous accompagner au mieux"
                                    >
                                      ?
                                    </span>
                                  </FormLabel>
                                  <div className="text-sm text-blue-700 mb-4">
                                    Merci de détailler votre demande particulière afin que nous puissions l'étudier avec attention et vous proposer la solution la plus adaptée à votre situation.
                                  </div>
                                  <FormControl>
                                    <Textarea 
                                      placeholder="Veuillez décrire votre demande spécifique (puissance, contraintes techniques, délais souhaités...)" 
                                      {...field} 
                                      rows={4}
                                      className="bg-white border-gray-200 focus:border-blue-300 focus:ring-blue-100"
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          )}
                          
                          <FormField
                            control={form.control}
                            name="typeBatiment"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="flex items-center gap-2 font-medium">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                  </svg>
                                  Type de bâtiment <span className="text-red-500">*</span>
                                  <span 
                                    className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150"
                                    title="Le type de bâtiment permet de déterminer les caractéristiques techniques du raccordement"
                                  >
                                    ?
                                  </span>
                                </FormLabel>
                                <FormControl>
                                  <div className="grid gap-3 grid-cols-2 md:grid-cols-4">
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow ${field.value === 'individual_house' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('individual_house')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'individual_house' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                          <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Maison individuelle</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow ${field.value === 'apartment_building' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('apartment_building')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'apartment_building' ? 'text-blue-500' : 'text-gray-500'}>
                                          <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
                                          <path d="M9 22v-4h6v4"></path>
                                          <path d="M8 6h.01"></path>
                                          <path d="M16 6h.01"></path>
                                          <path d="M8 10h.01"></path>
                                          <path d="M16 10h.01"></path>
                                          <path d="M8 14h.01"></path>
                                          <path d="M16 14h.01"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Immeuble collectif</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow ${field.value === 'commercial' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('commercial')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'commercial' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M3 3v18h18"></path>
                                          <path d="M7 17V9"></path>
                                          <path d="M11 17V6"></path>
                                          <path d="M15 17v-5"></path>
                                          <path d="M19 17v-2"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Local commercial</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow ${field.value === 'industrial' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('industrial')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'industrial' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0Z"></path>
                                          <path d="M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"></path>
                                          <path d="M18 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"></path>
                                          <path d="M18 12h4"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Bâtiment industriel</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow ${field.value === 'agricultural' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('agricultural')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'agricultural' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M3 6v14"></path>
                                          <path d="M3 10h18"></path>
                                          <path d="M10 3v7"></path>
                                          <path d="M10 3h4a2 2 0 0 1 2 2"></path>
                                          <path d="M21 10V8a2 2 0 0 0-2-2h-8a2 2 0 0 0-2 2"></path>
                                          <path d="M21 10v7a2 2 0 0 1-2 2h-3.5"></path>
                                          <path d="M12 13.5V17"></path>
                                          <path d="M9 17h6"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Exploitation agricole</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow ${field.value === 'public' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('public')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'public' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M2 22V7a2 2 0 0 1 2-2h6v5h4V5h6a2 2 0 0 1 2 2v15"></path>
                                          <path d="M18 22H6a2 2 0 0 1-2-2V4"></path>
                                          <path d="M18 10v12"></path>
                                          <path d="M22 10v12"></path>
                                          <path d="M2 14h20"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Bâtiment public</div>
                                    </div>
                                    
                                    <div
                                      className={`bg-white border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 hover:shadow ${field.value === 'terrain' ? 'border-blue-500 shadow-md bg-blue-50' : 'border-gray-200'}`}
                                      onClick={() => field.onChange('terrain')}
                                    >
                                      <div className="flex justify-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={field.value === 'terrain' ? 'text-blue-500' : 'text-gray-500'}>
                                          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                        </svg>
                                      </div>
                                      <div className="text-center text-sm font-medium">Terrain nu</div>
                                    </div>
                                  </div>
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          {form.watch('typeBatiment') === 'terrain' && (
                            <FormField
                              control={form.control}
                              name="terrainViabilise"
                              render={({ field }) => (
                                <FormItem className="bg-blue-50 p-4 rounded-lg border border-blue-100 animate-fadeIn">
                                  <FormLabel className="flex items-center gap-2 font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                      <path d="M8 3H7a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h1"></path>
                                      <path d="M17 3h1a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-1"></path>
                                      <path d="M12 12v3"></path>
                                      <path d="M10 7h4"></path>
                                      <path d="M2 21h20"></path>
                                      <path d="M19 21v-1a2 2 0 0 0-2-2h-3"></path>
                                      <path d="M5 21v-1a2 2 0 0 1 2-2h3"></path>
                                    </svg>
                                    Le terrain est-il viabilisé ? <span className="text-red-500">*</span>
                                    <span 
                                      className="inline-flex items-center justify-center ml-1 w-4 h-4 rounded-full bg-blue-100 text-blue-700 text-xs cursor-help hover:bg-blue-200 transition-colors duration-150"
                                      title="Un terrain viabilisé dispose déjà des accès aux différents réseaux (eau, électricité, etc.)"
                                    >
                                      ?
                                    </span>
                                  </FormLabel>
                                  <div className="text-sm text-blue-700 mb-4">
                                    Un terrain viabilisé est déjà relié aux réseaux d'eau, d'électricité et d'assainissement. Cela impacte grandement le coût et le délai de votre raccordement.
                                  </div>
                                  <FormControl>
                                    <div className="grid grid-cols-2 gap-4">
                                      <div
                                        className={`flex gap-3 items-center p-3 border rounded-lg cursor-pointer transition-all ${field.value === 'viabilise' ? 'bg-green-50 border-green-300 shadow' : 'bg-white border-gray-200 hover:border-blue-300'}`}
                                        onClick={() => field.onChange('viabilise')}
                                      >
                                        <div className={`rounded-full w-5 h-5 flex items-center justify-center ${field.value === 'viabilise' ? 'bg-green-500' : 'border border-gray-300'}`}>
                                          {field.value === 'viabilise' && (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                              <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                          )}
                                        </div>
                                        <div>
                                          <div className="font-medium">Oui</div>
                                          <div className="text-xs text-gray-500">Le terrain est déjà viabilisé</div>
                                        </div>
                                      </div>
                                      
                                      <div
                                        className={`flex gap-3 items-center p-3 border rounded-lg cursor-pointer transition-all ${field.value === 'non_viabilise' ? 'bg-amber-50 border-amber-300 shadow' : 'bg-white border-gray-200 hover:border-blue-300'}`}
                                        onClick={() => field.onChange('non_viabilise')}
                                      >
                                        <div className={`rounded-full w-5 h-5 flex items-center justify-center ${field.value === 'non_viabilise' ? 'bg-amber-500' : 'border border-gray-300'}`}>
                                          {field.value === 'non_viabilise' && (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                              <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                          )}
                                        </div>
                                        <div>
                                          <div className="font-medium">Non</div>
                                          <div className="text-xs text-gray-500">Le terrain n'est pas encore viabilisé</div>
                                        </div>
                                      </div>
                                    </div>
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          )}
                          
                          <FormField
                            control={form.control}
                            name="etatProjet"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>État du projet *</FormLabel>
                                <FormControl>
                                  <Select 
                                    value={field.value} 
                                    onValueChange={field.onChange}
                                  >
                                    <SelectTrigger>
                                      <SelectValue placeholder="Sélectionnez l'état de votre projet" />
                                    </SelectTrigger>
                                    <SelectContent>
                                      <SelectItem value="planning">En phase de planification</SelectItem>
                                      <SelectItem value="permit_pending">Permis de construire en cours</SelectItem>
                                      <SelectItem value="permit_approved">Permis de construire obtenu</SelectItem>
                                      <SelectItem value="construction_started">Construction démarrée</SelectItem>
                                    </SelectContent>
                                  </Select>
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          {['permit_pending', 'permit_approved', 'construction_started'].includes(form.watch('etatProjet')) && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <FormField
                                control={form.control}
                                name="numeroPermis"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Numéro de permis de construire</FormLabel>
                                    <FormControl>
                                      <Input placeholder="PC 123456789" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                              
                              <FormField
                                control={form.control}
                                name="datePermis"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Date de délivrance</FormLabel>
                                    <FormControl>
                                      <Input type="date" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                            </div>
                          )}
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormField
                              control={form.control}
                              name="puissanceDemandee"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Puissance demandée (kVA) *</FormLabel>
                                  <FormControl>
                                    <Select 
                                      value={field.value} 
                                      onValueChange={field.onChange}
                                    >
                                      <SelectTrigger>
                                        <SelectValue placeholder="Sélectionnez la puissance" />
                                      </SelectTrigger>
                                      <SelectContent>
                                        {form.watch('typePhase') === 'monophase' ? (
                                          <>
                                            <SelectItem value="3">3 kVA</SelectItem>
                                            <SelectItem value="6">6 kVA</SelectItem>
                                            <SelectItem value="9">9 kVA</SelectItem>
                                            <SelectItem value="12">12 kVA</SelectItem>
                                          </>
                                        ) : (
                                          <>
                                            <SelectItem value="12">12 kVA</SelectItem>
                                            <SelectItem value="18">18 kVA</SelectItem>
                                            <SelectItem value="24">24 kVA</SelectItem>
                                            <SelectItem value="36">36 kVA</SelectItem>
                                          </>
                                        )}
                                      </SelectContent>
                                    </Select>
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            
                            <FormField
                              control={form.control}
                              name="typePhase"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Type de phase *</FormLabel>
                                  <FormControl>
                                    <RadioGroup 
                                      onValueChange={(value) => {
                                        field.onChange(value);
                                        // Réinitialiser la puissance si on change de phase
                                        if (value === 'monophase') {
                                          form.setValue('puissanceDemandee', '9');
                                        } else {
                                          form.setValue('puissanceDemandee', '12');
                                        }
                                      }}
                                      defaultValue={field.value}
                                      className="flex space-x-4"
                                    >
                                      <div className="flex items-center space-x-2">
                                        <RadioGroupItem value="monophase" id="monophase" />
                                        <Label htmlFor="monophase">Monophasé</Label>
                                      </div>
                                      <div className="flex items-center space-x-2">
                                        <RadioGroupItem value="triphase" id="triphase" />
                                        <Label htmlFor="triphase">Triphasé</Label>
                                      </div>
                                    </RadioGroup>
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>
                          
                          <FormField
                            control={form.control}
                            name="delaiRaccordement"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Délai de raccordement souhaité *</FormLabel>
                                <FormControl>
                                  <Select 
                                    value={field.value} 
                                    onValueChange={field.onChange}
                                  >
                                    <SelectTrigger>
                                      <SelectValue placeholder="Sélectionnez un délai" />
                                    </SelectTrigger>
                                    <SelectContent>
                                      <SelectItem value="less-1.5m">Moins d'un mois et demi</SelectItem>
                                      <SelectItem value="1.5m">1 mois et demi</SelectItem>
                                      <SelectItem value="1.5-3m">Entre 1,5 et 3 mois</SelectItem>
                                      <SelectItem value="3-6m">Entre 3 et 6 mois</SelectItem>
                                      <SelectItem value="6m+">Plus de 6 mois</SelectItem>
                                    </SelectContent>
                                  </Select>
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        </div>
                      </div>
                    )}
                    
                    {currentStep === 3 && (
                      <div className="space-y-6 animate-fadeIn">
                        <div className="space-y-4">
                          <h3 className="text-lg font-medium">Informations complémentaires</h3>
                          
                          <FormField
                            control={form.control}
                            name="avezVousArchitecte"
                            render={({ field }) => (
                              <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                                <FormControl>
                                  <Checkbox 
                                    checked={field.value} 
                                    onCheckedChange={field.onChange} 
                                    id="architecte" 
                                  />
                                </FormControl>
                                <div className="space-y-1 leading-none">
                                  <FormLabel htmlFor="architecte">
                                    J'ai un architecte pour ce projet
                                  </FormLabel>
                                </div>
                              </FormItem>
                            )}
                          />
                          
                          {form.watch('avezVousArchitecte') && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pl-8">
                              <FormField
                                control={form.control}
                                name="nomArchitecte"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Nom de l'architecte</FormLabel>
                                    <FormControl>
                                      <Input placeholder="Nom et prénom" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                              
                              <FormField
                                control={form.control}
                                name="telephoneArchitecte"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Téléphone</FormLabel>
                                    <FormControl>
                                      <Input placeholder="0123456789" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                              
                              <FormField
                                control={form.control}
                                name="emailArchitecte"
                                render={({ field }) => (
                                  <FormItem className="col-span-2">
                                    <FormLabel>Email</FormLabel>
                                    <FormControl>
                                      <Input placeholder="architecte@exemple.com" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                            </div>
                          )}
                          
                          <FormField
                            control={form.control}
                            name="adresseFacturationDifferente"
                            render={({ field }) => (
                              <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                                <FormControl>
                                  <Checkbox 
                                    checked={field.value} 
                                    onCheckedChange={field.onChange} 
                                    id="adresse-facturation" 
                                  />
                                </FormControl>
                                <div className="space-y-1 leading-none">
                                  <FormLabel htmlFor="adresse-facturation">
                                    Utiliser une adresse de facturation différente
                                  </FormLabel>
                                </div>
                              </FormItem>
                            )}
                          />
                          
                          {form.watch('adresseFacturationDifferente') && (
                            <div className="space-y-4 pl-8">
                              <FormField
                                control={form.control}
                                name="adresseFacturation"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Adresse de facturation</FormLabel>
                                    <FormControl>
                                      <Input placeholder="Adresse" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />
                              
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                  control={form.control}
                                  name="codePostalFacturation"
                                  render={({ field }) => (
                                    <FormItem>
                                      <FormLabel>Code postal</FormLabel>
                                      <FormControl>
                                        <Input placeholder="75000" {...field} />
                                      </FormControl>
                                      <FormMessage />
                                    </FormItem>
                                  )}
                                />
                                
                                <FormField
                                  control={form.control}
                                  name="villeFacturation"
                                  render={({ field }) => (
                                    <FormItem>
                                      <FormLabel>Ville</FormLabel>
                                      <FormControl>
                                        <Input placeholder="Ville" {...field} />
                                      </FormControl>
                                      <FormMessage />
                                    </FormItem>
                                  )}
                                />
                              </div>
                            </div>
                          )}
                          
                          <FormField
                            control={form.control}
                            name="commentaires"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Commentaires additionnels</FormLabel>
                                <FormControl>
                                  <Textarea 
                                    placeholder="Précisez ici toute information complémentaire utile à votre demande" 
                                    {...field} 
                                    rows={4}
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          <FormField
                            control={form.control}
                            name="accepteConditions"
                            render={({ field }) => (
                              <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                                <FormControl>
                                  <Checkbox 
                                    checked={field.value} 
                                    onCheckedChange={field.onChange} 
                                    id="conditions" 
                                  />
                                </FormControl>
                                <div className="space-y-1 leading-none">
                                  <FormLabel htmlFor="conditions">
                                    J'accepte les conditions générales d'utilisation et la politique de confidentialité
                                  </FormLabel>
                                </div>
                              </FormItem>
                            )}
                          />
                        </div>
                      </div>
                    )}
                    
                    <div className="flex justify-between items-center pt-8">
                      {currentStep > 1 ? (
                        <Button
                          type="button"
                          variant="outline"
                          onClick={goToPrevStep}
                          className="flex items-center gap-2 px-5 py-2.5 transition-all duration-200 hover:bg-gray-100 hover:border-gray-400 border-gray-300"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600">
                            <path d="m15 18-6-6 6-6"/>
                          </svg>
                          Précédent
                        </Button>
                      ) : (
                        <div className="invisible">Espace</div>
                      )}
                      
                      {currentStep < 3 ? (
                        <Button 
                          type="button"
                          onClick={() => {
                            // Sauvegarde automatique avant de passer à l'étape suivante
                            try {
                              const tempData = form.getValues();
                              localStorage.setItem('raccordementFormData', JSON.stringify(tempData));
                            } catch (error) {
                              console.error("Erreur lors de la sauvegarde automatique:", error);
                            }
                            // Passer à l'étape suivante
                            goToNextStep();
                          }}
                          className="bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white flex items-center gap-2 px-6 py-2.5 rounded-md shadow-md hover:shadow-lg transition-all duration-200 font-medium"
                        >
                          Suivant
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="m9 18 6-6-6-6"/>
                          </svg>
                        </Button>
                      ) : (
                        <Button 
                          type="submit"
                          disabled={isSubmitting || !form.watch('accepteConditions')}
                          className={`flex items-center gap-2 px-6 py-2.5 rounded-md shadow-md hover:shadow-lg transition-all duration-200 text-white font-medium 
                            ${!form.watch('accepteConditions') 
                              ? 'bg-gray-400 cursor-not-allowed' 
                              : 'bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800'
                            }`}
                        >
                          {isSubmitting ? (
                            <>
                              <svg className="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                              </svg>
                              Envoi en cours...
                            </>
                          ) : (
                            <>
                              Envoyer ma demande
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="m22 2-7 20-4-9-9-4Z"/>
                                <path d="M22 2 11 13"/>
                              </svg>
                            </>
                          )}
                        </Button>
                      )}
                    </div>
                  </form>
                </Form>
              </div>
              
              <div className="w-full lg:w-1/4 mt-8 lg:mt-0">
                <div className="bg-gray-50 rounded-lg p-6 shadow-sm border border-gray-100">
                  <h3 className="text-lg font-medium mb-6 flex items-center text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2">
                      <path d="M2 3h20"></path>
                      <path d="M20 3v18"></path>
                      <path d="M4 3v18"></path>
                      <path d="M4 7h16"></path>
                      <path d="M4 11h16"></path>
                      <path d="M4 15h16"></path>
                    </svg>
                    Étapes à suivre
                  </h3>
                  
                  <div className="space-y-8">
                    <div className={`relative pl-10 ${currentStep >= 1 ? 'text-gray-900' : 'text-gray-400'}`}>
                      <div className={`absolute left-0 top-0 rounded-full flex items-center justify-center w-7 h-7 transition-all duration-300
                        ${currentStep === 1 ? 'bg-blue-600 text-white ring-4 ring-blue-100' : 
                           currentStep > 1 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'}`}>
                        {currentStep > 1 ? 
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg> : "1"}
                      </div>
                      <div>
                        <h4 className="font-medium text-base">Étape 1 : Informations personnelles</h4>
                        <p className="text-sm text-gray-500 mt-1">Veuillez renseigner vos coordonnées personnelles pour commencer votre demande.</p>
                      </div>
                    </div>
                    
                    <div className={`relative pl-10 ${currentStep >= 2 ? 'text-gray-900' : 'text-gray-400'}`}>
                      <div className={`absolute left-0 top-0 rounded-full flex items-center justify-center w-7 h-7 transition-all duration-300
                        ${currentStep === 2 ? 'bg-blue-600 text-white ring-4 ring-blue-100' : 
                           currentStep > 2 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'}`}>
                        {currentStep > 2 ? 
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg> : "2"}
                      </div>
                      <div>
                        <h4 className="font-medium text-base">Étape 2 : Détails du projet</h4>
                        <p className="text-sm text-gray-500 mt-1">Spécifications techniques et détails du raccordement.</p>
                      </div>
                    </div>
                    
                    <div className={`relative pl-10 ${currentStep >= 3 ? 'text-gray-900' : 'text-gray-400'}`}>
                      <div className={`absolute left-0 top-0 rounded-full flex items-center justify-center w-7 h-7 transition-all duration-300
                        ${currentStep === 3 ? 'bg-blue-600 text-white ring-4 ring-blue-100' : 
                           currentStep > 3 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'}`}>
                        {currentStep > 3 ? 
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg> : "3"}
                      </div>
                      <div>
                        <h4 className="font-medium text-base">Étape 3 : Validation et finalisation</h4>
                        <p className="text-sm text-gray-500 mt-1">Validation finale de votre demande avant envoi.</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="mt-8 mb-4">
                    <div className="flex justify-between text-sm font-medium mb-2">
                      <div className="flex items-center text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500 mr-1">
                          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                        <span className="text-blue-700 font-medium">Progression de votre demande</span>
                      </div>
                      <div>
                        <span className="text-blue-600 font-bold">{Math.floor(formProgress)}</span>
                        <span className="text-gray-400">/ 100</span>
                      </div>
                    </div>
                    
                    <div className="progress-container">
                      <div 
                        className="progress-bar"
                        style={{ 
                          width: `${formProgress}%`,
                          backgroundSize: '200% 100%',
                          backgroundImage: 'linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0) 100%), linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #2563eb 100%)'
                        }}
                      >
                        <div className="progress-bar-shine"></div>
                      </div>
                      <div className="progress-indicator" style={{ right: `${100 - formProgress}%` }}></div>
                    </div>
                    
                    <div className="flex justify-end text-sm text-gray-600 mt-2 font-medium">
                      <div className="flex items-center">
                        <span className="text-blue-700">
                          {formProgress < 34 && "Informations personnelles"}
                          {formProgress >= 34 && formProgress < 67 && "Détails techniques"}
                          {formProgress >= 67 && formProgress < 100 && "Finalisation"}
                          {formProgress === 100 && "Terminé !"}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-8 mb-6 mt-6 shadow-sm border border-blue-200">
            <div className="flex flex-col md:flex-row md:items-center">
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-blue-900 mb-3 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 text-blue-700">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v-4"></path>
                    <path d="M12 8h.01"></path>
                  </svg>
                  Besoin d'aide pour votre raccordement ?
                </h2>
                <p className="text-blue-800 mb-4 text-base">
                  Notre équipe de spécialistes est disponible pour répondre à vos questions et vous accompagner tout au long de votre démarche de raccordement électrique.
                </p>
              </div>
              <div className="mt-4 md:mt-0 md:ml-6">
                <Button
                  onClick={() => setContactModalOpen(true)}
                  variant="outline"
                  className="bg-white text-blue-700 border-blue-300 hover:bg-blue-50 shadow-sm px-5 py-2 flex items-center gap-2 transition-all duration-200"
                >
                  <MessageSquare className="h-5 w-5" />
                  Nous contacter
                </Button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Modal de contact */}
      <Dialog open={contactModalOpen} onOpenChange={setContactModalOpen}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <DialogTitle>Contactez notre équipe</DialogTitle>
            <DialogDescription>
              Posez-nous vos questions concernant votre raccordement électrique. Nous vous répondrons dans les plus brefs délais.
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={handleContactSubmit} className="space-y-4">
            <div className="grid grid-cols-1 gap-4">
              <div className="space-y-2">
                <Label htmlFor="contact-name">Nom complet *</Label>
                <Input
                  id="contact-name"
                  name="name"
                  value={contactForm.name}
                  onChange={handleContactInputChange}
                  placeholder="Votre nom et prénom"
                  required
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="contact-email">Email *</Label>
                <Input
                  id="contact-email"
                  name="email"
                  type="email"
                  value={contactForm.email}
                  onChange={handleContactInputChange}
                  placeholder="votre@email.com"
                  required
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="contact-phone">Téléphone</Label>
                <Input
                  id="contact-phone"
                  name="phone"
                  value={contactForm.phone}
                  onChange={handleContactInputChange}
                  placeholder="0612345678 (facultatif)"
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="contact-message">Message *</Label>
                <Textarea
                  id="contact-message"
                  name="message"
                  value={contactForm.message}
                  onChange={handleContactInputChange}
                  placeholder="Votre message"
                  rows={4}
                  required
                />
              </div>
            </div>
            
            <DialogFooter>
              <Button type="button" variant="outline" onClick={() => setContactModalOpen(false)}>
                Annuler
              </Button>
              <Button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white">
                <Send className="mr-2 h-4 w-4" />
                Envoyer
              </Button>
            </DialogFooter>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}