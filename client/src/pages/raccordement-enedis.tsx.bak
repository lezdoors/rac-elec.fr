import { useState, useEffect, useRef } from "react";
import { Helmet } from "react-helmet";
import { 
  ChevronRight, MapPin, Mail, Phone, User, Send, X, MessageSquare, Info, Clock,
  Home, Building, Bolt, FileText, Calendar, CheckCircle, InfoIcon, LayoutDashboard
} from "lucide-react";
import { ModernClientType } from "@/components/modern-client-type";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter, DialogClose } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { toast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { z } from "zod";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from "@/components/ui/form";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Switch } from "@/components/ui/switch";
import { GoogleSnippetButton } from "@/components/google-snippet-button";
import { GoogleSnippetsInitializer } from "@/components/google-snippets-initializer";

// Schéma de validation pour le formulaire
const requestFormSchema = z.object({
  // Informations personnelles
  clientType: z.enum(["particulier", "professionnel", "collectivite"], {
    errorMap: () => ({ message: "Veuillez sélectionner un type de client" }),
  }).default("particulier"),
  nom: z.string().min(2, "Le nom est requis"),
  prenom: z.string().min(2, "Le prénom est requis"),
  email: z.string().email("Email invalide"),
  telephone: z.string().min(10, "Numéro de téléphone invalide"),
  societe: z.string().optional(),
  siret: z.string().optional(),
  
  // Détails techniques
  typeRaccordement: z.enum([
    "new_connection", 
    "power_upgrade", 
    "temporary_connection", 
    "meter_relocation",
    "other"
  ], {
    errorMap: () => ({ message: "Veuillez sélectionner un type de raccordement" }),
  }).default("new_connection"),
  dateRaccordementProvisoire: z.string().optional(),
  numeroPDL: z.string().optional(),
  pdlInconnu: z.boolean().optional().default(false),
  autreTypeDescription: z.string().optional(),
  typeBatiment: z.enum([
    "individual_house", 
    "apartment_building", 
    "commercial", 
    "industrial",
    "agricultural",
    "public",
    "terrain"
  ], {
    errorMap: () => ({ message: "Veuillez sélectionner un type de bâtiment" }),
  }).default("individual_house"),
  terrainViabilise: z.enum(["viabilise", "non_viabilise"]).optional(),
  etatProjet: z.enum([
    "planning", 
    "permit_pending", 
    "permit_approved", 
    "construction_started"
  ], {
    errorMap: () => ({ message: "Veuillez sélectionner l'état du projet" }),
  }).default("planning"),
  numeroPermis: z.string().optional(),
  datePermis: z.string().optional(),
  puissanceDemandee: z.string(),
  typePhase: z.enum(["monophase", "triphase"]).default("monophase"),
  delaiRaccordement: z.enum(["less-1.5m", "1.5m", "1.5-3m", "3-6m", "6m+"]).default("1.5-3m"),
  
  // Adresse et facturation
  adresse: z.string().min(5, "L'adresse est requise"),
  complementAdresse: z.string().optional(),
  codePostal: z.string().min(5, "Code postal invalide"),
  ville: z.string().min(2, "La ville est requise"),
  referenceCadastrale: z.string().optional(),
  adresseFacturationDifferente: z.boolean().default(false),
  adresseFacturation: z.string().optional(),
  villeFacturation: z.string().optional(),
  codePostalFacturation: z.string().optional(),
  
  // Autres informations
  avezVousArchitecte: z.boolean().default(false),
  nomArchitecte: z.string().optional(),
  telephoneArchitecte: z.string().optional(),
  emailArchitecte: z.string().email("Email de l'architecte invalide").optional(),
  commentaires: z.string().optional(),
  accepteConditions: z.boolean().default(false)
});

type RequestFormValues = z.infer<typeof requestFormSchema>;

// Cette fonction recherche la fonction onSubmit
export function searchOnSubmitFunction() {
  return `
  // Fonction de soumission finale du formulaire
  const onSubmit = async (data: RequestFormValues) => {
    try {
      setIsSubmitting(true);
      
      // Conversion des données pour l'API
      const requestData = {
        // Informations personnelles
        firstName: data.prenom,
        lastName: data.nom,
        email: data.email,
        phone: data.telephone,
        clientType: data.clientType,
        company: data.societe || "",
        siret: data.siret || "",
        
        // Adresse
        address: data.adresse,
        addressComplement: data.complementAdresse || "",
        postalCode: data.codePostal,
        city: data.ville,
        cadastralReference: data.referenceCadastrale || "",
        
        // Type de service
        serviceType: "electricity",
        requestType: data.typeRaccordement,
        temporaryConnectionDate: data.dateRaccordementProvisoire || "",
        pdlNumber: data.numeroPDL || "",
        pdlUnknown: data.pdlInconnu || false,
        otherRequestTypeDesc: data.autreTypeDescription || "",
        
        // Détails du bâtiment
        buildingType: data.typeBatiment,
        terrainViabilise: data.terrainViabilise || "",
        projectStatus: data.etatProjet,
        permitNumber: data.numeroPermis || "",
        permitDeliveryDate: data.datePermis || "",
        
        // Puissance et phase
        powerRequired: data.puissanceDemandee,
        phaseType: data.typePhase,
        
        // Planning
        connectionDelay: data.delaiRaccordement,
        
        // Facturation
        useDifferentBillingAddress: data.adresseFacturationDifferente,
        billingAddress: data.adresseFacturation || "",
        billingCity: data.villeFacturation || "",
        billingPostalCode: data.codePostalFacturation || "",
        
        // Architecte
        hasArchitect: data.avezVousArchitecte,
        architectName: data.nomArchitecte || "",
        architectPhone: data.telephoneArchitecte || "",
        architectEmail: data.emailArchitecte || "",
        
        // Commentaires
        comments: data.commentaires || "",
        
        // Termes et conditions
        termsAccepted: data.accepteConditions,
      };
      
      // Envoi des données à l'API
      const response = await apiRequest('POST', '/api/service-requests', requestData);
      
      if (!response.ok) {
        throw new Error("Erreur lors de la soumission du formulaire");
      }
      
      const result = await response.json();
      
      toast({
        title: "Demande envoyée avec succès!",
        description: "Votre numéro de référence: " + result.referenceNumber,
      });
      
      // Redirection vers la page de confirmation
      setTimeout(() => {
        window.location.href = \`/raccordement-enedis/confirmation?ref=\${result.referenceNumber}\`;
      }, 2000);
    } catch (error) {
      console.error("Erreur:", error);
      toast({
        title: "Erreur",
        description: "Une erreur est survenue lors de l'envoi de votre demande. Veuillez réessayer.",
        variant: "destructive",
      });
    } finally {
      setIsSubmitting(false);
    }
  };
  `;
}

export default function RaccordementEnedisPage() {
  const topRef = useRef<HTMLDivElement>(null);
  const [contactModalOpen, setContactModalOpen] = useState(false);
  const [contactForm, setContactForm] = useState({
    name: '',
    email: '',
    phone: '',
    message: '',
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  // État du formulaire à étapes
  const [currentStep, setCurrentStep] = useState(1);
  const [formProgress, setFormProgress] = useState(33);
  
  // Initialisation du formulaire
  const form = useForm<RequestFormValues>({
    resolver: zodResolver(requestFormSchema),
    defaultValues: {
      // Informations personnelles
      clientType: "particulier",
      nom: "",
      prenom: "",
      email: "",
      telephone: "",
      societe: "",
      siret: "",
      
      // Détails techniques
      typeRaccordement: "new_connection",
      dateRaccordementProvisoire: "",
      numeroPDL: "",
      pdlInconnu: false,
      autreTypeDescription: "",
      typeBatiment: "individual_house",
      terrainViabilise: "viabilise",
      etatProjet: "planning",
      numeroPermis: "",
      datePermis: "",
      puissanceDemandee: "9",
      typePhase: "monophase",
      delaiRaccordement: "1.5-3m",
      
      // Adresse et facturation
      adresse: "",
      complementAdresse: "",
      codePostal: "",
      ville: "",
      referenceCadastrale: "",
      adresseFacturationDifferente: false,
      adresseFacturation: "",
      villeFacturation: "",
      codePostalFacturation: "",
      
      // Autres informations
      avezVousArchitecte: false,
      nomArchitecte: "",
      telephoneArchitecte: "",
      emailArchitecte: "",
      commentaires: "",
      accepteConditions: false
    },
  });
  
  // Fonction pour passer à l'étape suivante
  const goToNextStep = async () => {
    const currentFields = getCurrentStepFields();
    const result = await form.trigger(currentFields as any);
    
    if (result) {
      const nextStep = currentStep + 1;
      setCurrentStep(nextStep);
      
      // Calcul de la progression
      if (nextStep === 2) {
        setFormProgress(66);
      } else if (nextStep === 3) {
        setFormProgress(100);
      }
      
      // Si les champs de l'étape 1 sont remplis, on crée le lead en arrière-plan
      if (currentStep === 1) {
        try {
          const formData = form.getValues();
          const response = await apiRequest('POST', '/api/leads/create', {
            firstName: formData.prenom,
            lastName: formData.nom,
            email: formData.email,
            phone: formData.telephone,
            clientType: "particulier",
            serviceType: "electricity",
            requestType: "new_connection"
          });
          
          // Traitement silencieux, pas de notification à l'utilisateur
          await response.json();
        } catch (error) {
          console.error("Erreur lors de la création du lead:", error);
          // Pas d'alerte à l'utilisateur pour ne pas perturber l'expérience
        }
      }
    }
  };
  
  // Fonction pour revenir à l'étape précédente
  const goToPrevStep = () => {
    const prevStep = Math.max(1, currentStep - 1);
    setCurrentStep(prevStep);
    
    // Mise à jour de la progression
    if (prevStep === 1) {
      setFormProgress(33);
    } else if (prevStep === 2) {
      setFormProgress(66);
    }
  };
  
  // Fonction pour obtenir les champs de l'étape courante
  const getCurrentStepFields = () => {
    switch (currentStep) {
      case 1:
        // Étape 1: Informations personnelles
        const step1Fields = ['clientType', 'nom', 'prenom', 'email', 'telephone'];
        
        // Ajout des champs spécifiques aux professionnels
        if (form.watch('clientType') !== 'particulier') {
          step1Fields.push('societe', 'siret');
        }
        
        return step1Fields;
      
      case 2:
        // Étape 2: Adresse du projet et détails techniques
        const step2Fields = ['adresse', 'complementAdresse', 'codePostal', 'ville', 'referenceCadastrale'];
        
        // Ajout des champs spécifiques en fonction du type de demande
        step2Fields.push('typeRaccordement', 'typeBatiment');
        
        if (form.watch('typeBatiment') === 'terrain') {
          step2Fields.push('terrainViabilise');
        }
        
        if (form.watch('typeRaccordement') === 'temporary_connection') {
          step2Fields.push('dateRaccordementProvisoire');
        }
        
        if (form.watch('typeRaccordement') === 'meter_relocation') {
          step2Fields.push('numeroPDL', 'pdlInconnu');
        }
        
        if (form.watch('typeRaccordement') === 'other') {
          step2Fields.push('autreTypeDescription');
        }
        
        // Informations techniques supplémentaires
        step2Fields.push('etatProjet', 'puissanceDemandee', 'typePhase', 'delaiRaccordement');
        
        if (['permit_pending', 'permit_approved', 'construction_started'].includes(form.watch('etatProjet'))) {
          step2Fields.push('numeroPermis', 'datePermis');
        }
        
        return step2Fields;
      
      case 3:
        // Étape 3: Validation et informations complémentaires
        const step3Fields = ['accepteConditions'];
        
        // Ajout des champs d'architecte si nécessaire
        if (form.watch('avezVousArchitecte')) {
          step3Fields.push('nomArchitecte', 'telephoneArchitecte', 'emailArchitecte');
        }
        
        // Ajout des champs d'adresse de facturation si différente
        if (form.watch('adresseFacturationDifferente')) {
          step3Fields.push('adresseFacturation', 'villeFacturation', 'codePostalFacturation');
        }
        
        step3Fields.push('commentaires');
        
        return step3Fields;
      
      default:
        return [];
    }
  };
  
  // Fonction de soumission finale du formulaire
  const onSubmit = async (data: RequestFormValues) => {
    try {
      setIsSubmitting(true);
      
      // Envoi des données à l'API
      const response = await apiRequest('POST', '/api/service-requests', {
        firstName: data.prenom,
        lastName: data.nom,
        email: data.email,
        phone: data.telephone,
        address: data.adresse,
        postalCode: data.codePostal,
        city: data.ville,
        clientType: "particulier",
        serviceType: "electricity",
        requestType: "new_connection"
      });
      
      if (!response.ok) {
        throw new Error("Erreur lors de la soumission du formulaire");
      }
      
      const result = await response.json();
      
      toast({
        title: "Demande envoyée avec succès!",
        description: "Votre numéro de référence: " + result.referenceNumber,
      });
      
      // Redirection vers la page de confirmation
      setTimeout(() => {
        window.location.href = `/raccordement-enedis/confirmation?ref=${result.referenceNumber}`;
      }, 1000);
      
    } catch (error) {
      toast({
        variant: "destructive",
        title: "Erreur lors de l'envoi",
        description: error instanceof Error ? error.message : "Une erreur est survenue",
      });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  // Gestionnaire de modification des champs du formulaire de contact
  const handleContactInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setContactForm(prev => ({ ...prev, [name]: value }));
  };
  
  // Gestionnaire de soumission du formulaire de contact
  const handleContactSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation simple du formulaire
    if (!contactForm.name || !contactForm.email || !contactForm.message) {
      toast({
        title: "Formulaire incomplet",
        description: "Veuillez remplir tous les champs obligatoires.",
        variant: "destructive",
      });
      return;
    }
    
    // Simulation de l'envoi du formulaire
    setIsSubmitting(true);
    
    try {
      // Ici, vous pourriez ajouter un appel API pour envoyer les données du formulaire
      await new Promise(resolve => setTimeout(resolve, 1500)); // Simulation de délai réseau
      
      toast({
        title: "Message envoyé !",
        description: "Nous vous répondrons dans les plus brefs délais.",
      });
      
      // Réinitialiser le formulaire
      setContactForm({
        name: '',
        email: '',
        phone: '',
        message: '',
      });
      
      // Fermer la modal
      setContactModalOpen(false);
    } catch (error) {
      toast({
        title: "Erreur lors de l'envoi",
        description: "Une erreur s'est produite. Veuillez réessayer ultérieurement.",
        variant: "destructive",
      });
    } finally {
      setIsSubmitting(false);
    }
  };
  
  // Autocomplete pour les villes en France
  const lookupCity = async (postalCode: string) => {
    if (postalCode.length === 5) {
      try {
        // API gratuite pour récupérer les communes françaises
        const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${postalCode}&fields=nom&format=json`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          // Si une seule ville correspond, on l'utilise automatiquement
          if (data.length === 1) {
            form.setValue("ville", data[0].nom);
          }
        }
      } catch (error) {
        console.error("Erreur lors de la récupération de la ville:", error);
      }
    }
  };
  
  // Effet pour scroller vers le haut quand la page est chargée
  useEffect(() => {
    if (topRef.current) {
      topRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, []);
  
  // Watch code postal pour autocomplétion de la ville
  const watchedPostalCode = form.watch("codePostal");
  
  useEffect(() => {
    if (watchedPostalCode) {
      lookupCity(watchedPostalCode);
    }
  }, [watchedPostalCode]);
  
  return (
    <div ref={topRef}>
      {/* Initialisation des snippets Google */}
      <GoogleSnippetsInitializer page="/raccordement-enedis" />
      
      {/* Ajout de métadonnées SEO */}
        <Helmet>
        <title>Demande de Raccordement Électrique Enedis | Formulaire en Ligne Simplifié</title>
        <meta name="description" content="Formulaire de demande de raccordement électrique Enedis pour particuliers et professionnels. Raccordement maison, branchement Enedis, service simplifié, accompagnement personnalisé et traitement rapide pour votre raccordement électrique." />
        <meta name="keywords" content="raccordement enedis, enedis raccordement, demande de raccordement, raccordement électrique, raccordement électrique particulier, raccordement maison, branchement Enedis, formulaire de raccordement enedis" />
        <link rel="canonical" href="https://raccordement.net/raccordement-enedis" />
        
        {/* Balises Open Graph optimisées */}
        <meta property="og:title" content="Demande de Raccordement Électrique Enedis | Formulaire Simplifié" />
        <meta property="og:description" content="Service professionnel de raccordement électrique Enedis. Formulaire simplifié, accompagnement tout au long du processus et traitement prioritaire pour votre maison ou local." />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://raccordement.net/raccordement-enedis" />
        <meta property="og:image" content="https://raccordement.net/assets/og-image-raccordement.jpg" />
        
        {/* Balisage Schema.org pour ServiceForm */}
        <script type="application/ld+json">
          {`
            {
              "@context": "https://schema.org",
              "@type": "WebPage",
              "name": "Formulaire de Demande de Raccordement Électrique Enedis",
              "description": "Formulaire en ligne pour demander un raccordement électrique Enedis pour votre maison ou local professionnel",
              "mainEntity": {
                "@type": "Service",
                "name": "Service de Raccordement Électrique Enedis",
                "serviceType": "Raccordement au réseau de distribution électrique",
                "provider": {
                  "@type": "Organization",
                  "name": "RaccordementElec",
                  "url": "https://raccordement.net"
                },
                "description": "Service de demande de raccordement électrique Enedis simplifié pour particuliers et professionnels",
                "areaServed": {
                  "@type": "Country",
                  "name": "France"
                },
                "audience": {
                  "@type": "Audience",
                  "audienceType": "Particuliers et professionnels"
                },
                "offers": {
                  "@type": "Offer",
                  "price": "129.80",
                  "priceCurrency": "EUR"
                },
                "termsOfService": "https://raccordement.net/conditions-utilisation",
                "availableChannel": {
                  "@type": "ServiceChannel",
                  "serviceUrl": "https://raccordement.net/raccordement-enedis",
                  "name": "Formulaire en ligne"
                }
              },
              "speakable": {
                "@type": "SpeakableSpecification",
                "cssSelector": ["h1", ".speakable"]
              },
              "breadcrumb": {
                "@type": "BreadcrumbList",
                "itemListElement": [
                  {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Accueil",
                    "item": "https://raccordement.net/"
                  },
                  {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "Raccordement Électrique Enedis",
                    "item": "https://raccordement.net/raccordement-enedis"
                  }
                ]
              }
            }
          `}
        </script>
      </Helmet>
      
      {/* Nouveau formulaire basé sur la maquette */}
      <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden my-12">
        {/* En-tête du formulaire */}
        <div className="p-6 sm:p-8 border-b border-gray-100">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">Demande de raccordement électrique</h1>
          <p className="text-gray-600">Complétez le formulaire ci-dessous pour commencer votre démarche de raccordement électrique.</p>
        </div>
        
        <div className="flex flex-col md:flex-row">
          {/* Formulaire principal */}
          <div className="flex-1 p-6 sm:p-8">
            <Form {...form}>
              <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                {/* Étape 1: Informations personnelles */}
                {currentStep === 1 && (
                  <div className="space-y-6 animate-in fade-in slide-in-from-left-5 duration-300">
                    <FormField
                      control={form.control}
                      name="clientType"
                      render={({ field }) => (
                        <FormItem className="mb-8">
                          <FormControl>
                            <ModernClientType 
                              value={field.value} 
                              onChange={field.onChange} 
                              error={form.formState.errors.clientType?.message}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="nom"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nom <span className="text-red-500">*</span></FormLabel>
                          <FormControl>
                            <Input placeholder="Votre nom" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="prenom"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Prénom <span className="text-red-500">*</span></FormLabel>
                          <FormControl>
                            <Input placeholder="Votre prénom" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="email"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Email <span className="text-red-500">*</span></FormLabel>
                          <FormControl>
                            <Input placeholder="votre@email.com" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="telephone"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Téléphone <span className="text-red-500">*</span></FormLabel>
                          <FormControl>
                            <Input placeholder="0123456789" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    {/* Affichage conditionnel des champs pour professionnels et collectivités */}
                    {form.watch('clientType') !== 'particulier' && (
                      <>
                        <FormField
                          control={form.control}
                          name="societe"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>
                                {form.watch('clientType') === 'professionnel' ? 'Société' : 'Organisme'} 
                                <span className="text-red-500">*</span>
                              </FormLabel>
                              <FormControl>
                                <Input 
                                  placeholder={form.watch('clientType') === 'professionnel' 
                                    ? "Nom de votre entreprise" 
                                    : "Nom de l'organisme"}
                                  {...field} 
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="siret"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>
                                {form.watch('clientType') === 'professionnel' ? 'SIRET' : 'SIRET/RNA'} 
                                <span className="text-red-500">*</span>
                              </FormLabel>
                              <FormControl>
                                <Input 
                                  placeholder={form.watch('clientType') === 'professionnel' 
                                    ? "SIRET de l'entreprise" 
                                    : "Numéro SIRET ou RNA"}
                                  {...field} 
                                />
                              </FormControl>
                              <FormMessage />
                              {form.watch('clientType') === 'professionnel' && (
                                <FormDescription>
                                  <p className="text-xs text-muted-foreground">
                                    Numéro à 14 chiffres de votre entreprise
                                  </p>
                                </FormDescription>
                              )}
                            </FormItem>
                          )}
                        />
                      </>
                    )}
                  </div>
                )}
                
                {/* Étape 2: Adresse du projet */}
                {currentStep === 2 && (
                  <div className="space-y-6 animate-in fade-in slide-in-from-left-5 duration-300">
                    <FormField
                      control={form.control}
                      name="adresse"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Adresse <span className="text-red-500">*</span></FormLabel>
                          <div className="flex items-start">
                            <FormControl>
                              <Input placeholder="Saisissez une adresse..." {...field} />
                            </FormControl>
                            <div className="rounded-full bg-blue-50 p-1 ml-2 cursor-help" title="L'adresse où sera effectué le raccordement électrique">
                              <Info className="h-4 w-4 text-blue-500" />
                            </div>
                          </div>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <FormField
                        control={form.control}
                        name="codePostal"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Code postal <span className="text-red-500">*</span></FormLabel>
                            <FormControl>
                              <Input placeholder="75000" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      
                      <FormField
                        control={form.control}
                        name="ville"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Ville <span className="text-red-500">*</span></FormLabel>
                            <FormControl>
                              <Input placeholder="Votre ville" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                  </div>
                )}
                
                {/* Étape 3: Validation et résumé */}
                {currentStep === 3 && (
                  <div className="space-y-6 animate-in fade-in slide-in-from-left-5 duration-300">
                    <div className="bg-blue-50 p-6 rounded-lg">
                      <h3 className="font-semibold text-lg text-blue-800 mb-4">Récapitulatif de votre demande</h3>
                      
                      <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-2">
                          <p className="text-gray-600 font-medium">Nom:</p>
                          <p>{form.getValues().nom}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <p className="text-gray-600 font-medium">Prénom:</p>
                          <p>{form.getValues().prenom}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <p className="text-gray-600 font-medium">Email:</p>
                          <p>{form.getValues().email}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <p className="text-gray-600 font-medium">Téléphone:</p>
                          <p>{form.getValues().telephone}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <p className="text-gray-600 font-medium">Adresse:</p>
                          <p>{form.getValues().adresse}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <p className="text-gray-600 font-medium">Code postal:</p>
                          <p>{form.getValues().codePostal}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <p className="text-gray-600 font-medium">Ville:</p>
                          <p>{form.getValues().ville}</p>
                        </div>
                      </div>
                      
                      <div className="flex items-center mt-6 p-4 bg-blue-100 rounded-md">
                        <Info className="h-5 w-5 text-blue-600 mr-2 flex-shrink-0" />
                        <p className="text-sm text-blue-800">
                          En validant ce formulaire, vous serez redirigé vers un récapitulatif de votre demande et le paiement des frais de traitement de dossier de 129,80€ TTC.
                        </p>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Navigation et boutons */}
                <div className="flex justify-between pt-4 mt-8 border-t border-gray-100">
                  {currentStep > 1 && (
                    <Button
                      type="button"
                      variant="outline"
                      onClick={goToPrevStep}
                      className="px-3 py-1 h-auto text-sm md:text-base md:px-4 md:py-2 md:h-10"
                    >
                      <span className="hidden sm:inline">Précédent</span>
                      <span className="sm:hidden">Retour</span>
                    </Button>
                  )}
                  
                  {currentStep < 3 ? (
                    <GoogleSnippetButton
                      page="/raccordement-enedis"
                      selector=".next-step-button"
                      type="button"
                      onClick={goToNextStep}
                      className="ml-auto px-3 py-1 h-auto text-sm md:text-base md:px-4 md:py-2 md:h-10 next-step-button"
                    >
                      <span className="hidden sm:inline">Suivant</span>
                      <span className="sm:hidden">Suite</span>
                      <ChevronRight className="ml-1 h-4 w-4" />
                    </GoogleSnippetButton>
                  ) : (
                    <GoogleSnippetButton
                      page="/raccordement-enedis"
                      selector=".submit-form-button"
                      type="submit"
                      className="ml-auto bg-gradient-to-r from-blue-600 to-blue-800 px-3 py-1 h-auto text-sm md:text-base md:px-4 md:py-2 md:h-10 submit-form-button"
                      disabled={isSubmitting}
                    >
                      {isSubmitting ? (
                        <span className="flex items-center">
                          <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          <span className="hidden sm:inline">Traitement...</span>
                          <span className="sm:hidden">Envoi...</span>
                        </span>
                      ) : (
                        <span className="flex items-center">
                          <span className="hidden sm:inline">Valider ma demande</span>
                          <span className="sm:hidden">Valider</span>
                          <CheckCircle className="ml-1 h-4 w-4" />
                        </span>
                      )}
                    </GoogleSnippetButton>
                  )}
                </div>
                
                {/* Bouton Sauvegarder pour étape intermédiaire */}
                {currentStep < 3 && (
                  <div className="flex justify-start">
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      className="text-gray-500 hover:text-gray-700"
                    >
                      Sauvegarder
                    </Button>
                  </div>
                )}
              </form>
            </Form>
          </div>
          
          {/* Barre latérale avec étapes */}
          <div className="w-full md:w-72 bg-gray-50 p-6 border-t md:border-t-0 md:border-l border-gray-100">
            <div className="mb-8">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">Étapes à suivre</h3>
              
              <div className="space-y-6">
                <div className={`flex ${currentStep === 1 ? 'text-primary' : 'text-gray-600'}`}>
                  <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${currentStep === 1 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-500'} mr-3`}>
                    1
                  </div>
                  <div>
                    <h4 className="font-medium text-inherit">Informations personnelles</h4>
                    <p className="text-sm text-gray-500 mt-1">
                      Veuillez renseigner vos coordonnées personnelles pour commencer votre demande.
                    </p>
                  </div>
                </div>
                
                <div className={`flex ${currentStep === 2 ? 'text-primary' : 'text-gray-600'}`}>
                  <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${currentStep === 2 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-500'} mr-3`}>
                    2
                  </div>
                  <div>
                    <h4 className="font-medium text-inherit">Détails du projet</h4>
                    <p className="text-sm text-gray-500 mt-1">
                      Spécifications techniques
                    </p>
                  </div>
                </div>
                
                <div className={`flex ${currentStep === 3 ? 'text-primary' : 'text-gray-600'}`}>
                  <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${currentStep === 3 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-500'} mr-3`}>
                    3
                  </div>
                  <div>
                    <h4 className="font-medium text-inherit">Validation et finalisation</h4>
                    <p className="text-sm text-gray-500 mt-1">
                      Validation finale
                    </p>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Barre de progression */}
            <div className="mt-6 md:mt-8">
              <p className="text-xs md:text-sm text-gray-600 flex justify-between items-center mb-1 md:mb-2">
                <span className="flex items-center">
                  <Clock className="w-3 h-3 md:w-4 md:h-4 mr-1" />
                  <span className="hidden xs:inline">Progression</span>
                  <span className="xs:hidden">Étape {currentStep}/3</span>
                </span>
                <span className="text-xs font-medium bg-blue-50 text-blue-700 rounded-full px-2 py-0.5">{formProgress}%</span>
              </p>
              <div className="w-full h-1.5 md:h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-blue-500 to-blue-700 rounded-full transition-all duration-500"
                  style={{ width: `${formProgress}%` }}
                ></div>
              </div>
              
              {/* Étiquettes d'étapes */}
              <div className="flex justify-between text-xs mt-1 px-1 text-gray-500">
                <span className={currentStep >= 1 ? "text-blue-600 font-medium" : ""}>Infos</span>
                <span className={currentStep >= 2 ? "text-blue-600 font-medium" : ""}>Adresse</span>
                <span className={currentStep >= 3 ? "text-blue-600 font-medium" : ""}>Validation</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Contact Modal */}
      <Dialog open={contactModalOpen} onOpenChange={setContactModalOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Contactez-nous</DialogTitle>
            <DialogDescription>
              Posez-nous vos questions ou demandez des informations complémentaires
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={handleContactSubmit} className="space-y-4 mt-4">
            <div className="grid grid-cols-1 gap-4">
              <div className="space-y-2">
                <Label htmlFor="name">Nom complet</Label>
                <Input 
                  id="name" 
                  name="name" 
                  placeholder="Votre nom" 
                  value={contactForm.name}
                  onChange={handleContactInputChange}
                  required
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="email">Email</Label>
                <Input 
                  id="email" 
                  name="email" 
                  type="email" 
                  placeholder="votre@email.com" 
                  value={contactForm.email}
                  onChange={handleContactInputChange}
                  required
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="phone">Téléphone (optionnel)</Label>
                <Input 
                  id="phone" 
                  name="phone" 
                  placeholder="0612345678" 
                  value={contactForm.phone}
                  onChange={handleContactInputChange}
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="message">Message</Label>
                <Textarea 
                  id="message" 
                  name="message" 
                  placeholder="Comment pouvons-nous vous aider ?" 
                  rows={4}
                  value={contactForm.message}
                  onChange={handleContactInputChange}
                  required
                />
              </div>
            </div>
            
            <DialogFooter className="flex flex-col-reverse sm:flex-row sm:justify-between sm:space-x-2">
              <DialogClose asChild>
                <Button type="button" variant="outline">Annuler</Button>
              </DialogClose>
              <Button 
                type="submit" 
                disabled={isSubmitting}
                className="flex items-center gap-2"
              >
                {isSubmitting ? (
                  <>
                    <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Envoi en cours...
                  </>
                ) : (
                  <>
                    <Send className="h-4 w-4" />
                    Envoyer
                  </>
                )}
              </Button>
            </DialogFooter>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}