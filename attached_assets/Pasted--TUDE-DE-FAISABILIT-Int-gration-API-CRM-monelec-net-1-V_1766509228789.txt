Ã‰TUDE DE FAISABILITÃ‰ : IntÃ©gration API CRM monelec.net
1. Vue d'ensemble de l'architecture actuelle
L'API rÃ©pond correctement. Maintenant j'ai toutes les informations nÃ©cessaires pour l'Ã©tude de faisabilitÃ©.

ğŸ“Š Ã‰TUDE DE FAISABILITÃ‰ : IntÃ©gration API CRM monelec.net
1. Vue d'ensemble de l'architecture actuelle

Diagram
2. Points d'intÃ©gration identifiÃ©s
Ã‰vÃ©nement	Edge Function	DonnÃ©es Ã  transmettre	Endpoint monelec.net
Lead capturÃ© (Step 1)	form-start	email, phone, firstName, lastName, serviceType, utm_*	POST /leads
Demande complÃ¨te (Step final)	form-submit	Toutes les donnÃ©es du formulaire + customer_id	POST /requests
Contact/Rappel	contact-callback	full_name, phone, postal_code, source	POST /leads
Paiement crÃ©Ã©	create-payment-intent	request_id, amount, customer info	POST /payment-session ou POST /payment-intent
Paiement confirmÃ©	stripe-webhook	payment_intent_id, status, amount	POST /requests (update)
3. Architecture proposÃ©e (avec sync API)
2. Points d'intÃ©gration identifiÃ©s
Ã‰vÃ©nement	Edge Function	DonnÃ©es Ã  transmettre	Endpoint monelec.net
Lead capturÃ© (Step 1)	form-start	email, phone, firstName, lastName, serviceType, utm_*	POST /leads
Demande complÃ¨te (Step final)	form-submit	Toutes les donnÃ©es du formulaire + customer_id	POST /requests
Contact/Rappel	contact-callback	full_name, phone, postal_code, source	POST /leads
Paiement crÃ©Ã©	create-payment-intent	request_id, amount, customer info	POST /payment-session ou POST /payment-intent
Paiement confirmÃ©	stripe-webhook	payment_intent_id, status, amount	POST /requests (update)
3. Architecture proposÃ©e (avec sync API)

Diagram
4. Changements requis par fichier
Fichier	Modification	Impact	Risque
supabase/functions/form-start/index.ts	Ajouter EdgeRuntime.waitUntil() pour POST vers /leads	âœ… Nul (async non-bloquant)	ğŸŸ¢ Faible
supabase/functions/form-submit/index.ts	Ajouter EdgeRuntime.waitUntil() pour POST vers /requests	âœ… Nul (async non-bloquant)	ğŸŸ¢ Faible
supabase/functions/contact-callback/index.ts	Ajouter EdgeRuntime.waitUntil() pour POST vers /leads	âœ… Nul (async non-bloquant)	ğŸŸ¢ Faible
supabase/functions/stripe-webhook/index.ts	Ajouter sync statut paiement vers /requests	âœ… Nul (async non-bloquant)	ğŸŸ¢ Faible
Nouveau secret	MONELEC_API_KEY	Requis	ğŸŸ¢ Faible
5. Mapping des donnÃ©es
POST /leads (form-start, contact-callback)

// DonnÃ©es existantes â†’ API monelec.net
{
  email: payload.email,                    // âœ… Disponible
  phone: payload.phone,                    // âœ… Disponible
  firstName: payload.firstname,            // âœ… Disponible
  lastName: payload.lastname,              // âœ… Disponible
  serviceType: payload.connection_type,    // âœ… Peut Ãªtre mappÃ©
  postalCode: payload.postal_code,         // âœ… Disponible
  source: 'lovable-website',               // âœ… Ã€ ajouter
  utm_source: payload.utm_source,          // âœ… Disponible
  utm_medium: payload.utm_medium,          // âœ… Disponible
  utm_campaign: payload.utm_campaign       // âœ… Disponible
}
POST /requests (form-submit, aprÃ¨s paiement)

{
  // Identifiants
  lovable_request_id: dbRequestId,         // âœ… Lien avec Supabase
  
  // Client
  email: customer.email,                   // âœ… Disponible
  phone: customer.phone,                   // âœ… Disponible
  full_name: customer.full_name,           // âœ… Disponible
  client_type: customer.client_type,       // âœ… Disponible
  company_name: customer.company_name,     // âœ… Disponible
  siren: customer.siren,                   // âœ… Disponible
  
  // Projet
  type_raccordement: request.type_raccordement, // âœ… Disponible
  usage: request.usage,                    // âœ… Disponible
  address: request.address,                // âœ… Disponible
  city: request.city,                      // âœ… Disponible
  zip_code: request.zip_code,              // âœ… Disponible
  phase: request.phase,                    // âœ… Disponible
  power_kva: request.power_kva,            // âœ… Disponible
  is_viabilise: request.is_viabilise,      // âœ… Disponible
  
  // Statut
  status: 'submitted',                     // âœ… Ã€ mapper
  payment_status: 'paid' | 'pending'       // âœ… Ã€ mapper
}
6. Risques et mitigations
Risque	ProbabilitÃ©	Impact	Mitigation
API monelec.net indisponible	Moyenne	âŒ Aucun (async)	Fire-and-forget avec logging
Erreur de format API	Moyenne	âš ï¸ DonnÃ©es manquantes	Validation cÃ´tÃ© serveur + logs
Latence API externe	Faible	âŒ Aucun	EdgeRuntime.waitUntil() non-bloquant
API key compromise	Faible	âš ï¸ SÃ©curitÃ©	Stockage dans Supabase Secrets
7. Changements de domaine (demande-raccordement.fr)
Les fichiers suivants rÃ©fÃ©rencent le domaine actuel et devront Ãªtre mis Ã  jour :

Fichier	Variable/Valeur	Nouvelle valeur
supabase/functions/create-payment/index.ts	siteUrl fallback	https://www.demande-raccordement.fr
supabase/functions/create-payment-intent/index.ts	siteUrl fallback	https://www.demande-raccordement.fr
src/lib/seo.ts	CANONICAL_DOMAIN	https://demande-raccordement.fr
Secret Supabase	SITE_URL	https://www.demande-raccordement.fr
8. Plan d'implÃ©mentation dÃ©taillÃ©
Phase 1: Configuration (5 min)
Ajouter le secret MONELEC_API_KEY = crm-api-0b6612a855725caa0ec2c1be89f9b3dc0e7496dfaab0c8b982cc142da8538597
Mettre Ã  jour SITE_URL = https://www.demande-raccordement.fr
Phase 2: Modification des Edge Functions (30 min)
form-start: Ajouter sync async vers POST /leads
form-submit: Ajouter sync async vers POST /requests
contact-callback: Ajouter sync async vers POST /leads
stripe-webhook: Ajouter sync async vers POST /requests (avec payment_status)
Phase 3: Mise Ã  jour du domaine (10 min)
Mettre Ã  jour les fallbacks de domaine dans les edge functions
Mettre Ã  jour CANONICAL_DOMAIN dans src/lib/seo.ts
Phase 4: Tests (15 min)
Test lead step 1 â†’ vÃ©rifier log API monelec.net
Test demande complÃ¨te â†’ vÃ©rifier log API monelec.net
Test paiement â†’ vÃ©rifier sync statut
9. Code exemple pour form-start

// Ã€ ajouter aprÃ¨s la crÃ©ation du lead dans Supabase (ligne 174)

// Sync to external CRM (non-blocking)
const monelecApiKey = Deno.env.get('MONELEC_API_KEY');
if (monelecApiKey) {
  EdgeRuntime.waitUntil(
    fetch('https://monelec.net/api/external/leads', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': monelecApiKey,
      },
      body: JSON.stringify({
        email: email,
        phone: payload.phone,
        firstName: payload.firstname || null,
        lastName: payload.lastname || null,
        serviceType: payload.connection_type || 'non-specifie',
        postalCode: payload.postal_code || null,
        source: 'lovable-website',
        lovable_lead_id: leadId, // Pour le lien retour
        utm_source: payload.utm_source || null,
        utm_medium: payload.utm_medium || null,
        utm_campaign: payload.utm_campaign || null,
      }),
    })
    .then(async res => {
      if (res.ok) {
        console.log('[form-start] âœ… CRM sync success');
      } else {
        const errorText = await res.text();
        console.error('[form-start] âŒ CRM sync failed:', res.status, errorText);
      }
    })
    .catch(err => {
      console.error('[form-start] âŒ CRM sync error:', err.message);
    })
  );
}
10. Conclusion de faisabilitÃ©
CritÃ¨re	Ã‰valuation
FaisabilitÃ© technique	âœ… 100% rÃ©alisable
Impact sur le site	âœ… Nul (modifications async non-bloquantes)
Temps d'implÃ©mentation	â±ï¸ ~1 heure
Risque de rÃ©gression	ğŸŸ¢ TrÃ¨s faible (fire-and-forget)
RÃ©versibilitÃ©	âœ… ImmÃ©diate (supprimer les appels API)
Recommandation: âœ… ProcÃ©der Ã  l'implÃ©mentation

L'intÃ©gration utilise le pattern "fire-and-forget" avec EdgeRuntime.waitUntil(), ce qui garantit :

Aucune latence ajoutÃ©e pour l'utilisateur
Aucun risque de casser le flux existant
Logs complets pour debug
RÃ©silience totale (si monelec.net est down, le site continue de fonctionner)
PrÃªt Ã  implÃ©menter sur votre feu vert. Voulez-vous que je prÃ©pare un plan plus dÃ©taillÃ© pour une phase spÃ©cifique, ou avez-vous des questions sur cette Ã©tude ?