import{c as W,a as J,r as p,j as e,l as D,B as l,O as ne,m as F,e as Ne,Q as be,T as ge,V as ye,W as ve,M as R,a0 as we,D as P,I as K,a1 as ie,S as le,a2 as Ce,aH as Ee,b2 as X,b3 as Y,b4 as ce,b5 as de,X as H,b6 as Se,P as re,U as $,x as Z,J as me,C as _,q as Te,aF as De}from"./index-Cz1F2q7w.js";import{u as U}from"./useQuery-CQbaOUrt.js";import{w as Ae,A as Le,U as ke}from"./admin-layout-DgQKjVGc.js";import{C as A,a as q,b as M,c as z,d as L,e as Ie}from"./card-CTEwFI4n.js";import{B as Q}from"./badge-BOU_Iejm.js";import{R as r,A as d}from"./schema-39NBoto0.js";import{A as ee,a as se,b as ae,c as te}from"./accordion-BT4iV_js.js";import{T as he,a as je,b as G,c as O}from"./tabs-CrsaXEl1.js";import{S as Pe}from"./separator-D8ovXjGg.js";import{F as T}from"./file-text-Bx0Qb6Jn.js";import{T as pe}from"./triangle-alert-sm9fhL4S.js";import{D as Fe}from"./download-CgHoQYXN.js";import{S as Re,a as Ve,d as _e,b as qe,c as Me}from"./select-Dpg69ypZ.js";import{R as ze}from"./refresh-cw-CYGln0Kp.js";import{S as Ge}from"./settings-HY8_biDZ.js";import{B as Oe}from"./building-_TZt65_R.js";import{H as oe}from"./history-v9pVT22Z.js";import{M as Ue}from"./map-pin-BrUDvd2R.js";import{C as He,H as $e}from"./hourglass-Cx9gGEKu.js";import{I as xe}from"./inbox-CCNhOXVt.js";import{I as Be}from"./info-CloRKCUn.js";import{S as Ke}from"./search-BVrWl9hN.js";import"./use-auth-BfrcAMzO.js";import"./use-mobile-BuYX4aVm.js";import"./index-Cjiveb02.js";import"./log-out-CxaugLBr.js";import"./credit-card-D6XBTJ7q.js";import"./index-D7CM7Zsg.js";import"./index-BOlLhLkC.js";import"./external-link-BO07SF5k.js";import"./chevron-down-BnRlLJNW.js";import"./index-DHHXNjsj.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=W("CircleUser",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}],["path",{d:"M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662",key:"154egf"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=W("Clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=W("LockKeyhole",[["circle",{cx:"12",cy:"16",r:"1",key:"1au0dj"}],["rect",{x:"3",y:"10",width:"18",height:"12",rx:"2",key:"6s8ecr"}],["path",{d:"M7 10V7a5 5 0 0 1 10 0v3",key:"1pqi11"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=W("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]);function Je({clientId:f,referenceNumber:n,showTitle:m=!1}){const{toast:w}=J(),[o,c]=p.useState(!1),{data:N,isLoading:g,error:x,isError:y}=U({queryKey:[`/api/certificates/${n}`],queryFn:async()=>{const i=await F("GET",`/api/certificates/${n}`);if(!i.ok){if(i.status===404)return null;throw new Error("Erreur lors de la récupération du certificat")}return(await i.json()).url}}),b=async()=>{c(!0);try{const i=await F("POST",`/api/certificates/${n}/generate`,{});if(!i.ok){const h=await i.json();throw new Error(h.message||"Erreur lors de la génération du certificat")}const u=await i.json();await new Promise(h=>setTimeout(h,1e3)),window.open(u.url,"_blank"),w({title:"Certificat généré",description:"Le certificat a été généré avec succès"})}catch(i){w({title:"Erreur",description:i.message,variant:"destructive"})}finally{c(!1)}},C=()=>{N&&(c(!0),window.open(N,"_blank"),setTimeout(()=>{c(!1)},1e3))};return g?e.jsxs(A,{children:[m&&e.jsxs(q,{className:"pb-2",children:[e.jsxs(M,{className:"text-lg flex items-center",children:[e.jsx(T,{className:"h-5 w-5 mr-2 text-blue-600"}),"Certificat de demande"]}),e.jsx(z,{children:"Certificat attestant la demande et le paiement"})]}),e.jsxs(L,{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(D,{className:"h-8 w-8 animate-spin text-blue-600 mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Vérification du certificat..."})]})]}):y?e.jsxs(A,{children:[m&&e.jsxs(q,{className:"pb-2",children:[e.jsxs(M,{className:"text-lg flex items-center",children:[e.jsx(T,{className:"h-5 w-5 mr-2 text-blue-600"}),"Certificat de demande"]}),e.jsx(z,{children:"Certificat attestant la demande et le paiement"})]}),e.jsxs(L,{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(pe,{className:"h-10 w-10 text-amber-500 mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Une erreur est survenue lors de la récupération du certificat"}),e.jsx("p",{className:"text-sm text-red-500",children:x instanceof Error?x.message:"Erreur inconnue"})]})]}):N?e.jsxs(A,{children:[m&&e.jsxs(q,{className:"pb-2",children:[e.jsxs(M,{className:"text-lg flex items-center",children:[e.jsx(T,{className:"h-5 w-5 mr-2 text-blue-600"}),"Certificat de demande"]}),e.jsx(z,{children:"Certificat attestant la demande et le paiement"})]}),e.jsx(L,{className:"pt-6",children:e.jsx("div",{className:"flex flex-col items-center",children:e.jsxs("div",{className:"w-full max-w-md mx-auto border rounded-md overflow-hidden mb-6",children:[e.jsxs("div",{className:"bg-blue-50 p-3 flex items-center border-b",children:[e.jsx(ne,{className:"h-5 w-5 text-blue-600 mr-2"}),e.jsxs("span",{className:"font-medium",children:["Certificat de demande #",n]})]}),e.jsxs("div",{className:"p-4 flex flex-col items-center",children:[e.jsx(T,{className:"h-24 w-24 text-blue-600 mb-2"}),e.jsx("p",{className:"text-center mb-4",children:"Ce certificat atteste officiellement de la demande de raccordement électrique et du paiement associé. Il peut être utilisé comme preuve en cas de litige."}),e.jsxs("div",{className:"w-full mt-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between border-t border-dashed pt-3",children:[e.jsx("span",{className:"text-muted-foreground",children:"Format:"}),e.jsx("span",{className:"font-medium",children:"PDF"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Sécurité:"}),e.jsx("span",{className:"font-medium",children:"Horodaté et sécurisé"})]})]})]})]})})}),e.jsx(Ie,{children:e.jsx(l,{className:"w-full",onClick:C,disabled:o,children:o?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"Téléchargement..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Télécharger le certificat"]})})})]}):e.jsxs(A,{children:[m&&e.jsxs(q,{className:"pb-2",children:[e.jsxs(M,{className:"text-lg flex items-center",children:[e.jsx(T,{className:"h-5 w-5 mr-2 text-blue-600"}),"Certificat de demande"]}),e.jsx(z,{children:"Certificat attestant la demande et le paiement"})]}),e.jsx(L,{className:"pt-6",children:e.jsxs("div",{className:"text-center py-6 border border-dashed rounded-lg",children:[e.jsx(We,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Certificat non disponible"}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-md mx-auto",children:"Aucun certificat n'a encore été généré pour cette demande. Les certificats sont générés après validation du paiement."}),e.jsx(l,{onClick:b,disabled:o,children:o?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"Génération..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Générer le certificat"]})})]})})]})}function fe({isOpen:f,onClose:n,clientEmail:m,clientName:w,referenceNumber:o}){const{toast:c}=J(),[N,g]=p.useState("template"),[x,y]=p.useState(""),[b,C]=p.useState(""),[i,u]=p.useState(""),[h,j]=p.useState(!1),{data:v,isLoading:k}=U({queryKey:["/api/email-templates"],queryFn:async()=>{const s=await F("GET","/api/email-templates");if(!s.ok)throw new Error("Erreur lors de la récupération des modèles d'email");return s.json()},enabled:f}),E=Ne({mutationFn:async()=>{const s=await F("POST","/api/send-email",{to:m,subject:b,content:i,referenceNumber:o});if(!s.ok){const a=await s.json();throw new Error(a.message||"Erreur lors de l'envoi de l'email")}return s.json()},onSuccess:()=>{c({title:"Email envoyé",description:"L'email a été envoyé avec succès au client"}),n()},onError:s=>{c({title:"Erreur",description:s.message,variant:"destructive"})}}),t=v?Object.entries(v.reduce((s,a)=>(s[a.category]||(s[a.category]=[]),s[a.category].push(a),s),{})):[],V=s=>{if(y(s),j(!1),!v)return;const a=v.find(S=>S.id.toString()===s);if(a){let S=a.content.replace(/{name}/g,w).replace(/{reference}/g,o);C(a.subject),u(S)}},I=()=>{if(!b.trim()||!i.trim()){c({title:"Champs requis",description:"Veuillez remplir le sujet et le contenu de l'email",variant:"destructive"});return}E.mutate()};return p.useEffect(()=>{f&&(g("template"),y(""),C(""),u(""),j(!1))},[f]),e.jsx(be,{open:f,onOpenChange:s=>!s&&n(),children:e.jsxs(ge,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ye,{children:[e.jsxs(ve,{className:"flex items-center",children:[e.jsx(R,{className:"mr-2 h-5 w-5 text-blue-600"}),"Envoyer un email au client"]}),e.jsx(we,{children:"Envoyez un email au client à partir d'un modèle ou créez un message personnalisé."})]}),e.jsxs(he,{value:N,onValueChange:g,className:"mt-4",children:[e.jsxs(je,{className:"grid grid-cols-2 mb-6",children:[e.jsxs(G,{value:"template",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Modèles"]}),e.jsxs(G,{value:"custom",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Email personnalisé"]})]}),e.jsx(O,{value:"template",className:"space-y-4 m-0",children:k?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(D,{className:"h-8 w-8 animate-spin text-blue-600 mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Chargement des modèles..."})]}):!v||v.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[e.jsx(pe,{className:"h-12 w-12 text-amber-500 mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Aucun modèle d'email disponible."})]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"template-select",children:"Sélectionner un modèle"}),e.jsxs(Re,{value:x,onValueChange:V,children:[e.jsx(Ve,{id:"template-select",children:e.jsx(_e,{placeholder:"Choisir un modèle"})}),e.jsx(qe,{children:t.map(([s,a])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground px-2 py-1.5",children:s}),a.map(S=>e.jsx(Me,{value:S.id.toString(),children:S.name},S.id))]},s))})]})]}),x&&e.jsxs("div",{className:"border rounded-md p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(P,{htmlFor:"template-subject",children:"Objet"}),h?e.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>V(x),children:[e.jsx(ze,{className:"h-3.5 w-3.5 mr-1.5"}),"Réinitialiser"]}):e.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>j(!0),children:[e.jsx(Ge,{className:"h-3.5 w-3.5 mr-1.5"}),"Personnaliser"]})]}),e.jsx(K,{id:"template-subject",value:b,onChange:s=>C(s.target.value),disabled:!h})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"template-content",children:"Contenu"}),e.jsx(ie,{id:"template-content",value:i,onChange:s=>u(s.target.value),rows:12,disabled:!h,className:"font-sans"})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Sera envoyé à: ",e.jsx("span",{className:"font-medium",children:m})]}),e.jsx(l,{onClick:I,disabled:E.isPending||!b.trim()||!i.trim(),children:E.isPending?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"Envoi en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Envoyer l'email"]})})]})})]})]})})}),e.jsx(O,{value:"custom",className:"space-y-4 m-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"custom-to",children:"Destinataire"}),e.jsx(K,{id:"custom-to",value:m,disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"custom-subject",children:"Objet"}),e.jsx(K,{id:"custom-subject",value:b,onChange:s=>C(s.target.value),placeholder:"Objet de l'email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"custom-content",children:"Contenu"}),e.jsx(ie,{id:"custom-content",value:i,onChange:s=>u(s.target.value),placeholder:"Saisissez votre message ici...",rows:12,className:"font-sans"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground italic mb-4",children:["Astuce: Vous pouvez utiliser ",e.jsx("span",{className:"font-mono",children:"{name}"})," pour le nom du client et ",e.jsx("span",{className:"font-mono",children:"{reference}"})," pour la référence de la demande."]})]})})]}),e.jsxs(Ce,{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx(Ee,{className:"h-3.5 w-3.5 inline-block mr-1"}),"Client: ",e.jsx("span",{className:"font-medium",children:w})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(l,{variant:"outline",onClick:n,children:"Annuler"}),e.jsx(l,{onClick:I,disabled:E.isPending||!b.trim()||!i.trim(),children:E.isPending?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"Envoi en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Envoyer"]})})]})]})]})})}function Xe({clientId:f,onClose:n}){J();const[m,w]=p.useState("info"),[o,c]=p.useState(!1),{data:N,isLoading:g,error:x}=U({queryKey:[`/api/service-request-id/${f}`],queryFn:async()=>{const a=await F("GET",`/api/service-request-id/${f}`);if(!a.ok)throw new Error("Erreur lors de la récupération des détails du client");return a.json()}}),{data:y,isLoading:b}=U({queryKey:[`/api/activity-logs/service_request/${f}`],queryFn:async()=>{const a=await F("GET",`/api/activity-logs/service_request/${f}`);if(!a.ok)throw new Error("Erreur lors de la récupération des logs d'activité");return a.json()},enabled:!!N}),C=a=>{switch(a){case r.NEW:return e.jsx(xe,{className:"h-4 w-4 text-blue-500"});case r.PENDING:return e.jsx($e,{className:"h-4 w-4 text-amber-500"});case r.ASSIGNED:return e.jsx($,{className:"h-4 w-4 text-purple-500"});case r.VALIDATED:return e.jsx(_,{className:"h-4 w-4 text-green-500"});case r.IN_PROGRESS:return e.jsx(Te,{className:"h-4 w-4 text-indigo-500"});case r.SCHEDULED:return e.jsx(Z,{className:"h-4 w-4 text-cyan-500"});case r.COMPLETED:return e.jsx(_,{className:"h-4 w-4 text-emerald-500"});case r.CANCELLED:return e.jsx(H,{className:"h-4 w-4 text-red-500"});default:return e.jsx(He,{className:"h-4 w-4 text-gray-500"})}},i=a=>{switch(a){case r.NEW:return"Nouvelle demande";case r.PENDING:return"En attente";case r.ASSIGNED:return"Assignée";case r.VALIDATED:return"Validée";case r.IN_PROGRESS:return"En cours";case r.SCHEDULED:return"Rendez-vous planifié";case r.COMPLETED:return"Terminée";case r.CANCELLED:return"Annulée";default:return"Statut inconnu"}},u=a=>{switch(a){case r.NEW:return"blue";case r.PENDING:return"amber";case r.ASSIGNED:return"purple";case r.VALIDATED:return"green";case r.IN_PROGRESS:return"indigo";case r.SCHEDULED:return"cyan";case r.COMPLETED:return"emerald";case r.CANCELLED:return"red";default:return"gray"}},h=a=>{if(!a)return"N/A";const S=typeof a=="string"?new Date(a):a;return new Intl.DateTimeFormat("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(S)},j=a=>{if(!a)return"N/A";switch(a){case"monophase":return"Monophasé";case"triphase":return"Triphasé";default:return a}},v=a=>{switch(a){case"particulier":return"Particulier";case"professionnel":return"Professionnel";case"collectivite":return"Collectivité";default:return a}},k=a=>{switch(a){case"new_connection":return"Nouveau raccordement";case"power_upgrade":return"Augmentation de puissance";case"temporary_connection":return"Raccordement temporaire";case"relocation":return"Déplacement d'ouvrage";case"technical_visit":return"Visite technique";case"other":return"Autre";default:return a}},E=a=>{switch(a){case"individual_house":return"Maison individuelle";case"apartment_building":return"Immeuble collectif";case"commercial":return"Local commercial";case"industrial":return"Site industriel";case"agricultural":return"Exploitation agricole";case"public":return"Bâtiment public";case"terrain":return"Terrain";default:return a}},t=a=>{switch(a){case"planning":return"En phase de planification";case"permit_pending":return"Permis en cours d'instruction";case"permit_approved":return"Permis approuvé";case"construction_started":return"Construction démarrée";case"construction_completed":return"Construction terminée";default:return a}},V=a=>{switch(a){case d.CREATE:return"Création";case d.UPDATE:return"Mise à jour";case d.ASSIGN:return"Assignation";case d.VALIDATE:return"Validation";case d.SCHEDULE:return"Planification";case d.COMPLETE:return"Finalisation";case d.CANCEL:return"Annulation";case"payment_succeeded":return"Paiement réussi";case"payment_failed":return"Paiement échoué";case"certificate_generated":return"Certificat généré";case"email_sent":return"Email envoyé";default:return a}},I=a=>{switch(a){case d.CREATE:return e.jsx(xe,{className:"h-4 w-4"});case d.UPDATE:return e.jsx(T,{className:"h-4 w-4"});case d.ASSIGN:return e.jsx($,{className:"h-4 w-4"});case d.VALIDATE:return e.jsx(_,{className:"h-4 w-4"});case d.SCHEDULE:return e.jsx(Z,{className:"h-4 w-4"});case d.COMPLETE:return e.jsx(_,{className:"h-4 w-4"});case d.CANCEL:return e.jsx(H,{className:"h-4 w-4"});case"payment_succeeded":return e.jsx(_,{className:"h-4 w-4 text-green-500"});case"payment_failed":return e.jsx(H,{className:"h-4 w-4 text-red-500"});case"certificate_generated":return e.jsx(me,{className:"h-4 w-4 text-blue-500"});case"email_sent":return e.jsx(R,{className:"h-4 w-4 text-blue-500"});default:return e.jsx(Be,{className:"h-4 w-4"})}};if(g)return e.jsx(X,{open:!0,onOpenChange:n,children:e.jsx(Y,{className:"w-full sm:w-[600px] sm:max-w-full overflow-y-auto",children:e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(D,{className:"h-10 w-10 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Chargement des détails du client..."})]})})});if(x||!N)return e.jsx(X,{open:!0,onOpenChange:n,children:e.jsxs(Y,{className:"w-full sm:w-[600px] sm:max-w-full overflow-y-auto",children:[e.jsx(ce,{className:"mb-6",children:e.jsx(de,{children:"Détails du client"})}),e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx("div",{className:"rounded-full bg-red-100 p-3 mb-4",children:e.jsx(H,{className:"h-6 w-6 text-red-600"})}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Erreur"}),e.jsx("p",{className:"text-muted-foreground text-center",children:x instanceof Error?x.message:"Une erreur est survenue lors de la récupération des détails du client."}),e.jsx(l,{onClick:n,className:"mt-6",children:"Fermer"})]})]})});const s=N;return e.jsxs(e.Fragment,{children:[e.jsx(X,{open:!0,onOpenChange:n,children:e.jsxs(Y,{className:"w-full sm:w-[600px] sm:max-w-full overflow-y-auto",children:[e.jsxs(ce,{className:"mb-1",children:[e.jsxs(de,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ue,{className:"mr-2 h-5 w-5 text-primary"}),"Détails du client"]}),e.jsx(Q,{className:`bg-${u(s.status)}-100 text-${u(s.status)}-800 hover:bg-${u(s.status)}-100`,children:e.jsxs("span",{className:"flex items-center",children:[C(s.status),e.jsx("span",{className:"ml-1",children:i(s.status)})]})})]}),e.jsx(Se,{children:e.jsxs("div",{className:"flex justify-between flex-wrap items-start",children:[e.jsxs("span",{children:["Référence: ",e.jsx("span",{className:"font-semibold",children:s.referenceNumber})]}),e.jsxs("span",{children:["Créée le: ",h(s.createdAt)]})]})})]}),e.jsx(Pe,{className:"my-4"}),e.jsxs("div",{className:"flex justify-end space-x-2 mb-4",children:[e.jsxs(l,{size:"sm",variant:"outline",onClick:()=>{const a=s.phone.replace(/\s/g,"");window.open(`tel:${a}`,"_blank")},children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"Appeler"]}),e.jsxs(l,{size:"sm",variant:"outline",onClick:()=>c(!0),children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Envoyer un email"]})]}),e.jsxs(he,{value:m,onValueChange:w,children:[e.jsxs(je,{className:"grid grid-cols-3 mb-4",children:[e.jsxs(G,{value:"info",children:[e.jsx(ue,{className:"h-4 w-4 mr-1"}),"Infos client"]}),e.jsxs(G,{value:"tech",children:[e.jsx(Oe,{className:"h-4 w-4 mr-1"}),"Infos techniques"]}),e.jsxs(G,{value:"history",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Historique"]})]}),e.jsxs(Ae,{className:"h-[calc(90vh-200px)]",children:[e.jsx(O,{value:"info",className:"mt-0",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx($,{className:"h-5 w-5 mr-2 text-blue-600"}),"Informations client"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Nom"}),e.jsx("span",{className:"font-medium",children:s.name})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Email"}),e.jsx("span",{className:"font-medium",children:s.email})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Téléphone"}),e.jsx("span",{className:"font-medium",children:s.phone})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type"}),e.jsx("span",{className:"font-medium",children:v(s.clientType)})]}),s.company&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Entreprise"}),e.jsx("span",{className:"font-medium",children:s.company})]}),s.siret&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"SIRET"}),e.jsx("span",{className:"font-medium",children:s.siret})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx(Ue,{className:"h-5 w-5 mr-2 text-red-500"}),"Adresse du site"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Adresse"}),e.jsx("span",{className:"font-medium",children:s.address})]}),s.addressComplement&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Complément"}),e.jsx("span",{className:"font-medium",children:s.addressComplement})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Ville"}),e.jsx("span",{className:"font-medium",children:s.city})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Code postal"}),e.jsx("span",{className:"font-medium",children:s.postalCode})]}),s.cadastralReference&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Référence cadastrale"}),e.jsx("span",{className:"font-medium",children:s.cadastralReference})]})]})]}),s.billingAddress&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx(B,{className:"h-5 w-5 mr-2 text-green-500"}),"Adresse de facturation"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Adresse"}),e.jsx("span",{className:"font-medium",children:s.billingAddress})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Ville"}),e.jsx("span",{className:"font-medium",children:s.billingCity})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Code postal"}),e.jsx("span",{className:"font-medium",children:s.billingPostalCode})]})]})]}),e.jsx(Je,{clientId:s.id,referenceNumber:s.referenceNumber,showTitle:!0})]})}),e.jsx(O,{value:"tech",className:"mt-0",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx(Qe,{className:"h-5 w-5 mr-2 text-amber-500"}),"Informations de la demande"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type de demande"}),e.jsx("span",{className:"font-medium",children:k(s.requestType)})]}),s.requestType==="other"&&s.otherRequestTypeDesc&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Précision"}),e.jsx("span",{className:"font-medium",children:s.otherRequestTypeDesc})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type de bâtiment"}),e.jsx("span",{className:"font-medium",children:E(s.buildingType)})]}),s.buildingType==="terrain"&&s.terrainViabilise&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"État du terrain"}),e.jsx("span",{className:"font-medium",children:s.terrainViabilise==="viabilise"?"Viabilisé":"Non viabilisé"})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx(B,{className:"h-5 w-5 mr-2 text-purple-500"}),"État du projet"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Statut"}),e.jsx("span",{className:"font-medium",children:t(s.projectStatus)})]}),s.permitNumber&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Numéro de permis"}),e.jsx("span",{className:"font-medium",children:s.permitNumber})]}),s.permitDeliveryDate&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Date de délivrance"}),e.jsx("span",{className:"font-medium",children:s.permitDeliveryDate})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx(B,{className:"h-5 w-5 mr-2 text-yellow-500"}),"Puissance"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Puissance demandée"}),e.jsxs("span",{className:"font-medium",children:[s.powerRequired," kVA"]})]}),s.phaseType&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type de phase"}),e.jsx("span",{className:"font-medium",children:j(s.phaseType)})]})]})]}),s.desiredCompletionDate&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx(Z,{className:"h-5 w-5 mr-2 text-blue-500"}),"Planning"]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Date souhaitée"}),e.jsx("span",{className:"font-medium",children:s.desiredCompletionDate})]})})]}),s.hasArchitect&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx($,{className:"h-5 w-5 mr-2 text-indigo-500"}),"Architecte"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[s.architectName&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Nom"}),e.jsx("span",{className:"font-medium",children:s.architectName})]}),s.architectPhone&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Téléphone"}),e.jsx("span",{className:"font-medium",children:s.architectPhone})]}),s.architectEmail&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Email"}),e.jsx("span",{className:"font-medium",children:s.architectEmail})]})]})]}),s.comments&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-2 flex items-center",children:[e.jsx(B,{className:"h-5 w-5 mr-2 text-gray-500"}),"Commentaires"]}),e.jsx("div",{className:"border rounded-md p-3",children:e.jsx("p",{className:"whitespace-pre-wrap",children:s.comments})})]})]})}),e.jsx(O,{value:"history",className:"mt-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(ee,{type:"single",collapsible:!0,defaultValue:"history",className:"mb-4",children:e.jsxs(se,{value:"history",children:[e.jsx(ae,{className:"py-2",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(oe,{className:"h-5 w-5 mr-2 text-blue-600"}),e.jsx("span",{children:"Historique des activités"})]})}),e.jsx(te,{children:b?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(D,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):!y||y.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:"Aucune activité enregistrée"}):e.jsx("div",{className:"space-y-3 py-2",children:y.map(a=>e.jsxs("div",{className:"relative border rounded-md p-3",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"rounded-full p-1.5 bg-blue-100 mr-2",children:I(a.action)}),e.jsx("span",{className:"font-medium",children:V(a.action)})]}),e.jsx(Q,{variant:"outline",children:h(a.createdAt)})]}),e.jsx("div",{className:"text-sm pl-7 text-muted-foreground",children:a.details}),a.ipAddress&&e.jsx("div",{className:"text-xs mt-2 text-muted-foreground flex items-center pl-7",children:e.jsxs("span",{children:["IP: ",a.ipAddress]})})]},a.id))})})]})}),e.jsx(ee,{type:"single",collapsible:!0,className:"mb-4",children:e.jsxs(se,{value:"payment",children:[e.jsx(ae,{className:"py-2",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(me,{className:"h-5 w-5 mr-2 text-green-600"}),e.jsx("span",{children:"Informations de paiement"})]})}),e.jsx(te,{children:e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Statut"}),e.jsx(Q,{variant:s.paymentStatus==="succeeded"?"default":s.paymentStatus==="failed"?"destructive":"outline",children:s.paymentStatus||"Non payé"})]}),s.paymentId&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"ID Transaction"}),e.jsx("span",{className:"font-medium font-mono text-sm",children:s.paymentId})]}),s.paymentMethod&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Méthode"}),e.jsx("span",{className:"font-medium",children:s.paymentMethod})]}),s.paymentDate&&e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Date"}),e.jsx("span",{className:"font-medium",children:h(s.paymentDate)})]}),e.jsxs("div",{className:"flex justify-between py-1 border-b",children:[e.jsx("span",{className:"text-muted-foreground",children:"Montant"}),e.jsx("span",{className:"font-medium",children:"129,80 € TTC"})]})]})})]})}),s.notes&&e.jsx(ee,{type:"single",collapsible:!0,className:"mb-4",children:e.jsxs(se,{value:"notes",children:[e.jsx(ae,{className:"py-2",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(T,{className:"h-5 w-5 mr-2 text-amber-600"}),e.jsx("span",{children:"Notes internes"})]})}),e.jsx(te,{children:e.jsx("div",{className:"p-3 border rounded-md whitespace-pre-wrap",children:s.notes})})]})})]})})]})]})]})}),o&&e.jsx(fe,{clientEmail:s.email,clientName:s.name,referenceNumber:s.referenceNumber,isOpen:o,onClose:()=>c(!1)})]})}function Ls(){var v,k,E;const{toast:f}=J(),[n,m]=p.useState(""),[w,o]=p.useState(null),[c,N]=p.useState(!1),[g,x]=p.useState(null),{data:y,isLoading:b,error:C}=U({queryKey:["/api/service-requests"],queryFn:De({on401:"throw"})}),i=t=>{o(t)},u=t=>{x(t),N(!0)},h=t=>{window.location.href=`tel:${t}`,f({title:"Appel en cours",description:`Appel vers ${t}`})},j=y?y.map(t=>({id:t.id,name:t.name||"Client sans nom",email:t.email,phone:t.phone,companyName:t.company||null,status:t.status,referenceNumber:t.referenceNumber,createdAt:new Date(t.createdAt).toISOString()})).filter(t=>n===""||t.name.toLowerCase().includes(n.toLowerCase())||t.email.toLowerCase().includes(n.toLowerCase())||t.companyName&&t.companyName.toLowerCase().includes(n.toLowerCase())||t.referenceNumber.toLowerCase().includes(n.toLowerCase())):[];return e.jsxs(Le,{title:"Clients",description:"Gestion des clients et prospects",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Gestion des clients"})}),e.jsxs("p",{className:"text-muted-foreground",children:[j.length," client",j.length!==1?"s":""," au total"]})]}),e.jsxs("div",{className:"flex w-full sm:w-auto items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ke,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(K,{type:"search",placeholder:"Rechercher un client...",className:"pl-8 w-full sm:w-[300px]",value:n,onChange:t=>m(t.target.value)})]}),e.jsxs(l,{variant:"default",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Nouveau client"]})]})]}),b?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(D,{className:"h-8 w-8 animate-spin text-blue-600"})}):C?e.jsx(A,{children:e.jsxs(L,{className:"py-10 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"Une erreur est survenue lors du chargement des clients."}),e.jsx(l,{variant:"outline",size:"sm",className:"mt-4",children:"Réessayer"})]})}):j.length===0?e.jsx(A,{children:e.jsxs(L,{className:"py-10 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Aucun client trouvé."}),n&&e.jsx(l,{variant:"outline",size:"sm",onClick:()=>m(""),children:"Effacer la recherche"})]})}):e.jsxs(A,{children:[e.jsxs(q,{className:"pb-1",children:[e.jsx(M,{children:"Liste des clients"}),e.jsx(z,{children:"Consultez et gérez tous vos clients"})]}),e.jsx(L,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left py-3 px-2 font-medium",children:"Client"}),e.jsx("th",{className:"text-left py-3 px-2 font-medium",children:"Contact"}),e.jsx("th",{className:"text-left py-3 px-2 font-medium",children:"Référence"}),e.jsx("th",{className:"text-left py-3 px-2 font-medium",children:"Statut"}),e.jsx("th",{className:"text-left py-3 px-2 font-medium",children:"Date"}),e.jsx("th",{className:"text-right py-3 px-2 font-medium",children:"Actions"})]})}),e.jsx("tbody",{children:j.map(t=>{const I=new Date(t.createdAt).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"});let s="default",a="";switch(t.status){case"new":s="default",a="Nouveau";break;case"pending":s="outline",a="En attente";break;case"in_progress":s="secondary",a="En cours";break;case"validated":s="default",a="Validé";break;case"scheduled":s="default",a="Planifié";break;case"completed":s="default",a="Terminé";break;case"cancelled":s="destructive",a="Annulé";break;default:s="outline",a=t.status}return e.jsxs("tr",{className:"border-b hover:bg-muted/50",children:[e.jsxs("td",{className:"py-3 px-2",children:[e.jsx("div",{className:"font-medium",children:t.name}),t.companyName&&e.jsx("div",{className:"text-xs text-muted-foreground",children:t.companyName})]}),e.jsxs("td",{className:"py-3 px-2",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:t.email})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground mt-1",children:[e.jsx(re,{className:"h-3 w-3"}),e.jsx("span",{children:t.phone})]})]}),e.jsx("td",{className:"py-3 px-2",children:e.jsx("div",{className:"font-mono text-xs",children:t.referenceNumber})}),e.jsx("td",{className:"py-3 px-2",children:e.jsx(Q,{variant:s,children:a})}),e.jsx("td",{className:"py-3 px-2 text-muted-foreground text-xs",children:I}),e.jsx("td",{className:"py-3 px-2 text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"ghost",size:"icon",title:"Voir les détails",onClick:()=>i(t.id),children:e.jsx(T,{className:"h-4 w-4"})}),e.jsx(l,{variant:"ghost",size:"icon",title:"Envoyer un email",onClick:()=>u(t.id),children:e.jsx(R,{className:"h-4 w-4"})}),e.jsx(l,{variant:"ghost",size:"icon",title:"Appeler",onClick:()=>h(t.phone),children:e.jsx(re,{className:"h-4 w-4"})})]})})]},t.id)})})]})})})]})]}),w&&e.jsx(Xe,{clientId:w,onClose:()=>o(null)}),c&&g&&e.jsx(fe,{clientEmail:((v=j.find(t=>t.id===g))==null?void 0:v.email)||"",clientName:((k=j.find(t=>t.id===g))==null?void 0:k.name)||"",referenceNumber:((E=j.find(t=>t.id===g))==null?void 0:E.referenceNumber)||"",isOpen:c,onClose:()=>{N(!1),x(null)}})]})}export{Ls as default};
