var me=t=>{throw TypeError(t)};var X=(t,e,s)=>e.has(t)||me("Cannot "+s);var r=(t,e,s)=>(X(t,e,"read from private field"),s?s.call(t):e.get(t)),S=(t,e,s)=>e.has(t)?me("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),d=(t,e,s,n)=>(X(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s),m=(t,e,s)=>(X(t,e,"access private method"),s);import{ad as Oe,ae as ge,af as I,ag as ee,ah as H,ai as te,aj as se,ak as Se,al as ke,am as J,an as xe,ao as De,ap as ve,aq as Te,r as C,ar as Ue,as as Me,c as Qe,a as _e,e as Z,at as W,l as ye}from"./index-BZibFF0G.js";var y,a,$,v,x,Q,w,O,B,_,F,D,U,k,P,h,j,re,ie,ne,oe,ae,ce,le,Ce,Ie,Fe=(Ie=class extends Oe{constructor(e,s){super();S(this,h);S(this,y);S(this,a);S(this,$);S(this,v);S(this,x);S(this,Q);S(this,w);S(this,O);S(this,B);S(this,_);S(this,F);S(this,D);S(this,U);S(this,k);S(this,P,new Set);this.options=s,d(this,y,e),d(this,O,null),d(this,w,ge()),this.bindMethods(),this.setOptions(s)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(r(this,a).addObserver(this),be(r(this,a),this.options)?m(this,h,j).call(this):this.updateResult(),m(this,h,oe).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return ue(r(this,a),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return ue(r(this,a),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,m(this,h,ae).call(this),m(this,h,ce).call(this),r(this,a).removeObserver(this)}setOptions(e){const s=this.options,n=r(this,a);if(this.options=r(this,y).defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof I(this.options.enabled,r(this,a))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");m(this,h,le).call(this),r(this,a).setOptions(this.options),s._defaulted&&!ee(this.options,s)&&r(this,y).getQueryCache().notify({type:"observerOptionsUpdated",query:r(this,a),observer:this});const c=this.hasListeners();c&&Re(r(this,a),n,this.options,s)&&m(this,h,j).call(this),this.updateResult(),c&&(r(this,a)!==n||I(this.options.enabled,r(this,a))!==I(s.enabled,r(this,a))||H(this.options.staleTime,r(this,a))!==H(s.staleTime,r(this,a)))&&m(this,h,re).call(this);const l=m(this,h,ie).call(this);c&&(r(this,a)!==n||I(this.options.enabled,r(this,a))!==I(s.enabled,r(this,a))||l!==r(this,k))&&m(this,h,ne).call(this,l)}getOptimisticResult(e){const s=r(this,y).getQueryCache().build(r(this,y),e),n=this.createResult(s,e);return Ae(this,n)&&(d(this,v,n),d(this,Q,this.options),d(this,x,r(this,a).state)),n}getCurrentResult(){return r(this,v)}trackResult(e,s){return new Proxy(e,{get:(n,c)=>(this.trackProp(c),s==null||s(c),c==="promise"&&!this.options.experimental_prefetchInRender&&r(this,w).status==="pending"&&r(this,w).reject(new Error("experimental_prefetchInRender feature flag is not enabled")),Reflect.get(n,c))})}trackProp(e){r(this,P).add(e)}getCurrentQuery(){return r(this,a)}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const s=r(this,y).defaultQueryOptions(e),n=r(this,y).getQueryCache().build(r(this,y),s);return n.fetch().then(()=>this.createResult(n,s))}fetch(e){return m(this,h,j).call(this,{...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),r(this,v)))}createResult(e,s){var pe;const n=r(this,a),c=this.options,l=r(this,v),u=r(this,x),b=r(this,Q),o=e!==n?e.state:r(this,$),{state:f}=e;let p={...f},A=!1,g;if(s._optimisticResults){const E=this.hasListeners(),V=!E&&be(e,s),M=E&&Re(e,n,s,c);(V||M)&&(p={...p,...De(f.data,e.options)}),s._optimisticResults==="isRestoring"&&(p.fetchStatus="idle")}let{error:L,errorUpdatedAt:N,status:R}=p;g=p.data;let z=!1;if(s.placeholderData!==void 0&&g===void 0&&R==="pending"){let E;l!=null&&l.isPlaceholderData&&s.placeholderData===(b==null?void 0:b.placeholderData)?(E=l.data,z=!0):E=typeof s.placeholderData=="function"?s.placeholderData((pe=r(this,F))==null?void 0:pe.state.data,r(this,F)):s.placeholderData,E!==void 0&&(R="success",g=ve(l==null?void 0:l.data,E,s),A=!0)}if(s.select&&g!==void 0&&!z)if(l&&g===(u==null?void 0:u.data)&&s.select===r(this,B))g=r(this,_);else try{d(this,B,s.select),g=s.select(g),g=ve(l==null?void 0:l.data,g,s),d(this,_,g),d(this,O,null)}catch(E){d(this,O,E)}r(this,O)&&(L=r(this,O),g=r(this,_),N=Date.now(),R="error");const G=p.fetchStatus==="fetching",K=R==="pending",Y=R==="error",de=K&&G,fe=g!==void 0,T={status:R,fetchStatus:p.fetchStatus,isPending:K,isSuccess:R==="success",isError:Y,isInitialLoading:de,isLoading:de,data:g,dataUpdatedAt:p.dataUpdatedAt,error:L,errorUpdatedAt:N,failureCount:p.fetchFailureCount,failureReason:p.fetchFailureReason,errorUpdateCount:p.errorUpdateCount,isFetched:p.dataUpdateCount>0||p.errorUpdateCount>0,isFetchedAfterMount:p.dataUpdateCount>o.dataUpdateCount||p.errorUpdateCount>o.errorUpdateCount,isFetching:G,isRefetching:G&&!K,isLoadingError:Y&&!fe,isPaused:p.fetchStatus==="paused",isPlaceholderData:A,isRefetchError:Y&&fe,isStale:he(e,s),refetch:this.refetch,promise:r(this,w),isEnabled:I(s.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){const E=q=>{T.status==="error"?q.reject(T.error):T.data!==void 0&&q.resolve(T.data)},V=()=>{const q=d(this,w,T.promise=ge());E(q)},M=r(this,w);switch(M.status){case"pending":e.queryHash===n.queryHash&&E(M);break;case"fulfilled":(T.status==="error"||T.data!==M.value)&&V();break;case"rejected":(T.status!=="error"||T.error!==M.reason)&&V();break}}return T}updateResult(){const e=r(this,v),s=this.createResult(r(this,a),this.options);if(d(this,x,r(this,a).state),d(this,Q,this.options),r(this,x).data!==void 0&&d(this,F,r(this,a)),ee(s,e))return;d(this,v,s);const n=()=>{if(!e)return!0;const{notifyOnChangeProps:c}=this.options,l=typeof c=="function"?c():c;if(l==="all"||!l&&!r(this,P).size)return!0;const u=new Set(l??r(this,P));return this.options.throwOnError&&u.add("error"),Object.keys(r(this,v)).some(b=>{const i=b;return r(this,v)[i]!==e[i]&&u.has(i)})};m(this,h,Ce).call(this,{listeners:n()})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&m(this,h,oe).call(this)}},y=new WeakMap,a=new WeakMap,$=new WeakMap,v=new WeakMap,x=new WeakMap,Q=new WeakMap,w=new WeakMap,O=new WeakMap,B=new WeakMap,_=new WeakMap,F=new WeakMap,D=new WeakMap,U=new WeakMap,k=new WeakMap,P=new WeakMap,h=new WeakSet,j=function(e){m(this,h,le).call(this);let s=r(this,a).fetch(this.options,e);return e!=null&&e.throwOnError||(s=s.catch(te)),s},re=function(){m(this,h,ae).call(this);const e=H(this.options.staleTime,r(this,a));if(se||r(this,v).isStale||!Se(e))return;const n=ke(r(this,v).dataUpdatedAt,e)+1;d(this,D,J.setTimeout(()=>{r(this,v).isStale||this.updateResult()},n))},ie=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(r(this,a)):this.options.refetchInterval)??!1},ne=function(e){m(this,h,ce).call(this),d(this,k,e),!(se||I(this.options.enabled,r(this,a))===!1||!Se(r(this,k))||r(this,k)===0)&&d(this,U,J.setInterval(()=>{(this.options.refetchIntervalInBackground||xe.isFocused())&&m(this,h,j).call(this)},r(this,k)))},oe=function(){m(this,h,re).call(this),m(this,h,ne).call(this,m(this,h,ie).call(this))},ae=function(){r(this,D)&&(J.clearTimeout(r(this,D)),d(this,D,void 0))},ce=function(){r(this,U)&&(J.clearInterval(r(this,U)),d(this,U,void 0))},le=function(){const e=r(this,y).getQueryCache().build(r(this,y),this.options);if(e===r(this,a))return;const s=r(this,a);d(this,a,e),d(this,$,e.state),this.hasListeners()&&(s==null||s.removeObserver(this),e.addObserver(this))},Ce=function(e){Te.batch(()=>{e.listeners&&this.listeners.forEach(s=>{s(r(this,v))}),r(this,y).getQueryCache().notify({query:r(this,a),type:"observerResultsUpdated"})})},Ie);function Pe(t,e){return I(e.enabled,t)!==!1&&t.state.data===void 0&&!(t.state.status==="error"&&e.retryOnMount===!1)}function be(t,e){return Pe(t,e)||t.state.data!==void 0&&ue(t,e,e.refetchOnMount)}function ue(t,e,s){if(I(e.enabled,t)!==!1&&H(e.staleTime,t)!=="static"){const n=typeof s=="function"?s(t):s;return n==="always"||n!==!1&&he(t,e)}return!1}function Re(t,e,s,n){return(t!==e||I(n.enabled,t)===!1)&&(!s.suspense||t.state.status!=="error")&&he(t,s)}function he(t,e){return I(e.enabled,t)!==!1&&t.isStaleByTime(H(e.staleTime,t))}function Ae(t,e){return!ee(t.getCurrentResult(),e)}var we=C.createContext(!1),Le=()=>C.useContext(we);we.Provider;function Ne(){let t=!1;return{clearReset:()=>{t=!1},reset:()=>{t=!0},isReset:()=>t}}var je=C.createContext(Ne()),He=()=>C.useContext(je),$e=(t,e)=>{(t.suspense||t.throwOnError||t.experimental_prefetchInRender)&&(e.isReset()||(t.retryOnMount=!1))},Be=t=>{C.useEffect(()=>{t.clearReset()},[t])},ze=({result:t,errorResetBoundary:e,throwOnError:s,query:n,suspense:c})=>t.isError&&!e.isReset()&&!t.isFetching&&n&&(c&&t.data===void 0||Ue(s,[t.error,n])),Ve=t=>{if(t.suspense){const s=c=>c==="static"?c:Math.max(c??1e3,1e3),n=t.staleTime;t.staleTime=typeof n=="function"?(...c)=>s(n(...c)):s(n),typeof t.gcTime=="number"&&(t.gcTime=Math.max(t.gcTime,1e3))}},qe=(t,e)=>t.isLoading&&t.isFetching&&!e,Je=(t,e)=>(t==null?void 0:t.suspense)&&e.isPending,Ee=(t,e,s)=>e.fetchOptimistic(t).catch(()=>{s.clearReset()});function We(t,e,s){var p,A,g,L,N;const n=Le(),c=He(),l=Me(),u=l.defaultQueryOptions(t);(A=(p=l.getDefaultOptions().queries)==null?void 0:p._experimental_beforeQuery)==null||A.call(p,u),u._optimisticResults=n?"isRestoring":"optimistic",Ve(u),$e(u,c),Be(c);const b=!l.getQueryCache().get(u.queryHash),[i]=C.useState(()=>new e(l,u)),o=i.getOptimisticResult(u),f=!n&&t.subscribed!==!1;if(C.useSyncExternalStore(C.useCallback(R=>{const z=f?i.subscribe(Te.batchCalls(R)):te;return i.updateResult(),z},[i,f]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),C.useEffect(()=>{i.setOptions(u)},[u,i]),Je(u,o))throw Ee(u,i,c);if(ze({result:o,errorResetBoundary:c,throwOnError:u.throwOnError,query:l.getQueryCache().get(u.queryHash),suspense:u.suspense}))throw o.error;if((L=(g=l.getDefaultOptions().queries)==null?void 0:g._experimental_afterQuery)==null||L.call(g,u,o),u.experimental_prefetchInRender&&!se&&qe(o,n)){const R=b?Ee(u,i,c):(N=l.getQueryCache().get(u.queryHash))==null?void 0:N.promise;R==null||R.catch(te).finally(()=>{i.updateResult()})}return u.notifyOnChangeProps?o:i.trackResult(o)}function Ge(t,e){return We(t,Fe)}/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=Qe("Sparkles",[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]]),Ke=async()=>{try{const t=localStorage.getItem("adminToken");if(!t)return console.log("fetchUser - Pas de token, utilisateur non authentifié"),localStorage.removeItem("adminUser"),sessionStorage.clear(),null;const e=localStorage.getItem("adminUser"),s=localStorage.getItem("lastAuthCheck"),n=new Date().getTime(),c=s?parseInt(s):0,l=n-c,u=15*60*1e3;if(e&&l<u)try{const f=JSON.parse(e);if(f&&f.id&&f.username&&f.role)return console.log(`fetchUser - Utilisation des données en cache (${Math.round(l/1e3)}s)`),{...f}}catch(f){console.error("Erreur lors de la lecture du cache:",f)}const b=new Date().getTime();console.log(`fetchUser - Requête directe au serveur avec timestamp: ${b}`);const i=await fetch(`/api/user?_t=${b}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(!i.ok){if(i.status===401)return console.log("fetchUser - Token invalide (401), nettoyage des données locales"),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),sessionStorage.clear(),null;throw console.error(`Échec de récupération des données utilisateur - Statut HTTP: ${i.status}`),new Error(`Échec de récupération des données utilisateur - Statut: ${i.status}`)}const o=await i.json();return console.log(`fetchUser - Utilisateur récupéré du serveur au timestamp ${b}`),!o||typeof o!="object"?(console.error("Données utilisateur invalides (format incorrect)",o),null):!o.id||!o.username||!o.role?(console.error("Données utilisateur incomplètes",o),null):(localStorage.setItem("adminUser",JSON.stringify(o)),localStorage.setItem("lastAuthCheck",n.toString()),console.log(`Utilisateur mis à jour en cache: ${o.username} (${o.role})`),{...o})}catch(t){return console.error("Erreur lors de la récupération de l'utilisateur:",t),null}};function tt(){const{toast:t}=_e(),{data:e,error:s,isLoading:n,refetch:c}=Ge({queryKey:["/api/user"],queryFn:Ke,staleTime:5*60*1e3,gcTime:20*60*1e3,refetchInterval:10*60*1e3,refetchOnMount:!1,refetchOnWindowFocus:!1});C.useEffect(()=>{const i=setTimeout(()=>{console.log("useAuth - Refetch forcé des données utilisateur"),c()},100);return()=>clearTimeout(i)},[c]);const l=Z({mutationFn:async i=>{try{localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),console.log("Tentative de connexion pour:",i.username);const o=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),credentials:"include"}),f=await o.json();if(!o.ok)throw new Error(f.message||"Échec de connexion");return console.log("Réponse de connexion complète:",f),f.token&&(localStorage.setItem("adminToken",f.token),console.log("Token stocké:",f.token)),f}catch(o){throw console.error("Erreur de connexion:",o),o}},onSuccess:i=>{if(!i.user||!i.user.id||!i.user.role){console.error("Données utilisateur invalides reçues:",i),t({title:"Erreur d'authentification",description:"Données utilisateur invalides. Veuillez réessayer.",variant:"destructive"});return}console.log("Connexion réussie - NETTOYAGE RADICAL avant affichage de l'interface de",i.user.username),localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(function(o){document.cookie=o.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),W.clear(),localStorage.setItem("adminToken",i.token),localStorage.setItem("adminUser",JSON.stringify(i.user)),localStorage.setItem("lastLoginTime",new Date().toString()),localStorage.setItem("userRole",i.user.role),localStorage.setItem("userId",i.user.id.toString()),t({title:"Connexion réussie",description:`Bienvenue, ${i.user.fullName||i.user.username}! Chargement de votre interface...`}),setTimeout(()=>{console.log("HARD RELOAD complet du navigateur..."),window.location.href="/admin/dashboard?t="+new Date().getTime()},800)},onError:i=>{t({title:"Erreur de connexion",description:i.message,variant:"destructive"})}}),u=Z({mutationFn:async i=>{const o=await ye("POST","/api/register",i);if(!o.ok){const f=await o.json();throw new Error(f.message||"Échec d'inscription")}return await o.json()},onSuccess:i=>{W.setQueryData(["/api/user"],i),t({title:"Inscription réussie",description:"Votre compte a été créé avec succès !"})},onError:i=>{t({title:"Erreur d'inscription",description:i.message,variant:"destructive"})}}),b=Z({mutationFn:async()=>{if(console.log("Début du processus de déconnexion"),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),W.setQueryData(["/api/user"],null),!(await ye("POST","/api/logout")).ok)throw new Error("Échec de déconnexion")},onSuccess:()=>{console.log("Déconnexion - Nettoyage complet des données en cours..."),W.clear(),localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(function(i){document.cookie=i.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),console.log("Déconnexion effectuée - Données utilisateur supprimées"),t({title:"Déconnexion réussie",description:"Vous êtes maintenant déconnecté."}),setTimeout(()=>{console.log("Redirection vers la page d'authentification..."),window.location.href="/admin"},500)},onError:i=>{t({title:"Erreur de déconnexion",description:i.message,variant:"destructive"})}});return{user:e??null,isLoading:n,error:s,loginMutation:l,logoutMutation:b,registerMutation:u}}export{et as S,Ge as a,tt as u};
