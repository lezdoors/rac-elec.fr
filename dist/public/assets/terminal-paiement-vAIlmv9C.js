import{a as ve,r,e as P,j as e,G as j,B as o,I as u,L as N,J as T,O as E,K as k,o as Ne,T as ge,W as ye,Y as Ce,Z as be,a2 as we,a4 as Se,l as R,a9 as S,aK as De}from"./index-InhjyHm0.js";import{A as Le}from"./admin-layout-BW0ipa1H.js";import{C as Fe,a as Pe,b as Te,c as Ee,d as ke,e as Re}from"./card-B7tkKAo4.js";import{u as ze}from"./useQuery-DOSQnzDT.js";import{T as Ie,a as Me,b as H,c as J}from"./tabs-BN4xMOjO.js";import{S as Ve}from"./search-BZH_6Opu.js";import{C as W}from"./credit-card-CgH8BP2W.js";import{E as z}from"./external-link-CdoSiPTs.js";import{R as qe}from"./refresh-cw-BIiAX5XA.js";import{C as Ae}from"./circle-x-Cb6a1TMf.js";import"./use-auth-PLHI6dmw.js";import"./badge-DMUusXD1.js";import"./use-mobile-CSsiiRqa.js";import"./index-CLRojjno.js";import"./log-out-D9CJfHdP.js";import"./file-text-BwcVwm3e.js";import"./users-Bru_dOIy.js";import"./settings-CKsDs99O.js";import"./index-Bqs1_l0U.js";import"./index-BzlsJDoI.js";import"./separator-uZDxqRbz.js";function lt(){const{toast:s}=ve(),[X,D]=r.useState(""),[I,Z]=r.useState(""),[g,M]=r.useState(""),[y,V]=r.useState(""),[f,q]=r.useState(""),[C,A]=r.useState(""),[p,_]=r.useState(129.8),[Y,b]=r.useState(!1),[i,Q]=r.useState(null),[L,ee]=r.useState("manual"),[d,$]=r.useState(null),[te,ae]=r.useState(null),[K,F]=r.useState(!1),[n,h]=r.useState(!1),[l,v]=r.useState(!1),[se,x]=r.useState(!1),[w,O]=r.useState(""),{data:re=[],isLoading:ne}=ze({queryKey:["/api/service-requests-unpaid"],queryFn:De({on401:"throw"}),enabled:Y});r.useEffect(()=>{new URLSearchParams(window.location.search).get("canceled")==="true"&&(s({title:"Paiement annulé",description:"Le paiement a été annulé ou abandonné par le client.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname))},[s]);const ie=P({mutationFn:async t=>{const a=await R("POST","/api/create-payment-terminal-session",t);if(!a.ok){const c=await a.json();throw new Error(c.message||"Erreur lors de la création du terminal de paiement")}return a.json()},onSuccess:t=>{h(!1),$(t.checkoutUrl),O(t.paymentId),s({title:"Terminal prêt",description:`Terminal de paiement créé pour ${p.toFixed(2).replace(".",",")}€. Cliquez sur le lien pour procéder au paiement.`,variant:"default"})},onError:t=>{h(!1),x(!0),s({title:"Échec de la création du terminal",description:t.message,variant:"destructive"})}}),le=P({mutationFn:async t=>{const a=await R("GET",`/api/payment-terminal-status/${t}`);if(!a.ok){const c=await a.json();throw new Error(c.message||"Erreur lors de la vérification du paiement")}return a.json()},onSuccess:t=>{var a;F(!1),ae(t.status),t.status==="succeeded"?(v(!0),s({title:"Paiement confirmé",description:`Le paiement de ${(a=t.amount)==null?void 0:a.toFixed(2).replace(".",",")}€ a été traité avec succès.`,variant:"default"}),S.invalidateQueries({queryKey:["/api/service-requests"]}),S.invalidateQueries({queryKey:["/api/service-requests-unpaid"]}),S.invalidateQueries({queryKey:["/api/payments/recent"]}),S.invalidateQueries({queryKey:["/api/payments/stats"]})):t.status==="canceled"?(x(!0),s({title:"Paiement annulé",description:"Le paiement a été annulé.",variant:"destructive"})):s({title:"Paiement en attente",description:`Le paiement est en statut: ${t.status}. Vérifiez à nouveau plus tard.`,variant:"default"})},onError:t=>{F(!1),s({title:"Erreur de vérification",description:t.message,variant:"destructive"})}}),ce=P({mutationFn:async t=>{const a=await R("POST","/api/process-manual-payment",t);if(!a.ok){const c=await a.json();throw new Error(c.message||"Erreur lors du traitement du paiement")}return a.json()},onSuccess:t=>{h(!1),v(!0),O(t.paymentId),s({title:"Paiement réussi",description:`Le paiement de ${p.toFixed(2).replace(".",",")}€ a été traité avec succès. ID de transaction: ${t.paymentId}`,variant:"default"})},onError:t=>{h(!1),x(!0),s({title:"Échec du paiement",description:t.message,variant:"destructive"})}}),oe=t=>{const a=t.replace(/\D/g,""),c=[];for(let m=0;m<a.length;m+=4)c.push(a.slice(m,m+4));return c.join(" ")},de=t=>{const a=t.replace(/\D/g,"");return a.length<=2?a:a.slice(0,2)+"/"+a.slice(2,4)},me=()=>{if(!i){s({title:"Erreur",description:"Veuillez sélectionner une demande de service",variant:"destructive"});return}if(!g||!y||!f||!C){s({title:"Formulaire incomplet",description:"Veuillez remplir tous les champs du formulaire de paiement",variant:"destructive"});return}const t=g.replace(/\D/g,"");if(t.length<16){s({title:"Numéro de carte invalide",description:"Le numéro de carte doit comporter au moins 16 chiffres",variant:"destructive"});return}const a=y.split("/");if(a.length!==2||a[0].length!==2||a[1].length!==2){s({title:"Date d'expiration invalide",description:"La date d'expiration doit être au format MM/YY",variant:"destructive"});return}const c=parseInt(a[0],10),m=parseInt(`20${a[1]}`,10),B=new Date,je=B.getMonth()+1,G=B.getFullYear();if(m<G||m===G&&c<je){s({title:"Carte expirée",description:"La date d'expiration de la carte est dépassée. Veuillez utiliser une carte valide.",variant:"destructive"});return}if(f.length<3){s({title:"CVC invalide",description:"Le code de sécurité (CVC) doit comporter au moins 3 chiffres",variant:"destructive"});return}h(!0),v(!1),x(!1);const fe={referenceNumber:i.referenceNumber,cardNumber:t,cardExpMonth:parseInt(a[0]),cardExpYear:parseInt(`20${a[1]}`),cardCvc:f,cardholderName:C,amount:p,serviceRequestId:i.id};ce.mutate(fe)},ue=()=>{if(!i){s({title:"Erreur",description:"Veuillez sélectionner une demande de service",variant:"destructive"});return}h(!0),v(!1),x(!1),$(null);const t={referenceNumber:i.referenceNumber,amount:p,serviceRequestId:i.id};ie.mutate(t)},pe=()=>{if(!w){s({title:"Erreur",description:"Aucun paiement en cours",variant:"destructive"});return}F(!0),le.mutate(w)},U=re.filter(t=>{const a=I.toLowerCase();return t.referenceNumber.toLowerCase().includes(a)||t.name.toLowerCase().includes(a)||t.email.toLowerCase().includes(a)||t.phone.toLowerCase().includes(a)}),he=t=>{Q(t),D(t.referenceNumber),b(!1)},xe=()=>{M(""),V(""),q(""),A(""),D(""),Q(null),v(!1),x(!1)};return e.jsxs(Le,{title:"Terminal de paiement",description:"Traitez les paiements par téléphone ou en personne",children:[e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs(Fe,{className:"mb-4",children:[e.jsxs(Pe,{children:[e.jsx(Te,{children:"Terminal de paiement virtuel"}),e.jsx(Ee,{children:"Utilisez ce terminal pour traiter les paiements par téléphone ou en personne. Vos clients peuvent vous communiquer leurs informations de carte bancaire par téléphone."})]}),e.jsxs(ke,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(j,{htmlFor:"reference",children:"Référence de la demande"}),e.jsxs(o,{type:"button",variant:"ghost",size:"sm",onClick:()=>b(!0),children:[e.jsx(Ve,{className:"w-4 h-4 mr-2"}),"Rechercher"]})]}),e.jsx(u,{id:"reference",placeholder:"ex: RAC-2025-0602-143045-742",value:X,onChange:t=>D(t.target.value),disabled:n||l,className:"font-mono"}),i&&e.jsxs("div",{className:"text-sm text-gray-700 bg-gray-50 p-2 rounded",children:["Client: ",i.name," • ",i.email," • ",i.phone]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"amount",children:"Montant (€)"}),e.jsx(u,{id:"amount",type:"number",value:p.toFixed(2),step:"0.01",min:"0",placeholder:"Entrez le montant",className:"font-bold",disabled:n||l,onChange:t=>{const a=parseFloat(t.target.value);isNaN(a)||_(parseFloat(a.toFixed(2)))}})]}),e.jsxs(Ie,{defaultValue:L,value:L,onValueChange:t=>ee(t),className:"w-full",children:[e.jsxs(Me,{className:"grid w-full grid-cols-2",children:[e.jsxs(H,{value:"manual",disabled:n||l,children:[e.jsx(W,{className:"w-4 h-4 mr-2"}),"Saisie manuelle"]}),e.jsxs(H,{value:"terminal",disabled:n||l,children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Terminal Stripe"]})]}),e.jsxs(J,{value:"manual",className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardNumber",children:"Numéro de carte"}),e.jsxs("div",{className:"relative",children:[e.jsx(u,{id:"cardNumber",placeholder:"1234 5678 9012 3456",value:g,onChange:t=>M(oe(t.target.value)),disabled:n||l,maxLength:19,className:"font-mono"}),e.jsx(W,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardExpiry",children:"Date d'expiration"}),e.jsx(u,{id:"cardExpiry",placeholder:"MM/YY",value:y,onChange:t=>V(de(t.target.value)),disabled:n||l,maxLength:5,className:"font-mono"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardCvc",children:"CVC"}),e.jsx(u,{id:"cardCvc",placeholder:"123",value:f,onChange:t=>{const a=t.target.value.replace(/\D/g,"");q(a.slice(0,4))},disabled:n||l,maxLength:4,className:"font-mono"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardholderName",children:"Nom du titulaire"}),e.jsx(u,{id:"cardholderName",placeholder:"Jean Dupont",value:C,onChange:t=>A(t.target.value),disabled:n||l})]})]}),e.jsx(J,{value:"terminal",className:"mt-4 space-y-4",children:e.jsxs("div",{className:"bg-gray-50 p-4 rounded-md border",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Terminal de paiement Stripe"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Ce mode crée un terminal de paiement Stripe sécurisé que vous pouvez partager avec votre client. Il pourra entrer ses informations bancaires directement sur la page Stripe."}),d&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center mb-2 text-sm font-medium text-blue-600",children:e.jsx("span",{children:"URL du terminal:"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",readOnly:!0,value:d,className:"flex-1 p-2 text-sm font-mono bg-white border rounded",onClick:t=>t.target.select()}),e.jsx(o,{size:"sm",variant:"outline",onClick:()=>{d&&window.open(d,"_blank")},children:e.jsx(z,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Status: ",te||"En attente de paiement"]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:pe,disabled:K||!w,children:[K?e.jsx(N,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(qe,{className:"h-4 w-4 mr-2"}),"Vérifier le statut"]})]})]})]})})]}),n&&!d&&e.jsxs(T,{children:[e.jsx(N,{className:"h-4 w-4 animate-spin mr-2"}),e.jsx(E,{children:"Traitement en cours"}),e.jsx(k,{children:"Veuillez patienter pendant que nous préparons votre paiement..."})]}),l&&e.jsxs(T,{className:"bg-green-50 border-green-200 text-green-800",children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),e.jsx(E,{children:"Paiement réussi!"}),e.jsxs(k,{children:["Le paiement de ",p.toFixed(2).replace(".",","),"€ a été traité avec succès. ID de transaction: ",w]})]}),se&&e.jsxs(T,{variant:"destructive",children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),e.jsx(E,{children:"Échec du paiement"}),e.jsx(k,{children:"Le paiement a échoué. Veuillez vérifier les informations et réessayer."})]})]}),e.jsxs(Re,{className:"flex justify-between",children:[e.jsx(o,{variant:"outline",onClick:xe,disabled:n,children:"Réinitialiser"}),L==="manual"?e.jsx(o,{onClick:me,disabled:n||!i||l||!g||!y||!f||!C,children:n?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Traitement..."]}):"Traiter le paiement manuel"}):e.jsx(o,{onClick:ue,disabled:n||!i||l,children:n&&!d?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Préparation..."]}):d?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"Ouvrir le terminal"]}):"Créer un terminal de paiement"})]})]})}),e.jsx(ge,{open:Y,onOpenChange:b,children:e.jsxs(ye,{className:"max-w-3xl",children:[e.jsxs(Ce,{children:[e.jsx(be,{children:"Sélectionner une demande"}),e.jsx(we,{children:"Recherchez et sélectionnez une demande pour traiter le paiement"})]}),e.jsxs("div",{className:"my-4",children:[e.jsx(u,{placeholder:"Rechercher par référence, nom, email ou téléphone...",value:I,onChange:t=>Z(t.target.value),className:"mb-4"}),e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-100 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 px-4 text-left",children:"Référence"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Client"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Contact"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Type"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Action"})]})}),e.jsx("tbody",{children:ne?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4",children:e.jsx(N,{className:"animate-spin h-6 w-6 mx-auto text-blue-500"})})}):U.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4 text-gray-500",children:"Aucune demande trouvée"})}):U.map(t=>e.jsxs("tr",{className:"border-t hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-4 font-mono text-sm",children:t.referenceNumber}),e.jsx("td",{className:"py-2 px-4",children:t.name}),e.jsxs("td",{className:"py-2 px-4 text-sm",children:[t.email,e.jsx("br",{}),t.phone]}),e.jsx("td",{className:"py-2 px-4",children:e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800",children:t.clientType==="professional"?"Pro":"Part."})}),e.jsx("td",{className:"py-2 px-4",children:e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>he(t),children:"Sélectionner"})})]},t.id))})]})})})]}),e.jsx(Se,{children:e.jsx(o,{variant:"outline",onClick:()=>b(!1),children:"Annuler"})})]})})]})}export{lt as default};
