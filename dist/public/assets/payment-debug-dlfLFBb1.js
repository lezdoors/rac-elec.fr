import{r as l,j as e,B as d,Y as b,I as O,K as B,Z as o,$ as w,a0 as C}from"./index-C49_B6j6.js";import{C as u,a as h,b as p,c as f,d as j,e as S}from"./card-CP7_ekb1.js";import{B as G}from"./use-mobile-D8yuFFUd.js";import{T as M,a as Q,b as I,c as R}from"./tabs-CGZXluEU.js";import{A as z,a as F,b as L,c as J}from"./accordion-CvvS3AgK.js";import{A as U}from"./admin-layout-B0JtcnfG.js";import{R as X}from"./refresh-ccw-BVc9ZzwF.js";import{S as W}from"./search-B39WZIgc.js";import{C as y}from"./circle-x-D8kBQA9K.js";import"./use-auth-B565S7XO.js";import"./log-out-B0IRPIHU.js";import"./file-text-ChMaYJBS.js";import"./credit-card-pXb7B0gr.js";import"./settings-Ci-M6rTw.js";import"./separator-CKDRA2Tu.js";import"./external-link-ByhaHAx3.js";function fe(){const[t,k]=l.useState(""),[v,P]=l.useState(null),[c,A]=l.useState(null),[N,Y]=l.useState(""),[a,m]=l.useState({reference:!1,payment:!1,create:!1}),[s,i]=l.useState({reference:"",payment:"",create:""}),[g,E]=l.useState(""),[T,_]=l.useState([]);l.useEffect(()=>{V()},[]);const V=async()=>{try{const r=await fetch("/api/service-requests/recent?limit=5"),n=await r.json();if(r.ok&&n.success){const x=n.requests.map(Z=>Z.referenceNumber);_(x)}}catch(r){console.error("Erreur lors du chargement des références récentes:",r)}},D=async()=>{if(t){m({...a,reference:!0}),i({...s,reference:""}),P(null);try{const r=await fetch(`/api/service-requests/${t}`),n=await r.json();r.ok?P(n):i({...s,reference:n.message||"Référence introuvable"})}catch(r){console.error("Erreur lors de la vérification de la référence:",r),i({...s,reference:"Erreur de communication avec le serveur"})}finally{m({...a,reference:!1})}}},K=async()=>{if(t){m({...a,payment:!0}),i({...s,payment:""}),A(null);try{const r=N?`/api/payment-status/${t}?payment_intent=${N}`:`/api/payment-status/${t}`,n=await fetch(r),x=await n.json();A(x),n.ok||i({...s,payment:x.message||"Erreur lors de la vérification du paiement"})}catch(r){console.error("Erreur lors de la vérification du statut du paiement:",r),i({...s,payment:"Erreur de communication avec le serveur"})}finally{m({...a,payment:!1})}}},H=async()=>{if(t){m({...a,create:!0}),i({...s,create:""}),E("");try{const r=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reference:t,amount:129.8})}),n=await r.json();r.ok?E(n.clientSecret):i({...s,create:n.message||"Erreur lors de la création du payment intent"})}catch(r){console.error("Erreur lors de la création du payment intent:",r),i({...s,create:"Erreur de communication avec le serveur"})}finally{m({...a,create:!1})}}},$=()=>{t&&window.open(`/simple-payment?reference=${t}`,"_blank")},q=r=>JSON.stringify(r,null,2);return e.jsx(U,{title:"Diagnostic Paiement",description:"Outil de débogage pour les problèmes liés au paiement",children:e.jsxs("div",{className:"container py-6 space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mt-2 bg-amber-50 border border-amber-200 text-amber-700 p-2 rounded-md text-sm flex items-center",children:[e.jsx("span",{className:"font-medium",children:"Accès restreint :"}),e.jsx("span",{className:"ml-1",children:"Cette page est réservée aux administrateurs et responsables."})]})}),e.jsxs(d,{variant:"outline",onClick:V,size:"sm",children:[e.jsx(X,{className:"h-4 w-4 mr-2"})," Rafraîchir les références"]})]}),e.jsxs(u,{className:"mb-8",children:[e.jsxs(h,{children:[e.jsx(p,{children:"Entrée de référence"}),e.jsx(f,{children:"Entrez une référence de demande ou sélectionnez-en une récente"})]}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(b,{htmlFor:"referenceInput",children:"Référence"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(O,{id:"referenceInput",placeholder:"ex: RAC-2025-0602-143045-742",value:t,onChange:r=>k(r.target.value)}),e.jsxs(d,{onClick:D,children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Vérifier"]}),e.jsxs(d,{variant:"secondary",onClick:$,disabled:!t,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Page Paiement"]})]})]}),T.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:T.map(r=>e.jsx(G,{className:"cursor-pointer",variant:"outline",onClick:()=>k(r),children:r},r))})]})})]}),e.jsxs(M,{defaultValue:"reference",children:[e.jsxs(Q,{className:"grid w-full grid-cols-3",children:[e.jsxs(I,{value:"reference",children:["Vérifier Référence",v&&e.jsx(o,{className:"h-3 w-3 ml-1 text-green-500"}),s.reference&&e.jsx(y,{className:"h-3 w-3 ml-1 text-red-500"})]}),e.jsxs(I,{value:"payment",children:["Vérifier Paiement",c&&e.jsx(o,{className:"h-3 w-3 ml-1 text-green-500"}),s.payment&&e.jsx(y,{className:"h-3 w-3 ml-1 text-red-500"})]}),e.jsxs(I,{value:"create",children:["Créer Intent",g&&e.jsx(o,{className:"h-3 w-3 ml-1 text-green-500"}),s.create&&e.jsx(y,{className:"h-3 w-3 ml-1 text-red-500"})]})]}),e.jsx(R,{value:"reference",className:"space-y-4",children:e.jsxs(u,{children:[e.jsxs(h,{children:[e.jsx(p,{children:"Vérification de la référence"}),e.jsx(f,{children:"Vérifie si une référence existe dans la base de données"})]}),e.jsx(j,{children:a.reference?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{children:"Vérification en cours..."})]}):s.reference?e.jsx(w,{variant:"destructive",children:e.jsx(C,{children:s.reference})}):v?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-green-50 border border-green-100 rounded-md",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(o,{className:"h-5 w-5 text-green-500 mr-2"}),e.jsx("p",{className:"text-green-700 font-medium",children:"Référence valide trouvée"})]})}),e.jsx(z,{type:"single",collapsible:!0,className:"w-full",children:e.jsxs(F,{value:"serviceRequest",children:[e.jsx(L,{children:"Détails de la demande"}),e.jsx(J,{children:e.jsx("pre",{className:"p-4 bg-gray-50 rounded-md text-xs overflow-auto max-h-96",children:q(v)})})]})})]}):e.jsx("div",{className:"text-center py-6 text-gray-500",children:e.jsx("p",{children:"Aucune vérification n'a encore été effectuée"})})}),e.jsx(S,{className:"flex justify-end",children:e.jsx(d,{onClick:D,disabled:!t||a.reference,children:a.reference?"Chargement...":"Vérifier la référence"})})]})}),e.jsx(R,{value:"payment",className:"space-y-4",children:e.jsxs(u,{children:[e.jsxs(h,{children:[e.jsx(p,{children:"Vérification du statut de paiement"}),e.jsx(f,{children:"Vérifie le statut du paiement associé à une référence"})]}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(b,{htmlFor:"paymentIdInput",children:"ID PaymentIntent (optionnel)"}),e.jsx(O,{id:"paymentIdInput",placeholder:"ex: pi_3RK6TSF0p2SYXeXz1BY5vORk",value:N,onChange:r=>Y(r.target.value)})]}),a.payment?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{children:"Vérification en cours..."})]}):s.payment?e.jsx(w,{variant:"destructive",children:e.jsx(C,{children:s.payment})}):c?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`p-4 ${c.status==="succeeded"?"bg-green-50 border-green-100":c.status==="failed"?"bg-red-50 border-red-100":"bg-yellow-50 border-yellow-100"} border rounded-md`,children:e.jsxs("div",{className:"flex items-center",children:[c.status==="succeeded"?e.jsx(o,{className:"h-5 w-5 text-green-500 mr-2"}):c.status==="failed"?e.jsx(y,{className:"h-5 w-5 text-red-500 mr-2"}):e.jsx(X,{className:"h-5 w-5 text-yellow-500 mr-2"}),e.jsxs("p",{className:`font-medium ${c.status==="succeeded"?"text-green-700":c.status==="failed"?"text-red-700":"text-yellow-700"}`,children:["Statut: ",c.status]})]})}),e.jsx(z,{type:"single",collapsible:!0,className:"w-full",children:e.jsxs(F,{value:"paymentStatus",children:[e.jsx(L,{children:"Détails du statut de paiement"}),e.jsx(J,{children:e.jsx("pre",{className:"p-4 bg-gray-50 rounded-md text-xs overflow-auto max-h-96",children:q(c)})})]})})]}):e.jsx("div",{className:"text-center py-6 text-gray-500",children:e.jsx("p",{children:"Aucune vérification n'a encore été effectuée"})})]})}),e.jsx(S,{className:"flex justify-end",children:e.jsx(d,{onClick:K,disabled:!t||a.payment,children:a.payment?"Chargement...":"Vérifier le paiement"})})]})}),e.jsx(R,{value:"create",className:"space-y-4",children:e.jsxs(u,{children:[e.jsxs(h,{children:[e.jsx(p,{children:"Créer un Payment Intent"}),e.jsx(f,{children:"Crée un nouveau Payment Intent pour tester le paiement"})]}),e.jsx(j,{children:a.create?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{children:"Création en cours..."})]}):s.create?e.jsx(w,{variant:"destructive",children:e.jsx(C,{children:s.create})}):g?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-green-50 border border-green-100 rounded-md",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(o,{className:"h-5 w-5 text-green-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-green-700 font-medium",children:"PaymentIntent créé avec succès"}),e.jsx("p",{className:"text-green-600 text-sm mt-1",children:"ClientSecret généré et prêt à être utilisé avec Stripe Elements"})]})]})}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(b,{className:"block mb-2",children:"Client Secret"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded text-xs overflow-auto font-mono break-all",children:g})]}),e.jsx("div",{className:"flex justify-center",children:e.jsxs(d,{onClick:$,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Tester le paiement"]})})]}):e.jsx("div",{className:"text-center py-6 text-gray-500",children:e.jsx("p",{children:"Aucun PaymentIntent n'a encore été créé"})})}),e.jsx(S,{className:"flex justify-end",children:e.jsx(d,{onClick:H,disabled:!t||a.create,children:a.create?"Chargement...":"Créer PaymentIntent"})})]})})]})]})})}export{fe as default};
