import{a as X,r as x,d as U,j as e,t as H,B as h,F as L,f as c,g as d,i as m,h as u,m as V,I as g,k as v,C as Y,U as Z,M as _,n as ee,l as N,o as $,s as b,p as A,q as se,u as re}from"./index-B3Ws-9bC.js";import{u as q,S as te}from"./use-auth-B8UD4tbp.js";import{C,a as y,b as E,c as S,d as P,e as R}from"./card-CYufAO8o.js";import{C as D}from"./checkbox-D9utjePl.js";import{P as ne}from"./progress-DzQ4AeUr.js";import{S as ie}from"./settings-DzPgacoN.js";import"./index-Dk-YhRBn.js";import"./index-dSPHo9gO.js";const ae=$({fullName:b().min(1,"Le nom complet est requis"),email:b().email("Adresse email invalide")}),oe=$({smtpEnabled:A().optional(),smtpHost:b().optional(),smtpPort:se().int().positive().optional(),smtpSecure:A().optional(),smtpUser:b().optional(),smtpPassword:b().optional(),smtpFromEmail:b().email("Email d'expédition invalide").optional()}),a=[{id:"welcome",title:"Bienvenue",icon:e.jsx(te,{className:"h-5 w-5"})},{id:"profile",title:"Profil",icon:e.jsx(Z,{className:"h-5 w-5"})},{id:"smtp",title:"Email",icon:e.jsx(_,{className:"h-5 w-5"})},{id:"finish",title:"Terminer",icon:e.jsx(ee,{className:"h-5 w-5"})}];function le(){const{user:r}=q(),{toast:n}=X(),[j,M]=x.useState("welcome"),[z,B]=x.useState(0),[o,T]=x.useState(null),[f,p]=x.useState(!1),w=U({resolver:H(ae),defaultValues:{fullName:(r==null?void 0:r.fullName)||"",email:(r==null?void 0:r.email)||""}}),i=U({resolver:H(oe),defaultValues:{smtpEnabled:!1,smtpHost:"",smtpPort:587,smtpSecure:!0,smtpUser:"",smtpPassword:"",smtpFromEmail:""}});x.useEffect(()=>{r&&T({id:r.id,fullName:r.fullName||"",email:r.email||"",smtpHost:r.smtpHost,smtpPort:r.smtpPort,smtpSecure:r.smtpSecure,smtpUser:r.smtpUser,smtpPassword:r.smtpPassword,smtpFromEmail:r.smtpFromEmail,smtpEnabled:r.smtpEnabled,onboardingCompleted:r.onboardingCompleted})},[r]),x.useEffect(()=>{const s=a.findIndex(t=>t.id===j);B(s/(a.length-1)*100)},[j]),x.useEffect(()=>{r!=null&&r.onboardingCompleted&&(window.location.href="/admin")},[r==null?void 0:r.onboardingCompleted]);const k=()=>{const s=a.findIndex(t=>t.id===j);s<a.length-1&&M(a[s+1].id)},F=()=>{const s=a.findIndex(t=>t.id===j);s>0&&M(a[s-1].id)},O=async s=>{p(!0);try{if(!r)return;if(!(await N("PATCH",`/api/users/${r.id}`,{...s})).ok)throw new Error("Erreur lors de la mise à jour du profil");T(l=>l?{...l,...s}:null),k()}catch(t){n({title:"Erreur",description:t instanceof Error?t.message:"Une erreur s'est produite",variant:"destructive"})}finally{p(!1)}},W=async s=>{p(!0);try{if(!r)return;const t=s.smtpEnabled?s:{smtpEnabled:!1};if(!(await N("PATCH",`/api/users/${r.id}`,{...t})).ok)throw new Error("Erreur lors de la mise à jour des paramètres SMTP");T(I=>I?{...I,...t}:null),k()}catch(t){n({title:"Erreur",description:t instanceof Error?t.message:"Une erreur s'est produite",variant:"destructive"})}finally{p(!1)}},G=async()=>{p(!0);try{if(!r)return;if(!(await N("PATCH",`/api/users/${r.id}`,{onboardingCompleted:!0})).ok)throw new Error("Erreur lors de la finalisation de l'onboarding");n({title:"Configuration terminée",description:"Votre compte a été configuré avec succès"}),window.location.href="/admin"}catch(s){n({title:"Erreur",description:s instanceof Error?s.message:"Une erreur s'est produite",variant:"destructive"})}finally{p(!1)}},J=async()=>{p(!0);try{const s=i.getValues();if(!s.smtpEnabled){n({title:"Information",description:"Veuillez d'abord activer la configuration SMTP"});return}if(!r)return;const t=await N("POST","/api/users/test-smtp",{userId:r.id,...s});if(!t.ok){const l=await t.json();throw new Error(l.message||"Erreur lors du test SMTP")}n({title:"Test réussi",description:"La configuration SMTP fonctionne correctement"})}catch(s){n({title:"Erreur",description:s instanceof Error?s.message:"Une erreur s'est produite",variant:"destructive"})}finally{p(!1)}},K=()=>{switch(j){case"welcome":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(y,{children:[e.jsx(E,{className:"text-2xl",children:"Bienvenue dans l'assistant de configuration"}),e.jsx(S,{children:"Cet assistant vous guidera dans la configuration initiale de votre compte."})]}),e.jsx(P,{className:"space-y-4",children:e.jsxs("div",{className:"rounded-lg bg-muted p-4 text-muted-foreground",children:[e.jsx("p",{children:"Nous allons vous aider à configurer :"}),e.jsxs("ul",{className:"list-disc list-inside mt-2",children:[e.jsx("li",{children:"Votre profil personnel"}),e.jsx("li",{children:"Vos paramètres d'email (SMTP)"}),e.jsx("li",{children:"Et bien plus encore..."})]})]})}),e.jsx(R,{className:"flex justify-end",children:e.jsxs(h,{onClick:k,children:["Commencer ",e.jsx(Y,{className:"ml-2 h-4 w-4"})]})})]});case"profile":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(y,{children:[e.jsx(E,{className:"text-2xl",children:"Votre profil"}),e.jsx(S,{children:"Mettez à jour vos informations personnelles"})]}),e.jsx(P,{children:e.jsx(L,{...w,children:e.jsxs("form",{onSubmit:w.handleSubmit(O),className:"space-y-4",children:[e.jsx(c,{control:w.control,name:"fullName",render:({field:s})=>e.jsxs(d,{children:[e.jsx(u,{children:"Nom complet"}),e.jsx(m,{children:e.jsx(g,{...s})}),e.jsx(v,{})]})}),e.jsx(c,{control:w.control,name:"email",render:({field:s})=>e.jsxs(d,{children:[e.jsx(u,{children:"Email"}),e.jsx(m,{children:e.jsx(g,{type:"email",...s})}),e.jsx(v,{})]})}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(h,{type:"button",variant:"outline",onClick:F,children:"Retour"}),e.jsx(h,{type:"submit",disabled:f,children:f?"Enregistrement...":"Continuer"})]})]})})})]});case"smtp":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(y,{children:[e.jsx(E,{className:"text-2xl",children:"Configuration de l'email"}),e.jsx(S,{children:"Configurez vos paramètres SMTP pour l'envoi d'emails"})]}),e.jsx(P,{children:e.jsx(L,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(W),className:"space-y-4",children:[e.jsx(c,{control:i.control,name:"smtpEnabled",render:({field:s})=>e.jsxs(d,{className:"flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4 mb-4",children:[e.jsx(m,{children:e.jsx(D,{checked:s.value,onCheckedChange:s.onChange})}),e.jsxs("div",{className:"space-y-1 leading-none",children:[e.jsx(u,{children:"Activer SMTP personnel"}),e.jsx(V,{children:"Permettre d'envoyer des emails via votre propre serveur SMTP"})]})]})}),e.jsxs("div",{className:i.watch("smtpEnabled")?"":"opacity-50 pointer-events-none",children:[e.jsx(c,{control:i.control,name:"smtpHost",render:({field:s})=>e.jsxs(d,{children:[e.jsx(u,{children:"Serveur SMTP"}),e.jsx(m,{children:e.jsx(g,{placeholder:"smtp.example.com",...s,value:s.value||""})}),e.jsx(v,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsx(c,{control:i.control,name:"smtpPort",render:({field:s})=>e.jsxs(d,{children:[e.jsx(u,{children:"Port"}),e.jsx(m,{children:e.jsx(g,{type:"number",placeholder:"587",...s,value:s.value===void 0?"":s.value,onChange:t=>s.onChange(t.target.value===""?void 0:Number(t.target.value))})}),e.jsx(v,{})]})}),e.jsx(c,{control:i.control,name:"smtpSecure",render:({field:s})=>e.jsxs(d,{className:"flex flex-row items-center space-x-3 space-y-0 rounded-md border p-4",children:[e.jsx(m,{children:e.jsx(D,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx("div",{className:"space-y-1 leading-none",children:e.jsx(u,{children:"Sécurisé (TLS)"})})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 mt-4",children:[e.jsx(c,{control:i.control,name:"smtpUser",render:({field:s})=>e.jsxs(d,{children:[e.jsx(u,{children:"Nom d'utilisateur SMTP"}),e.jsx(m,{children:e.jsx(g,{placeholder:"user@example.com",...s,value:s.value||""})}),e.jsx(v,{})]})}),e.jsx(c,{control:i.control,name:"smtpPassword",render:({field:s})=>e.jsxs(d,{children:[e.jsx(u,{children:"Mot de passe SMTP"}),e.jsx(m,{children:e.jsx(g,{type:"password",placeholder:"••••••••",...s,value:s.value||""})}),e.jsx(v,{})]})}),e.jsx(c,{control:i.control,name:"smtpFromEmail",render:({field:s})=>e.jsxs(d,{children:[e.jsx(u,{children:"Adresse d'expédition"}),e.jsx(m,{children:e.jsx(g,{placeholder:"noreply@example.com",...s,value:s.value||""})}),e.jsx(V,{children:"L'adresse email qui apparaîtra comme expéditeur"}),e.jsx(v,{})]})}),e.jsxs(h,{type:"button",variant:"outline",className:"mt-2",onClick:J,disabled:f||!i.watch("smtpEnabled"),children:[e.jsx(ie,{className:"mr-2 h-4 w-4"}),"Tester la configuration"]})]})]}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(h,{type:"button",variant:"outline",onClick:F,children:"Retour"}),e.jsx(h,{type:"submit",disabled:f,children:f?"Enregistrement...":"Continuer"})]})]})})})]});case"finish":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(y,{children:[e.jsx(E,{className:"text-2xl",children:"Configuration terminée !"}),e.jsx(S,{children:"Votre compte est maintenant configuré et prêt à l'emploi."})]}),e.jsx(P,{className:"space-y-4",children:e.jsxs("div",{className:"rounded-lg bg-muted p-4 text-muted-foreground",children:[e.jsx("p",{children:"Récapitulatif de votre configuration :"}),e.jsxs("ul",{className:"list-disc list-inside mt-2",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Profil"})," : ",o==null?void 0:o.fullName," (",o==null?void 0:o.email,")"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Email SMTP"})," : ",o!=null&&o.smtpEnabled?"Configuré":"Non configuré"]})]})]})}),e.jsxs(R,{className:"flex justify-between",children:[e.jsx(h,{type:"button",variant:"outline",onClick:F,children:"Retour"}),e.jsx(h,{onClick:G,disabled:f,children:f?"Finalisation...":"Terminer la configuration"})]})]});default:return null}},Q=()=>e.jsxs("div",{className:"mb-8 w-full max-w-md mx-auto",children:[e.jsx(ne,{value:z,className:"h-2"}),e.jsx("div",{className:"mt-4 flex justify-between",children:a.map((s,t)=>e.jsxs("div",{className:`flex flex-col items-center ${a.findIndex(l=>l.id===j)>=t?"text-primary":"text-muted-foreground"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center mb-1 ${a.findIndex(l=>l.id===j)>=t?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"}`,children:s.icon}),e.jsx("span",{className:"text-xs",children:s.title})]},s.id))})]});return e.jsx("div",{className:"w-full min-h-screen bg-background py-12 px-4 flex flex-col items-center",children:e.jsxs("div",{className:"max-w-2xl w-full",children:[e.jsx("h1",{className:"text-3xl font-bold text-center mb-8",children:"Assistant de configuration"}),Q(),K()]})})}function fe(){const{user:r,isLoading:n}=q();return re(),x.useEffect(()=>{!n&&!r&&(window.location.href="/auth")},[n,r]),x.useEffect(()=>{!n&&(r!=null&&r.onboardingCompleted)&&(window.location.href="/admin")},[n,r==null?void 0:r.onboardingCompleted]),e.jsxs("div",{className:"bg-background min-h-screen",children:[!n&&r&&e.jsx(le,{}),n&&e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full"})})]})}export{fe as default};
