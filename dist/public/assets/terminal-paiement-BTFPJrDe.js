import{a as ve,r,j as e,i as f,B as o,I as u,d as N,A as P,l as E,k as T,D as Ne,n as ge,o as ye,p as Ce,s as be,t as we,e as k,$ as S,ak as Se}from"./index-CUIrBm9o.js";import{A as De}from"./admin-layout-B_5lEmpc.js";import{C as Fe,a as Le,b as Pe,c as Ee,d as Te,e as ke}from"./card-B3S0I_H7.js";import{a as Re}from"./use-auth-BcgWddCX.js";import{u as R}from"./useMutation-D1_2mGyz.js";import{T as ze,a as Ie,b as G,c as J}from"./tabs-DhPsVOkk.js";import{S as Me}from"./search-qFNkKYVk.js";import{C as X}from"./credit-card-BsMekCjh.js";import{E as z}from"./external-link-DVHpcEbQ.js";import{R as Ve}from"./refresh-cw-CEpPbngw.js";import{C as Ae}from"./circle-check-big-BsYUaqy4.js";import{C as qe}from"./circle-x-BDmlj6MH.js";import"./use-mobile-DKykdz_A.js";import"./index-Cj87Fuwj.js";import"./log-out-CAGW1Fe6.js";import"./file-text-CDM67-yI.js";import"./users-D8XrnR9s.js";import"./clock-pgo03ecp.js";import"./settings-B08tDknL.js";import"./index-CulLse46.js";import"./index-3wgKPZld.js";import"./separator-mByQb6DW.js";import"./check-B460mZXX.js";function ot(){const{toast:s}=ve(),[_,D]=r.useState(""),[I,W]=r.useState(""),[g,M]=r.useState(""),[y,V]=r.useState(""),[j,A]=r.useState(""),[C,q]=r.useState(""),[p,Z]=r.useState(129.8),[$,b]=r.useState(!1),[i,Q]=r.useState(null),[F,ee]=r.useState("manual"),[d,Y]=r.useState(null),[te,ae]=r.useState(null),[U,L]=r.useState(!1),[n,h]=r.useState(!1),[l,v]=r.useState(!1),[se,x]=r.useState(!1),[w,K]=r.useState(""),{data:re=[],isLoading:ne}=Re({queryKey:["/api/service-requests-unpaid"],queryFn:Se({on401:"throw"}),enabled:$});r.useEffect(()=>{new URLSearchParams(window.location.search).get("canceled")==="true"&&(s({title:"Paiement annulé",description:"Le paiement a été annulé ou abandonné par le client.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname))},[s]);const ie=R({mutationFn:async t=>{const a=await k("POST","/api/create-payment-terminal-session",t);if(!a.ok){const c=await a.json();throw new Error(c.message||"Erreur lors de la création du terminal de paiement")}return a.json()},onSuccess:t=>{h(!1),Y(t.checkoutUrl),K(t.paymentId),s({title:"Terminal prêt",description:`Terminal de paiement créé pour ${p.toFixed(2).replace(".",",")}€. Cliquez sur le lien pour procéder au paiement.`,variant:"default"})},onError:t=>{h(!1),x(!0),s({title:"Échec de la création du terminal",description:t.message,variant:"destructive"})}}),le=R({mutationFn:async t=>{const a=await k("GET",`/api/payment-terminal-status/${t}`);if(!a.ok){const c=await a.json();throw new Error(c.message||"Erreur lors de la vérification du paiement")}return a.json()},onSuccess:t=>{var a;L(!1),ae(t.status),t.status==="succeeded"?(v(!0),s({title:"Paiement confirmé",description:`Le paiement de ${(a=t.amount)==null?void 0:a.toFixed(2).replace(".",",")}€ a été traité avec succès.`,variant:"default"}),S.invalidateQueries({queryKey:["/api/service-requests"]}),S.invalidateQueries({queryKey:["/api/service-requests-unpaid"]}),S.invalidateQueries({queryKey:["/api/payments/recent"]}),S.invalidateQueries({queryKey:["/api/payments/stats"]})):t.status==="canceled"?(x(!0),s({title:"Paiement annulé",description:"Le paiement a été annulé.",variant:"destructive"})):s({title:"Paiement en attente",description:`Le paiement est en statut: ${t.status}. Vérifiez à nouveau plus tard.`,variant:"default"})},onError:t=>{L(!1),s({title:"Erreur de vérification",description:t.message,variant:"destructive"})}}),ce=R({mutationFn:async t=>{const a=await k("POST","/api/process-manual-payment",t);if(!a.ok){const c=await a.json();throw new Error(c.message||"Erreur lors du traitement du paiement")}return a.json()},onSuccess:t=>{h(!1),v(!0),K(t.paymentId),s({title:"Paiement réussi",description:`Le paiement de ${p.toFixed(2).replace(".",",")}€ a été traité avec succès. ID de transaction: ${t.paymentId}`,variant:"default"})},onError:t=>{h(!1),x(!0),s({title:"Échec du paiement",description:t.message,variant:"destructive"})}}),oe=t=>{const a=t.replace(/\D/g,""),c=[];for(let m=0;m<a.length;m+=4)c.push(a.slice(m,m+4));return c.join(" ")},de=t=>{const a=t.replace(/\D/g,"");return a.length<=2?a:a.slice(0,2)+"/"+a.slice(2,4)},me=()=>{if(!i){s({title:"Erreur",description:"Veuillez sélectionner une demande de service",variant:"destructive"});return}if(!g||!y||!j||!C){s({title:"Formulaire incomplet",description:"Veuillez remplir tous les champs du formulaire de paiement",variant:"destructive"});return}const t=g.replace(/\D/g,"");if(t.length<16){s({title:"Numéro de carte invalide",description:"Le numéro de carte doit comporter au moins 16 chiffres",variant:"destructive"});return}const a=y.split("/");if(a.length!==2||a[0].length!==2||a[1].length!==2){s({title:"Date d'expiration invalide",description:"La date d'expiration doit être au format MM/YY",variant:"destructive"});return}const c=parseInt(a[0],10),m=parseInt(`20${a[1]}`,10),B=new Date,fe=B.getMonth()+1,H=B.getFullYear();if(m<H||m===H&&c<fe){s({title:"Carte expirée",description:"La date d'expiration de la carte est dépassée. Veuillez utiliser une carte valide.",variant:"destructive"});return}if(j.length<3){s({title:"CVC invalide",description:"Le code de sécurité (CVC) doit comporter au moins 3 chiffres",variant:"destructive"});return}h(!0),v(!1),x(!1);const je={referenceNumber:i.referenceNumber,cardNumber:t,cardExpMonth:parseInt(a[0]),cardExpYear:parseInt(`20${a[1]}`),cardCvc:j,cardholderName:C,amount:p,serviceRequestId:i.id};ce.mutate(je)},ue=()=>{if(!i){s({title:"Erreur",description:"Veuillez sélectionner une demande de service",variant:"destructive"});return}h(!0),v(!1),x(!1),Y(null);const t={referenceNumber:i.referenceNumber,amount:p,serviceRequestId:i.id};ie.mutate(t)},pe=()=>{if(!w){s({title:"Erreur",description:"Aucun paiement en cours",variant:"destructive"});return}L(!0),le.mutate(w)},O=re.filter(t=>{const a=I.toLowerCase();return t.referenceNumber.toLowerCase().includes(a)||t.name.toLowerCase().includes(a)||t.email.toLowerCase().includes(a)||t.phone.toLowerCase().includes(a)}),he=t=>{Q(t),D(t.referenceNumber),b(!1)},xe=()=>{M(""),V(""),A(""),q(""),D(""),Q(null),v(!1),x(!1)};return e.jsxs(De,{title:"Terminal de paiement",description:"Traitez les paiements par téléphone ou en personne",children:[e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs(Fe,{className:"mb-4",children:[e.jsxs(Le,{children:[e.jsx(Pe,{children:"Terminal de paiement virtuel"}),e.jsx(Ee,{children:"Utilisez ce terminal pour traiter les paiements par téléphone ou en personne. Vos clients peuvent vous communiquer leurs informations de carte bancaire par téléphone."})]}),e.jsxs(Te,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{htmlFor:"reference",children:"Référence de la demande"}),e.jsxs(o,{type:"button",variant:"ghost",size:"sm",onClick:()=>b(!0),children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Rechercher"]})]}),e.jsx(u,{id:"reference",placeholder:"ex: RAC-2025-0602-143045-742",value:_,onChange:t=>D(t.target.value),disabled:n||l,className:"font-mono"}),i&&e.jsxs("div",{className:"text-sm text-gray-700 bg-gray-50 p-2 rounded",children:["Client: ",i.name," • ",i.email," • ",i.phone]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"amount",children:"Montant (€)"}),e.jsx(u,{id:"amount",type:"number",value:p.toFixed(2),step:"0.01",min:"0",placeholder:"Entrez le montant",className:"font-bold",disabled:n||l,onChange:t=>{const a=parseFloat(t.target.value);isNaN(a)||Z(parseFloat(a.toFixed(2)))}})]}),e.jsxs(ze,{defaultValue:F,value:F,onValueChange:t=>ee(t),className:"w-full",children:[e.jsxs(Ie,{className:"grid w-full grid-cols-2",children:[e.jsxs(G,{value:"manual",disabled:n||l,children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Saisie manuelle"]}),e.jsxs(G,{value:"terminal",disabled:n||l,children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Terminal Stripe"]})]}),e.jsxs(J,{value:"manual",className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"cardNumber",children:"Numéro de carte"}),e.jsxs("div",{className:"relative",children:[e.jsx(u,{id:"cardNumber",placeholder:"1234 5678 9012 3456",value:g,onChange:t=>M(oe(t.target.value)),disabled:n||l,maxLength:19,className:"font-mono"}),e.jsx(X,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"cardExpiry",children:"Date d'expiration"}),e.jsx(u,{id:"cardExpiry",placeholder:"MM/YY",value:y,onChange:t=>V(de(t.target.value)),disabled:n||l,maxLength:5,className:"font-mono"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"cardCvc",children:"CVC"}),e.jsx(u,{id:"cardCvc",placeholder:"123",value:j,onChange:t=>{const a=t.target.value.replace(/\D/g,"");A(a.slice(0,4))},disabled:n||l,maxLength:4,className:"font-mono"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"cardholderName",children:"Nom du titulaire"}),e.jsx(u,{id:"cardholderName",placeholder:"Jean Dupont",value:C,onChange:t=>q(t.target.value),disabled:n||l})]})]}),e.jsx(J,{value:"terminal",className:"mt-4 space-y-4",children:e.jsxs("div",{className:"bg-gray-50 p-4 rounded-md border",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Terminal de paiement Stripe"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Ce mode crée un terminal de paiement Stripe sécurisé que vous pouvez partager avec votre client. Il pourra entrer ses informations bancaires directement sur la page Stripe."}),d&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center mb-2 text-sm font-medium text-blue-600",children:e.jsx("span",{children:"URL du terminal:"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",readOnly:!0,value:d,className:"flex-1 p-2 text-sm font-mono bg-white border rounded",onClick:t=>t.target.select()}),e.jsx(o,{size:"sm",variant:"outline",onClick:()=>{d&&window.open(d,"_blank")},children:e.jsx(z,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Status: ",te||"En attente de paiement"]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:pe,disabled:U||!w,children:[U?e.jsx(N,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Vérifier le statut"]})]})]})]})})]}),n&&!d&&e.jsxs(P,{children:[e.jsx(N,{className:"h-4 w-4 animate-spin mr-2"}),e.jsx(E,{children:"Traitement en cours"}),e.jsx(T,{children:"Veuillez patienter pendant que nous préparons votre paiement..."})]}),l&&e.jsxs(P,{className:"bg-green-50 border-green-200 text-green-800",children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),e.jsx(E,{children:"Paiement réussi!"}),e.jsxs(T,{children:["Le paiement de ",p.toFixed(2).replace(".",","),"€ a été traité avec succès. ID de transaction: ",w]})]}),se&&e.jsxs(P,{variant:"destructive",children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),e.jsx(E,{children:"Échec du paiement"}),e.jsx(T,{children:"Le paiement a échoué. Veuillez vérifier les informations et réessayer."})]})]}),e.jsxs(ke,{className:"flex justify-between",children:[e.jsx(o,{variant:"outline",onClick:xe,disabled:n,children:"Réinitialiser"}),F==="manual"?e.jsx(o,{onClick:me,disabled:n||!i||l||!g||!y||!j||!C,children:n?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Traitement..."]}):"Traiter le paiement manuel"}):e.jsx(o,{onClick:ue,disabled:n||!i||l,children:n&&!d?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Préparation..."]}):d?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"Ouvrir le terminal"]}):"Créer un terminal de paiement"})]})]})}),e.jsx(Ne,{open:$,onOpenChange:b,children:e.jsxs(ge,{className:"max-w-3xl",children:[e.jsxs(ye,{children:[e.jsx(Ce,{children:"Sélectionner une demande"}),e.jsx(be,{children:"Recherchez et sélectionnez une demande pour traiter le paiement"})]}),e.jsxs("div",{className:"my-4",children:[e.jsx(u,{placeholder:"Rechercher par référence, nom, email ou téléphone...",value:I,onChange:t=>W(t.target.value),className:"mb-4"}),e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-100 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 px-4 text-left",children:"Référence"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Client"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Contact"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Type"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Action"})]})}),e.jsx("tbody",{children:ne?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4",children:e.jsx(N,{className:"animate-spin h-6 w-6 mx-auto text-blue-500"})})}):O.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4 text-gray-500",children:"Aucune demande trouvée"})}):O.map(t=>e.jsxs("tr",{className:"border-t hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-4 font-mono text-sm",children:t.referenceNumber}),e.jsx("td",{className:"py-2 px-4",children:t.name}),e.jsxs("td",{className:"py-2 px-4 text-sm",children:[t.email,e.jsx("br",{}),t.phone]}),e.jsx("td",{className:"py-2 px-4",children:e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800",children:t.clientType==="professional"?"Pro":"Part."})}),e.jsx("td",{className:"py-2 px-4",children:e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>he(t),children:"Sélectionner"})})]},t.id))})]})})})]}),e.jsx(we,{children:e.jsx(o,{variant:"outline",onClick:()=>b(!1),children:"Annuler"})})]})})]})}export{ot as default};
