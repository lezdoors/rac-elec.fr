import{c as h,a as p,r as f,e as m,a9 as u,l as g}from"./index-Diw4zqMT.js";import{u as S}from"./useQuery-BMZrI7_U.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const w=h("Sparkles",[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]]),k=async()=>{try{const r=localStorage.getItem("adminToken");if(!r)return console.log("fetchUser - Pas de token, utilisateur non authentifié"),localStorage.removeItem("adminUser"),sessionStorage.clear(),null;const s=localStorage.getItem("adminUser"),a=localStorage.getItem("lastAuthCheck"),i=new Date().getTime(),c=a?parseInt(a):0,l=i-c,d=15*60*1e3;if(s&&l<d)try{const o=JSON.parse(s);if(o&&o.id&&o.username&&o.role)return console.log(`fetchUser - Utilisation des données en cache (${Math.round(l/1e3)}s)`),{...o}}catch(o){console.error("Erreur lors de la lecture du cache:",o)}const n=new Date().getTime();console.log(`fetchUser - Requête directe au serveur avec timestamp: ${n}`);const e=await fetch(`/api/user?_t=${n}`,{method:"GET",headers:{Authorization:`Bearer ${r}`,"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(!e.ok){if(e.status===401)return console.log("fetchUser - Token invalide (401), nettoyage des données locales"),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),sessionStorage.clear(),null;throw console.error(`Échec de récupération des données utilisateur - Statut HTTP: ${e.status}`),new Error(`Échec de récupération des données utilisateur - Statut: ${e.status}`)}const t=await e.json();return console.log(`fetchUser - Utilisateur récupéré du serveur au timestamp ${n}`),!t||typeof t!="object"?(console.error("Données utilisateur invalides (format incorrect)",t),null):!t.id||!t.username||!t.role?(console.error("Données utilisateur incomplètes",t),null):(localStorage.setItem("adminUser",JSON.stringify(t)),localStorage.setItem("lastAuthCheck",i.toString()),console.log(`Utilisateur mis à jour en cache: ${t.username} (${t.role})`),{...t})}catch(r){return console.error("Erreur lors de la récupération de l'utilisateur:",r),null}};function y(){const{toast:r}=p(),{data:s,error:a,isLoading:i,refetch:c}=S({queryKey:["/api/user"],queryFn:k,staleTime:5*60*1e3,gcTime:20*60*1e3,refetchInterval:10*60*1e3,refetchOnMount:!1,refetchOnWindowFocus:!1});f.useEffect(()=>{const e=setTimeout(()=>{console.log("useAuth - Refetch forcé des données utilisateur"),c()},100);return()=>clearTimeout(e)},[c]);const l=m({mutationFn:async e=>{try{localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),console.log("Tentative de connexion pour:",e.username);const t=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),credentials:"include"}),o=await t.json();if(!t.ok)throw new Error(o.message||"Échec de connexion");return console.log("Réponse de connexion complète:",o),o.token&&(localStorage.setItem("adminToken",o.token),console.log("Token stocké:",o.token)),o}catch(t){throw console.error("Erreur de connexion:",t),t}},onSuccess:e=>{if(!e.user||!e.user.id||!e.user.role){console.error("Données utilisateur invalides reçues:",e),r({title:"Erreur d'authentification",description:"Données utilisateur invalides. Veuillez réessayer.",variant:"destructive"});return}console.log("Connexion réussie - NETTOYAGE RADICAL avant affichage de l'interface de",e.user.username),localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(function(t){document.cookie=t.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),u.clear(),localStorage.setItem("adminToken",e.token),localStorage.setItem("adminUser",JSON.stringify(e.user)),localStorage.setItem("lastLoginTime",new Date().toString()),localStorage.setItem("userRole",e.user.role),localStorage.setItem("userId",e.user.id.toString()),r({title:"Connexion réussie",description:`Bienvenue, ${e.user.fullName||e.user.username}! Chargement de votre interface...`}),setTimeout(()=>{console.log("HARD RELOAD complet du navigateur..."),window.location.href="/admin/dashboard?t="+new Date().getTime()},800)},onError:e=>{r({title:"Erreur de connexion",description:e.message,variant:"destructive"})}}),d=m({mutationFn:async e=>{const t=await g("POST","/api/register",e);if(!t.ok){const o=await t.json();throw new Error(o.message||"Échec d'inscription")}return await t.json()},onSuccess:e=>{u.setQueryData(["/api/user"],e),r({title:"Inscription réussie",description:"Votre compte a été créé avec succès !"})},onError:e=>{r({title:"Erreur d'inscription",description:e.message,variant:"destructive"})}}),n=m({mutationFn:async()=>{if(console.log("Début du processus de déconnexion"),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),u.setQueryData(["/api/user"],null),!(await g("POST","/api/logout")).ok)throw new Error("Échec de déconnexion")},onSuccess:()=>{console.log("Déconnexion - Nettoyage complet des données en cours..."),u.clear(),localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),console.log("Déconnexion effectuée - Données utilisateur supprimées"),r({title:"Déconnexion réussie",description:"Vous êtes maintenant déconnecté."}),setTimeout(()=>{console.log("Redirection vers la page d'authentification..."),window.location.href="/admin"},500)},onError:e=>{r({title:"Erreur de déconnexion",description:e.message,variant:"destructive"})}});return{user:s??null,isLoading:i,error:a,loginMutation:l,logoutMutation:n,registerMutation:d}}export{w as S,y as u};
