const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-BI5bkCKM.js","assets/index-BjMBsvVP.js","assets/index-DRysUEll.css"])))=>i.map(i=>d[i]);
import{a as ue,r as h,j as e,o as xe,p as he,B as j,I as be,L as U,e as te,M as ve,Q as we,T as Ee,V as Ce,J as Se,W as De,a0 as Fe,a2 as ye,l as z,a4 as re,_ as Pe,aF as Re}from"./index-BjMBsvVP.js";import{u as Te}from"./useQuery-CoaADR8l.js";import{A as Ae}from"./admin-layout-BYyYRbUL.js";import{C as P,d as R,a as Le,b as Ie}from"./card-itC3CWJX.js";import{T as Me,a as qe,b as le,c as M,d as ze,e as q}from"./table-B4TwbQDM.js";import{S as ce,a as oe,d as de,b as me,c as N}from"./select-BXm20hds.js";import{B as ke}from"./badge-SvH6iM8X.js";import{C as $}from"./circle-x-Bb2HRCLr.js";import{T as pe}from"./triangle-alert-C2pJAz8h.js";import{R as V}from"./refresh-cw-Du8zWOvd.js";import{C as ne}from"./credit-card-Daftj5PX.js";import{D as fe}from"./download-DJy_0gqc.js";import{S as Oe}from"./search-CgaR8jut.js";import{F as ae}from"./file-text-BJTD10yd.js";import{L as Ue}from"./lock-E6jT_9zs.js";import"./use-auth-D_GRaOy5.js";import"./use-mobile-CP-aw7vL.js";import"./index-DGZHqXYo.js";import"./log-out-CReUxlGf.js";import"./settings-DXLPLaEU.js";import"./index-BUTs_h7C.js";import"./index-Br5vXGFH.js";import"./separator-BAf5abPo.js";import"./external-link-DeVB-lyJ.js";import"./index-CUCq7q8p.js";import"./chevron-down-B4Lb9pOc.js";function w(t){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(t)}function Y(t){return new Date(t).toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function $e({payment:t}){var H,Q;const{toast:B}=ue(),T=t.cardBrand||t.cardLast4||t.bankName,[x,y]=h.useState(null),[A,b]=h.useState(!1),[G,L]=h.useState(!1);h.useEffect(()=>{(async()=>{if(t.status==="succeeded"||t.status==="paid")try{b(!0);const v=await(await z("GET",`/api/payment-receipt-status/${t.id}`)).json();v.success&&y({exists:v.exists,receiptUrl:v.receiptUrl})}catch(m){console.error("Erreur lors de la vérification du reçu:",m)}finally{b(!1)}})()},[t.id,t.status]);const S=te({mutationFn:async r=>{b(!0);const m=await z("GET",`/api/payment-receipt/${r}`);if(!m.ok)try{const g=await m.json();throw new Error(g.message||"Erreur lors de la génération du reçu")}catch{throw new Error("Erreur lors de la génération du reçu")}const v=await m.json();if(v.generatePdf&&v.receiptData){const{jsPDF:g}=await Pe(async()=>{const{jsPDF:d}=await import("./jspdf.es.min-BI5bkCKM.js").then(i=>i.j);return{jsPDF:d}},__vite__mapDeps([0,1,2])),a=new g,l=v.receiptData,X=(d,i,u,f)=>{const J=new Date().toISOString(),O=`${l.paymentId}-${l.clientEmail}-${l.amount}-${l.referenceNumber}`;let C=0;for(let se=0;se<O.length;se++){const Ne=O.charCodeAt(se);C=(C<<5)-C+Ne,C=C&C}const je=new Date(l.date).getTime();C=C^je;const ge=Math.abs(C).toString(16).toUpperCase().substring(0,6);i.setFont("courier","normal"),i.setFontSize(9),i.text("SIGNATURE ELECTRONIQUE",u,f),i.text(`Signataire: ${d}`,u,f+4),i.text(`Horodatage: ${J}`,u,f+8),i.text(`Hash transaction: D0A${ge}`,u,f+12),i.text("Conforme au reglement eIDAS (UE) 910/2014",u,f+16),i.setLineWidth(.8),i.setDrawColor(0,102,204),i.rect(u-2,f-3,125,22)};a.setFontSize(18),a.setFont("helvetica","bold"),a.text("DEVOIR DE CONSEIL ET RECU DE PAIEMENT",105,18,{align:"center"}),a.setFontSize(9),a.setFont("helvetica","normal"),a.text("Conformement aux articles L. 111-1 et L. 312-1-1 du Code de la consommation",105,25,{align:"center"}),a.setFontSize(12),a.setFont("helvetica","normal"),a.text("Assistance au raccordement Electrique d'Enedis",105,32,{align:"center"}),a.setLineWidth(.8),a.line(20,38,190,38);let n=45;const K=4.8,Z=65;a.setFontSize(9),[["Numero de reference:",l.referenceNumber],["ID de paiement Stripe:",l.paymentId],["Date de transaction:",l.date],["Nom et prenom:",l.clientName||"Non renseigne"],["Adresse email:",l.clientEmail||"Non renseignee"],["Numero de telephone:",l.clientPhone||"Non renseigne"],["Adresse:",l.address!=="N/A"?l.address:"Non renseignee"],["Montant paye:",l.amount],["Methode de paiement:","Carte bancaire via lien securise Stripe"],["Statut de la transaction:","PAYE"]].forEach(([d,i])=>{a.setFont("helvetica","bold"),a.text(d,20,n),a.setFont("helvetica","normal");const u=i||"Non renseigne",f=u.length>60?u.substring(0,57)+"...":u;a.text(f,20+Z,n),n+=K}),n+=2,a.setFont("helvetica","bold"),a.setFontSize(10),a.text("OBJET DE LA COMMANDE:",20,n),n+=5,a.setFont("helvetica","normal"),a.setFontSize(8),a.text("Accompagnement personnalise dans les demarches de raccordement electrique aupres du fournisseur Enedis.",20,n),n+=8,a.setFontSize(10),a.setFont("helvetica","bold"),a.text("CONSENTEMENT DU CLIENT",20,n),n+=6,a.setFontSize(7),a.setFont("helvetica","normal"),a.text("Le client a :",20,n),n+=K,["• Valide le paiement en toute connaissance de cause, apres affichage clair du prix TTC et confirmation explicite du montant total incluant toutes les taxes et frais applicables.","• Accepte sans reserve les Conditions Generales de Vente (CGV), les Conditions Generales d'Utilisation (CGU), ainsi que la Politique de confidentialite et de gestion des cookies via case a cocher obligatoire prealablement au paiement.","• Reconnu expressement que la prestation d'accompagnement aux demarches administratives aupres d'Enedis commence immediatement apres validation du paiement, conformement aux dispositions de l'article L221-28 du Code de la consommation relatif au droit de retractation.","• Comprend parfaitement que notre service consiste exclusivement en un accompagnement personnalise et une assistance administrative pour faciliter les demarches de raccordement electrique aupres du gestionnaire de reseau Enedis, incluant la preparation complete des documents techniques et le suivi administratif personnalise.","• Fourni volontairement et en toute conscience ses coordonnees personnelles completes (nom, prenom, adresse postale complete, adresse email valide, numero de telephone) necessaires au traitement de sa demande de raccordement electrique."].forEach(d=>{a.splitTextToSize(d,170).forEach(f=>{a.text(f,20,n),n+=3.2}),n+=.5}),n+=16,a.setFontSize(10),a.setFont("helvetica","bold"),a.text("SIGNATURE",20,n),n+=5,a.setFontSize(8),a.setFont("helvetica","normal");const ee=`Je soussigne(e), ${l.clientName}, confirme avoir lu, compris et accepte l'ensemble des informations mentionnees ci-dessus.`,s=175,c=ee.split(" ");let o="";c.forEach((d,i)=>{const u=o+(o?" ":"")+d;a.getTextWidth(u)>s&&o?(a.text(o,20,n),n+=3.5,o=d):o=u,i===c.length-1&&o&&(a.text(o,20,n),n+=4)}),a.setFont("helvetica","bold"),a.text(`Nom et prenom: ${l.clientName}`,20,n),n+=4,a.text(`Numero de telephone: ${l.clientPhone||"Non renseigne"}`,20,n),n+=4,a.text(`Fait le: ${l.date}`,20,n),n+=6,a.setFont("helvetica","normal"),a.text("Signature electronique:",20,n),n+=4,X(l.clientName,a,20,n);const p=270;return a.setLineWidth(.8),a.line(20,p-8,190,p-8),a.setFontSize(9),a.setFont("helvetica","bold"),a.text("HADDAOUI LLC",20,p),a.setFont("helvetica","normal"),a.text("61 Bridge Street, Kington, England, HR5 3DJ - Company number: 14112679",20,p+4),a.setFontSize(8),a.text("Pour toute reclamation ou assistance: contact@demande-raccordement.fr",20,p+8),a.text("Copyright 2025 - Tous droits reserves",20,p+11),a.save(l.fileName),{success:!0,downloaded:!0,fileName:l.fileName}}return v},onSuccess:r=>{r.downloaded&&r.fileName?(y({exists:!0,receiptUrl:null}),B({title:"Téléchargement réussi",description:`Le reçu PDF a été téléchargé: ${r.fileName}`,duration:5e3})):r.receiptUrl&&(y({exists:!0,receiptUrl:r.receiptUrl}),window.open(r.receiptUrl,"_blank"))},onError:r=>{console.error("Erreur lors de la génération du reçu:",r),alert(`Erreur lors de la génération du reçu: ${r.message||"Veuillez réessayer"}`)},onSettled:()=>{b(!1)}}),D=()=>{L(!0)},k=()=>{L(!1),x!=null&&x.exists&&x.receiptUrl?window.open(x.receiptUrl,"_blank"):S.mutate(t.id)},W=te({mutationFn:async r=>(await z("POST",`/api/payments/cancel/${r}`)).json(),onSuccess:()=>{re.invalidateQueries({queryKey:["/api/stripe/payments"]}),alert("Le paiement a été marqué comme annulé avec succès.")},onError:r=>{console.error("Erreur lors de l'annulation du paiement:",r),alert(`Erreur lors de l'annulation du paiement: ${r.message||"Veuillez réessayer"}`)}}),I=te({mutationFn:async r=>(await z("POST",`/api/payments/refund/${r}`)).json(),onSuccess:()=>{re.invalidateQueries({queryKey:["/api/stripe/payments"]}),alert("Le paiement a été marqué comme remboursé avec succès.")},onError:r=>{console.error("Erreur lors du remboursement du paiement:",r),alert(`Erreur lors du remboursement du paiement: ${r.message||"Veuillez réessayer"}`)}}),F=()=>{window.confirm(`CONFIRMATION REQUISE

Êtes-vous sûr de vouloir annuler le paiement ${t.referenceNumber} ?

Cette action changera uniquement le statut du paiement dans notre CRM.

Les actions sur Stripe sont gérées directement par le propriétaire du compte Stripe.

Cliquez sur OK pour confirmer le changement de statut.`)&&W.mutate(t.id)},_=()=>{window.confirm(`CONFIRMATION REQUISE

Êtes-vous sûr de vouloir marquer le paiement ${t.referenceNumber} comme remboursé ?

Cette action changera uniquement le statut du paiement dans notre CRM.

Les actions sur Stripe sont gérées directement par le propriétaire du compte Stripe.

Cliquez sur OK pour confirmer le changement de statut.`)&&I.mutate(t.id)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Référence"}),e.jsx("p",{className:"font-medium",children:t.referenceNumber})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Montant"}),t.status==="succeeded"||t.status==="paid"?e.jsx("p",{className:"font-bold text-green-700",children:w(t.amount)}):t.status==="processing"?e.jsx("p",{className:"font-bold text-blue-600",children:w(t.amount)}):t.status==="refunded"?e.jsx("p",{className:"font-bold text-purple-600 line-through",children:w(t.amount)}):e.jsx("p",{className:"font-bold text-gray-500",children:w(t.amount)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Date"}),e.jsx("p",{children:Y(t.createdAt)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Statut"}),e.jsx("div",{className:"mt-1",children:e.jsx("div",{className:"flex items-center",children:t.status==="succeeded"||t.status==="paid"?e.jsxs("div",{className:"flex items-center bg-green-50 text-green-800 px-3 py-1 rounded-md border border-green-200",children:[e.jsx(xe,{className:"h-4 w-4 mr-2 text-green-600"}),e.jsx("span",{className:"font-medium",children:"Paiement réussi"})]}):t.status==="processing"?e.jsxs("div",{className:"flex items-center bg-blue-50 text-blue-800 px-3 py-1 rounded-md border border-blue-200",children:[e.jsx(he,{className:"h-4 w-4 mr-2 text-blue-600"}),e.jsx("span",{className:"font-medium",children:"En traitement"})]}):t.status==="refunded"?e.jsxs("div",{className:"flex items-center bg-purple-50 text-purple-800 px-3 py-1 rounded-md border border-purple-200",children:[e.jsx(V,{className:"h-4 w-4 mr-2 text-purple-600"}),e.jsx("span",{className:"font-medium",children:"Remboursé"})]}):t.status==="failed"?e.jsxs("div",{className:"flex items-center bg-red-50 text-red-800 px-3 py-1 rounded-md border border-red-200",children:[e.jsx($,{className:"h-4 w-4 mr-2 text-red-600"}),e.jsx("span",{className:"font-medium",children:"Paiement échoué"})]}):e.jsxs("div",{className:"flex items-center bg-gray-50 text-gray-800 px-3 py-1 rounded-md border border-gray-200",children:[e.jsx(pe,{className:"h-4 w-4 mr-2 text-orange-600"}),e.jsx("span",{className:"font-medium",children:"Paiement abandonné"})]})})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Client"}),e.jsx("p",{children:t.customerName||t.billingName||((H=t.metadata)==null?void 0:H.customerName)||"Non spécifié"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Email"}),e.jsx("p",{children:t.customerEmail||((Q=t.metadata)==null?void 0:Q.customerEmail)||"Non spécifié"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500",children:"Méthode de paiement"}),e.jsx("p",{children:t.paymentMethod||"Carte de crédit"})]})]}),T&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 mb-3",children:"Informations de paiement"}),e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-100",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"col-span-1 md:col-span-2 mb-1",children:e.jsx("h4",{className:"text-xs font-semibold text-blue-700 uppercase tracking-wider border-b border-blue-200 pb-1 mb-3",children:"Détails de la transaction"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500",children:"ID de transaction"}),e.jsx("p",{className:"font-mono text-xs",children:t.id})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500",children:"Date de transaction"}),e.jsx("p",{children:Y(t.createdAt)})]}),e.jsx("div",{className:"col-span-1 md:col-span-2 mt-3 mb-1",children:e.jsx("h4",{className:"text-xs font-semibold text-blue-700 uppercase tracking-wider border-b border-blue-200 pb-1 mb-3",children:"Carte bancaire"})}),t.cardBrand&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500",children:"Type de carte"}),e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(ne,{className:"h-4 w-4 mr-2 text-blue-600"}),e.jsx("p",{className:"capitalize font-medium",children:t.cardBrand})]})]}),t.cardLast4&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500",children:"Numéro de carte (4 derniers chiffres)"}),e.jsx("p",{className:"font-medium text-base",children:t.cardLast4}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Seuls les 4 derniers chiffres sont disponibles pour des raisons de sécurité PCI DSS"})]}),t.bankName&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500",children:"Banque émettrice"}),e.jsx("p",{className:"font-medium",children:t.bankName})]}),t.cardExpMonth&&t.cardExpYear&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500",children:"Date d'expiration"}),e.jsxs("p",{className:"font-medium",children:[t.cardExpMonth.toString().padStart(2,"0"),"/",t.cardExpYear]})]}),t.billingName&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500",children:"Titulaire de la carte"}),e.jsx("p",{className:"font-medium",children:t.billingName})]})]})})]}),t.metadata&&Object.keys(t.metadata).length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-2",children:"Métadonnées"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded-md text-sm",children:e.jsx("pre",{className:"whitespace-pre-wrap",children:JSON.stringify(t.metadata,null,2)})})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4 border-t",children:[e.jsxs(j,{variant:"outline",size:"sm",onClick:r=>{r.stopPropagation(),window.dispatchEvent(new CustomEvent("refresh-payment-details",{detail:{paymentId:t.id}}))},children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Actualiser"]}),(t.status==="succeeded"||t.status==="paid"||t.status==="processing")&&e.jsx(j,{variant:"destructive",size:"sm",onClick:r=>{r.stopPropagation(),F()},disabled:W.isPending,children:W.isPending?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),"Annulation..."]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Annuler paiement"]})}),(t.status==="succeeded"||t.status==="paid")&&e.jsx(j,{variant:"outline",size:"sm",onClick:r=>{r.stopPropagation(),_()},disabled:I.isPending,children:I.isPending?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),"Traitement..."]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Marquer remboursé"]})}),(t.status==="succeeded"||t.status==="paid")&&e.jsx(j,{variant:"outline",size:"sm",onClick:r=>{r.stopPropagation(),D()},disabled:A||S.isPending,className:"bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100 hover:text-blue-800",children:A||S.isPending?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),x!=null&&x.exists?"Chargement...":"Génération..."]}):x!=null&&x.exists?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Voir reçu"]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Générer reçu"]})}),t.status==="failed"&&e.jsxs(j,{variant:"destructive",size:"sm",onClick:r=>{r.stopPropagation(),confirm(`CONFIRMATION REQUISE

Voulez-vous envoyer un rappel au client pour ce paiement échoué?

Un email sera envoyé à l'adresse: `+(t.customerEmail||"Non spécifiée")+`

Ce rappel est uniquement géré par notre CRM et n'effectue aucune action sur Stripe.

Cliquez sur OK pour confirmer l'envoi du rappel.`)&&fetch(`/api/send-payment-reminder/${t.id}`,{method:"POST"}).then(m=>m.json()).then(m=>{alert(m.success?"Rappel envoyé avec succès!":"Erreur lors de l'envoi du rappel: "+(m.message||"Veuillez réessayer"))}).catch(m=>{console.error("Erreur lors de l'envoi du rappel:",m),alert("Erreur lors de l'envoi du rappel: Veuillez réessayer plus tard")})},children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Rappel client"]})]}),e.jsx(we,{open:G,onOpenChange:L,children:e.jsxs(Ee,{className:"sm:max-w-[500px]",children:[e.jsx(Ce,{children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(Se,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(De,{className:"text-lg font-semibold text-gray-900",children:"Téléchargement de reçu de paiement"}),e.jsx(Fe,{className:"text-sm text-gray-600",children:"Document légal avec signature électronique authentique"})]})]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ae,{className:"h-5 w-5 text-blue-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:"font-medium text-blue-900 mb-1",children:["Reçu de paiement - Référence ",t.referenceNumber]}),e.jsx("p",{className:"text-sm text-blue-700",children:"Document PDF avec signature électronique D0A authentique et protection anti-litiges"})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:"Montant:"}),e.jsx("p",{className:"text-gray-900",children:w(t.amount)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:"Date:"}),e.jsx("p",{className:"text-gray-900",children:Y(t.createdAt)})]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ue,{className:"h-4 w-4 text-amber-600 mt-0.5"}),e.jsxs("div",{className:"text-xs text-amber-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Signature électronique authentique"}),e.jsx("p",{children:"Ce reçu contient une signature cryptographique basée sur les données réelles de la transaction Stripe, conforme aux exigences légales françaises."})]})]})})]}),e.jsxs(ye,{className:"flex-col sm:flex-row gap-2",children:[e.jsx(j,{variant:"outline",onClick:()=>L(!1),className:"w-full sm:w-auto",children:"Annuler"}),e.jsx(j,{onClick:k,className:"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white",disabled:A||S.isPending,children:A||S.isPending?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),x!=null&&x.exists?"Chargement...":"Génération..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Confirmer le téléchargement"]})})]})]})})]})}function hs(){ue();const[t,B]=h.useState(""),[T,x]=h.useState(null);h.useState("today");const[y,A]=h.useState("month"),[b,G]=h.useState(null),[L,S]=h.useState(!1),[D,k]=h.useState(1),[W,I]=h.useState(!1);h.useEffect(()=>{(async()=>{try{I(!0),await z("GET","/api/stripe/sync-today"),re.invalidateQueries({queryKey:["/api/stripe/rac-payments"]})}catch(c){console.log("Sync Stripe silencieux:",c)}finally{I(!1)}})()},[]);const F=20,{data:_=[],isLoading:H,error:Q,refetch:r}=Te({queryKey:["/api/stripe/rac-payments"],queryFn:Re({on401:"throw"}),refetchOnWindowFocus:!1,staleTime:3e4}),m=s=>{const c=new Date;return c.setHours(0,0,0,0),s.filter(o=>new Date(o.createdAt)>=c)},v=(s,c)=>{if(c==="all")return s;const o=new Date;return s.filter(p=>{const d=new Date(p.createdAt);if(c==="today"){const i=new Date;return i.setHours(0,0,0,0),d>=i}else if(c==="week"){const i=new Date(o);return i.setDate(o.getDate()-7),d>=i}else if(c==="month"){const i=new Date(o.getFullYear(),o.getMonth(),1);return d>=i}return!0})},g=m(_),a=g.filter(s=>s.status==="succeeded"||s.status==="paid").length,l=g.filter(s=>s.status==="failed"||s.status==="canceled"||s.status==="requires_payment_method").length,X=g.filter(s=>s.status==="abandoned").length,n=g.filter(s=>s.status==="processing"||s.status==="pending").length,K=g.filter(s=>s.status==="refunded").length,Z=g.filter(s=>s.status==="succeeded"||s.status==="paid").reduce((s,c)=>s+c.amount,0),E=v(_,y).filter(s=>{var d;if(!((d=s.referenceNumber)==null?void 0:d.startsWith("RAC-")))return!1;const o=!t||s.referenceNumber.toLowerCase().includes(t.toLowerCase())||s.customerEmail&&s.customerEmail.toLowerCase().includes(t.toLowerCase())||s.customerName&&s.customerName.toLowerCase().includes(t.toLowerCase()),p=!T||s.status===T;return o&&p});h.useEffect(()=>{k(1)},[y,t,T]);const ie=s=>{G(s),S(!0)},ee=async()=>{if(b)try{const s=await z("GET",`/api/payments/${b.id}`);if(!s.ok)throw new Error("Erreur lors du chargement des détails du paiement");const c=await s.json();G(c),r()}catch(s){console.error("Erreur lors du rafraîchissement des détails:",s)}};return h.useEffect(()=>{const s=c=>{ee()};return window.addEventListener("refresh-payment-details",s),()=>{window.removeEventListener("refresh-payment-details",s)}},[b]),e.jsx(Ae,{title:"Suivi des paiements",description:"Suivez et gérez tous les paiements en temps réel",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(P,{className:"bg-green-50 border-green-100",children:e.jsxs(R,{className:"p-4 flex flex-col items-center justify-center",children:[e.jsx(xe,{className:"h-8 w-8 text-green-600 mb-1"}),e.jsx("p",{className:"text-xl font-bold text-green-800",children:a}),e.jsx("p",{className:"text-xs text-green-700",children:"Réussis"})]})}),e.jsx(P,{className:"bg-yellow-50 border-yellow-100",children:e.jsxs(R,{className:"p-4 flex flex-col items-center justify-center",children:[e.jsx(he,{className:"h-8 w-8 text-yellow-600 mb-1"}),e.jsx("p",{className:"text-xl font-bold text-yellow-800",children:n}),e.jsx("p",{className:"text-xs text-yellow-700",children:"En cours"})]})}),e.jsx(P,{className:"bg-red-50 border-red-100",children:e.jsxs(R,{className:"p-4 flex flex-col items-center justify-center",children:[e.jsx($,{className:"h-8 w-8 text-red-600 mb-1"}),e.jsx("p",{className:"text-xl font-bold text-red-800",children:l}),e.jsx("p",{className:"text-xs text-red-700",children:"Échoués"})]})}),e.jsx(P,{className:"bg-orange-50 border-orange-100",children:e.jsxs(R,{className:"p-4 flex flex-col items-center justify-center",children:[e.jsx(pe,{className:"h-8 w-8 text-orange-600 mb-1"}),e.jsx("p",{className:"text-xl font-bold text-orange-800",children:X}),e.jsx("p",{className:"text-xs text-orange-700",children:"Abandonnés"})]})}),e.jsx(P,{className:"bg-purple-50 border-purple-100",children:e.jsxs(R,{className:"p-4 flex flex-col items-center justify-center",children:[e.jsx(V,{className:"h-8 w-8 text-purple-600 mb-1"}),e.jsx("p",{className:"text-xl font-bold text-purple-800",children:K}),e.jsx("p",{className:"text-xs text-purple-700",children:"Remboursés"})]})}),e.jsx(P,{className:"bg-blue-50 border-blue-100",children:e.jsxs(R,{className:"p-4 flex flex-col items-center justify-center",children:[e.jsx(ne,{className:"h-8 w-8 text-blue-600 mb-1"}),e.jsx("p",{className:"text-xl font-bold text-blue-800",children:w(Z)}),e.jsx("p",{className:"text-xs text-blue-700",children:"Total encaissé"})]})})]}),e.jsxs(P,{children:[e.jsx(Le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(Ie,{children:"Liste des paiements"})}),e.jsxs(j,{variant:"outline",size:"sm",children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Exporter"]})]})}),e.jsxs(R,{children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Oe,{className:"absolute h-4 w-4 top-3 left-3 text-gray-400"}),e.jsx(be,{placeholder:"Rechercher par référence, client ou email...",className:"pl-10",value:t,onChange:s=>B(s.target.value)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ce,{value:T||"all",onValueChange:s=>x(s==="all"?null:s),children:[e.jsx(oe,{className:"w-[180px]",children:e.jsx(de,{placeholder:"Tous les statuts"})}),e.jsxs(me,{children:[e.jsx(N,{value:"all",children:"Tous les statuts"}),e.jsx(N,{value:"succeeded",children:"Réussis"}),e.jsx(N,{value:"paid",children:"Payés"}),e.jsx(N,{value:"processing",children:"En cours"}),e.jsx(N,{value:"failed",children:"Échoués"}),e.jsx(N,{value:"abandoned",children:"Abandonnés"}),e.jsx(N,{value:"refunded",children:"Remboursés"})]})]}),e.jsxs(ce,{value:y,onValueChange:A,children:[e.jsx(oe,{className:"w-[180px]",children:e.jsx(de,{placeholder:"Période"})}),e.jsxs(me,{children:[e.jsx(N,{value:"all",children:"Tout l'historique"}),e.jsx(N,{value:"month",children:"Ce mois"}),e.jsx(N,{value:"week",children:"7 derniers jours"}),e.jsx(N,{value:"today",children:"Aujourd'hui"})]})]})]})]}),H?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx(U,{className:"h-8 w-8 animate-spin text-blue-600"})}):Q?e.jsxs("div",{className:"text-center py-12",children:[e.jsx($,{className:"h-10 w-10 text-red-500 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-600 mb-3",children:"Une erreur est survenue lors du chargement des paiements"}),e.jsxs(j,{variant:"outline",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Réessayer"]})]}):E.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ne,{className:"h-10 w-10 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-600",children:"Aucun paiement ne correspond à vos critères de recherche"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Me,{children:[e.jsx(qe,{children:e.jsxs(le,{children:[e.jsx(M,{children:"Référence"}),e.jsx(M,{children:"Date"}),e.jsx(M,{children:"Client"}),e.jsx(M,{children:"Montant"}),e.jsx(M,{children:"Statut"}),e.jsx(M,{children:"Détails"})]})}),e.jsx(ze,{children:E.slice((D-1)*F,D*F).map(s=>{var c,o,p,d,i,u,f,J,O;return e.jsxs(le,{children:[e.jsx(q,{className:"font-medium",children:s.referenceNumber||((c=s.metadata)==null?void 0:c.referenceNumber)||((o=s.metadata)==null?void 0:o.reference)||s.id}),e.jsx(q,{children:Y(s.createdAt)}),e.jsx(q,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.customerName||s.billingName||((p=s.metadata)==null?void 0:p.customerName)||((d=s.metadata)!=null&&d.prenom&&((i=s.metadata)!=null&&i.nom)?`${s.metadata.prenom} ${s.metadata.nom}`:((u=s.metadata)==null?void 0:u.prenom)||((f=s.metadata)==null?void 0:f.nom)||"Non spécifié")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.customerEmail||((J=s.metadata)==null?void 0:J.customerEmail)||((O=s.metadata)==null?void 0:O.email)||"Email non disponible"})]})}),e.jsx(q,{children:s.status==="succeeded"||s.status==="paid"?e.jsx("span",{className:"text-green-700 font-medium",children:w(s.amount)}):s.status==="processing"?e.jsx("span",{className:"text-blue-600",children:w(s.amount)}):s.status==="refunded"?e.jsx("span",{className:"text-purple-600 line-through",children:w(s.amount)}):e.jsx("span",{className:"text-gray-500",children:w(s.amount)})}),e.jsx(q,{children:e.jsx(ke,{className:s.status==="succeeded"||s.status==="paid"?"bg-green-100 text-green-800 hover:bg-green-200":s.status==="processing"?"bg-blue-100 text-blue-800 hover:bg-blue-200":s.status==="refunded"?"bg-purple-100 text-purple-800 hover:bg-purple-200":"bg-red-100 text-red-800 hover:bg-red-200",children:s.status==="succeeded"||s.status==="paid"?"Réussi":s.status==="processing"?"En cours":s.status==="refunded"?"Remboursé":s.status==="failed"?"Échoué":"Abandonné"})}),e.jsx(q,{children:e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>ie(s),children:"Voir détails"})})]},s.id)})})]})}),E.length>0&&e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Affichage de ",Math.min((D-1)*F+1,E.length)," à ",Math.min(D*F,E.length)," sur ",E.length," paiements"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{variant:"outline",size:"sm",onClick:()=>k(s=>Math.max(1,s-1)),disabled:D===1,children:"Précédent"}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>k(s=>Math.min(Math.ceil(E.length/F),s+1)),disabled:D>=Math.ceil(E.length/F),children:"Suivant"})]})]})]})]}),L&&b&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center",children:e.jsx("div",{className:"bg-white rounded-lg w-full max-w-2xl max-h-[80vh] overflow-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Détails du paiement"}),e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>S(!1),children:e.jsx($,{className:"h-5 w-5"})})]}),e.jsx($e,{payment:b})]})})})]})})}export{hs as default};
