var de=t=>{throw TypeError(t)};var K=(t,e,s)=>e.has(t)||de("Cannot "+s);var r=(t,e,s)=>(K(t,e,"read from private field"),s?s.call(t):e.get(t)),g=(t,e,s)=>e.has(t)?de("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),d=(t,e,s,n)=>(K(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s),m=(t,e,s)=>(K(t,e,"access private method"),s);import{ax as we,ay as fe,az as T,aA as X,aB as q,aC as Ie,aD as Z,aE as pe,aF as ke,aG as Oe,aH as xe,aI as me,aJ as Ce,r as w,aK as De,aL as Ue,aM as ge,c as Qe,a as Fe,e as Y,ae as V,m as ve}from"./index-DHUCxmvZ.js";var R,o,B,S,U,L,O,E,N,P,j,Q,F,x,_,l,$,ee,te,se,re,ie,ne,ae,Ee,Re,Me=(Re=class extends we{constructor(e,s){super();g(this,l);g(this,R);g(this,o);g(this,B);g(this,S);g(this,U);g(this,L);g(this,O);g(this,E);g(this,N);g(this,P);g(this,j);g(this,Q);g(this,F);g(this,x);g(this,_,new Set);this.options=s,d(this,R,e),d(this,E,null),d(this,O,fe()),this.options.experimental_prefetchInRender||r(this,O).reject(new Error("experimental_prefetchInRender feature flag is not enabled")),this.bindMethods(),this.setOptions(s)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(r(this,o).addObserver(this),ye(r(this,o),this.options)?m(this,l,$).call(this):this.updateResult(),m(this,l,re).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return oe(r(this,o),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return oe(r(this,o),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,m(this,l,ie).call(this),m(this,l,ne).call(this),r(this,o).removeObserver(this)}setOptions(e,s){const n=this.options,f=r(this,o);if(this.options=r(this,R).defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof T(this.options.enabled,r(this,o))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");m(this,l,ae).call(this),r(this,o).setOptions(this.options),n._defaulted&&!X(this.options,n)&&r(this,R).getQueryCache().notify({type:"observerOptionsUpdated",query:r(this,o),observer:this});const u=this.hasListeners();u&&Se(r(this,o),f,this.options,n)&&m(this,l,$).call(this),this.updateResult(s),u&&(r(this,o)!==f||T(this.options.enabled,r(this,o))!==T(n.enabled,r(this,o))||q(this.options.staleTime,r(this,o))!==q(n.staleTime,r(this,o)))&&m(this,l,ee).call(this);const c=m(this,l,te).call(this);u&&(r(this,o)!==f||T(this.options.enabled,r(this,o))!==T(n.enabled,r(this,o))||c!==r(this,x))&&m(this,l,se).call(this,c)}getOptimisticResult(e){const s=r(this,R).getQueryCache().build(r(this,R),e),n=this.createResult(s,e);return Le(this,n)&&(d(this,S,n),d(this,L,this.options),d(this,U,r(this,o).state)),n}getCurrentResult(){return r(this,S)}trackResult(e,s){const n={};return Object.keys(e).forEach(f=>{Object.defineProperty(n,f,{configurable:!1,enumerable:!0,get:()=>(this.trackProp(f),s==null||s(f),e[f])})}),n}trackProp(e){r(this,_).add(e)}getCurrentQuery(){return r(this,o)}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const s=r(this,R).defaultQueryOptions(e),n=r(this,R).getQueryCache().build(r(this,R),s);return n.fetch().then(()=>this.createResult(n,s))}fetch(e){return m(this,l,$).call(this,{...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),r(this,S)))}createResult(e,s){var he;const n=r(this,o),f=this.options,u=r(this,S),c=r(this,U),v=r(this,L),a=e!==n?e.state:r(this,B),{state:h}=e;let p={...h},D=!1,b;if(s._optimisticResults){const y=this.hasListeners(),M=!y&&ye(e,s),A=y&&Se(e,n,s,f);(M||A)&&(p={...p,...xe(h.data,e.options)}),s._optimisticResults==="isRestoring"&&(p.fetchStatus="idle")}let{error:H,errorUpdatedAt:k,status:I}=p;if(s.select&&p.data!==void 0)if(u&&p.data===(c==null?void 0:c.data)&&s.select===r(this,N))b=r(this,P);else try{d(this,N,s.select),b=s.select(p.data),b=me(u==null?void 0:u.data,b,s),d(this,P,b),d(this,E,null)}catch(y){d(this,E,y)}else b=p.data;if(s.placeholderData!==void 0&&b===void 0&&I==="pending"){let y;if(u!=null&&u.isPlaceholderData&&s.placeholderData===(v==null?void 0:v.placeholderData))y=u.data;else if(y=typeof s.placeholderData=="function"?s.placeholderData((he=r(this,j))==null?void 0:he.state.data,r(this,j)):s.placeholderData,s.select&&y!==void 0)try{y=s.select(y),d(this,E,null)}catch(M){d(this,E,M)}y!==void 0&&(I="success",b=me(u==null?void 0:u.data,y,s),D=!0)}r(this,E)&&(H=r(this,E),b=r(this,P),k=Date.now(),I="error");const J=p.fetchStatus==="fetching",W=I==="pending",G=I==="error",le=W&&J,ue=b!==void 0,C={status:I,fetchStatus:p.fetchStatus,isPending:W,isSuccess:I==="success",isError:G,isInitialLoading:le,isLoading:le,data:b,dataUpdatedAt:p.dataUpdatedAt,error:H,errorUpdatedAt:k,failureCount:p.fetchFailureCount,failureReason:p.fetchFailureReason,errorUpdateCount:p.errorUpdateCount,isFetched:p.dataUpdateCount>0||p.errorUpdateCount>0,isFetchedAfterMount:p.dataUpdateCount>a.dataUpdateCount||p.errorUpdateCount>a.errorUpdateCount,isFetching:J,isRefetching:J&&!W,isLoadingError:G&&!ue,isPaused:p.fetchStatus==="paused",isPlaceholderData:D,isRefetchError:G&&ue,isStale:ce(e,s),refetch:this.refetch,promise:r(this,O)};if(this.options.experimental_prefetchInRender){const y=z=>{C.status==="error"?z.reject(C.error):C.data!==void 0&&z.resolve(C.data)},M=()=>{const z=d(this,O,C.promise=fe());y(z)},A=r(this,O);switch(A.status){case"pending":e.queryHash===n.queryHash&&y(A);break;case"fulfilled":(C.status==="error"||C.data!==A.value)&&M();break;case"rejected":(C.status!=="error"||C.error!==A.reason)&&M();break}}return C}updateResult(e){const s=r(this,S),n=this.createResult(r(this,o),this.options);if(d(this,U,r(this,o).state),d(this,L,this.options),r(this,U).data!==void 0&&d(this,j,r(this,o)),X(n,s))return;d(this,S,n);const f={},u=()=>{if(!s)return!0;const{notifyOnChangeProps:c}=this.options,v=typeof c=="function"?c():c;if(v==="all"||!v&&!r(this,_).size)return!0;const i=new Set(v??r(this,_));return this.options.throwOnError&&i.add("error"),Object.keys(r(this,S)).some(a=>{const h=a;return r(this,S)[h]!==s[h]&&i.has(h)})};(e==null?void 0:e.listeners)!==!1&&u()&&(f.listeners=!0),m(this,l,Ee).call(this,{...f,...e})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&m(this,l,re).call(this)}},R=new WeakMap,o=new WeakMap,B=new WeakMap,S=new WeakMap,U=new WeakMap,L=new WeakMap,O=new WeakMap,E=new WeakMap,N=new WeakMap,P=new WeakMap,j=new WeakMap,Q=new WeakMap,F=new WeakMap,x=new WeakMap,_=new WeakMap,l=new WeakSet,$=function(e){m(this,l,ae).call(this);let s=r(this,o).fetch(this.options,e);return e!=null&&e.throwOnError||(s=s.catch(Ie)),s},ee=function(){m(this,l,ie).call(this);const e=q(this.options.staleTime,r(this,o));if(Z||r(this,S).isStale||!pe(e))return;const n=ke(r(this,S).dataUpdatedAt,e)+1;d(this,Q,setTimeout(()=>{r(this,S).isStale||this.updateResult()},n))},te=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(r(this,o)):this.options.refetchInterval)??!1},se=function(e){m(this,l,ne).call(this),d(this,x,e),!(Z||T(this.options.enabled,r(this,o))===!1||!pe(r(this,x))||r(this,x)===0)&&d(this,F,setInterval(()=>{(this.options.refetchIntervalInBackground||Oe.isFocused())&&m(this,l,$).call(this)},r(this,x)))},re=function(){m(this,l,ee).call(this),m(this,l,se).call(this,m(this,l,te).call(this))},ie=function(){r(this,Q)&&(clearTimeout(r(this,Q)),d(this,Q,void 0))},ne=function(){r(this,F)&&(clearInterval(r(this,F)),d(this,F,void 0))},ae=function(){const e=r(this,R).getQueryCache().build(r(this,R),this.options);if(e===r(this,o))return;const s=r(this,o);d(this,o,e),d(this,B,e.state),this.hasListeners()&&(s==null||s.removeObserver(this),e.addObserver(this))},Ee=function(e){Ce.batch(()=>{e.listeners&&this.listeners.forEach(s=>{s(r(this,S))}),r(this,R).getQueryCache().notify({query:r(this,o),type:"observerResultsUpdated"})})},Re);function Ae(t,e){return T(e.enabled,t)!==!1&&t.state.data===void 0&&!(t.state.status==="error"&&e.retryOnMount===!1)}function ye(t,e){return Ae(t,e)||t.state.data!==void 0&&oe(t,e,e.refetchOnMount)}function oe(t,e,s){if(T(e.enabled,t)!==!1){const n=typeof s=="function"?s(t):s;return n==="always"||n!==!1&&ce(t,e)}return!1}function Se(t,e,s,n){return(t!==e||T(n.enabled,t)===!1)&&(!s.suspense||t.state.status!=="error")&&ce(t,s)}function ce(t,e){return T(e.enabled,t)!==!1&&t.isStaleByTime(q(e.staleTime,t))}function Le(t,e){return!X(t.getCurrentResult(),e)}var Te=w.createContext(!1),Pe=()=>w.useContext(Te);Te.Provider;function je(){let t=!1;return{clearReset:()=>{t=!1},reset:()=>{t=!0},isReset:()=>t}}var _e=w.createContext(je()),He=()=>w.useContext(_e),$e=(t,e)=>{(t.suspense||t.throwOnError||t.experimental_prefetchInRender)&&(e.isReset()||(t.retryOnMount=!1))},Be=t=>{w.useEffect(()=>{t.clearReset()},[t])},Ne=({result:t,errorResetBoundary:e,throwOnError:s,query:n})=>t.isError&&!e.isReset()&&!t.isFetching&&n&&De(s,[t.error,n]),ze=t=>{t.suspense&&(t.staleTime===void 0&&(t.staleTime=1e3),typeof t.gcTime=="number"&&(t.gcTime=Math.max(t.gcTime,1e3)))},Ve=(t,e)=>t.isLoading&&t.isFetching&&!e,qe=(t,e)=>(t==null?void 0:t.suspense)&&e.isPending,be=(t,e,s)=>e.fetchOptimistic(t).catch(()=>{s.clearReset()});function Je(t,e,s){var h,p,D,b,H;const n=Ue(),f=Pe(),u=He(),c=n.defaultQueryOptions(t);(p=(h=n.getDefaultOptions().queries)==null?void 0:h._experimental_beforeQuery)==null||p.call(h,c),c._optimisticResults=f?"isRestoring":"optimistic",ze(c),$e(c,u),Be(u);const v=!n.getQueryCache().get(c.queryHash),[i]=w.useState(()=>new e(n,c)),a=i.getOptimisticResult(c);if(w.useSyncExternalStore(w.useCallback(k=>{const I=f?ge:i.subscribe(Ce.batchCalls(k));return i.updateResult(),I},[i,f]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),w.useEffect(()=>{i.setOptions(c,{listeners:!1})},[c,i]),qe(c,a))throw be(c,i,u);if(Ne({result:a,errorResetBoundary:u,throwOnError:c.throwOnError,query:n.getQueryCache().get(c.queryHash)}))throw a.error;if((b=(D=n.getDefaultOptions().queries)==null?void 0:D._experimental_afterQuery)==null||b.call(D,c,a),c.experimental_prefetchInRender&&!Z&&Ve(a,f)){const k=v?be(c,i,u):(H=n.getQueryCache().get(c.queryHash))==null?void 0:H.promise;k==null||k.catch(ge).finally(()=>{i.updateResult()})}return c.notifyOnChangeProps?a:i.trackResult(a)}function We(t,e){return Je(t,Me)}/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=Qe("Sparkles",[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]]),Ge=async()=>{try{const t=localStorage.getItem("adminToken");if(!t)return console.log("fetchUser - Pas de token, utilisateur non authentifié"),localStorage.removeItem("adminUser"),sessionStorage.clear(),null;const e=localStorage.getItem("adminUser"),s=localStorage.getItem("lastAuthCheck"),n=new Date().getTime(),f=s?parseInt(s):0,u=n-f,c=15*60*1e3;if(e&&u<c)try{const h=JSON.parse(e);if(h&&h.id&&h.username&&h.role)return console.log(`fetchUser - Utilisation des données en cache (${Math.round(u/1e3)}s)`),{...h}}catch(h){console.error("Erreur lors de la lecture du cache:",h)}const v=new Date().getTime();console.log(`fetchUser - Requête directe au serveur avec timestamp: ${v}`);const i=await fetch(`/api/user?_t=${v}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(!i.ok){if(i.status===401)return console.log("fetchUser - Token invalide (401), nettoyage des données locales"),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),sessionStorage.clear(),null;throw console.error(`Échec de récupération des données utilisateur - Statut HTTP: ${i.status}`),new Error(`Échec de récupération des données utilisateur - Statut: ${i.status}`)}const a=await i.json();return console.log(`fetchUser - Utilisateur récupéré du serveur au timestamp ${v}`),!a||typeof a!="object"?(console.error("Données utilisateur invalides (format incorrect)",a),null):!a.id||!a.username||!a.role?(console.error("Données utilisateur incomplètes",a),null):(localStorage.setItem("adminUser",JSON.stringify(a)),localStorage.setItem("lastAuthCheck",n.toString()),console.log(`Utilisateur mis à jour en cache: ${a.username} (${a.role})`),{...a})}catch(t){return console.error("Erreur lors de la récupération de l'utilisateur:",t),null}};function et(){const{toast:t}=Fe(),{data:e,error:s,isLoading:n,refetch:f}=We({queryKey:["/api/user"],queryFn:Ge,staleTime:5*60*1e3,gcTime:20*60*1e3,refetchInterval:10*60*1e3,refetchOnMount:!1,refetchOnWindowFocus:!1});w.useEffect(()=>{const i=setTimeout(()=>{console.log("useAuth - Refetch forcé des données utilisateur"),f()},100);return()=>clearTimeout(i)},[f]);const u=Y({mutationFn:async i=>{try{localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),console.log("Tentative de connexion pour:",i.username);const a=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),credentials:"include"}),h=await a.json();if(!a.ok)throw new Error(h.message||"Échec de connexion");return console.log("Réponse de connexion complète:",h),h.token&&(localStorage.setItem("adminToken",h.token),console.log("Token stocké:",h.token)),h}catch(a){throw console.error("Erreur de connexion:",a),a}},onSuccess:i=>{if(!i.user||!i.user.id||!i.user.role){console.error("Données utilisateur invalides reçues:",i),t({title:"Erreur d'authentification",description:"Données utilisateur invalides. Veuillez réessayer.",variant:"destructive"});return}console.log("Connexion réussie - NETTOYAGE RADICAL avant affichage de l'interface de",i.user.username),localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(function(a){document.cookie=a.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),V.clear(),localStorage.setItem("adminToken",i.token),localStorage.setItem("adminUser",JSON.stringify(i.user)),localStorage.setItem("lastLoginTime",new Date().toString()),localStorage.setItem("userRole",i.user.role),localStorage.setItem("userId",i.user.id.toString()),t({title:"Connexion réussie",description:`Bienvenue, ${i.user.fullName||i.user.username}! Chargement de votre interface...`}),setTimeout(()=>{console.log("HARD RELOAD complet du navigateur..."),window.location.href="/admin/dashboard?t="+new Date().getTime()},800)},onError:i=>{t({title:"Erreur de connexion",description:i.message,variant:"destructive"})}}),c=Y({mutationFn:async i=>{const a=await ve("POST","/api/register",i);if(!a.ok){const h=await a.json();throw new Error(h.message||"Échec d'inscription")}return await a.json()},onSuccess:i=>{V.setQueryData(["/api/user"],i),t({title:"Inscription réussie",description:"Votre compte a été créé avec succès !"})},onError:i=>{t({title:"Erreur d'inscription",description:i.message,variant:"destructive"})}}),v=Y({mutationFn:async()=>{if(console.log("Début du processus de déconnexion"),localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),V.setQueryData(["/api/user"],null),!(await ve("POST","/api/logout")).ok)throw new Error("Échec de déconnexion")},onSuccess:()=>{console.log("Déconnexion - Nettoyage complet des données en cours..."),V.clear(),localStorage.clear(),sessionStorage.clear(),document.cookie.split(";").forEach(function(i){document.cookie=i.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date().toUTCString()+";path=/")}),console.log("Déconnexion effectuée - Données utilisateur supprimées"),t({title:"Déconnexion réussie",description:"Vous êtes maintenant déconnecté."}),setTimeout(()=>{console.log("Redirection vers la page d'authentification..."),window.location.href="/admin"},500)},onError:i=>{t({title:"Erreur de déconnexion",description:i.message,variant:"destructive"})}});return{user:e??null,isLoading:n,error:s,loginMutation:u,logoutMutation:v,registerMutation:c}}export{Ze as S,We as a,et as u};
