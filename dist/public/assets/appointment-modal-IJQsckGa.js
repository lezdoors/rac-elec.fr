import{a as C,d as T,t as w,e as F,aC as c,l as q,j as e,a5 as P,a7 as E,a8 as L,a9 as A,N as D,ae as M,F as z,f as m,g as u,h as p,i as d,B as S,k as x,z as $,A as H,D as K,E as V,ac as Q,G as v,af as B,m as R,ag as _,L as O,o as U,s as f,ch as G}from"./index-C49_B6j6.js";import{L as J}from"./schema-Dew-KQs6.js";import{C as W}from"./calendar-CFPDVKKe.js";import{P as X,a as Y,b as Z}from"./popover-D1D6CqVC.js";import{f as I,B as ee}from"./admin-layout-B0JtcnfG.js";const ae=U({callbackDate:G({required_error:"Veuillez sélectionner une date"}),callbackTime:f().min(1,"Veuillez sélectionner une heure"),callbackNotes:f().optional()});function ce({isOpen:h,onClose:j,leadId:t,leadInfo:r,onAppointmentCreated:g}){const{toast:b}=C(),N={callbackDate:new Date,callbackTime:"09:00",callbackNotes:""},l=T({resolver:w(ae),defaultValues:N}),o=F({mutationFn:async a=>{if(!t)throw new Error("ID du lead manquant");const[s,n]=a.callbackTime.split(":").map(Number),i=new Date(a.callbackDate);i.setHours(s,n,0,0);const k={leadId:t,callbackDate:i.toISOString(),callbackNotes:a.callbackNotes,status:J.CALLBACK_SCHEDULED};return await(await q("POST","/api/leads/schedule-callback",k)).json()},onSuccess:a=>{if(b({title:"Rendez-vous programmé",description:"Le rappel a été correctement planifié",variant:"default"}),c.invalidateQueries({queryKey:["/api/leads/all"]}),c.invalidateQueries({queryKey:["/api/leads/incomplete"]}),c.invalidateQueries({queryKey:["/api/leads/new"]}),c.invalidateQueries({queryKey:["/api/service-requests"]}),t&&c.invalidateQueries({queryKey:[`/api/leads/${t}`]}),g&&a){const[s,n]=a.callbackTime.split(":").map(Number),i=new Date(a.callbackDate);i.setHours(s,n,0,0),g({id:a.id||t,customerName:r?`${r.firstName||""} ${r.lastName||""}`.trim():"Client",appointmentDate:i,timeSlot:a.callbackTime,referenceNumber:a.referenceNumber})}j(),l.reset(N)},onError:a=>{b({title:"Erreur",description:`Impossible de programmer le rendez-vous: ${a.message}`,variant:"destructive"})}}),y=a=>{o.mutate(a)};return h?e.jsx(P,{open:h,onOpenChange:j,children:e.jsxs(E,{className:"sm:max-w-[600px]",children:[e.jsxs(L,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(D,{className:"h-5 w-5"}),"Programmer un rappel"]}),e.jsx(M,{children:r&&e.jsxs("div",{className:"mt-2 bg-blue-50 p-3 rounded-md text-sm",children:[e.jsxs("p",{className:"font-semibold",children:["Client: ",r.firstName||""," ",r.lastName||""]}),r.phone&&e.jsxs("p",{children:["Téléphone: ",r.phone]}),r.email&&e.jsxs("p",{children:["Email: ",r.email]})]})})]}),e.jsx(z,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(y),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(m,{control:l.control,name:"callbackDate",render:({field:a})=>e.jsxs(u,{className:"flex flex-col",children:[e.jsx(p,{children:"Date du rappel"}),e.jsxs(X,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(d,{children:e.jsxs(S,{variant:"outline",className:"w-full pl-3 text-left font-normal",children:[a.value?I(a.value,"d MMMM yyyy",{locale:ee}):e.jsx("span",{children:"Choisir une date"}),e.jsx(D,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(Z,{className:"w-auto p-0",align:"start",children:e.jsx(W,{mode:"single",selected:a.value,onSelect:a.onChange,disabled:s=>s<new Date(new Date().setHours(0,0,0,0)),initialFocus:!0})})]}),e.jsx(x,{})]})}),e.jsx(m,{control:l.control,name:"callbackTime",render:({field:a})=>e.jsxs(u,{children:[e.jsx(p,{children:"Heure du rappel"}),e.jsxs($,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(d,{children:e.jsx(H,{children:e.jsx(K,{placeholder:"Sélectionner une heure"})})}),e.jsx(V,{children:Array.from({length:12},(s,n)=>n+8).map(s=>e.jsxs(Q.Fragment,{children:[e.jsxs(v,{value:`${s.toString().padStart(2,"0")}:00`,children:[s.toString().padStart(2,"0"),":00"]}),e.jsxs(v,{value:`${s.toString().padStart(2,"0")}:30`,children:[s.toString().padStart(2,"0"),":30"]})]},s))})]}),e.jsx(x,{})]})})]}),e.jsx(m,{control:l.control,name:"callbackNotes",render:({field:a})=>e.jsxs(u,{children:[e.jsx(p,{children:"Notes pour le rappel"}),e.jsx(d,{children:e.jsx(B,{placeholder:"Informations supplémentaires pour le rappel...",className:"resize-none",...a})}),e.jsx(R,{children:"Ajoutez ici des informations importantes à rappeler lors du contact avec le client."}),e.jsx(x,{})]})}),e.jsx(_,{children:e.jsx(S,{type:"submit",disabled:o.isPending,className:"w-full sm:w-auto",children:o.isPending?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"}),"Planification..."]}):"Programmer le rappel"})})]})})]})}):null}export{ce as A};
