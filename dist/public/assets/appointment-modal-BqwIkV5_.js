import{a as C,j as e,D as w,n as T,o as F,p as q,s as P,B as S,R as E,t as L,d as M,e as $,$ as o}from"./index-CUIrBm9o.js";import{u as z}from"./useMutation-D1_2mGyz.js";import{L as A}from"./schema-cZS9kAQ1.js";import{C as H}from"./calendar-B48O4zd5.js";import{u as K,t as V,F as Q,a as p,b as u,c as d,d as x,e as h,f as R}from"./form-2XVttuC3.js";import{P as B,a as _,b as O}from"./popover-Ze0ZfbGk.js";import{S as U,a as G,d as J,b as W,c as D}from"./select-CWZnZ7K2.js";import{T as X}from"./textarea-BVmmHZmc.js";import{z as c}from"./index-D4r1jjLZ.js";import{C as v}from"./calendar-CMp338cE.js";import{k as Y,B as Z}from"./admin-layout-B_5lEmpc.js";const I=c.object({callbackDate:c.date({required_error:"Veuillez sélectionner une date"}),callbackTime:c.string().min(1,"Veuillez sélectionner une heure"),callbackNotes:c.string().optional()});function ue({isOpen:j,onClose:g,leadId:l,leadInfo:r,onAppointmentCreated:b}){const{toast:N}=C(),f={callbackDate:new Date,callbackTime:"09:00",callbackNotes:""},t=K({resolver:V(I),defaultValues:f}),m=z({mutationFn:async a=>{if(!l)throw new Error("ID du lead manquant");const[s,i]=a.callbackTime.split(":").map(Number),n=new Date(a.callbackDate);n.setHours(s,i,0,0);const k={leadId:l,callbackDate:n.toISOString(),callbackNotes:a.callbackNotes,status:A.CALLBACK_SCHEDULED};return await(await $("POST","/api/leads/schedule-callback",k)).json()},onSuccess:a=>{if(N({title:"Rendez-vous programmé",description:"Le rappel a été correctement planifié",variant:"default"}),o.invalidateQueries({queryKey:["/api/leads/all"]}),o.invalidateQueries({queryKey:["/api/leads/incomplete"]}),o.invalidateQueries({queryKey:["/api/leads/new"]}),o.invalidateQueries({queryKey:["/api/service-requests"]}),l&&o.invalidateQueries({queryKey:[`/api/leads/${l}`]}),b&&a){const[s,i]=a.callbackTime.split(":").map(Number),n=new Date(a.callbackDate);n.setHours(s,i,0,0),b({id:a.id||l,customerName:r?`${r.firstName||""} ${r.lastName||""}`.trim():"Client",appointmentDate:n,timeSlot:a.callbackTime,referenceNumber:a.referenceNumber})}g(),t.reset(f)},onError:a=>{N({title:"Erreur",description:`Impossible de programmer le rendez-vous: ${a.message}`,variant:"destructive"})}}),y=a=>{m.mutate(a)};return j?e.jsx(w,{open:j,onOpenChange:g,children:e.jsxs(T,{className:"sm:max-w-[600px]",children:[e.jsxs(F,{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-5 w-5"}),"Programmer un rappel"]}),e.jsx(P,{children:r&&e.jsxs("div",{className:"mt-2 bg-blue-50 p-3 rounded-md text-sm",children:[e.jsxs("p",{className:"font-semibold",children:["Client: ",r.firstName||""," ",r.lastName||""]}),r.phone&&e.jsxs("p",{children:["Téléphone: ",r.phone]}),r.email&&e.jsxs("p",{children:["Email: ",r.email]})]})})]}),e.jsx(Q,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(y),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(p,{control:t.control,name:"callbackDate",render:({field:a})=>e.jsxs(u,{className:"flex flex-col",children:[e.jsx(d,{children:"Date du rappel"}),e.jsxs(B,{children:[e.jsx(_,{asChild:!0,children:e.jsx(x,{children:e.jsxs(S,{variant:"outline",className:"w-full pl-3 text-left font-normal",children:[a.value?Y(a.value,"d MMMM yyyy",{locale:Z}):e.jsx("span",{children:"Choisir une date"}),e.jsx(v,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(O,{className:"w-auto p-0",align:"start",children:e.jsx(H,{mode:"single",selected:a.value,onSelect:a.onChange,disabled:s=>s<new Date(new Date().setHours(0,0,0,0)),initialFocus:!0})})]}),e.jsx(h,{})]})}),e.jsx(p,{control:t.control,name:"callbackTime",render:({field:a})=>e.jsxs(u,{children:[e.jsx(d,{children:"Heure du rappel"}),e.jsxs(U,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(x,{children:e.jsx(G,{children:e.jsx(J,{placeholder:"Sélectionner une heure"})})}),e.jsx(W,{children:Array.from({length:12},(s,i)=>i+8).map(s=>e.jsxs(E.Fragment,{children:[e.jsxs(D,{value:`${s.toString().padStart(2,"0")}:00`,children:[s.toString().padStart(2,"0"),":00"]}),e.jsxs(D,{value:`${s.toString().padStart(2,"0")}:30`,children:[s.toString().padStart(2,"0"),":30"]})]},s))})]}),e.jsx(h,{})]})})]}),e.jsx(p,{control:t.control,name:"callbackNotes",render:({field:a})=>e.jsxs(u,{children:[e.jsx(d,{children:"Notes pour le rappel"}),e.jsx(x,{children:e.jsx(X,{placeholder:"Informations supplémentaires pour le rappel...",className:"resize-none",...a})}),e.jsx(R,{children:"Ajoutez ici des informations importantes à rappeler lors du contact avec le client."}),e.jsx(h,{})]})}),e.jsx(L,{children:e.jsx(S,{type:"submit",disabled:m.isPending,className:"w-full sm:w-auto",children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}),"Planification..."]}):"Programmer le rappel"})})]})})]})}):null}export{ue as A};
