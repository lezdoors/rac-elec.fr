import{r as l,j as e,B as d,E as b,I as O,A as B,G as w,J as C}from"./index-C79Lqn-b.js";import{C as u,a as p,b as h,c as f,d as j,e as S}from"./card-SWO2MdYe.js";import{B as M}from"./badge-CCh-PC4z.js";import{T as Q,a as U,b as I,c as R}from"./tabs-ChRO9r4I.js";import{A as z,a as F,b as J,c as L}from"./accordion-GubuOxN8.js";import{A as W}from"./admin-layout-BC-7Pt2H.js";import{R as X}from"./refresh-ccw-DmrCGbaB.js";import{S as Z}from"./search-CY7BTyec.js";import{C as o}from"./circle-check-BlAFi1lB.js";import{C as y}from"./circle-x-DIo8nARH.js";import"./use-mobile-CP5sxB4v.js";import"./index-CWmD1AeD.js";import"./chevron-down-BuxCIRpp.js";import"./use-auth-DE_63HxB.js";import"./useQuery-SQPHT_K6.js";import"./log-out-C8fd9QXr.js";import"./file-text-CcRc0FXS.js";import"./credit-card-BOPZl7hA.js";import"./settings-B1qVUT92.js";import"./index-ZEkTGTtd.js";import"./index-6qOn_ibe.js";import"./separator-ClAQoWnA.js";import"./external-link-CUrnlzx8.js";function we(){const[a,k]=l.useState(""),[v,P]=l.useState(null),[c,A]=l.useState(null),[N,_]=l.useState(""),[t,m]=l.useState({reference:!1,payment:!1,create:!1}),[s,i]=l.useState({reference:"",payment:"",create:""}),[g,E]=l.useState(""),[T,Y]=l.useState([]);l.useEffect(()=>{V()},[]);const V=async()=>{try{const r=await fetch("/api/service-requests/recent?limit=5"),n=await r.json();if(r.ok&&n.success){const x=n.requests.map(K=>K.referenceNumber);Y(x)}}catch(r){console.error("Erreur lors du chargement des références récentes:",r)}},D=async()=>{if(a){m({...t,reference:!0}),i({...s,reference:""}),P(null);try{const r=await fetch(`/api/service-requests/${a}`),n=await r.json();r.ok?P(n):i({...s,reference:n.message||"Référence introuvable"})}catch(r){console.error("Erreur lors de la vérification de la référence:",r),i({...s,reference:"Erreur de communication avec le serveur"})}finally{m({...t,reference:!1})}}},G=async()=>{if(a){m({...t,payment:!0}),i({...s,payment:""}),A(null);try{const r=N?`/api/payment-status/${a}?payment_intent=${N}`:`/api/payment-status/${a}`,n=await fetch(r),x=await n.json();A(x),n.ok||i({...s,payment:x.message||"Erreur lors de la vérification du paiement"})}catch(r){console.error("Erreur lors de la vérification du statut du paiement:",r),i({...s,payment:"Erreur de communication avec le serveur"})}finally{m({...t,payment:!1})}}},H=async()=>{if(a){m({...t,create:!0}),i({...s,create:""}),E("");try{const r=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reference:a,amount:129.8})}),n=await r.json();r.ok?E(n.clientSecret):i({...s,create:n.message||"Erreur lors de la création du payment intent"})}catch(r){console.error("Erreur lors de la création du payment intent:",r),i({...s,create:"Erreur de communication avec le serveur"})}finally{m({...t,create:!1})}}},$=()=>{a&&window.open(`/simple-payment?reference=${a}`,"_blank")},q=r=>JSON.stringify(r,null,2);return e.jsx(W,{title:"Diagnostic Paiement",description:"Outil de débogage pour les problèmes liés au paiement",children:e.jsxs("div",{className:"container py-6 space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mt-2 bg-amber-50 border border-amber-200 text-amber-700 p-2 rounded-md text-sm flex items-center",children:[e.jsx("span",{className:"font-medium",children:"Accès restreint :"}),e.jsx("span",{className:"ml-1",children:"Cette page est réservée aux administrateurs et responsables."})]})}),e.jsxs(d,{variant:"outline",onClick:V,size:"sm",children:[e.jsx(X,{className:"h-4 w-4 mr-2"})," Rafraîchir les références"]})]}),e.jsxs(u,{className:"mb-8",children:[e.jsxs(p,{children:[e.jsx(h,{children:"Entrée de référence"}),e.jsx(f,{children:"Entrez une référence de demande ou sélectionnez-en une récente"})]}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(b,{htmlFor:"referenceInput",children:"Référence"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(O,{id:"referenceInput",placeholder:"ex: RAC-2025-0602-143045-742",value:a,onChange:r=>k(r.target.value)}),e.jsxs(d,{onClick:D,children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Vérifier"]}),e.jsxs(d,{variant:"secondary",onClick:$,disabled:!a,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Page Paiement"]})]})]}),T.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:T.map(r=>e.jsx(M,{className:"cursor-pointer",variant:"outline",onClick:()=>k(r),children:r},r))})]})})]}),e.jsxs(Q,{defaultValue:"reference",children:[e.jsxs(U,{className:"grid w-full grid-cols-3",children:[e.jsxs(I,{value:"reference",children:["Vérifier Référence",v&&e.jsx(o,{className:"h-3 w-3 ml-1 text-green-500"}),s.reference&&e.jsx(y,{className:"h-3 w-3 ml-1 text-red-500"})]}),e.jsxs(I,{value:"payment",children:["Vérifier Paiement",c&&e.jsx(o,{className:"h-3 w-3 ml-1 text-green-500"}),s.payment&&e.jsx(y,{className:"h-3 w-3 ml-1 text-red-500"})]}),e.jsxs(I,{value:"create",children:["Créer Intent",g&&e.jsx(o,{className:"h-3 w-3 ml-1 text-green-500"}),s.create&&e.jsx(y,{className:"h-3 w-3 ml-1 text-red-500"})]})]}),e.jsx(R,{value:"reference",className:"space-y-4",children:e.jsxs(u,{children:[e.jsxs(p,{children:[e.jsx(h,{children:"Vérification de la référence"}),e.jsx(f,{children:"Vérifie si une référence existe dans la base de données"})]}),e.jsx(j,{children:t.reference?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{children:"Vérification en cours..."})]}):s.reference?e.jsx(w,{variant:"destructive",children:e.jsx(C,{children:s.reference})}):v?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-green-50 border border-green-100 rounded-md",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(o,{className:"h-5 w-5 text-green-500 mr-2"}),e.jsx("p",{className:"text-green-700 font-medium",children:"Référence valide trouvée"})]})}),e.jsx(z,{type:"single",collapsible:!0,className:"w-full",children:e.jsxs(F,{value:"serviceRequest",children:[e.jsx(J,{children:"Détails de la demande"}),e.jsx(L,{children:e.jsx("pre",{className:"p-4 bg-gray-50 rounded-md text-xs overflow-auto max-h-96",children:q(v)})})]})})]}):e.jsx("div",{className:"text-center py-6 text-gray-500",children:e.jsx("p",{children:"Aucune vérification n'a encore été effectuée"})})}),e.jsx(S,{className:"flex justify-end",children:e.jsx(d,{onClick:D,disabled:!a||t.reference,children:t.reference?"Chargement...":"Vérifier la référence"})})]})}),e.jsx(R,{value:"payment",className:"space-y-4",children:e.jsxs(u,{children:[e.jsxs(p,{children:[e.jsx(h,{children:"Vérification du statut de paiement"}),e.jsx(f,{children:"Vérifie le statut du paiement associé à une référence"})]}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(b,{htmlFor:"paymentIdInput",children:"ID PaymentIntent (optionnel)"}),e.jsx(O,{id:"paymentIdInput",placeholder:"ex: pi_3RK6TSF0p2SYXeXz1BY5vORk",value:N,onChange:r=>_(r.target.value)})]}),t.payment?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{children:"Vérification en cours..."})]}):s.payment?e.jsx(w,{variant:"destructive",children:e.jsx(C,{children:s.payment})}):c?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`p-4 ${c.status==="succeeded"?"bg-green-50 border-green-100":c.status==="failed"?"bg-red-50 border-red-100":"bg-yellow-50 border-yellow-100"} border rounded-md`,children:e.jsxs("div",{className:"flex items-center",children:[c.status==="succeeded"?e.jsx(o,{className:"h-5 w-5 text-green-500 mr-2"}):c.status==="failed"?e.jsx(y,{className:"h-5 w-5 text-red-500 mr-2"}):e.jsx(X,{className:"h-5 w-5 text-yellow-500 mr-2"}),e.jsxs("p",{className:`font-medium ${c.status==="succeeded"?"text-green-700":c.status==="failed"?"text-red-700":"text-yellow-700"}`,children:["Statut: ",c.status]})]})}),e.jsx(z,{type:"single",collapsible:!0,className:"w-full",children:e.jsxs(F,{value:"paymentStatus",children:[e.jsx(J,{children:"Détails du statut de paiement"}),e.jsx(L,{children:e.jsx("pre",{className:"p-4 bg-gray-50 rounded-md text-xs overflow-auto max-h-96",children:q(c)})})]})})]}):e.jsx("div",{className:"text-center py-6 text-gray-500",children:e.jsx("p",{children:"Aucune vérification n'a encore été effectuée"})})]})}),e.jsx(S,{className:"flex justify-end",children:e.jsx(d,{onClick:G,disabled:!a||t.payment,children:t.payment?"Chargement...":"Vérifier le paiement"})})]})}),e.jsx(R,{value:"create",className:"space-y-4",children:e.jsxs(u,{children:[e.jsxs(p,{children:[e.jsx(h,{children:"Créer un Payment Intent"}),e.jsx(f,{children:"Crée un nouveau Payment Intent pour tester le paiement"})]}),e.jsx(j,{children:t.create?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{children:"Création en cours..."})]}):s.create?e.jsx(w,{variant:"destructive",children:e.jsx(C,{children:s.create})}):g?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-green-50 border border-green-100 rounded-md",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(o,{className:"h-5 w-5 text-green-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-green-700 font-medium",children:"PaymentIntent créé avec succès"}),e.jsx("p",{className:"text-green-600 text-sm mt-1",children:"ClientSecret généré et prêt à être utilisé avec Stripe Elements"})]})]})}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(b,{className:"block mb-2",children:"Client Secret"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded text-xs overflow-auto font-mono break-all",children:g})]}),e.jsx("div",{className:"flex justify-center",children:e.jsxs(d,{onClick:$,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Tester le paiement"]})})]}):e.jsx("div",{className:"text-center py-6 text-gray-500",children:e.jsx("p",{children:"Aucun PaymentIntent n'a encore été créé"})})}),e.jsx(S,{className:"flex justify-end",children:e.jsx(d,{onClick:H,disabled:!a||t.create,children:t.create?"Chargement...":"Créer PaymentIntent"})})]})})]})]})})}export{we as default};
