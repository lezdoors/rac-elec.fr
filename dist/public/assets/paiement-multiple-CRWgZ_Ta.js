import{c as B,s as M,j as e,y as v,B as p,a as D,u as O,r as i,E as N,I as G,l as w}from"./index-BtS7nRqx.js";import{E as K,l as U,u as H,a as J,C}from"./react-stripe.esm-BwbjKvQb.js";import{C as E,a as S,b as q,c as R,d as k,e as W}from"./card-4w5MxnDX.js";import{C as V}from"./credit-card-Cmnyo_Xr.js";import{S as Q}from"./shield-VWRbjCnh.js";import{T as Y}from"./triangle-alert-QxnH57r-.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=B("BadgeEuro",[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"M7 12h5",key:"gblrwe"}],["path",{d:"M15 9.4a4 4 0 1 0 0 5.2",key:"1makmb"}]]),X=U("pk_live_51RfpODBVU6GhVKJF3e6Seit8WvztJbYRj1iPHE1qot58b0Oq2IK1s6w0tSyI45W7KKRFm7o4Q6vE36gVVgq9bcGB00MNCLPkGN"),ee={style:{base:{fontSize:"16px",color:"#424770","::placeholder":{color:"#aab7c4"}},invalid:{color:"#9e2146"}}},te=({reference:s,multiplier:a})=>{const n=H(),x=J(),{toast:d}=D(),[,h]=O(),[j,f]=i.useState(!1),[o,P]=i.useState(""),[_,T]=i.useState(!1),[l,F]=i.useState(null),[I,L]=i.useState(!0),[b,z]=i.useState(null),y=129.8*a,m=y.toFixed(2).replace(".",",");i.useEffect(()=>{(async()=>{try{const t=await w("GET",`/api/service-requests/${s}`);if(!t.ok)throw new Error("Impossible de récupérer les détails de la demande");const r=await t.json();F(r.serviceRequest)}catch(t){console.error("Erreur lors de la récupération des détails:",t),z("Impossible de récupérer les détails de cette demande")}finally{L(!1)}})()},[s]);const $=async c=>{if(c.preventDefault(),!n||!x){d({title:"Service de paiement non disponible",description:"Veuillez réessayer ultérieurement",variant:"destructive"});return}if(!o.trim()){d({title:"Nom du titulaire requis",description:"Veuillez saisir le nom du titulaire de la carte",variant:"destructive"});return}try{f(!0);const t=await w("POST","/api/create-payment-intent-multiple",{referenceNumber:s,multiplier:a,createOnly:!0});if(!t.ok){const A=await t.json();throw new Error(A.message||"Erreur lors de la préparation du paiement")}const{clientSecret:r}=await t.json(),{error:g,paymentIntent:u}=await n.confirmCardPayment(r,{payment_method:{card:x.getElement(C),billing_details:{name:o.trim()}}});if(g)throw g;u.status==="succeeded"?h(`/paiement-confirmation?reference=${s}&status=success&payment_intent=${u.id}&multiplier=${a}&amount=${y.toFixed(2)}`):h(`/paiement-confirmation?reference=${s}&payment_intent=${u.id}&multiplier=${a}`)}catch(t){console.error("Erreur de paiement:",t);let r="Une erreur est survenue lors du traitement de votre paiement.";if(t.type==="card_error")switch(t.code){case"card_declined":r="Votre carte a été refusée. Veuillez utiliser une autre carte.";break;case"expired_card":r="Votre carte est expirée. Veuillez utiliser une autre carte.";break;case"incorrect_cvc":r="Le code de sécurité (CVC) de votre carte est incorrect.";break;case"processing_error":r="Une erreur est survenue lors du traitement de votre carte. Veuillez réessayer.";break;default:r=t.message||r}d({title:"Échec du paiement",description:r,variant:"destructive"})}finally{f(!1)}};return I?e.jsx("div",{className:"flex justify-center items-center h-60",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):b?e.jsxs("div",{className:"flex flex-col items-center justify-center h-60 text-center",children:[e.jsx(Y,{className:"w-12 h-12 text-red-500 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Erreur lors du chargement"}),e.jsx("p",{className:"text-gray-600 mb-4",children:b}),e.jsx(p,{variant:"outline",onClick:()=>window.location.href="/admin/demandes",children:"Retour aux demandes"})]}):e.jsxs("form",{onSubmit:$,className:"space-y-6",children:[e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(Z,{className:"w-6 h-6 text-blue-600 mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-blue-800",children:"Paiement de votre demande"}),e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Cette page permet de régler le montant de ",e.jsxs("strong",{children:[m,"€"]})," pour la demande ",s,"."]})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"cardholderName",children:"Nom du titulaire de la carte"}),e.jsx(G,{id:"cardholderName",placeholder:"Nom complet tel qu'il apparaît sur la carte",value:o,onChange:c=>P(c.target.value),required:!0,className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"card-element",children:"Carte bancaire"}),e.jsx("div",{className:"mt-1 border rounded-md p-3",children:e.jsx(C,{id:"card-element",options:ee,onChange:c=>T(c.complete)})})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-100",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-gray-600",children:"Référence"}),e.jsx("span",{className:"font-medium",children:s})]}),l&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-gray-600",children:"Client"}),e.jsx("span",{className:"font-medium",children:l.name})]}),e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"text-gray-600",children:"Type de demande"}),e.jsx("span",{className:"font-medium",children:l.requestType==="new_connection"?"Nouveau raccordement":l.requestType==="power_upgrade"?"Augmentation de puissance":l.requestType==="temporary_connection"?"Raccordement provisoire":l.requestType==="relocation"?"Déplacement de compteur":"Autre"})]})]}),e.jsxs("div",{className:"flex justify-between pt-2 border-t border-gray-200 mt-2",children:[e.jsx("span",{className:"text-gray-700 font-medium",children:"Total à payer"}),e.jsxs("span",{className:"text-lg font-bold text-blue-700",children:[m,"€"]})]})]}),e.jsx(p,{type:"submit",className:"w-full py-6 text-lg flex items-center justify-center gap-2",disabled:!n||j||!_,children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Traitement en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"w-5 h-5"}),"Payer ",m,"€"]})}),e.jsx("div",{className:"text-center text-sm text-gray-500",children:e.jsx("p",{children:"Paiement sécurisé. Vos informations de carte sont cryptées."})})]})};function de(){const s=M(),a=s.reference,n=parseInt(s.multiplier,10);return!a||isNaN(n)||n<1||n>5?e.jsx(v,{children:e.jsx("div",{className:"container max-w-2xl mx-auto py-10",children:e.jsxs(E,{children:[e.jsxs(S,{children:[e.jsx(q,{className:"text-red-600",children:"Erreur de paramètre"}),e.jsx(R,{children:"La référence ou le paramètre de quantité spécifié est invalide."})]}),e.jsx(k,{children:e.jsx("p",{children:"Veuillez vérifier l'URL et réessayer. Le paramètre de quantité doit être entre 1 et 5."})}),e.jsx(W,{children:e.jsx(p,{variant:"outline",onClick:()=>window.location.href="/admin/demandes",children:"Retour aux demandes"})})]})})}):e.jsx(v,{children:e.jsx("div",{className:"container max-w-2xl mx-auto py-10",children:e.jsxs(E,{className:"shadow-lg border-t-4 border-t-blue-600",children:[e.jsxs(S,{className:"pb-4",children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-blue-600"}),"Paiement de votre demande"]}),e.jsxs(R,{children:["Effectuez le paiement pour la demande ",a]})]}),e.jsxs(k,{children:[e.jsxs("div",{className:"flex items-center justify-center mb-4 space-x-2 bg-green-50 p-3 rounded-lg border border-green-100",children:[e.jsx(Q,{className:"h-5 w-5 text-green-600"}),e.jsx("p",{className:"text-green-800 text-sm",children:"Vos données sont protégées par notre système de paiement sécurisé."})]}),e.jsx(K,{stripe:X,children:e.jsx(te,{reference:a,multiplier:n})})]})]})})})}export{de as default};
