import{a as ve,r,e as P,j as e,K as j,B as o,I as u,L as N,N as E,R as T,O as k,p as Ne,Y as ge,_ as ye,$ as Ce,a0 as be,a5 as we,a7 as Se,m as R,ae as S,ac as De}from"./index-OqB-3qjU.js";import{A as Le}from"./admin-layout-B-n7hJvi.js";import{C as Fe,a as Pe,b as Ee,c as Te,d as ke,e as Re}from"./card-YkhDqIyK.js";import{a as ze}from"./use-auth-DdTEH3GW.js";import{T as Ie,a as Me,b as _,c as G}from"./tabs-yzwLXF2Y.js";import{S as Ve}from"./search-tiOFoAmf.js";import{C as J}from"./credit-card-BUxoGV01.js";import{E as z}from"./external-link-BUTkst92.js";import{R as qe}from"./refresh-cw-mvQ0N0PX.js";import{C as Ae}from"./circle-x-H38LlLUC.js";import"./use-mobile-BgrQZlM3.js";import"./index-CQ8atBht.js";import"./log-out-CXQxNQ_g.js";import"./file-text-CP8gUIFP.js";import"./users-Czwb4yTn.js";import"./settings-DE9zXQUe.js";import"./index-DZ6rkOP_.js";import"./index-9gn0K9eO.js";import"./separator-KwyN41l4.js";function na(){const{toast:s}=ve(),[X,D]=r.useState(""),[I,W]=r.useState(""),[g,M]=r.useState(""),[y,V]=r.useState(""),[f,q]=r.useState(""),[C,A]=r.useState(""),[p,Z]=r.useState(129.8),[Y,b]=r.useState(!1),[i,$]=r.useState(null),[L,ee]=r.useState("manual"),[d,Q]=r.useState(null),[ae,te]=r.useState(null),[K,F]=r.useState(!1),[n,h]=r.useState(!1),[l,v]=r.useState(!1),[se,x]=r.useState(!1),[w,O]=r.useState(""),{data:re=[],isLoading:ne}=ze({queryKey:["/api/service-requests-unpaid"],queryFn:De({on401:"throw"}),enabled:Y});r.useEffect(()=>{new URLSearchParams(window.location.search).get("canceled")==="true"&&(s({title:"Paiement annulé",description:"Le paiement a été annulé ou abandonné par le client.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname))},[s]);const ie=P({mutationFn:async a=>{const t=await R("POST","/api/create-payment-terminal-session",a);if(!t.ok){const c=await t.json();throw new Error(c.message||"Erreur lors de la création du terminal de paiement")}return t.json()},onSuccess:a=>{h(!1),Q(a.checkoutUrl),O(a.paymentId),s({title:"Terminal prêt",description:`Terminal de paiement créé pour ${p.toFixed(2).replace(".",",")}€. Cliquez sur le lien pour procéder au paiement.`,variant:"default"})},onError:a=>{h(!1),x(!0),s({title:"Échec de la création du terminal",description:a.message,variant:"destructive"})}}),le=P({mutationFn:async a=>{const t=await R("GET",`/api/payment-terminal-status/${a}`);if(!t.ok){const c=await t.json();throw new Error(c.message||"Erreur lors de la vérification du paiement")}return t.json()},onSuccess:a=>{var t;F(!1),te(a.status),a.status==="succeeded"?(v(!0),s({title:"Paiement confirmé",description:`Le paiement de ${(t=a.amount)==null?void 0:t.toFixed(2).replace(".",",")}€ a été traité avec succès.`,variant:"default"}),S.invalidateQueries({queryKey:["/api/service-requests"]}),S.invalidateQueries({queryKey:["/api/service-requests-unpaid"]}),S.invalidateQueries({queryKey:["/api/payments/recent"]}),S.invalidateQueries({queryKey:["/api/payments/stats"]})):a.status==="canceled"?(x(!0),s({title:"Paiement annulé",description:"Le paiement a été annulé.",variant:"destructive"})):s({title:"Paiement en attente",description:`Le paiement est en statut: ${a.status}. Vérifiez à nouveau plus tard.`,variant:"default"})},onError:a=>{F(!1),s({title:"Erreur de vérification",description:a.message,variant:"destructive"})}}),ce=P({mutationFn:async a=>{const t=await R("POST","/api/process-manual-payment",a);if(!t.ok){const c=await t.json();throw new Error(c.message||"Erreur lors du traitement du paiement")}return t.json()},onSuccess:a=>{h(!1),v(!0),O(a.paymentId),s({title:"Paiement réussi",description:`Le paiement de ${p.toFixed(2).replace(".",",")}€ a été traité avec succès. ID de transaction: ${a.paymentId}`,variant:"default"})},onError:a=>{h(!1),x(!0),s({title:"Échec du paiement",description:a.message,variant:"destructive"})}}),oe=a=>{const t=a.replace(/\D/g,""),c=[];for(let m=0;m<t.length;m+=4)c.push(t.slice(m,m+4));return c.join(" ")},de=a=>{const t=a.replace(/\D/g,"");return t.length<=2?t:t.slice(0,2)+"/"+t.slice(2,4)},me=()=>{if(!i){s({title:"Erreur",description:"Veuillez sélectionner une demande de service",variant:"destructive"});return}if(!g||!y||!f||!C){s({title:"Formulaire incomplet",description:"Veuillez remplir tous les champs du formulaire de paiement",variant:"destructive"});return}const a=g.replace(/\D/g,"");if(a.length<16){s({title:"Numéro de carte invalide",description:"Le numéro de carte doit comporter au moins 16 chiffres",variant:"destructive"});return}const t=y.split("/");if(t.length!==2||t[0].length!==2||t[1].length!==2){s({title:"Date d'expiration invalide",description:"La date d'expiration doit être au format MM/YY",variant:"destructive"});return}const c=parseInt(t[0],10),m=parseInt(`20${t[1]}`,10),B=new Date,je=B.getMonth()+1,H=B.getFullYear();if(m<H||m===H&&c<je){s({title:"Carte expirée",description:"La date d'expiration de la carte est dépassée. Veuillez utiliser une carte valide.",variant:"destructive"});return}if(f.length<3){s({title:"CVC invalide",description:"Le code de sécurité (CVC) doit comporter au moins 3 chiffres",variant:"destructive"});return}h(!0),v(!1),x(!1);const fe={referenceNumber:i.referenceNumber,cardNumber:a,cardExpMonth:parseInt(t[0]),cardExpYear:parseInt(`20${t[1]}`),cardCvc:f,cardholderName:C,amount:p,serviceRequestId:i.id};ce.mutate(fe)},ue=()=>{if(!i){s({title:"Erreur",description:"Veuillez sélectionner une demande de service",variant:"destructive"});return}h(!0),v(!1),x(!1),Q(null);const a={referenceNumber:i.referenceNumber,amount:p,serviceRequestId:i.id};ie.mutate(a)},pe=()=>{if(!w){s({title:"Erreur",description:"Aucun paiement en cours",variant:"destructive"});return}F(!0),le.mutate(w)},U=re.filter(a=>{const t=I.toLowerCase();return a.referenceNumber.toLowerCase().includes(t)||a.name.toLowerCase().includes(t)||a.email.toLowerCase().includes(t)||a.phone.toLowerCase().includes(t)}),he=a=>{$(a),D(a.referenceNumber),b(!1)},xe=()=>{M(""),V(""),q(""),A(""),D(""),$(null),v(!1),x(!1)};return e.jsxs(Le,{title:"Terminal de paiement",description:"Traitez les paiements par téléphone ou en personne",children:[e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs(Fe,{className:"mb-4",children:[e.jsxs(Pe,{children:[e.jsx(Ee,{children:"Terminal de paiement virtuel"}),e.jsx(Te,{children:"Utilisez ce terminal pour traiter les paiements par téléphone ou en personne. Vos clients peuvent vous communiquer leurs informations de carte bancaire par téléphone."})]}),e.jsxs(ke,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(j,{htmlFor:"reference",children:"Référence de la demande"}),e.jsxs(o,{type:"button",variant:"ghost",size:"sm",onClick:()=>b(!0),children:[e.jsx(Ve,{className:"w-4 h-4 mr-2"}),"Rechercher"]})]}),e.jsx(u,{id:"reference",placeholder:"ex: RAC-2025-0602-143045-742",value:X,onChange:a=>D(a.target.value),disabled:n||l,className:"font-mono"}),i&&e.jsxs("div",{className:"text-sm text-gray-700 bg-gray-50 p-2 rounded",children:["Client: ",i.name," • ",i.email," • ",i.phone]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"amount",children:"Montant (€)"}),e.jsx(u,{id:"amount",type:"number",value:p.toFixed(2),step:"0.01",min:"0",placeholder:"Entrez le montant",className:"font-bold",disabled:n||l,onChange:a=>{const t=parseFloat(a.target.value);isNaN(t)||Z(parseFloat(t.toFixed(2)))}})]}),e.jsxs(Ie,{defaultValue:L,value:L,onValueChange:a=>ee(a),className:"w-full",children:[e.jsxs(Me,{className:"grid w-full grid-cols-2",children:[e.jsxs(_,{value:"manual",disabled:n||l,children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Saisie manuelle"]}),e.jsxs(_,{value:"terminal",disabled:n||l,children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Terminal Stripe"]})]}),e.jsxs(G,{value:"manual",className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardNumber",children:"Numéro de carte"}),e.jsxs("div",{className:"relative",children:[e.jsx(u,{id:"cardNumber",placeholder:"1234 5678 9012 3456",value:g,onChange:a=>M(oe(a.target.value)),disabled:n||l,maxLength:19,className:"font-mono"}),e.jsx(J,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardExpiry",children:"Date d'expiration"}),e.jsx(u,{id:"cardExpiry",placeholder:"MM/YY",value:y,onChange:a=>V(de(a.target.value)),disabled:n||l,maxLength:5,className:"font-mono"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardCvc",children:"CVC"}),e.jsx(u,{id:"cardCvc",placeholder:"123",value:f,onChange:a=>{const t=a.target.value.replace(/\D/g,"");q(t.slice(0,4))},disabled:n||l,maxLength:4,className:"font-mono"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cardholderName",children:"Nom du titulaire"}),e.jsx(u,{id:"cardholderName",placeholder:"Jean Dupont",value:C,onChange:a=>A(a.target.value),disabled:n||l})]})]}),e.jsx(G,{value:"terminal",className:"mt-4 space-y-4",children:e.jsxs("div",{className:"bg-gray-50 p-4 rounded-md border",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Terminal de paiement Stripe"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Ce mode crée un terminal de paiement Stripe sécurisé que vous pouvez partager avec votre client. Il pourra entrer ses informations bancaires directement sur la page Stripe."}),d&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex items-center mb-2 text-sm font-medium text-blue-600",children:e.jsx("span",{children:"URL du terminal:"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",readOnly:!0,value:d,className:"flex-1 p-2 text-sm font-mono bg-white border rounded",onClick:a=>a.target.select()}),e.jsx(o,{size:"sm",variant:"outline",onClick:()=>{d&&window.open(d,"_blank")},children:e.jsx(z,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Status: ",ae||"En attente de paiement"]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:pe,disabled:K||!w,children:[K?e.jsx(N,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(qe,{className:"h-4 w-4 mr-2"}),"Vérifier le statut"]})]})]})]})})]}),n&&!d&&e.jsxs(E,{children:[e.jsx(N,{className:"h-4 w-4 animate-spin mr-2"}),e.jsx(T,{children:"Traitement en cours"}),e.jsx(k,{children:"Veuillez patienter pendant que nous préparons votre paiement..."})]}),l&&e.jsxs(E,{className:"bg-green-50 border-green-200 text-green-800",children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),e.jsx(T,{children:"Paiement réussi!"}),e.jsxs(k,{children:["Le paiement de ",p.toFixed(2).replace(".",","),"€ a été traité avec succès. ID de transaction: ",w]})]}),se&&e.jsxs(E,{variant:"destructive",children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),e.jsx(T,{children:"Échec du paiement"}),e.jsx(k,{children:"Le paiement a échoué. Veuillez vérifier les informations et réessayer."})]})]}),e.jsxs(Re,{className:"flex justify-between",children:[e.jsx(o,{variant:"outline",onClick:xe,disabled:n,children:"Réinitialiser"}),L==="manual"?e.jsx(o,{onClick:me,disabled:n||!i||l||!g||!y||!f||!C,children:n?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Traitement..."]}):"Traiter le paiement manuel"}):e.jsx(o,{onClick:ue,disabled:n||!i||l,children:n&&!d?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Préparation..."]}):d?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"Ouvrir le terminal"]}):"Créer un terminal de paiement"})]})]})}),e.jsx(ge,{open:Y,onOpenChange:b,children:e.jsxs(ye,{className:"max-w-3xl",children:[e.jsxs(Ce,{children:[e.jsx(be,{children:"Sélectionner une demande"}),e.jsx(we,{children:"Recherchez et sélectionnez une demande pour traiter le paiement"})]}),e.jsxs("div",{className:"my-4",children:[e.jsx(u,{placeholder:"Rechercher par référence, nom, email ou téléphone...",value:I,onChange:a=>W(a.target.value),className:"mb-4"}),e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-100 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 px-4 text-left",children:"Référence"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Client"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Contact"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Type"}),e.jsx("th",{className:"py-2 px-4 text-left",children:"Action"})]})}),e.jsx("tbody",{children:ne?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4",children:e.jsx(N,{className:"animate-spin h-6 w-6 mx-auto text-blue-500"})})}):U.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-4 text-gray-500",children:"Aucune demande trouvée"})}):U.map(a=>e.jsxs("tr",{className:"border-t hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-4 font-mono text-sm",children:a.referenceNumber}),e.jsx("td",{className:"py-2 px-4",children:a.name}),e.jsxs("td",{className:"py-2 px-4 text-sm",children:[a.email,e.jsx("br",{}),a.phone]}),e.jsx("td",{className:"py-2 px-4",children:e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800",children:a.clientType==="professional"?"Pro":"Part."})}),e.jsx("td",{className:"py-2 px-4",children:e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>he(a),children:"Sélectionner"})})]},a.id))})]})})})]}),e.jsx(Se,{children:e.jsx(o,{variant:"outline",onClick:()=>b(!1),children:"Annuler"})})]})})]})}export{na as default};
