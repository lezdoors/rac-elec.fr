import{c as re,j as e,S as Xe,r as l,B as d,D as p,I as A,a as Zs,Q as $e,T as Le,V as ze,W as Ie,a0 as Te,a1 as hs,a2 as Qe,C as ga,e as ns,m as T,a4 as ls,M as Ga,l as V,U as Ae,o as va,R as Ka,X as Ys,u as Qa,aR as _s,q as ts,p as Xa,v as Gs,aF as rs}from"./index-D0aNDh5L.js";import{u as xa,I as pe,S as cs,n as os,T as ds,A as Wa,R as ua,o as ms,M as Ja}from"./admin-layout-CM4-m4Me.js";import{S as Ya,u as Za}from"./use-auth-hZbjue8Y.js";import{u as _e}from"./useQuery-4ZaN6UoW.js";import{C as ce,a as Ge,b as Ke,d as oe,c as et,e as st}from"./card-g2bqyuJH.js";import{T as As,a as $s,b as ae,c as se}from"./tabs-DRBMJDHh.js";import{B as J}from"./badge-BKKTlACB.js";import{I as ks}from"./inbox-C-lgeTxs.js";import{T as at}from"./triangle-alert-BzF1a252.js";import{T as tt}from"./trash-2-DjgYC3by.js";import{S as Re,a as De,d as Fe,b as Me,c as R}from"./select-BYWjCN2B.js";import{S as Es}from"./switch-BcO5xR5Y.js";import{P as Na,a as ya,b as ba}from"./popover-DnV87mcL.js";import{S as Ks}from"./search-CR58YC69.js";import{F as je}from"./file-text-CL78jw9P.js";import{S as wa}from"./square-pen-DV-AKp4T.js";import{C as rt}from"./index-CN0BoPk4.js";import{C as Qs}from"./checkbox-Dok_nmDs.js";import{S as Xs}from"./separator-DzodqHP2.js";import{T as Se,a as ke,b as K,c as N,d as Ee,e as y}from"./table-CBITm6KM.js";import{A as Cs,a as Ss}from"./avatar-BNc_hiq5.js";import{A as it,a as nt,b as lt,c as ct,d as ot,e as dt,f as mt,g as ht}from"./alert-dialog-CJkVRFeS.js";import{R as xt}from"./refresh-cw-BbKG6u6w.js";import{A as pa}from"./arrow-left-B7PLWP4h.js";import{E as Ws}from"./eye-DOmFDOR3.js";import{I as ut}from"./info-DUAB7SnV.js";import{C as pt}from"./circle-x-B4QSBoHl.js";import{S as jt}from"./shield-alert-A0X66bmw.js";import"./use-mobile-CAygICyi.js";import"./index-BbNo7xzR.js";import"./log-out-DyChWGPZ.js";import"./credit-card-Gwd2tt5N.js";import"./settings-BzJCyKZ7.js";import"./index-42c2_13v.js";import"./external-link-Bx3PZ3Bg.js";import"./index-DhyfjYr8.js";import"./chevron-down-So192k0a.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ja=re("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=re("CopyCheck",[["path",{d:"m12 15 2 2 4-4",key:"2c609p"}],["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=re("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=re("LayoutTemplate",[["rect",{width:"18",height:"7",x:"3",y:"3",rx:"1",key:"f1a2em"}],["rect",{width:"9",height:"7",x:"3",y:"14",rx:"1",key:"jqznyg"}],["rect",{width:"5",height:"7",x:"16",y:"14",rx:"1",key:"q5h2i8"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=re("List",[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=re("MailX",[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h9",key:"1j9vog"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m17 17 4 4",key:"1b3523"}],["path",{d:"m21 17-4 4",key:"uinynz"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=re("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=re("Signature",[["path",{d:"m21 17-2.156-1.868A.5.5 0 0 0 18 15.5v.5a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1c0-2.545-3.991-3.97-8.5-4a1 1 0 0 0 0 5c4.153 0 4.745-11.295 5.708-13.5a2.5 2.5 0 1 1 3.31 3.284",key:"y32ogt"}],["path",{d:"M3 21h18",key:"itz85i"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=re("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=re("UserRound",[["circle",{cx:"12",cy:"8",r:"5",key:"1hypcn"}],["path",{d:"M20 21a8 8 0 0 0-16 0",key:"rfgkzh"}]]),Ct=n=>{if(Array.isArray(n))return n.length===0?[{name:"Inconnu",address:""}]:n.map(u=>typeof u=="string"?{address:u}:typeof u=="object"&&u!==null?{name:u.name||void 0,address:u.address||u.email||""}:{name:"Inconnu",address:""});if(typeof n=="object"&&n!==null)return[{name:n.name||void 0,address:n.address||n.email||""}];if(typeof n=="string"){const u=n.match(/(.*)<(.*)>/);return u?[{name:u[1].trim(),address:u[2].trim()}]:[{address:n}]}return[{name:"Inconnu",address:""}]},St=n=>{if(!n||!n.from)return"Inconnu";const u=Ct(n.from);return u.length===0?"Inconnu":u[0].name&&u[0].name.trim()?u[0].name:u[0].address?u[0].address:"Inconnu"},kt=n=>n&&n.subject||"(Sans objet)";function Et({currentFolder:n,onFolderChange:u,userId:I=1}){const D=xa(I),E=xa(I);return e.jsx(As,{defaultValue:n,value:n,onValueChange:u,className:"w-full",children:e.jsxs($s,{className:"grid grid-cols-4 mb-4",children:[e.jsxs(ae,{value:pe,className:"flex items-center justify-center",children:[e.jsx(ks,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Boîte de réception"}),e.jsx("span",{className:"inline sm:hidden",children:"Réception"}),D.unreadCount>0&&e.jsx(J,{variant:"secondary",className:"ml-2",children:D.unreadCount})]}),e.jsxs(ae,{value:cs,className:"flex items-center justify-center",children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Messages envoyés"}),e.jsx("span",{className:"inline sm:hidden",children:"Envoyés"})]}),e.jsxs(ae,{value:os,className:"flex items-center justify-center",children:[e.jsx(at,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:"Spam"}),E.unreadCount>0&&e.jsx(J,{variant:"secondary",className:"ml-2",children:E.unreadCount})]}),e.jsxs(ae,{value:ds,className:"flex items-center justify-center",children:[e.jsx(tt,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Corbeille"}),e.jsx("span",{className:"inline sm:hidden",children:"Corbeille"})]})]})})}function fa({value:n,onChange:u}){const[I,D]=l.useState(!1),[E,i]=l.useState(n||"#1e40af"),S=l.useRef(null),t=["#1e40af","#0ea5e9","#0f766e","#ef4444","#f97316","#84cc16","#6366f1","#8b5cf6","#ec4899","#000000","#71717a","#d4d4d8"];l.useEffect(()=>{n&&n!==E&&i(n)},[n]);const $=w=>{i(w),u(w),D(!1)},h=w=>{const F=w.target.value;i(F),u(F)};return e.jsxs(Na,{open:I,onOpenChange:D,children:[e.jsx(ya,{asChild:!0,children:e.jsx(d,{variant:"outline",className:"w-10 h-10 p-0 border-2",style:{backgroundColor:E},onClick:()=>D(!0),children:e.jsx("span",{className:"sr-only",children:"Choisir une couleur"})})}),e.jsx(ba,{className:"w-64",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"current-color",children:"Couleur courante"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded border",style:{backgroundColor:E}}),e.jsx(A,{id:"current-color",ref:S,type:"text",value:E,onChange:h,className:"flex-1"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Couleurs prédéfinies"}),e.jsx("div",{className:"grid grid-cols-6 gap-2",children:t.map(w=>e.jsx("button",{className:`w-8 h-8 rounded-sm border ${E===w?"ring-2 ring-offset-2 ring-offset-white ring-primary":""}`,style:{backgroundColor:w},onClick:()=>$(w),type:"button"},w))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(d,{variant:"secondary",size:"sm",onClick:()=>{S.current&&(S.current.value="#1e40af",$("#1e40af"))},children:"Réinitialiser"}),e.jsx(d,{variant:"default",size:"sm",onClick:()=>{$(E)},children:"Appliquer"})]})]})})]})}function At({initialHtml:n="",onSave:u,onClose:I,isOpen:D}){const{toast:E}=Zs();l.useEffect(()=>{n&&n.length>0&&console.log("HTML initial reçu",n.substring(0,50))},[n]);const[i,S]=l.useState({name:"Votre Nom",title:"Votre titre",company:"Raccordement Électrique",email:"votre.email@raccordement.fr",phone:"+33 6 12 34 56 78",website:"www.raccordement.fr",address:"123 Rue du Raccordement, 75000 Paris"}),[t,$]=l.useState({template:"modern",nameColor:"#1e40af",accentColor:"#3b82f6",fontSize:"medium",includeCompanyLogo:!0,includeSocialLinks:!0,includeAddress:!0,dividerStyle:"solid"}),[h,w]=l.useState({linkedin:"",twitter:"",facebook:""}),F=(m,B)=>{S({...i,[m]:B})},q=(m,B)=>{$({...t,[m]:B})},de=(m,B)=>{w({...h,[m]:B})},Y=()=>{const m={modern:`
        <div style="font-family: Arial, sans-serif; max-width: 500px; color: #333;">
          <table cellpadding="0" cellspacing="0" style="width: 100%;">
            <tr>
              <td style="padding-bottom: 10px;">
                <div style="font-size: ${t.fontSize==="small"?"18px":t.fontSize==="medium"?"20px":"22px"}; font-weight: bold; color: ${t.nameColor};">${i.name}</div>
                <div style="font-size: ${t.fontSize==="small"?"13px":t.fontSize==="medium"?"14px":"15px"}; color: #666;">${i.title}${i.company?` | ${i.company}`:""}</div>
              </td>
              ${t.includeCompanyLogo?`
              <td style="text-align: right;">
                <img src="https://placehold.co/100x50?text=Logo" alt="${i.company} Logo" style="max-width: 100px; height: auto;" />
              </td>
              `:""}
            </tr>
            <tr>
              <td colspan="2">
                <div style="border-top: 1px ${t.dividerStyle} ${t.accentColor}; margin: 10px 0;"></div>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <table cellpadding="0" cellspacing="0" style="width: 100%; font-size: ${t.fontSize==="small"?"12px":t.fontSize==="medium"?"13px":"14px"};">
                  <tr>
                    <td style="padding-right: 15px;">
                      <a href="mailto:${i.email}" style="color: ${t.accentColor}; text-decoration: none;">${i.email}</a>
                    </td>
                    <td>
                      <a href="tel:${i.phone}" style="color: ${t.accentColor}; text-decoration: none;">${i.phone}</a>
                    </td>
                  </tr>
                  ${i.website?`
                  <tr>
                    <td colspan="2" style="padding-top: 5px;">
                      <a href="https://${i.website}" style="color: ${t.accentColor}; text-decoration: none;">${i.website}</a>
                    </td>
                  </tr>
                  `:""}
                  ${t.includeAddress&&i.address?`
                  <tr>
                    <td colspan="2" style="padding-top: 5px; color: #666;">
                      ${i.address}
                    </td>
                  </tr>
                  `:""}
                </table>
              </td>
            </tr>
            ${t.includeSocialLinks&&(h.linkedin||h.twitter||h.facebook)?`
            <tr>
              <td colspan="2" style="padding-top: 10px;">
                <table cellpadding="0" cellspacing="0">
                  <tr>
                    ${h.linkedin?`
                    <td style="padding-right: 10px;">
                      <a href="${h.linkedin}" style="color: ${t.accentColor}; text-decoration: none;">LinkedIn</a>
                    </td>
                    `:""}
                    ${h.twitter?`
                    <td style="padding-right: 10px;">
                      <a href="${h.twitter}" style="color: ${t.accentColor}; text-decoration: none;">Twitter</a>
                    </td>
                    `:""}
                    ${h.facebook?`
                    <td>
                      <a href="${h.facebook}" style="color: ${t.accentColor}; text-decoration: none;">Facebook</a>
                    </td>
                    `:""}
                  </tr>
                </table>
              </td>
            </tr>
            `:""}
          </table>
        </div>
      `,classic:`
        <div style="font-family: 'Times New Roman', Times, serif; max-width: 500px; color: #333;">
          <table cellpadding="0" cellspacing="0" style="width: 100%;">
            <tr>
              <td style="padding-bottom: 10px;">
                <div style="font-size: ${t.fontSize==="small"?"18px":t.fontSize==="medium"?"20px":"22px"}; font-weight: bold; color: ${t.nameColor};">${i.name}</div>
                <div style="font-size: ${t.fontSize==="small"?"13px":t.fontSize==="medium"?"14px":"15px"}; font-style: italic; color: #666;">${i.title}${i.company?` | ${i.company}`:""}</div>
              </td>
            </tr>
            <tr>
              <td>
                <div style="border-top: 1px ${t.dividerStyle} ${t.accentColor}; margin: 10px 0;"></div>
              </td>
            </tr>
            <tr>
              <td>
                <table cellpadding="0" cellspacing="0" style="width: 100%; font-size: ${t.fontSize==="small"?"12px":t.fontSize==="medium"?"13px":"14px"};">
                  <tr>
                    <td width="70" style="color: #666;">Email:</td>
                    <td>
                      <a href="mailto:${i.email}" style="color: ${t.accentColor}; text-decoration: none;">${i.email}</a>
                    </td>
                  </tr>
                  <tr>
                    <td style="color: #666;">Téléphone:</td>
                    <td>
                      <a href="tel:${i.phone}" style="color: ${t.accentColor}; text-decoration: none;">${i.phone}</a>
                    </td>
                  </tr>
                  ${i.website?`
                  <tr>
                    <td style="color: #666;">Site web:</td>
                    <td>
                      <a href="https://${i.website}" style="color: ${t.accentColor}; text-decoration: none;">${i.website}</a>
                    </td>
                  </tr>
                  `:""}
                  ${t.includeAddress&&i.address?`
                  <tr>
                    <td style="color: #666;">Adresse:</td>
                    <td style="color: #333;">
                      ${i.address}
                    </td>
                  </tr>
                  `:""}
                </table>
              </td>
            </tr>
            ${t.includeSocialLinks&&(h.linkedin||h.twitter||h.facebook)?`
            <tr>
              <td style="padding-top: 10px;">
                <div style="font-size: ${t.fontSize==="small"?"11px":t.fontSize==="medium"?"12px":"13px"}; color: #666;">
                  Retrouvez-moi sur: 
                  ${h.linkedin?`<a href="${h.linkedin}" style="color: ${t.accentColor}; text-decoration: none;">LinkedIn</a>`:""}
                  ${h.linkedin&&(h.twitter||h.facebook)?" | ":""}
                  ${h.twitter?`<a href="${h.twitter}" style="color: ${t.accentColor}; text-decoration: none;">Twitter</a>`:""}
                  ${h.twitter&&h.facebook?" | ":""}
                  ${h.facebook?`<a href="${h.facebook}" style="color: ${t.accentColor}; text-decoration: none;">Facebook</a>`:""}
                </div>
              </td>
            </tr>
            `:""}
          </table>
        </div>
      `,compact:`
        <div style="font-family: Helvetica, Arial, sans-serif; max-width: 400px; color: #333;">
          <table cellpadding="0" cellspacing="0" style="width: 100%;">
            <tr>
              <td>
                <span style="font-weight: bold; color: ${t.nameColor};">${i.name}</span>
                <span style="color: #666; margin-left: 10px; font-size: ${t.fontSize==="small"?"12px":t.fontSize==="medium"?"13px":"14px"};">${i.title}</span>
              </td>
            </tr>
            <tr>
              <td>
                <div style="margin: 5px 0; font-size: ${t.fontSize==="small"?"12px":t.fontSize==="medium"?"13px":"14px"}; color: #666;">
                  <a href="mailto:${i.email}" style="color: ${t.accentColor}; text-decoration: none;">${i.email}</a>
                  <span style="margin: 0 5px;">|</span>
                  <a href="tel:${i.phone}" style="color: ${t.accentColor}; text-decoration: none;">${i.phone}</a>
                  ${i.website?`
                  <span style="margin: 0 5px;">|</span>
                  <a href="https://${i.website}" style="color: ${t.accentColor}; text-decoration: none;">${i.website}</a>
                  `:""}
                </div>
              </td>
            </tr>
            ${t.includeAddress&&i.address?`
            <tr>
              <td>
                <div style="font-size: ${t.fontSize==="small"?"11px":t.fontSize==="medium"?"12px":"13px"}; color: #777;">
                  ${i.address}
                </div>
              </td>
            </tr>
            `:""}
            ${t.includeSocialLinks&&(h.linkedin||h.twitter||h.facebook)?`
            <tr>
              <td style="padding-top: 5px;">
                <div style="font-size: ${t.fontSize==="small"?"11px":t.fontSize==="medium"?"12px":"13px"}; color: #777;">
                  ${h.linkedin?`<a href="${h.linkedin}" style="color: ${t.accentColor}; text-decoration: none;">LinkedIn</a>`:""}
                  ${h.linkedin&&(h.twitter||h.facebook)?" · ":""}
                  ${h.twitter?`<a href="${h.twitter}" style="color: ${t.accentColor}; text-decoration: none;">Twitter</a>`:""}
                  ${h.twitter&&h.facebook?" · ":""}
                  ${h.facebook?`<a href="${h.facebook}" style="color: ${t.accentColor}; text-decoration: none;">Facebook</a>`:""}
                </div>
              </td>
            </tr>
            `:""}
          </table>
        </div>
      `};return m[t.template]||m.modern},C=()=>{const m=Y();u(m),E({title:"Signature enregistrée",description:"Votre signature a été enregistrée avec succès"})},k=()=>{const m=Y();navigator.clipboard.writeText(m).then(()=>{E({title:"Copié dans le presse-papiers",description:"Le code HTML de la signature a été copié"})},B=>{E({title:"Erreur de copie",description:"Impossible de copier la signature dans le presse-papiers",variant:"destructive"})})};return e.jsx($e,{open:D,onOpenChange:m=>!m&&I(),children:e.jsxs(Le,{className:"max-w-4xl max-h-[90vh] overflow-hidden",children:[e.jsxs(ze,{children:[e.jsxs(Ie,{className:"flex items-center gap-2",children:[e.jsx(Ca,{className:"h-5 w-5"}),"Assistant de signature"]}),e.jsx(Te,{children:"Créez et personnalisez votre signature d'email professionnelle"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto py-4",style:{maxHeight:"calc(90vh - 200px)"},children:[e.jsx("div",{className:"space-y-6 overflow-y-auto pr-2",children:e.jsxs(As,{defaultValue:"personal",children:[e.jsxs($s,{className:"grid grid-cols-3 mb-4",children:[e.jsxs(ae,{value:"personal",className:"flex items-center gap-1",children:[e.jsx(wt,{className:"h-4 w-4"}),e.jsx("span",{children:"Informations"})]}),e.jsxs(ae,{value:"style",className:"flex items-center gap-1",children:[e.jsx(vt,{className:"h-4 w-4"}),e.jsx("span",{children:"Style"})]}),e.jsxs(ae,{value:"social",className:"flex items-center gap-1",children:[e.jsx(gt,{className:"h-4 w-4"}),e.jsx("span",{children:"Social"})]})]}),e.jsx(se,{value:"personal",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"name",children:"Nom complet"}),e.jsx(A,{id:"name",value:i.name,onChange:m=>F("name",m.target.value),placeholder:"Votre nom complet"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"title",children:"Titre / Poste"}),e.jsx(A,{id:"title",value:i.title,onChange:m=>F("title",m.target.value),placeholder:"Votre titre ou poste"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"company",children:"Entreprise"}),e.jsx(A,{id:"company",value:i.company,onChange:m=>F("company",m.target.value),placeholder:"Nom de votre entreprise"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"email",children:"Email"}),e.jsx(A,{id:"email",type:"email",value:i.email,onChange:m=>F("email",m.target.value),placeholder:"votre.email@exemple.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"phone",children:"Téléphone"}),e.jsx(A,{id:"phone",value:i.phone,onChange:m=>F("phone",m.target.value),placeholder:"+33 6 12 34 56 78"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"website",children:"Site web"}),e.jsx(A,{id:"website",value:i.website,onChange:m=>F("website",m.target.value),placeholder:"www.votresite.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"address",children:"Adresse"}),e.jsx(hs,{id:"address",value:i.address,onChange:m=>F("address",m.target.value),placeholder:"Adresse de l'entreprise",rows:2})]})]})}),e.jsx(se,{value:"style",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Modèle de signature"}),e.jsxs(Re,{value:t.template,onValueChange:m=>q("template",m),children:[e.jsx(De,{children:e.jsx(Fe,{placeholder:"Choisir un modèle"})}),e.jsxs(Me,{children:[e.jsx(R,{value:"modern",children:"Moderne"}),e.jsx(R,{value:"classic",children:"Classique"}),e.jsx(R,{value:"compact",children:"Compact"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Couleur du nom"}),e.jsx(fa,{value:t.nameColor,onChange:m=>q("nameColor",m)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Couleur d'accent"}),e.jsx(fa,{value:t.accentColor,onChange:m=>q("accentColor",m)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Taille de police"}),e.jsxs(Re,{value:t.fontSize,onValueChange:m=>q("fontSize",m),children:[e.jsx(De,{children:e.jsx(Fe,{placeholder:"Choisir une taille"})}),e.jsxs(Me,{children:[e.jsx(R,{value:"small",children:"Petite"}),e.jsx(R,{value:"medium",children:"Moyenne"}),e.jsx(R,{value:"large",children:"Grande"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Style de séparateur"}),e.jsxs(Re,{value:t.dividerStyle,onValueChange:m=>q("dividerStyle",m),children:[e.jsx(De,{children:e.jsx(Fe,{placeholder:"Choisir un style"})}),e.jsxs(Me,{children:[e.jsx(R,{value:"solid",children:"Ligne pleine"}),e.jsx(R,{value:"dashed",children:"Ligne pointillée"}),e.jsx(R,{value:"dotted",children:"Ligne en pointillés"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between space-y-0 pt-2",children:[e.jsx(p,{htmlFor:"company-logo",children:"Inclure le logo"}),e.jsx(Es,{id:"company-logo",checked:t.includeCompanyLogo,onCheckedChange:m=>q("includeCompanyLogo",m)})]}),e.jsxs("div",{className:"flex items-center justify-between space-y-0",children:[e.jsx(p,{htmlFor:"include-address",children:"Inclure l'adresse"}),e.jsx(Es,{id:"include-address",checked:t.includeAddress,onCheckedChange:m=>q("includeAddress",m)})]}),e.jsxs("div",{className:"flex items-center justify-between space-y-0",children:[e.jsx(p,{htmlFor:"social-links",children:"Inclure les liens sociaux"}),e.jsx(Es,{id:"social-links",checked:t.includeSocialLinks,onCheckedChange:m=>q("includeSocialLinks",m)})]})]})}),e.jsx(se,{value:"social",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"linkedin",children:"LinkedIn"}),e.jsx(A,{id:"linkedin",value:h.linkedin,onChange:m=>de("linkedin",m.target.value),placeholder:"https://www.linkedin.com/in/votre-profil"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"twitter",children:"Twitter"}),e.jsx(A,{id:"twitter",value:h.twitter,onChange:m=>de("twitter",m.target.value),placeholder:"https://twitter.com/votre-compte"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"facebook",children:"Facebook"}),e.jsx(A,{id:"facebook",value:h.facebook,onChange:m=>de("facebook",m.target.value),placeholder:"https://www.facebook.com/votre-page"})]})]})})]})}),e.jsxs("div",{className:"border rounded-lg p-4 overflow-y-auto bg-white",children:[e.jsxs("div",{className:"text-sm font-medium mb-4 text-muted-foreground flex items-center",children:[e.jsx(Ya,{className:"h-4 w-4 mr-1"}),"Aperçu de la signature"]}),e.jsx("div",{className:"signature-preview",dangerouslySetInnerHTML:{__html:Y()}})]})]}),e.jsxs(Qe,{className:"gap-2",children:[e.jsx(d,{variant:"outline",onClick:I,children:"Annuler"}),e.jsxs(d,{variant:"outline",onClick:k,children:[e.jsx(ft,{className:"h-4 w-4 mr-2"}),"Copier le HTML"]}),e.jsxs(d,{onClick:C,children:[e.jsx(ga,{className:"h-4 w-4 mr-2"}),"Utiliser cette signature"]})]})]})})}function $t({isOpen:n,onClose:u,initialRecipient:I="",initialSubject:D="",initialBody:E="",selectedLead:i=null,selectedServiceRequest:S=null}){const{toast:t}=Zs(),[$,h]=l.useState(I),[w,F]=l.useState(I?[I]:[]),[q,de]=l.useState(D),[Y,C]=l.useState(E),[k,m]=l.useState(""),[B,xs]=l.useState([]),[fe,We]=l.useState(!1),[Ls,Je]=l.useState(!1),[ge,qe]=l.useState([]),[ve,O]=l.useState(""),[zs,Z]=l.useState(!1),[Ye,Ne]=l.useState(!1),[Is,ee]=l.useState(""),Oe=ns({mutationFn:async r=>{const g=await T("POST","/api/send-email",r);if(!g.ok){const b=await g.json();throw new Error(b.message||"Erreur lors de l'envoi de l'email")}return await g.json()},onSuccess:()=>{t({title:"Email envoyé",description:"Votre email a été envoyé avec succès"}),ls.invalidateQueries({queryKey:["/api/email-logs"]}),u()},onError:r=>{t({title:"Erreur",description:r.message,variant:"destructive"})}});l.useEffect(()=>{if(!n)return;(async()=>{Z(!0);try{const g=await T("GET","/api/email-templates");if(g.ok){const b=await g.json();b&&Array.isArray(b)?qe(b):b&&b.templates&&Array.isArray(b.templates)?qe(b.templates):qe([])}}catch(g){console.error("Erreur lors du chargement des modèles d'email:",g)}finally{Z(!1)}})()},[n]),l.useEffect(()=>{i&&(h(i.email),w.includes(i.email)||F([...w,i.email]))},[i]),l.useEffect(()=>{S&&(h(S.clientEmail),w.includes(S.clientEmail)||F([...w,S.clientEmail]))},[S]);const me=async()=>{if(k){We(!0),xs([]);try{let r=[],g=!1;try{const v=await T("GET",`/api/leads/search?term=${encodeURIComponent(k)}`);if(v.ok){const x=await v.json();x&&x.leads&&Array.isArray(x.leads)&&(r=x.leads,g=!0,console.log("Leads trouvés via /api/leads/search",x.leads.length))}}catch{console.log("Échec de recherche sur /api/leads/search, tentative suivante...")}if(!g)try{const v=await T("GET",`/api/leads?search=${encodeURIComponent(k)}`);if(v.ok){const x=await v.json();x&&x.leads&&Array.isArray(x.leads)?(r=x.leads,g=!0,console.log("Leads trouvés via /api/leads?search=",x.leads.length)):Array.isArray(x)&&(r=x,g=!0,console.log("Leads trouvés (format tableau) via /api/leads?search=",x.length))}}catch{console.log("Échec de recherche sur /api/leads?search, tentative suivante...")}if(!g)try{const v=await T("GET","/api/leads");if(v.ok){const x=await v.json();let Q=[];x&&x.leads&&Array.isArray(x.leads)?Q=x.leads:Array.isArray(x)&&(Q=x);const X=k.toLowerCase();r=Q.filter(z=>z.firstName.toLowerCase().includes(X)||z.lastName.toLowerCase().includes(X)||z.email.toLowerCase().includes(X)||z.phone&&z.phone.includes(k)||z.referenceNumber&&z.referenceNumber.toLowerCase().includes(X)),console.log("Leads trouvés par filtrage local",r.length)}}catch(v){console.error("Impossible de récupérer les leads:",v)}let b=[],U=!1;try{const v=await T("GET",`/api/service-requests/search?term=${encodeURIComponent(k)}`);if(v.ok){const x=await v.json();x&&x.requests&&Array.isArray(x.requests)&&(b=x.requests,U=!0)}}catch{console.log("Échec de recherche sur /api/service-requests/search, tentative suivante...")}if(!U)try{const v=await T("GET",`/api/service-requests?search=${encodeURIComponent(k)}`);if(v.ok){const x=await v.json();x&&x.requests&&Array.isArray(x.requests)?(b=x.requests,U=!0):Array.isArray(x)&&(b=x,U=!0)}}catch{console.log("Échec de recherche sur /api/service-requests?search, tentative suivante...")}if(!U)try{const v=await T("GET","/api/service-requests");if(v.ok){const x=await v.json();let Q=[];x&&x.requests&&Array.isArray(x.requests)?Q=x.requests:Array.isArray(x)&&(Q=x);const X=k.toLowerCase();b=Q.filter(z=>z.clientName.toLowerCase().includes(X)||z.clientEmail.toLowerCase().includes(X)||z.clientPhone.includes(k)||z.referenceNumber.toLowerCase().includes(X))}}catch(v){console.error("Impossible de récupérer les demandes:",v)}const be=[...r,...b];xs(be),Je(be.length>0),be.length===0?t({title:"Aucun résultat",description:"Aucun lead ou demande ne correspond à votre recherche"}):console.log(`${be.length} résultats trouvés au total (${r.length} leads, ${b.length} demandes)`)}catch(r){console.error("Erreur globale lors de la recherche:",r),t({title:"Erreur de recherche",description:"Impossible de charger les résultats",variant:"destructive"})}finally{We(!1)}}},us=r=>{if(r==="none"){O("none");return}O(r);const g=ge.find(b=>b.id===r);if(g){let b=g.subject,U=g.body;i&&(b=b.replace(/\{nom\}/gi,`${i.firstName} ${i.lastName}`).replace(/\{prenom\}/gi,i.firstName).replace(/\{reference\}/gi,i.referenceNumber||""),U=U.replace(/\{nom\}/gi,`${i.firstName} ${i.lastName}`).replace(/\{prenom\}/gi,i.firstName).replace(/\{reference\}/gi,i.referenceNumber||"")),S&&(b=b.replace(/\{nom\}/gi,S.clientName).replace(/\{reference\}/gi,S.referenceNumber),U=U.replace(/\{nom\}/gi,S.clientName).replace(/\{reference\}/gi,S.referenceNumber)),de(b),C(U),t({title:"Modèle appliqué",description:`Le modèle "${g.name}" a été appliqué au message`})}},M=r=>{!r||w.includes(r)||(F([...w,r]),h(""),Je(!1))},ye=r=>{F(w.filter(g=>g!==r))},ie=r=>{const g="clientEmail"in r?r.clientEmail:r.email;M(g),t({title:"Destinataire ajouté",description:`${g} a été ajouté aux destinataires`})},ps=()=>{if(w.length===0){t({title:"Destinataire manquant",description:"Veuillez ajouter au moins un destinataire",variant:"destructive"});return}if(!q){t({title:"Sujet manquant",description:"Veuillez ajouter un sujet à votre email",variant:"destructive"});return}if(!Y){t({title:"Contenu manquant",description:"Veuillez ajouter du contenu à votre email",variant:"destructive"});return}const r={to:w.join(","),subject:q,content:Y,leadId:i==null?void 0:i.id,serviceRequestId:S==null?void 0:S.id,templateId:ve||void 0};Oe.mutate(r)},ne=r=>"firstName"in r,js=r=>{ee(r),C(Y+`

`+r),Ne(!1),t({title:"Signature ajoutée",description:"Votre signature a été ajoutée à l'email"})};return e.jsxs(e.Fragment,{children:[e.jsx(At,{isOpen:Ye,onClose:()=>Ne(!1),onSave:js,initialHtml:Is}),e.jsx($e,{open:n,onOpenChange:r=>!r&&u(),children:e.jsxs(Le,{className:"max-w-3xl max-h-[90vh] overflow-hidden",children:[e.jsxs(ze,{children:[e.jsxs(Ie,{className:"flex items-center gap-2",children:[e.jsx(Ga,{className:"h-5 w-5"}),"Nouveau message"]}),e.jsx(Te,{children:"Composez votre email et envoyez-le à vos contacts"})]}),e.jsx("div",{className:"overflow-y-auto p-1",style:{maxHeight:"calc(90vh - 200px)"},children:e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(p,{htmlFor:"recipient",className:"text-sm font-medium mb-1 text-muted-foreground",children:"À:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Na,{open:Ls,onOpenChange:Je,children:[e.jsx(ya,{asChild:!0,children:e.jsxs(d,{variant:"outline",size:"sm",className:"h-8 gap-1",children:[e.jsx(Ks,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Rechercher"})]})}),e.jsxs(ba,{className:"w-80 p-0",align:"end",children:[e.jsx("div",{className:"p-3 border-b",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{placeholder:"Nom, email, référence...",value:k,onChange:r=>m(r.target.value),className:"h-8 text-sm"}),e.jsx(d,{size:"sm",variant:"secondary",className:"h-8 px-3",onClick:me,disabled:fe||!k,children:fe?e.jsx(V,{className:"h-3.5 w-3.5 animate-spin"}):e.jsx(Ks,{className:"h-3.5 w-3.5"})})]})}),e.jsx("div",{className:"max-h-[300px] overflow-y-auto p-0",children:B.length>0?e.jsx("div",{className:"divide-y",children:B.map(r=>e.jsxs("div",{className:"p-2.5 hover:bg-muted flex items-center justify-between cursor-pointer",onClick:()=>ie(r),children:[e.jsx("div",{className:"overflow-hidden",children:e.jsxs("div",{className:"flex items-center gap-2",children:[ne(r)?e.jsx(Ae,{className:"h-4 w-4 text-blue-500 flex-shrink-0"}):e.jsx(je,{className:"h-4 w-4 text-amber-500 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium truncate",children:ne(r)?`${r.firstName} ${r.lastName}`:r.clientName}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:ne(r)?r.email:r.clientEmail})]})]})}),e.jsx(va,{className:"h-4 w-4 text-muted-foreground"})]},ne(r)?`lead-${r.id}`:`request-${r.id}`))}):fe?e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(V,{className:"h-8 w-8 animate-spin mx-auto text-muted-foreground opacity-50 mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Recherche en cours..."})]}):k?e.jsx("div",{className:"p-6 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun résultat trouvé"})}):e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(Ks,{className:"h-8 w-8 mx-auto text-muted-foreground opacity-20 mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Recherchez des contacts par nom, email ou référence"})]})})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(Re,{value:ve,onValueChange:us,children:[e.jsx(De,{className:"h-8 text-xs w-44",children:e.jsx(Fe,{placeholder:"Choisir un modèle"})}),e.jsxs(Me,{children:[e.jsx(R,{value:"none",children:"Aucun modèle"}),ge.map(r=>e.jsx(R,{value:r.id,children:r.name},r.id))]})]}),e.jsxs($e,{children:[e.jsx(Ka,{asChild:!0,children:e.jsx(d,{variant:"outline",size:"icon",className:"h-8 w-8",title:"Gérer les modèles",children:e.jsx(ja,{className:"h-4 w-4"})})}),e.jsxs(Le,{className:"max-w-xl",children:[e.jsxs(ze,{children:[e.jsxs(Ie,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5"}),"Gérer les modèles d'emails"]}),e.jsx(Te,{children:"Créez et personnalisez vos modèles d'emails pour une utilisation rapide"})]}),e.jsxs(As,{defaultValue:"new",className:"mt-4",children:[e.jsxs($s,{className:"grid grid-cols-2 mb-4",children:[e.jsxs(ae,{value:"new",className:"flex items-center gap-1",children:[e.jsx(ja,{className:"h-4 w-4"}),e.jsx("span",{children:"Nouveau modèle"})]}),e.jsxs(ae,{value:"list",className:"flex items-center gap-1",children:[e.jsx(Nt,{className:"h-4 w-4"}),e.jsx("span",{children:"Modèles existants"})]})]}),e.jsxs(se,{value:"new",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"templateName",children:"Nom du modèle"}),e.jsx(A,{id:"templateName",placeholder:"Ex: Confirmation de commande"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"templateSubject",children:"Sujet"}),e.jsx(A,{id:"templateSubject",placeholder:"Ex: Confirmation de votre demande {reference}"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"templateBody",children:"Corps du message"}),e.jsx(hs,{id:"templateBody",placeholder:"Bonjour {prenom},\\n\\nNous avons bien reçu votre demande avec la référence {reference}.",className:"min-h-[150px]"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Es,{id:"templateActive",defaultChecked:!0}),e.jsx(p,{htmlFor:"templateActive",children:"Activer ce modèle"})]}),e.jsxs("div",{className:"bg-muted rounded-md p-3 text-sm space-y-1",children:[e.jsx("h3",{className:"text-sm font-medium",children:"Variables disponibles :"}),e.jsxs("p",{children:[e.jsx("code",{children:"{nom}"})," - Nom complet du client"]}),e.jsxs("p",{children:[e.jsx("code",{children:"{prenom}"})," - Prénom du client"]}),e.jsxs("p",{children:[e.jsx("code",{children:"{reference}"})," - Numéro de référence"]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[e.jsx(d,{variant:"outline",children:"Annuler"}),e.jsx(d,{type:"submit",onClick:()=>{var v,x,Q,X;const r=(v=document.getElementById("templateName"))==null?void 0:v.value,g=(x=document.getElementById("templateSubject"))==null?void 0:x.value,b=(Q=document.getElementById("templateBody"))==null?void 0:Q.value,U=(X=document.getElementById("templateActive"))==null?void 0:X.checked;if(!r||!g||!b){t({title:"Formulaire incomplet",description:"Veuillez remplir tous les champs requis",variant:"destructive"});return}(async()=>{try{const z=await T("POST","/api/email-templates",{name:r,subject:g,body:b,active:U||!1,trigger:"manual"});if(z.ok){if(await z.json()){const Ze=await T("GET","/api/email-templates");if(Ze.ok){const fs=await Ze.json();Array.isArray(fs)&&qe(fs)}t({title:"Modèle enregistré",description:`Le modèle "${r}" a été créé avec succès`})}}else throw new Error("Impossible d'enregistrer le modèle")}catch(z){console.error("Erreur lors de l'enregistrement du modèle:",z),t({title:"Erreur",description:"Impossible d'enregistrer le modèle",variant:"destructive"})}})()},children:"Enregistrer le modèle"})]})]}),e.jsx(se,{value:"list",children:e.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto",children:ge.length>0?e.jsx("div",{className:"space-y-2 divide-y",children:ge.map(r=>e.jsx("div",{className:"pt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:r.name}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:r.subject})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"Modifier",children:e.jsx(wa,{className:"h-4 w-4"})}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"Utiliser ce modèle",onClick:()=>{us(r.id);const g=document.querySelector("[data-dialog-close]");g&&g.click()},children:e.jsx(ga,{className:"h-4 w-4"})})]})]})},r.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(je,{className:"h-10 w-10 mx-auto text-muted-foreground opacity-20 mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Aucun modèle disponible"})]})})})]})]})]})]})]})]}),e.jsxs("div",{className:"flex items-center mt-1 border rounded-md px-3 py-2 focus-within:ring-1 focus-within:ring-primary focus-within:border-primary",children:[e.jsx("div",{className:"flex flex-wrap gap-1.5 mr-2",children:w.map(r=>e.jsxs(J,{variant:"secondary",className:"gap-1.5 py-1",children:[e.jsx("span",{className:"text-xs",children:r}),e.jsx("button",{type:"button",onClick:()=>ye(r),className:"h-3.5 w-3.5 rounded-full hover:bg-muted-foreground/10 inline-flex items-center justify-center",children:e.jsx(Ys,{className:"h-2.5 w-2.5"})})]},r))}),e.jsx(A,{id:"recipient",value:$,onChange:r=>h(r.target.value),placeholder:w.length>0?"":"Destinataires",className:"border-0 focus-visible:ring-0 px-0 py-1 h-8 text-sm focus-visible:outline-none",onKeyDown:r=>{r.key==="Enter"&&$&&(r.preventDefault(),M($))}})]})]}),e.jsx("div",{children:e.jsx(A,{value:q,onChange:r=>de(r.target.value),placeholder:"Sujet",className:"border-x-0 border-t-0 rounded-none focus-visible:ring-0 px-3 py-3 text-base focus-visible:border-primary"})}),e.jsx("div",{children:e.jsx(hs,{value:Y,onChange:r=>C(r.target.value),placeholder:"Rédigez votre message ici...",className:"min-h-[200px] focus-visible:ring-0 p-3 resize-none"})})]})}),e.jsxs(Qe,{className:"mt-4 flex items-center justify-between space-x-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"icon",className:"rounded-full",title:"Joindre un fichier",children:e.jsx(bt,{className:"h-4 w-4"})}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>Ne(!0),className:"flex items-center gap-1 h-8",children:[e.jsx(Ca,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"text-xs",children:"Signature"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",onClick:u,children:"Annuler"}),e.jsx(d,{onClick:ps,disabled:Oe.isPending||w.length===0||!q||!Y,children:Oe.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-4 w-4 animate-spin mr-2"}),"Envoi..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"Envoyer"]})})]})]})]})})]})}function Js({currentPage:n,totalPages:u,totalEmails:I,indexOfFirstEmail:D,indexOfLastEmail:E,onPageChange:i}){return e.jsxs("div",{className:"flex justify-between items-center py-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Affichage de ",D+1," à ",Math.min(E,I)," sur ",I," emails"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:()=>i(n-1),disabled:n===1,children:e.jsx(rt,{className:"h-4 w-4"})}),Array.from({length:Math.min(u,5)},(S,t)=>{let $=0;return u<=5||n<=3?$=t+1:n>=u-2?$=u-4+t:$=n-2+t,e.jsx(d,{variant:n===$?"default":"outline",size:"sm",onClick:()=>i($),className:"w-8 h-8 p-0",children:$},$)}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>i(n+1),disabled:n===u||u===0,children:e.jsx(va,{className:"h-4 w-4"})})]})]})}const Lt=({template:n,onEdit:u,onSendTest:I,onDelete:D,onSend:E})=>e.jsxs(ce,{children:[e.jsxs(Ge,{className:"pb-2",children:[e.jsxs(Ke,{className:"text-base flex items-start justify-between",children:[e.jsx("span",{className:"truncate mr-2",children:n.name}),n.active?e.jsx(J,{variant:"outline",className:"bg-green-50 text-green-700 hover:bg-green-50 border-green-200",children:"Actif"}):e.jsx(J,{variant:"outline",className:"bg-gray-50 text-gray-500 hover:bg-gray-50 border-gray-200",children:"Inactif"})]}),e.jsxs(et,{className:"text-xs truncate",children:["Déclencheur: ",n.trigger]})]}),e.jsxs(oe,{className:"pb-3 text-sm",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold text-xs text-muted-foreground",children:"Sujet:"}),e.jsx("p",{className:"truncate",children:n.subject})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-xs text-muted-foreground",children:"Contenu:"}),e.jsx("p",{className:"line-clamp-2 text-sm text-muted-foreground",children:n.body})]})]}),e.jsxs(st,{className:"flex justify-between pt-0",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(d,{variant:"ghost",size:"sm",onClick:u,children:[e.jsx(wa,{className:"h-3.5 w-3.5 mr-1"}),"Éditer"]}),e.jsxs(d,{variant:"ghost",size:"sm",onClick:I,children:[e.jsx(Xe,{className:"h-3.5 w-3.5 mr-1"}),"Tester"]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:D,children:e.jsx(ms,{className:"h-3.5 w-3.5 text-red-500"})}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:E,children:e.jsx(Xe,{className:"h-3.5 w-3.5 text-blue-500"})})]})]})]});function jr(){return e.jsx(Wa,{title:"Mail",description:"Gestion de votre messagerie",children:e.jsx(zt,{})})}function zt(){var ma,ha;const{toast:n}=Zs(),[u,I]=l.useState(!1),[D,E]=l.useState([]),[i,S]=l.useState(!1),[t,$]=l.useState([]),[h,w]=l.useState(!1),[F,q]=l.useState(!1),[de,Y]=l.useState("inbox"),[C,k]=l.useState(null),[m,B]=l.useState(!1),[xs,fe]=l.useState(!1),[We,Ls]=l.useState(""),[Je,ge]=l.useState(!1),[qe,ve]=l.useState(!1),[O,zs]=l.useState(null),[Z,Ye]=l.useState([]),[Ne,Is]=l.useState(!1),[ee,Oe]=l.useState(""),[me,us]=l.useState("");l.useState(""),l.useState(!1);const[M,ye]=l.useState(""),[ie,ps]=l.useState([]),[ne,js]=l.useState(""),[r,g]=l.useState(""),[b,U]=l.useState("desc");l.useState("createdAt"),l.useState(!1);const[be,v]=l.useState(!1),[x,Q]=l.useState(""),[X,z]=l.useState(""),[ea,Ze]=l.useState(""),[fs,Ts]=l.useState(null),[Sa,sa]=l.useState(null),aa=async()=>{if(ee){I(!0),S(!0),w(!1);try{const s=await T("GET","/api/leads");if(!s.ok)throw new Error("Erreur lors de la récupération des leads");const a=await s.json();if(a&&typeof a=="object"&&"leads"in a&&Array.isArray(a.leads)){const c=a.leads.filter(o=>{const j=`${o.firstName} ${o.lastName}`.toLowerCase(),L=o.email.toLowerCase(),W=ee.toLowerCase();return j.includes(W)||L.includes(W)||o.referenceNumber&&o.referenceNumber.toLowerCase().includes(W)});E(c)}else E([])}catch(s){console.error("Erreur lors de la recherche des leads:",s),n({title:"Erreur",description:"Impossible de charger les résultats de recherche",variant:"destructive"}),E([])}finally{I(!1)}}},ka=async()=>{if(ee){q(!0),w(!0),S(!1);try{const s=await T("GET","/api/service-requests");if(!s.ok)throw new Error("Erreur lors de la récupération des demandes");const a=await s.json();if(a&&Array.isArray(a)){const c=a.filter(o=>{const j=ee.toLowerCase();return o.referenceNumber.toLowerCase().includes(j)||o.clientName.toLowerCase().includes(j)||o.clientEmail.toLowerCase().includes(j)});$(c)}else $([])}catch(s){console.error("Erreur lors de la recherche des demandes:",s),n({title:"Erreur",description:"Impossible de charger les résultats de recherche",variant:"destructive"}),$([])}finally{q(!1)}}},{user:_}=Za(),[P,Pe]=l.useState(0),[G,Ve]=l.useState(pe);l.useEffect(()=>{_&&_.id&&Pe(_.id)},[_]),l.useEffect(()=>{const s=new URLSearchParams(window.location.search),a=s.get("leadId");if(s.get("view"),a){const c=parseInt(a,10);isNaN(c)||(Ts({id:c}),v(!0))}try{const c=sessionStorage.getItem("reply_to_email");if(c){const o=JSON.parse(c);o&&setTimeout(()=>{Ps(o),sessionStorage.removeItem("reply_to_email")},500)}}catch(c){console.error("Erreur lors de la récupération de l'email à répondre:",c)}},[]);const[f,he]=l.useState(null),[Be,xe]=l.useState(!1),[gs,Rs]=l.useState(1),Ds=20,vs=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s),{data:le,isLoading:Ea}=_e({queryKey:["/api/leads"],queryFn:rs({on401:"returnNull"})}),{data:Ue,isLoading:Aa}=_e({queryKey:["/api/email-logs"],queryFn:rs({on401:"returnNull"})}),{data:Ns,isLoading:$a}=_e({queryKey:["/api/users"],queryFn:rs({on401:"returnNull"})});_e({queryKey:["/api/mailboxes",P],queryFn:rs({on401:"returnNull"}),enabled:!!P});const{data:te,isLoading:ue,refetch:Fs}=_e({queryKey:["/api/user-emails",P,G],queryFn:async({queryKey:s})=>{const[a,c,o]=s;if(!c)throw new Error("ID utilisateur requis");const j=await T("GET",`/api/user-emails?userId=${c}&selectedMailbox=${o||"INBOX"}`);if(!j.ok){const L=await j.json();throw new Error(L.message||"Erreur lors de la récupération des emails")}return j.json()},enabled:!!P&&!!G}),{data:H,isLoading:ta}=_e({queryKey:["/api/email-templates"],queryFn:rs({on401:"returnNull"})});l.useEffect(()=>{const a=new URLSearchParams(window.location.search).get("view");if(a&&te&&typeof te=="object"&&"emails"in te){const c=te.emails.find(o=>o.id===a);c&&we(c)}},[te]);const La=H&&typeof H=="object"&&"templates"in H&&Array.isArray(H.templates)?H.templates.length:0,za=H&&typeof H=="object"&&"templates"in H&&Array.isArray(H.templates)?H.templates.filter(s=>s.active).length:0,Ms=Array.isArray(Ue)?Ue.length:0,Ia=Ms>0&&Array.isArray(Ue)?Math.round(Ue.filter(s=>s.status==="delivered"||s.status==="opened"||s.status==="clicked").length/Ms*100):0,es=H&&typeof H=="object"&&"templates"in H&&Array.isArray(H.templates)?H.templates:[],ra=ns({mutationFn:async({userId:s,messageId:a,isRead:c,mailbox:o})=>{const j=await T("POST","/api/mark-email",{userId:s,messageId:a,isRead:c,mailbox:o});if(!j.ok){const L=await j.json();throw new Error(L.message||"Erreur lors du marquage de l'email")}return j.json()},onSuccess:()=>{ls.invalidateQueries({queryKey:["/api/user-emails",P,G]}),n({title:"Email mis à jour",variant:"default"})},onError:s=>{n({title:"Erreur lors de la mise à jour de l'email",description:s.message,variant:"destructive"})}}),qs=ns({mutationFn:async({userId:s,messageId:a,destinationMailbox:c,sourceMailbox:o})=>{const j=await T("POST","/api/move-email",{userId:s,messageId:a,destinationMailbox:c,sourceMailbox:o});if(!j.ok){const L=await j.json();throw new Error(L.message||"Erreur lors du déplacement de l'email")}return j.json()},onSuccess:()=>{ls.invalidateQueries({queryKey:["/api/user-emails",P,G]}),he(null),xe(!1),n({title:"Email déplacé",variant:"default"})},onError:s=>{n({title:"Erreur lors du déplacement de l'email",description:s.message,variant:"destructive"})}}),Os=ns({mutationFn:async({userId:s,messageId:a,mailbox:c})=>{const o=await T("DELETE","/api/delete-email",{userId:s,messageId:a,mailbox:c});if(!o.ok){const j=await o.json();throw new Error(j.message||"Erreur lors de la suppression de l'email")}return o.json()},onSuccess:()=>{ls.invalidateQueries({queryKey:["/api/user-emails",P,G]}),he(null),xe(!1),n({title:"Email supprimé",variant:"default"})},onError:s=>{n({title:"Erreur lors de la suppression de l'email",description:s.message,variant:"destructive"})}}),ys=ns({mutationFn:async s=>{const a={...s,body:s.content,content:s.content};return await(await T("POST","/api/send-email",a)).json()},onSuccess:()=>{n({title:"Email envoyé avec succès",variant:"default"}),ve(!1),ls.invalidateQueries({queryKey:["/api/email-logs"]})},onError:s=>{n({title:"Erreur lors de l'envoi de l'email",description:s.message,variant:"destructive"})}}),Ps=s=>{if(!s){n({title:"Erreur",description:"Impossible de répondre à cet email",variant:"destructive"});return}const a=kt(s),c=a.startsWith("Re: ")?a:`Re: ${a}`;let o="";if(s.from){if(Array.isArray(s.from)&&s.from.length>0)s.from[0].address?o=s.from[0].address:typeof s.from[0]=="string"&&(o=s.from[0]);else if(typeof s.from=="object"&&s.from!==null){if("address"in s.from&&s.from.address)o=s.from.address;else if("text"in s.from&&s.from.text){const as=String(s.from.text).match(/<([^>]+)>/);o=as?as[1]:s.from.text}}else if(typeof s.from=="string"){const as=s.from.match(/<([^>]+)>/);o=as?as[1]:s.from}}if(!o){n({title:"Erreur",description:"Impossible de déterminer l'adresse de l'expéditeur",variant:"destructive"});return}const j=s.date?new Date(s.date).toLocaleString("fr-FR"):"Date inconnue",W=`

--------- Message original ---------
De: ${St(s)}
Date: ${j}
Objet: ${a}

`,_a=s.text||"";console.log("Réponse à l'email - Destinataire:",o),Q(o),z(c),Ze(W+_a),Ts(null),sa(null),v(!0)},Ta=s=>{s==="no-user"||!s?_&&_.id?Pe(_.id):Pe(1):(Pe(parseInt(s)),Ve(pe)),he(null),xe(!1)},Ra=s=>{Y(s),Rs(1),(s===pe.toLowerCase()||s===cs.toLowerCase()||s===os.toLowerCase()||s===ds.toLowerCase())&&(s===pe.toLowerCase()?Ve(pe):s===cs.toLowerCase()?Ve(cs):s===os.toLowerCase()?Ve(os):s===ds.toLowerCase()&&Ve(ds),he(null),xe(!1),Fs())},we=s=>{he(s),xe(!0),s.isRead||ra.mutate({userId:P,messageId:s.id,isRead:!0,mailbox:G})},[ia,Da]=l.useState(null),[Fa,Vs]=l.useState(!1),Bs=(s,a,c)=>{Da({userId:s,messageId:a,mailbox:c}),Vs(!0)},Ma=()=>{ia&&Os.mutate(ia),Vs(!1)},na=(s,a)=>{Ye(a?c=>[...c,s]:c=>c.filter(o=>o.id!==s.id))},qa=s=>{zs(s),js(s.subject),g(s.body),ve(!0)},Oa=s=>{if(Z.length===0){n({title:"Aucun lead sélectionné",description:"Veuillez sélectionner au moins un lead avant d'envoyer.",variant:"destructive"});return}Z.forEach(a=>{const c={leadId:a.id,templateId:s.id,to:a.email,subject:s.subject,content:s.body,recipients:[{id:a.id,email:a.email,name:`${a.firstName} ${a.lastName}`,referenceNumber:a.referenceNumber}]};ys.mutate(c)})};l.useEffect(()=>{if(Ne){const s=le&&"leads"in le?le.leads.filter(a=>{const c=`${a.firstName} ${a.lastName}`.toLowerCase(),o=a.email.toLowerCase(),j=ee.toLowerCase(),L=c.includes(j)||o.includes(j)||a.referenceNumber&&a.referenceNumber.toLowerCase().includes(j),W=!me||a.status&&a.status===me;return L&&W}):[];Ye(s)}},[Ne,le,ee,me]);const Ce=te&&typeof te=="object"&&"emails"in te&&Array.isArray(te.emails)?[...te.emails].sort((s,a)=>{if(!s.isRead&&a.isRead)return-1;if(s.isRead&&!a.isRead)return 1;const c=new Date(s.date).getTime(),o=new Date(a.date).getTime();return b==="desc"?o-c:c-o}):[],bs=Ce.length,Us=Math.ceil(bs/Ds),ss=gs*Ds,ws=ss-Ds,He=Ce.slice(ws,ss),Hs=s=>{Rs(s),window.scrollTo(0,0)},la=le&&typeof le=="object"&&"leads"in le&&Array.isArray(le.leads)?le.leads.filter(s=>{const a=`${s.firstName} ${s.lastName}`.toLowerCase(),c=s.email.toLowerCase(),o=ee.toLowerCase(),j=a.includes(o)||c.includes(o)||s.referenceNumber&&s.referenceNumber.toLowerCase().includes(o),L=!me||s.status&&s.status===me;return j&&L}):[],ca=Array.isArray(Ue)?Ue.filter(s=>!0):[],oa=Array.isArray(ca)?[...ca].sort((s,a)=>{const c=new Date(s.createdAt).getTime(),o=new Date(a.createdAt).getTime();return b==="desc"?o-c:c-o}):[],Pa=()=>{if(!M&&ie.length===0){n({title:"Aucun destinataire spécifié",description:"Veuillez ajouter au moins un destinataire.",variant:"destructive"});return}if(!ne){n({title:"Sujet vide",description:"Veuillez ajouter un sujet à votre email.",variant:"destructive"});return}if(!r){n({title:"Contenu vide",description:"Veuillez ajouter du contenu à votre email.",variant:"destructive"});return}const s=[...ie];M&&!s.includes(M)&&s.push(M);const a={templateId:(O==null?void 0:O.id)||"",to:s.join(","),subject:ne,content:r};ys.mutate(a)},Va=()=>{M&&vs(M)&&!ie.includes(M)?(ps(s=>[...s,M]),ye("")):M&&!vs(M)?n({title:"Format d'email invalide",description:"Veuillez entrer une adresse email valide.",variant:"destructive"}):ie.includes(M)&&(n({title:"Destinataire déjà ajouté",description:"Ce destinataire est déjà dans la liste.",variant:"default"}),ye(""))},Ba=s=>{ps(a=>a.filter(c=>c!==s))},[da,It]=Qa();l.useState(0);const Ua=async s=>{const a=await T("GET",`/api/mailboxes?userId=${s}`);if(!a.ok)throw new Error("Erreur lors du chargement des boîtes mail");await a.json()},Ha=async(s,a)=>{const c=await T("GET",`/api/user-emails?userId=${s}&selectedMailbox=${a}`);if(!c.ok)throw new Error("Erreur lors du chargement des emails");await c.json()};return l.useEffect(()=>{_&&(new URLSearchParams(da.split("?")[1]||"").get("defaultUser")==="contact@demande-raccordement.fr"&&_.username==="admin"?(Pe(_.id),Ua(_.id),Ha(_.id,"INBOX")):Pe(_.id))},[da,_]),e.jsxs("div",{className:"pb-10",children:[e.jsxs("div",{className:"flex flex-col gap-8",children:[e.jsxs("div",{className:"space-y-4 xl:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Mail"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Re,{value:P.toString(),onValueChange:Ta,children:[e.jsx(De,{className:"w-[200px]",children:e.jsx(Fe,{placeholder:"Sélectionner un utilisateur"})}),e.jsx(Me,{children:$a?e.jsx("div",{className:"flex items-center justify-center py-2",children:e.jsx(V,{className:"h-4 w-4 animate-spin"})}):Ns&&"users"in Ns&&Array.isArray(Ns.users)&&Ns.users.map(s=>e.jsxs(R,{value:s.id.toString(),children:[s.username," (",s.email,")"]},s.id))})]}),e.jsx(d,{variant:"outline",size:"icon",onClick:()=>Fs(),disabled:ue,children:ue?e.jsx(V,{className:"h-4 w-4 animate-spin"}):e.jsx(xt,{className:"h-4 w-4"})}),e.jsxs(d,{variant:"default",onClick:()=>{Q(""),z(""),Ze(""),Ts(null),sa(null),v(!0)},children:[e.jsx(_s,{className:"h-4 w-4 mr-2"}),"Nouveau message"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(ce,{children:[e.jsx(Ge,{className:"pb-2",children:e.jsx(Ke,{className:"text-sm font-medium",children:"Messages non lus"})}),e.jsxs(oe,{children:[e.jsx("div",{className:"text-2xl font-bold",children:Ce.filter(s=>!s.isRead).length}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",Ce.filter(s=>!s.isRead&&new Date(s.date)>new Date(Date.now()-24*60*60*1e3)).length," aujourd'hui"]})]})]}),e.jsxs(ce,{children:[e.jsx(Ge,{className:"pb-2",children:e.jsx(Ke,{className:"text-sm font-medium",children:"Modèles disponibles"})}),e.jsxs(oe,{children:[e.jsx("div",{className:"text-2xl font-bold",children:La}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[za," modèles actifs"]})]})]}),e.jsxs(ce,{children:[e.jsx(Ge,{className:"pb-2",children:e.jsx(Ke,{className:"text-sm font-medium",children:"Emails envoyés (30j)"})}),e.jsxs(oe,{children:[e.jsx("div",{className:"text-2xl font-bold",children:Ms}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Taux de délivrance: ",Ia,"%"]})]})]}),e.jsxs(ce,{children:[e.jsx(Ge,{className:"pb-2",children:e.jsx(Ke,{className:"text-sm font-medium",children:"Dossiers disponibles"})}),e.jsxs(oe,{children:[e.jsx("div",{className:"text-2xl font-bold",children:"4 "}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Boîte active: ",G]})]})]})]})]}),e.jsx("div",{className:"flex-1 space-y-4 lg:space-y-6",children:e.jsxs(As,{value:de,onValueChange:Ra,className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"flex-1",children:e.jsx(Et,{currentFolder:G,onFolderChange:s=>{Ve(s),Y(s.toLowerCase()),Rs(1),he(null),xe(!1),Fs()},userId:P})}),e.jsxs($s,{className:"mb-4 ml-2",children:[e.jsxs(ae,{value:"templates",className:"flex items-center gap-1.5",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Modèles"})]}),e.jsxs(ae,{value:"logs",className:"flex items-center gap-1.5",children:[e.jsx(ts,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Historique"})]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border shadow-sm",children:[e.jsxs(se,{value:"inbox",className:"mt-0",children:[ue?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):Be&&f?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{he(null),xe(!1)},children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),"Retour"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>Ps(f),children:[e.jsx(ua,{className:"h-4 w-4 mr-2"}),"Répondre"]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{Bs(P,f.id,G)},disabled:Os.isPending,children:[e.jsx(ms,{className:"h-4 w-4 mr-2 text-red-500"}),"Supprimer"]})]})]}),e.jsx(ce,{children:e.jsxs(oe,{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold",children:f.subject||"(Sans objet)"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-1 md:gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ae,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"font-medium",children:"De:"}),e.jsx("span",{className:"ml-1",children:f.from.map(s=>s.name||s.address).join(", ")})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(ts,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"font-medium",children:"Date:"}),e.jsx("span",{className:"ml-1",children:new Date(f.date).toLocaleString("fr-FR")})]})]}),f.to&&f.to.length>0&&e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground mt-1",children:[e.jsx(Ae,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"font-medium",children:"À:"}),e.jsx("span",{className:"ml-1",children:f.to.map(s=>s.name||s.address).join(", ")})]})]}),e.jsx(Xs,{}),e.jsxs("div",{children:[f.hasAttachments&&e.jsxs("div",{className:"mb-4 border border-dashed rounded-md p-3",children:[e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(is,{className:"h-4 w-4 mr-2 text-blue-500"}),e.jsxs("span",{className:"font-medium",children:[((ma=f.attachments)==null?void 0:ma.length)||0," pièce(s) jointe(s)"]})]}),f.attachments&&f.attachments.length>0&&e.jsx("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2",children:f.attachments.map((s,a)=>e.jsxs("div",{className:"flex items-center bg-muted p-2 rounded-md text-xs",children:[e.jsx(je,{className:"h-4 w-4 mr-2 text-blue-500"}),e.jsx("span",{className:"truncate flex-1",children:s.filename}),e.jsxs("span",{className:"text-muted-foreground ml-2",children:[Math.round(s.size/1024),"KB"]})]},a))})]}),e.jsx("div",{className:"email-content",children:f.html?e.jsx("div",{className:"border rounded-md p-4 bg-white",dangerouslySetInnerHTML:{__html:f.html}}):e.jsx("div",{className:"border rounded-md p-4 bg-white whitespace-pre-line",children:f.text||"(Pas de contenu)"})})]})]})})]}):He.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ks,{className:"h-12 w-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Boîte de réception vide"}),e.jsx("p",{className:"text-sm text-gray-500 max-w-md mx-auto",children:"Aucun email trouvé dans cette boîte. Les nouveaux messages apparaîtront ici."})]}):e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(K,{children:[e.jsx(N,{className:"w-[40px]"}),e.jsx(N,{children:"Expéditeur"}),e.jsx(N,{children:"Sujet"}),e.jsx(N,{className:"hidden md:table-cell",children:"Date"}),e.jsx(N,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Ee,{children:He.map(s=>{var a,c,o,j,L,W;return e.jsxs(K,{className:s.isRead?"":"font-medium bg-muted/30",children:[e.jsx(y,{children:e.jsxs("div",{className:"flex items-center",children:[!s.isRead&&e.jsx("div",{className:"h-2 w-2 rounded-full bg-blue-500 mr-2"}),s.hasAttachments&&e.jsx(is,{className:"h-4 w-4 text-muted-foreground"})]})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"h-6 w-6",children:e.jsx(Ss,{className:"text-xs",children:((c=(a=s.from[0])==null?void 0:a.name)==null?void 0:c[0])||((j=(o=s.from[0])==null?void 0:o.address)==null?void 0:j[0])||"?"})}),e.jsx("div",{className:"truncate max-w-[120px] md:max-w-[180px]",children:((L=s.from[0])==null?void 0:L.name)||((W=s.from[0])==null?void 0:W.address)||"Inconnu"})]})}),e.jsx(y,{children:e.jsx("div",{className:"cursor-pointer truncate max-w-[180px] md:max-w-[300px]",onClick:()=>we(s),children:s.subject||"(Sans objet)"})}),e.jsx(y,{className:"hidden md:table-cell text-muted-foreground text-sm",children:new Date(s.date).toLocaleString("fr-FR",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-primary hover:bg-primary/10",onClick:()=>we(s),title:"Voir",children:e.jsx(Ws,{className:"h-3.5 w-3.5"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-blue-500 hover:text-blue-600 hover:bg-blue-50",onClick:()=>Ps(s),title:"Répondre",children:e.jsx(ua,{className:"h-3.5 w-3.5"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 hover:bg-gray-100",onClick:()=>{ra.mutate({userId:P,messageId:s.id,isRead:!s.isRead,mailbox:G})},title:s.isRead?"Marquer comme non lu":"Marquer comme lu",children:s.isRead?e.jsx(yt,{className:"h-3.5 w-3.5 text-gray-500"}):e.jsx(Ja,{className:"h-3.5 w-3.5 text-green-500"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-red-400 hover:text-red-600 hover:bg-red-50",onClick:()=>{Bs(P,s.id,G)},title:"Supprimer",children:e.jsx(ms,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]}),!ue&&!Be&&Ce.length>0&&e.jsx(Js,{currentPage:gs,totalPages:Us,totalEmails:bs,indexOfFirstEmail:ws,indexOfLastEmail:ss,onPageChange:Hs})]}),e.jsxs(se,{value:cs.toLowerCase(),className:"mt-0",children:[ue?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):Be&&f?e.jsx("div",{className:"space-y-6"}):He.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Xe,{className:"h-12 w-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Aucun email envoyé"}),e.jsx("p",{className:"text-sm text-gray-500 max-w-md mx-auto",children:"Vous n'avez pas encore envoyé d'emails depuis ce compte."})]}):e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(K,{children:[e.jsx(N,{className:"w-[40px]"}),e.jsx(N,{children:"Destinataire"}),e.jsx(N,{children:"Sujet"}),e.jsx(N,{className:"hidden md:table-cell",children:"Date"}),e.jsx(N,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Ee,{children:He.map(s=>{var a,c,o,j;return e.jsxs(K,{children:[e.jsx(y,{children:e.jsx("div",{className:"flex items-center",children:s.hasAttachments&&e.jsx(is,{className:"h-4 w-4 text-muted-foreground"})})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"h-6 w-6",children:e.jsx(Ss,{className:"text-xs",children:s.from&&s.from.length>0?((c=(a=s.from[0])==null?void 0:a.name)==null?void 0:c[0])||((j=(o=s.from[0])==null?void 0:o.address)==null?void 0:j[0]):"?"})}),e.jsx("div",{className:"truncate max-w-[120px] md:max-w-[180px]",children:s.from&&s.from.length>0&&s.from.map(L=>L.name||L.address).join(", ")||"Expéditeur inconnu"})]})}),e.jsx(y,{children:e.jsx("div",{className:"cursor-pointer truncate max-w-[180px] md:max-w-[300px]",onClick:()=>we(s),children:s.subject||"(Sans objet)"})}),e.jsx(y,{className:"hidden md:table-cell text-muted-foreground text-sm",children:new Date(s.date).toLocaleString("fr-FR",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-primary hover:bg-primary/10",onClick:()=>we(s),title:"Voir",children:e.jsx(Ws,{className:"h-3.5 w-3.5"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-red-400 hover:text-red-600 hover:bg-red-50",onClick:()=>{Bs(P,s.id,G)},title:"Supprimer",children:e.jsx(ms,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]}),!ue&&!Be&&Ce.length>0&&e.jsx(Js,{currentPage:gs,totalPages:Us,totalEmails:bs,indexOfFirstEmail:ws,indexOfLastEmail:ss,onPageChange:Hs})]}),e.jsxs(se,{value:"templates",className:"mt-0",children:[e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["Modèles d'emails (",es.length,")"]}),e.jsxs(d,{onClick:()=>{k(null),B(!0)},children:[e.jsx(_s,{className:"h-4 w-4 mr-2"}),"Nouveau modèle"]})]}),ta?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):es.length===0?e.jsxs("div",{className:"text-center py-12 border rounded-lg bg-muted/20",children:[e.jsx(je,{className:"h-12 w-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Aucun modèle"}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-md mx-auto mb-4",children:"Vous n'avez pas encore créé de modèles d'emails. Les modèles vous permettent d'envoyer rapidement des messages standardisés."}),e.jsxs(d,{onClick:()=>{k(null),B(!0)},children:[e.jsx(_s,{className:"h-4 w-4 mr-2"}),"Créer un modèle"]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:es.map(s=>e.jsx(Lt,{template:s,onEdit:()=>{k(s),B(!0)},onSendTest:()=>{k(s),fe(!0)},onDelete:()=>{},onSend:()=>qa(s)},s.id))})]}),e.jsxs(se,{value:"logs",className:"mt-0",children:[e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Historique des emails"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(Re,{value:b,onValueChange:s=>U(s),children:[e.jsx(De,{className:"w-[150px]",children:e.jsx(Fe,{placeholder:"Trier par"})}),e.jsxs(Me,{children:[e.jsx(R,{value:"desc",children:"Plus récents d'abord"}),e.jsx(R,{value:"asc",children:"Plus anciens d'abord"})]})]})})]}),Aa?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):oa.length===0?e.jsxs("div",{className:"text-center py-12 border rounded-lg bg-muted/20",children:[e.jsx(ts,{className:"h-12 w-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Aucun historique"}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-md mx-auto",children:"L'historique des emails envoyés apparaîtra ici."})]}):e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(K,{children:[e.jsx(N,{className:"w-[40px]"}),e.jsx(N,{children:"Destinataire"}),e.jsx(N,{children:"Sujet"}),e.jsx(N,{children:"Modèle"}),e.jsx(N,{className:"hidden md:table-cell",children:"Date"}),e.jsx(N,{className:"w-[100px]",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Statut",e.jsx(ut,{className:"h-3.5 w-3.5 text-muted-foreground"})]})})]})}),e.jsx(Ee,{children:oa.map(s=>{var a;return e.jsxs(K,{children:[e.jsx(y,{children:e.jsx("div",{className:"flex items-center",children:s.status==="delivered"||s.status==="opened"||s.status==="clicked"?e.jsx(Xa,{className:"h-4 w-4 text-green-500"}):s.status==="bounced"||s.status==="failed"?e.jsx(pt,{className:"h-4 w-4 text-red-500"}):e.jsx(ts,{className:"h-4 w-4 text-amber-500"})})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"h-6 w-6",children:e.jsx(Ss,{className:"text-xs",children:((a=s.recipient[0])==null?void 0:a.toUpperCase())||"?"})}),e.jsx("div",{className:"truncate max-w-[120px] md:max-w-[180px]",children:s.recipient})]})}),e.jsx(y,{children:e.jsx("div",{className:"truncate max-w-[180px] md:max-w-[300px]",children:s.subject||"(Sans objet)"})}),e.jsx(y,{children:e.jsx("div",{className:"truncate max-w-[120px]",children:s.template||"(Personnalisé)"})}),e.jsx(y,{className:"hidden md:table-cell text-muted-foreground text-sm",children:new Date(s.createdAt).toLocaleString("fr-FR",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx(y,{children:e.jsx(J,{variant:s.status==="delivered"||s.status==="opened"||s.status==="clicked"?"outline":s.status==="bounced"||s.status==="failed"?"destructive":"secondary",className:Gs("capitalize",s.status==="delivered"&&"bg-green-50 text-green-700 hover:bg-green-50 border-green-200",s.status==="opened"&&"bg-blue-50 text-blue-700 hover:bg-blue-50 border-blue-200",s.status==="clicked"&&"bg-blue-100 text-blue-800 hover:bg-blue-100 border-blue-300",s.status==="queued"&&"bg-amber-50 text-amber-700 hover:bg-amber-50 border-amber-200"),children:{delivered:"Livré",opened:"Ouvert",clicked:"Cliqué",bounced:"Échec",failed:"Échec",spam:"Spam",queued:"En attente"}[s.status]||s.status})})]},s.id)})})]})]}),e.jsx(se,{value:os.toLowerCase(),className:"mt-0",children:e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(jt,{className:"h-12 w-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Dossier spam"}),e.jsx("p",{className:"text-sm text-gray-500 max-w-md mx-auto",children:"Les emails détectés comme indésirables apparaîtront ici."})]})}),e.jsxs(se,{value:ds.toLowerCase(),className:"mt-0",children:[ue?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):Be&&f?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{he(null),xe(!1)},children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),"Retour"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{qs.mutate({userId:P,messageId:f.id,destinationMailbox:pe,sourceMailbox:G})},disabled:qs.isPending,children:[e.jsx(ks,{className:"h-4 w-4 mr-2"}),"Restaurer"]})})]}),e.jsx(ce,{children:e.jsxs(oe,{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold",children:f.subject||"(Sans objet)"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-1 md:gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ae,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"font-medium",children:"De:"}),e.jsx("span",{className:"ml-1",children:f.from.map(s=>s.name||s.address).join(", ")})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(ts,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"font-medium",children:"Date:"}),e.jsx("span",{className:"ml-1",children:new Date(f.date).toLocaleString("fr-FR")})]})]}),f.to&&f.to.length>0&&e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground mt-1",children:[e.jsx(Ae,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"font-medium",children:"À:"}),e.jsx("span",{className:"ml-1",children:f.to.map(s=>s.name||s.address).join(", ")})]})]}),e.jsx(Xs,{}),e.jsxs("div",{children:[f.hasAttachments&&e.jsxs("div",{className:"mb-4 border border-dashed rounded-md p-3",children:[e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(is,{className:"h-4 w-4 mr-2 text-blue-500"}),e.jsxs("span",{className:"font-medium",children:[((ha=f.attachments)==null?void 0:ha.length)||0," pièce(s) jointe(s)"]})]}),f.attachments&&f.attachments.length>0&&e.jsx("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2",children:f.attachments.map((s,a)=>e.jsxs("div",{className:"flex items-center bg-muted p-2 rounded-md text-xs",children:[e.jsx(je,{className:"h-4 w-4 mr-2 text-blue-500"}),e.jsx("span",{className:"truncate flex-1",children:s.filename}),e.jsxs("span",{className:"text-muted-foreground ml-2",children:[Math.round(s.size/1024),"KB"]})]},a))})]}),e.jsx("div",{className:"email-content",children:f.html?e.jsx("div",{className:"border rounded-md p-4 bg-white",dangerouslySetInnerHTML:{__html:f.html}}):e.jsx("div",{className:"border rounded-md p-4 bg-white whitespace-pre-line",children:f.text||"(Pas de contenu)"})})]})]})})]}):He.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ms,{className:"h-12 w-12 mx-auto text-gray-300 mb-3"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Corbeille vide"}),e.jsx("p",{className:"text-sm text-gray-500 max-w-md mx-auto",children:"Aucun email dans la corbeille."})]}):e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(K,{children:[e.jsx(N,{className:"w-[40px]"}),e.jsx(N,{children:"Expéditeur"}),e.jsx(N,{children:"Sujet"}),e.jsx(N,{className:"hidden md:table-cell",children:"Date"}),e.jsx(N,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Ee,{children:He.map(s=>{var a,c,o,j,L,W;return e.jsxs(K,{children:[e.jsx(y,{children:e.jsx("div",{className:"flex items-center",children:s.hasAttachments&&e.jsx(is,{className:"h-4 w-4 text-muted-foreground"})})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"h-6 w-6",children:e.jsx(Ss,{className:"text-xs",children:((c=(a=s.from[0])==null?void 0:a.name)==null?void 0:c[0])||((j=(o=s.from[0])==null?void 0:o.address)==null?void 0:j[0])||"?"})}),e.jsx("div",{className:"truncate max-w-[120px] md:max-w-[180px]",children:((L=s.from[0])==null?void 0:L.name)||((W=s.from[0])==null?void 0:W.address)||"Inconnu"})]})}),e.jsx(y,{children:e.jsx("div",{className:"cursor-pointer truncate max-w-[180px] md:max-w-[300px]",onClick:()=>we(s),children:s.subject||"(Sans objet)"})}),e.jsx(y,{className:"hidden md:table-cell text-muted-foreground text-sm",children:new Date(s.date).toLocaleString("fr-FR",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-primary hover:bg-primary/10",onClick:()=>we(s),title:"Voir",children:e.jsx(Ws,{className:"h-3.5 w-3.5"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-blue-500 hover:text-blue-600 hover:bg-blue-50",onClick:()=>{qs.mutate({userId:P,messageId:s.id,destinationMailbox:pe,sourceMailbox:G})},title:"Restaurer",children:e.jsx(ks,{className:"h-3.5 w-3.5"})})]})})]},s.id)})})]}),!ue&&!Be&&Ce.length>0&&e.jsx(Js,{currentPage:gs,totalPages:Us,totalEmails:bs,indexOfFirstEmail:ws,indexOfLastEmail:ss,onPageChange:Hs})]})]})]})})]}),e.jsx($e,{open:m,onOpenChange:B,children:e.jsxs(Le,{className:"max-w-3xl",children:[e.jsxs(ze,{children:[e.jsx(Ie,{children:C?"Modifier le modèle":"Nouveau modèle d'email"}),e.jsx(Te,{children:"Créez ou modifiez un modèle d'email pour une utilisation rapide."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{htmlFor:"template-name",className:"text-right",children:"Nom"}),e.jsx(A,{id:"template-name",placeholder:"Nom du modèle",className:"col-span-3",value:(C==null?void 0:C.name)||"",onChange:s=>k(a=>a?{...a,name:s.target.value}:{id:"",name:s.target.value,subject:"",body:"",trigger:"",active:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{htmlFor:"template-trigger",className:"text-right",children:"Déclencheur"}),e.jsx(A,{id:"template-trigger",placeholder:"Ex: nouveau-client, suivi-commande",className:"col-span-3",value:(C==null?void 0:C.trigger)||"",onChange:s=>k(a=>a?{...a,trigger:s.target.value}:{id:"",name:"",subject:"",body:"",trigger:s.target.value,active:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{htmlFor:"template-subject",className:"text-right",children:"Sujet"}),e.jsx(A,{id:"template-subject",placeholder:"Sujet de l'email",className:"col-span-3",value:(C==null?void 0:C.subject)||"",onChange:s=>k(a=>a?{...a,subject:s.target.value}:{id:"",name:"",subject:s.target.value,body:"",trigger:"",active:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})})]}),e.jsxs("div",{className:"grid grid-cols-4 items-start gap-4",children:[e.jsx(p,{htmlFor:"template-body",className:"text-right pt-2",children:"Contenu"}),e.jsx(hs,{id:"template-body",placeholder:"Contenu de l'email...",className:"col-span-3 min-h-[200px]",value:(C==null?void 0:C.body)||"",onChange:s=>k(a=>a?{...a,body:s.target.value}:{id:"",name:"",subject:"",body:s.target.value,trigger:"",active:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx("div",{className:"text-right",children:e.jsx(p,{htmlFor:"template-active",className:"mr-2",children:"Actif"})}),e.jsx("div",{className:"col-span-3",children:e.jsx(Qs,{id:"template-active",checked:(C==null?void 0:C.active)||!1,onCheckedChange:s=>k(a=>a?{...a,active:s}:{id:"",name:"",subject:"",body:"",trigger:"",active:s,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})})})]})]}),e.jsxs(Qe,{children:[e.jsx(d,{variant:"outline",onClick:()=>B(!1),children:"Annuler"}),e.jsx(d,{children:"Enregistrer"})]})]})}),e.jsx($e,{open:xs,onOpenChange:fe,children:e.jsxs(Le,{children:[e.jsxs(ze,{children:[e.jsx(Ie,{children:"Tester le modèle"}),e.jsx(Te,{children:"Envoyez un email de test pour vérifier l'apparence du modèle."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{htmlFor:"test-email",className:"text-right",children:"Destinataire"}),e.jsx(A,{id:"test-email",placeholder:"Email de test",className:"col-span-3",value:We,onChange:s=>Ls(s.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{className:"text-right",children:"Modèle"}),e.jsx("div",{className:"col-span-3",children:e.jsx(J,{variant:"outline",className:"bg-gray-50 border-gray-200",children:(C==null?void 0:C.name)||"Modèle non sélectionné"})})]})]}),e.jsxs(Qe,{children:[e.jsx(d,{variant:"outline",onClick:()=>fe(!1),children:"Annuler"}),e.jsx(d,{disabled:!vs(We)||!C,children:"Envoyer le test"})]})]})}),e.jsx($e,{open:qe,onOpenChange:ve,children:e.jsxs(Le,{className:"max-w-3xl",children:[e.jsxs(ze,{children:[e.jsx(Ie,{children:"Nouveau message"}),e.jsx(Te,{children:"Rédigez un email personnalisé."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{htmlFor:"email-to",className:"text-right",children:"Destinataire"}),e.jsxs("div",{className:"col-span-3 flex items-center gap-2",children:[e.jsx(A,{id:"email-to",placeholder:"Email du destinataire",className:"flex-1",value:M,onChange:s=>ye(s.target.value)}),e.jsx(d,{variant:"outline",size:"sm",onClick:Va,disabled:!M||!vs(M),children:"Ajouter"})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{className:"text-right",children:"Rechercher par référence"}),e.jsx("div",{className:"col-span-3",children:e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(A,{placeholder:"Ex: RAC-2025-0602-143045-742",className:"flex-1",value:ee,onChange:s=>Oe(s.target.value),onKeyDown:s=>s.key==="Enter"&&aa()}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:aa,disabled:u,title:"Rechercher un lead",children:[u?e.jsx(V,{className:"h-4 w-4 animate-spin mr-1"}):e.jsx(Ae,{className:"h-4 w-4 mr-1"}),"Leads"]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:ka,disabled:F,title:"Rechercher une demande de service",children:[F?e.jsx(V,{className:"h-4 w-4 animate-spin mr-1"}):e.jsx(je,{className:"h-4 w-4 mr-1"}),"Demandes"]})]})]})})})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4 mt-2",children:[e.jsx("div",{}),e.jsxs("div",{className:"col-span-3",children:[i&&D.length>0&&e.jsx("div",{className:"mt-2 border rounded-md max-h-[200px] overflow-y-auto",children:e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(K,{children:[e.jsx(N,{className:"w-[200px]",children:"Nom"}),e.jsx(N,{children:"Référence"}),e.jsx(N,{className:"text-right",children:"Action"})]})}),e.jsx(Ee,{children:D.map(s=>e.jsxs(K,{children:[e.jsxs(y,{className:"font-medium",children:[s.firstName," ",s.lastName]}),e.jsx(y,{children:s.referenceNumber||"N/A"}),e.jsx(y,{className:"text-right",children:e.jsx(d,{size:"sm",variant:"outline",onClick:()=>{ye(s.email),S(!1),n({title:"Lead sélectionné",description:`${s.firstName} ${s.lastName} ajouté comme destinataire`})},children:"Sélectionner"})})]},s.id))})]})}),i&&D.length===0&&e.jsx("div",{className:"mt-2 p-4 text-center text-muted-foreground border rounded-md",children:"Aucun lead trouvé"}),h&&t.length>0&&e.jsx("div",{className:"mt-2 border rounded-md max-h-[200px] overflow-y-auto",children:e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(K,{children:[e.jsx(N,{children:"Référence"}),e.jsx(N,{className:"w-[200px]",children:"Client"}),e.jsx(N,{className:"text-right",children:"Action"})]})}),e.jsx(Ee,{children:t.map(s=>e.jsxs(K,{children:[e.jsx(y,{className:"font-medium",children:s.referenceNumber}),e.jsx(y,{children:s.clientName}),e.jsx(y,{className:"text-right",children:e.jsx(d,{size:"sm",variant:"outline",onClick:()=>{ye(s.clientEmail),w(!1),n({title:"Demande sélectionnée",description:`${s.referenceNumber} ajoutée comme destinataire`})},children:"Sélectionner"})})]},s.id))})]})}),h&&t.length===0&&e.jsx("div",{className:"mt-2 p-4 text-center text-muted-foreground border rounded-md",children:"Aucune demande trouvée"})]})]}),ie.length>0&&e.jsxs("div",{className:"grid grid-cols-4 items-start gap-4",children:[e.jsx("div",{}),e.jsx("div",{className:"col-span-3 flex flex-wrap gap-2",children:ie.map(s=>e.jsxs(J,{variant:"secondary",className:"flex items-center gap-1.5 py-1.5 pl-2 pr-1.5",children:[e.jsx("span",{children:s}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-4 w-4 rounded-full hover:bg-gray-200 p-0",onClick:()=>Ba(s),children:e.jsx(Ys,{className:"h-2.5 w-2.5"})})]},s))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{htmlFor:"email-subject",className:"text-right",children:"Sujet"}),e.jsx(A,{id:"email-subject",placeholder:"Sujet de l'email",className:"col-span-3",value:ne,onChange:s=>js(s.target.value)})]}),O&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(p,{className:"text-right",children:"Modèle"}),e.jsx("div",{className:"col-span-3",children:e.jsx(J,{variant:"outline",className:"bg-gray-50 border-gray-200",children:O.name})})]}),e.jsxs("div",{className:"grid grid-cols-4 items-start gap-4",children:[e.jsx(p,{htmlFor:"email-content",className:"text-right pt-2",children:"Message"}),e.jsx(hs,{id:"email-content",placeholder:"Contenu de l'email...",className:"col-span-3 min-h-[200px]",value:r,onChange:s=>g(s.target.value)})]})]}),e.jsxs(Qe,{children:[e.jsx(d,{variant:"outline",onClick:()=>ve(!1),children:"Annuler"}),e.jsx(d,{onClick:Pa,disabled:!M&&ie.length===0||!ne||!r||ys.isPending,children:ys.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Envoi en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"mr-2 h-4 w-4"}),"Envoyer"]})})]})]})}),e.jsx($e,{open:Je,onOpenChange:ge,children:e.jsxs(Le,{className:"max-w-3xl",children:[e.jsxs(ze,{children:[e.jsx(Ie,{children:"Envoyer un email aux leads"}),e.jsx(Te,{children:"Sélectionnez les leads auxquels vous souhaitez envoyer un email."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Qs,{id:"select-all",checked:Ne,onCheckedChange:s=>Is(s)}),e.jsx(p,{htmlFor:"select-all",children:"Tous sélectionner"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{placeholder:"Rechercher un lead...",value:ee,onChange:s=>Oe(s.target.value),className:"w-48 h-8 text-xs"}),e.jsxs(Re,{value:me,onValueChange:us,children:[e.jsx(De,{className:"w-[130px] h-8 text-xs",children:e.jsx(Fe,{placeholder:"Tous les statuts"})}),e.jsxs(Me,{children:[e.jsx(R,{value:"",children:"Tous les statuts"}),e.jsx(R,{value:"nouveau",children:"Nouveau"}),e.jsx(R,{value:"en_cours",children:"En cours"}),e.jsx(R,{value:"termine",children:"Terminé"}),e.jsx(R,{value:"annule",children:"Annulé"})]})]})]})]}),e.jsx("div",{className:"border rounded-md max-h-[300px] overflow-y-auto",children:Ea?e.jsx("div",{className:"flex justify-center items-center py-6",children:e.jsx(V,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):la.length===0?e.jsxs("div",{className:"text-center py-6 text-muted-foreground",children:[e.jsx(Ae,{className:"h-8 w-8 mx-auto text-gray-300 mb-2"}),e.jsx("p",{children:"Aucun lead correspondant aux critères."})]}):e.jsxs(Se,{children:[e.jsx(ke,{children:e.jsxs(K,{children:[e.jsx(N,{className:"w-[50px]"}),e.jsx(N,{children:"Nom"}),e.jsx(N,{children:"Email"}),e.jsx(N,{children:"Référence"}),e.jsx(N,{children:"Statut"})]})}),e.jsx(Ee,{children:la.map(s=>e.jsxs(K,{children:[e.jsx(y,{children:e.jsx(Qs,{checked:Z.some(a=>a.id===s.id),onCheckedChange:a=>na(s,a)})}),e.jsxs(y,{children:[s.firstName," ",s.lastName]}),e.jsx(y,{children:s.email}),e.jsx(y,{children:s.referenceNumber||"-"}),e.jsx(y,{children:e.jsx(J,{variant:"outline",className:Gs(s.status==="nouveau"&&"bg-blue-50 text-blue-700 border-blue-200",s.status==="en_cours"&&"bg-amber-50 text-amber-700 border-amber-200",s.status==="termine"&&"bg-green-50 text-green-700 border-green-200",s.status==="annule"&&"bg-red-50 text-red-700 border-red-200"),children:{nouveau:"Nouveau",en_cours:"En cours",termine:"Terminé",annule:"Annulé"}[s.status||""]||"Non défini"})})]},s.id))})]})}),e.jsxs("div",{className:"mt-2 mb-4",children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Destinataires sélectionnés:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Z.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun destinataire sélectionné"}):Z.map(s=>e.jsxs(J,{variant:"secondary",className:"flex items-center gap-1.5 py-1.5 pl-2 pr-1.5 bg-white border shadow-sm",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{children:[s.firstName," ",s.lastName]}),s.referenceNumber&&e.jsx("span",{className:"text-xs text-primary font-normal",children:s.referenceNumber})]}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-5 w-5 rounded-full hover:bg-gray-200 ml-1.5",onClick:()=>na(s,!1),children:e.jsx(Ys,{className:"h-3 w-3"})})]},`lead-${s.id}`))})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Sélectionnez un modèle:"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:ta?e.jsx("div",{className:"col-span-full flex justify-center items-center py-4",children:e.jsx(V,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):es.length===0?e.jsx("div",{className:"col-span-full text-center py-4 text-muted-foreground",children:e.jsx("p",{children:"Aucun modèle disponible."})}):es.map(s=>e.jsxs(ce,{className:Gs("cursor-pointer transition-all hover:border-primary hover:shadow-md",(O==null?void 0:O.id)===s.id&&"border-primary ring-1 ring-primary"),onClick:()=>zs(s),children:[e.jsx(Ge,{className:"p-3 pb-1",children:e.jsxs(Ke,{className:"text-sm flex items-center justify-between",children:[e.jsx("span",{className:"truncate",children:s.name}),s.active?e.jsx(J,{variant:"outline",className:"ml-2 bg-green-50 text-green-700 hover:bg-green-50 border-green-200 text-xs py-0",children:"Actif"}):e.jsx(J,{variant:"outline",className:"ml-2 bg-gray-50 text-gray-500 hover:bg-gray-50 border-gray-200 text-xs py-0",children:"Inactif"})]})}),e.jsx(oe,{className:"p-3 pt-1.5",children:e.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Sujet:"})," ",s.subject]}),e.jsxs("div",{className:"mt-1 truncate",children:[e.jsx("span",{className:"font-medium",children:"Contenu:"})," ",s.body.substring(0,50),"..."]})]})})]},s.id))})]}),O&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Aperçu du modèle:"}),e.jsx(ce,{children:e.jsxs(oe,{className:"p-4",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-medium text-sm",children:"Sujet:"})," ",O.subject]}),e.jsx(Xs,{className:"my-2"}),e.jsx("div",{className:"whitespace-pre-line text-sm",children:O.body})]})})]})]}),e.jsxs(Qe,{children:[e.jsx(d,{variant:"outline",onClick:()=>ge(!1),children:"Annuler"}),e.jsxs(d,{onClick:()=>Oa(O),disabled:Z.length===0||!O,children:["Envoyer à ",Z.length," destinataire",Z.length!==1?"s":""]})]})]})}),e.jsx($t,{isOpen:be,onClose:()=>v(!1),initialRecipient:x,initialSubject:X,initialBody:ea,selectedLead:fs,selectedServiceRequest:Sa}),e.jsx(it,{open:Fa,onOpenChange:Vs,children:e.jsxs(nt,{children:[e.jsxs(lt,{children:[e.jsx(ct,{children:"Confirmer la suppression"}),e.jsx(ot,{children:"Êtes-vous sûr de vouloir supprimer cet email ? Cette action est irréversible."})]}),e.jsxs(dt,{children:[e.jsx(mt,{children:"Annuler"}),e.jsx(ht,{onClick:Ma,className:"bg-red-600 hover:bg-red-700",children:Os.isPending?e.jsxs("div",{className:"flex items-center",children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Suppression..."]}):"Supprimer"})]})]})})]})}export{jr as default};
