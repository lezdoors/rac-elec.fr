import{a as K,r as p,d as U,t as H,j as e,z as a,U as Q,M as X,C as Y,B as j,F as L,f as d,g as m,i as u,h as x,n as V,I as b,k as v,o as Z,m as N,u as _}from"./index-CkF6reUV.js";import{u as z,S as ee}from"./use-auth-Bplk0OQB.js";import{C,a as E,b as y,c as S,d as P,e as A}from"./card-ClylLA9X.js";import{C as R}from"./checkbox-BrBvz8r_.js";import{P as se}from"./progress-C56ch9ML.js";import{S as re}from"./settings-F1gDzJuC.js";import"./index-BteFsJVt.js";import"./index-C-81cGvM.js";const te=a.object({fullName:a.string().min(1,"Le nom complet est requis"),email:a.string().email("Adresse email invalide")}),ne=a.object({smtpEnabled:a.boolean().optional(),smtpHost:a.string().optional(),smtpPort:a.number().int().positive().optional(),smtpSecure:a.boolean().optional(),smtpUser:a.string().optional(),smtpPassword:a.string().optional(),smtpFromEmail:a.string().email("Email d'expédition invalide").optional()}),o=[{id:"welcome",title:"Bienvenue",icon:e.jsx(ee,{className:"h-5 w-5"})},{id:"profile",title:"Profil",icon:e.jsx(Q,{className:"h-5 w-5"})},{id:"smtp",title:"Email",icon:e.jsx(X,{className:"h-5 w-5"})},{id:"finish",title:"Terminer",icon:e.jsx(Y,{className:"h-5 w-5"})}];function ie(){const{user:r}=z(),{toast:n}=K(),[f,M]=p.useState("welcome"),[D,$]=p.useState(0),[l,T]=p.useState(null),[g,h]=p.useState(!1),w=U({resolver:H(te),defaultValues:{fullName:(r==null?void 0:r.fullName)||"",email:(r==null?void 0:r.email)||""}}),i=U({resolver:H(ne),defaultValues:{smtpEnabled:!1,smtpHost:"",smtpPort:587,smtpSecure:!0,smtpUser:"",smtpPassword:"",smtpFromEmail:""}});p.useEffect(()=>{r&&T({id:r.id,fullName:r.fullName||"",email:r.email||"",smtpHost:r.smtpHost,smtpPort:r.smtpPort,smtpSecure:r.smtpSecure,smtpUser:r.smtpUser,smtpPassword:r.smtpPassword,smtpFromEmail:r.smtpFromEmail,smtpEnabled:r.smtpEnabled,onboardingCompleted:r.onboardingCompleted})},[r]),p.useEffect(()=>{const s=o.findIndex(t=>t.id===f);$(s/(o.length-1)*100)},[f]),p.useEffect(()=>{r!=null&&r.onboardingCompleted&&(window.location.href="/admin")},[r==null?void 0:r.onboardingCompleted]);const k=()=>{const s=o.findIndex(t=>t.id===f);s<o.length-1&&M(o[s+1].id)},F=()=>{const s=o.findIndex(t=>t.id===f);s>0&&M(o[s-1].id)},B=async s=>{h(!0);try{if(!r)return;if(!(await N("PATCH",`/api/users/${r.id}`,{...s})).ok)throw new Error("Erreur lors de la mise à jour du profil");T(c=>c?{...c,...s}:null),k()}catch(t){n({title:"Erreur",description:t instanceof Error?t.message:"Une erreur s'est produite",variant:"destructive"})}finally{h(!1)}},O=async s=>{h(!0);try{if(!r)return;const t=s.smtpEnabled?s:{smtpEnabled:!1};if(!(await N("PATCH",`/api/users/${r.id}`,{...t})).ok)throw new Error("Erreur lors de la mise à jour des paramètres SMTP");T(I=>I?{...I,...t}:null),k()}catch(t){n({title:"Erreur",description:t instanceof Error?t.message:"Une erreur s'est produite",variant:"destructive"})}finally{h(!1)}},q=async()=>{h(!0);try{if(!r)return;if(!(await N("PATCH",`/api/users/${r.id}`,{onboardingCompleted:!0})).ok)throw new Error("Erreur lors de la finalisation de l'onboarding");n({title:"Configuration terminée",description:"Votre compte a été configuré avec succès"}),window.location.href="/admin"}catch(s){n({title:"Erreur",description:s instanceof Error?s.message:"Une erreur s'est produite",variant:"destructive"})}finally{h(!1)}},W=async()=>{h(!0);try{const s=i.getValues();if(!s.smtpEnabled){n({title:"Information",description:"Veuillez d'abord activer la configuration SMTP"});return}if(!r)return;const t=await N("POST","/api/users/test-smtp",{userId:r.id,...s});if(!t.ok){const c=await t.json();throw new Error(c.message||"Erreur lors du test SMTP")}n({title:"Test réussi",description:"La configuration SMTP fonctionne correctement"})}catch(s){n({title:"Erreur",description:s instanceof Error?s.message:"Une erreur s'est produite",variant:"destructive"})}finally{h(!1)}},G=()=>{switch(f){case"welcome":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(E,{children:[e.jsx(y,{className:"text-2xl",children:"Bienvenue dans l'assistant de configuration"}),e.jsx(S,{children:"Cet assistant vous guidera dans la configuration initiale de votre compte."})]}),e.jsx(P,{className:"space-y-4",children:e.jsxs("div",{className:"rounded-lg bg-muted p-4 text-muted-foreground",children:[e.jsx("p",{children:"Nous allons vous aider à configurer :"}),e.jsxs("ul",{className:"list-disc list-inside mt-2",children:[e.jsx("li",{children:"Votre profil personnel"}),e.jsx("li",{children:"Vos paramètres d'email (SMTP)"}),e.jsx("li",{children:"Et bien plus encore..."})]})]})}),e.jsx(A,{className:"flex justify-end",children:e.jsxs(j,{onClick:k,children:["Commencer ",e.jsx(Z,{className:"ml-2 h-4 w-4"})]})})]});case"profile":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(E,{children:[e.jsx(y,{className:"text-2xl",children:"Votre profil"}),e.jsx(S,{children:"Mettez à jour vos informations personnelles"})]}),e.jsx(P,{children:e.jsx(L,{...w,children:e.jsxs("form",{onSubmit:w.handleSubmit(B),className:"space-y-4",children:[e.jsx(d,{control:w.control,name:"fullName",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Nom complet"}),e.jsx(u,{children:e.jsx(b,{...s})}),e.jsx(v,{})]})}),e.jsx(d,{control:w.control,name:"email",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Email"}),e.jsx(u,{children:e.jsx(b,{type:"email",...s})}),e.jsx(v,{})]})}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(j,{type:"button",variant:"outline",onClick:F,children:"Retour"}),e.jsx(j,{type:"submit",disabled:g,children:g?"Enregistrement...":"Continuer"})]})]})})})]});case"smtp":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(E,{children:[e.jsx(y,{className:"text-2xl",children:"Configuration de l'email"}),e.jsx(S,{children:"Configurez vos paramètres SMTP pour l'envoi d'emails"})]}),e.jsx(P,{children:e.jsx(L,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(O),className:"space-y-4",children:[e.jsx(d,{control:i.control,name:"smtpEnabled",render:({field:s})=>e.jsxs(m,{className:"flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4 mb-4",children:[e.jsx(u,{children:e.jsx(R,{checked:s.value,onCheckedChange:s.onChange})}),e.jsxs("div",{className:"space-y-1 leading-none",children:[e.jsx(x,{children:"Activer SMTP personnel"}),e.jsx(V,{children:"Permettre d'envoyer des emails via votre propre serveur SMTP"})]})]})}),e.jsxs("div",{className:i.watch("smtpEnabled")?"":"opacity-50 pointer-events-none",children:[e.jsx(d,{control:i.control,name:"smtpHost",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Serveur SMTP"}),e.jsx(u,{children:e.jsx(b,{placeholder:"smtp.example.com",...s,value:s.value||""})}),e.jsx(v,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsx(d,{control:i.control,name:"smtpPort",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Port"}),e.jsx(u,{children:e.jsx(b,{type:"number",placeholder:"587",...s,value:s.value===void 0?"":s.value,onChange:t=>s.onChange(t.target.value===""?void 0:Number(t.target.value))})}),e.jsx(v,{})]})}),e.jsx(d,{control:i.control,name:"smtpSecure",render:({field:s})=>e.jsxs(m,{className:"flex flex-row items-center space-x-3 space-y-0 rounded-md border p-4",children:[e.jsx(u,{children:e.jsx(R,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx("div",{className:"space-y-1 leading-none",children:e.jsx(x,{children:"Sécurisé (TLS)"})})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 mt-4",children:[e.jsx(d,{control:i.control,name:"smtpUser",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Nom d'utilisateur SMTP"}),e.jsx(u,{children:e.jsx(b,{placeholder:"user@example.com",...s,value:s.value||""})}),e.jsx(v,{})]})}),e.jsx(d,{control:i.control,name:"smtpPassword",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Mot de passe SMTP"}),e.jsx(u,{children:e.jsx(b,{type:"password",placeholder:"••••••••",...s,value:s.value||""})}),e.jsx(v,{})]})}),e.jsx(d,{control:i.control,name:"smtpFromEmail",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Adresse d'expédition"}),e.jsx(u,{children:e.jsx(b,{placeholder:"noreply@example.com",...s,value:s.value||""})}),e.jsx(V,{children:"L'adresse email qui apparaîtra comme expéditeur"}),e.jsx(v,{})]})}),e.jsxs(j,{type:"button",variant:"outline",className:"mt-2",onClick:W,disabled:g||!i.watch("smtpEnabled"),children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"Tester la configuration"]})]})]}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(j,{type:"button",variant:"outline",onClick:F,children:"Retour"}),e.jsx(j,{type:"submit",disabled:g,children:g?"Enregistrement...":"Continuer"})]})]})})})]});case"finish":return e.jsxs(C,{className:"w-full max-w-md mx-auto",children:[e.jsxs(E,{children:[e.jsx(y,{className:"text-2xl",children:"Configuration terminée !"}),e.jsx(S,{children:"Votre compte est maintenant configuré et prêt à l'emploi."})]}),e.jsx(P,{className:"space-y-4",children:e.jsxs("div",{className:"rounded-lg bg-muted p-4 text-muted-foreground",children:[e.jsx("p",{children:"Récapitulatif de votre configuration :"}),e.jsxs("ul",{className:"list-disc list-inside mt-2",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Profil"})," : ",l==null?void 0:l.fullName," (",l==null?void 0:l.email,")"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Email SMTP"})," : ",l!=null&&l.smtpEnabled?"Configuré":"Non configuré"]})]})]})}),e.jsxs(A,{className:"flex justify-between",children:[e.jsx(j,{type:"button",variant:"outline",onClick:F,children:"Retour"}),e.jsx(j,{onClick:q,disabled:g,children:g?"Finalisation...":"Terminer la configuration"})]})]});default:return null}},J=()=>e.jsxs("div",{className:"mb-8 w-full max-w-md mx-auto",children:[e.jsx(se,{value:D,className:"h-2"}),e.jsx("div",{className:"mt-4 flex justify-between",children:o.map((s,t)=>e.jsxs("div",{className:`flex flex-col items-center ${o.findIndex(c=>c.id===f)>=t?"text-primary":"text-muted-foreground"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center mb-1 ${o.findIndex(c=>c.id===f)>=t?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"}`,children:s.icon}),e.jsx("span",{className:"text-xs",children:s.title})]},s.id))})]});return e.jsx("div",{className:"w-full min-h-screen bg-background py-12 px-4 flex flex-col items-center",children:e.jsxs("div",{className:"max-w-2xl w-full",children:[e.jsx("h1",{className:"text-3xl font-bold text-center mb-8",children:"Assistant de configuration"}),J(),G()]})})}function pe(){const{user:r,isLoading:n}=z();return _(),p.useEffect(()=>{!n&&!r&&(window.location.href="/auth")},[n,r]),p.useEffect(()=>{!n&&(r!=null&&r.onboardingCompleted)&&(window.location.href="/admin")},[n,r==null?void 0:r.onboardingCompleted]),e.jsxs("div",{className:"bg-background min-h-screen",children:[!n&&r&&e.jsx(ie,{}),n&&e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full"})})]})}export{pe as default};
