import{b as B,a as F,r as t,j as e,H,M as O,P as G,x as W,O as X,l as I,u as Y,I as K,B as J,N as Q,Q as Z,R,T as ee,V as se,W as te,m as S}from"./index-C5k-JGAU.js";import{E as ae,l as re,u as ne,a as ie,b as D,c as le,d as ce}from"./react-stripe.esm-RTNwCEf0.js";import{H as oe}from"./house-DfcPKql3.js";import{M as de}from"./map-pin-CtCVk7Ud.js";import{C as V}from"./credit-card-CJgRs6-U.js";import{L as me}from"./lock-DndE-nWj.js";import{E as xe}from"./eye-off-CUJ278eW.js";const ue=re("pk_live_51MUY3KF0p2SYXeXzW4ebN4wdgqfmu9Mc8kTpm3XmBiyotz6kYZICKXNy73SWcmq1vCViETjWgcko8R6xd4TJbste00OL2WUCvP");function pe({referenceNumber:n,clientName:b,serviceRequest:i,isLoadingRequest:m}){const l=ne(),x=ie(),{toast:u}=F(),[,s]=Y(),[v,N]=t.useState(!1),[c,y]=t.useState(""),[T,P]=t.useState(!1),[o,h]=t.useState(!0);t.useEffect(()=>{if(i!=null&&i.name){const r=i.prenom&&i.nom?`${i.prenom} ${i.nom}`.trim():i.name;y(r),console.log("Nom du titulaire de la carte mis à jour:",r)}},[i]),t.useEffect(()=>{h(!1)},[]);const p={style:{base:{color:"#32325d",fontFamily:'"Inter", system-ui, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"},iconColor:"#3b82f6"},invalid:{color:"#fa755a",iconColor:"#fa755a"}},classes:{base:"stripe-element",focus:"stripe-element-focus",invalid:"stripe-element-invalid"},hidePostalCode:!0},[L,M]=t.useState(!1),[q,U]=t.useState(!1),[k,$]=t.useState(!1);t.useEffect(()=>{P(L&&q&&k&&c.trim()!=="")},[L,q,k,c]);const A=async r=>{var _;if(r.preventDefault(),!l||!x){u({title:"Service de paiement non disponible",description:"Veuillez patienter ou actualiser la page.",variant:"destructive"});return}if(!n||n.trim()===""){u({title:"Erreur de référence",description:"La référence de la demande est invalide ou manquante.",variant:"destructive"});return}if(!c||c.trim()===""){u({title:"Informations manquantes",description:"Veuillez entrer le nom du titulaire de la carte.",variant:"destructive"});return}N(!0);try{const a=await S("GET",`/api/service-requests/${n}`);if(!a.ok)throw new Error("Cette référence de demande est invalide ou introuvable.");const d=await a.json();if(d.request&&d.request.paymentStatus==="paid"){u({title:"Demande déjà payée",description:"Cette demande a déjà été payée. Vous allez être redirigé."}),s(`/paiement-confirmation?reference=${n}&status=success`);return}const f=await S("POST","/api/create-payment-intent",{referenceNumber:n,amount:129.8});if(!f.ok){const z=await f.json();throw new Error(z.message||"Erreur lors de la préparation du paiement")}const{clientSecret:j}=await f.json(),g=x.getElement(D);if(!g)throw new Error("Impossible de trouver l'élément de carte bancaire.");const w=await x.submit();if(w.error)throw new Error(w.error.message||"Informations de carte invalides");const{error:C,paymentIntent:E}=await l.confirmCardPayment(j,{payment_method:{card:g,billing_details:{name:c.trim()}}});if(C)throw C;E.status==="succeeded"?s(`/paiement-confirmation?reference=${n}&status=success`):s(`/paiement-confirmation?reference=${n}&payment_intent=${E.id}`)}catch(a){console.error("Erreur de paiement:",a);let d="Une erreur est survenue lors du traitement de votre paiement.",f="unknown";a.type==="card_error"&&(f=a.code||"card_error",a.code==="card_declined"?d="Votre carte a été refusée. Veuillez vérifier vos informations ou essayer avec une autre carte.":a.code==="expired_card"?d="Votre carte est expirée.":a.code==="incorrect_cvc"?d="Le code de sécurité (CVC) est incorrect.":a.code==="processing_error"?d="Une erreur est survenue lors du traitement de votre carte. Veuillez réessayer.":a.code==="insufficient_funds"&&(d="Fonds insuffisants sur votre carte."));try{const j=x==null?void 0:x.getElement(D);if(j){const g=await(l==null?void 0:l.createPaymentMethod({type:"card",card:j})),{brand:w,last4:C,exp_month:E,exp_year:z}=((_=g==null?void 0:g.paymentMethod)==null?void 0:_.card)||{};await S("POST","/api/store-payment-attempt",{referenceNumber:n,paymentError:{code:f,message:a.message||d,cardDetails:{cardholderName:c,last4:C||"****",brand:w||"unknown",expMonth:E,expYear:z}}}),console.log("Détails d'échec de paiement sauvegardés pour assistance future")}}catch(j){console.error("Impossible de sauvegarder les détails de l'échec de paiement:",j)}u({title:"Échec du paiement",description:a.message||d,variant:"destructive"})}finally{N(!1)}};return o?e.jsxs("div",{className:"min-h-[400px] flex flex-col items-center justify-center space-y-8 py-10 px-4",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"bg-blue-600 p-2 rounded-lg shadow-md",children:e.jsx("svg",{className:"w-12 h-12 text-white",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z",fill:"currentColor"})})}),e.jsxs("div",{className:"mt-6 text-center",children:[e.jsx("h2",{className:"text-xl font-bold text-blue-700",children:"Traitement en cours"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"Nous préparons votre demande de raccordement"})]})]}),e.jsxs("div",{className:"w-full max-w-md",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-2 bg-blue-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full w-2/3 bg-blue-600"})}),e.jsxs("div",{className:"flex justify-between mt-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-600"}),e.jsx("span",{className:"text-xs mt-1 text-gray-600",children:"Validation"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-400"}),e.jsx("span",{className:"text-xs mt-1 text-gray-600",children:"Préparation"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-300"}),e.jsx("span",{className:"text-xs mt-1 text-gray-600",children:"Finalisation"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-center mt-6 bg-white border border-blue-100 rounded-md py-2 px-4 shadow-sm",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-500 mr-2",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z",fill:"currentColor"})}),e.jsxs("p",{className:"text-sm font-medium text-gray-700",children:["Référence: ",e.jsx("span",{className:"font-bold text-blue-700",children:n})]})]})]})]}):e.jsxs("form",{onSubmit:A,className:"space-y-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center justify-between border-b pb-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"Confirmation de votre demande"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Traitement Enedis"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"font-bold text-lg text-blue-700",children:"129,8 €"}),e.jsx("p",{className:"text-xs text-gray-500",children:"TTC"})]})]})}),e.jsxs("div",{className:"space-y-5 mb-6",children:[e.jsx("div",{className:"flex items-center gap-3 border-b border-gray-200 pb-3",children:e.jsx("h3",{className:"font-medium text-gray-800",children:"Informations de paiement"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"cardholderName",className:"block text-sm font-medium text-gray-700",children:"Titulaire de la carte"}),e.jsx(K,{type:"text",id:"cardholderName",className:"w-full p-2",placeholder:"Nom complet tel qu'il apparaît sur la carte",required:!0,disabled:v,value:c,onChange:r=>y(r.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Numéro de carte"}),e.jsx("div",{className:"p-2 border border-gray-300 rounded-md bg-white focus-within:ring-1 focus-within:ring-blue-500 focus-within:border-blue-500",children:e.jsx(D,{options:p,onChange:r=>{M(r.complete)}})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Date d'expiration"}),e.jsx("div",{className:"p-2 border border-gray-300 rounded-md bg-white focus-within:ring-1 focus-within:ring-blue-500 focus-within:border-blue-500",children:e.jsx(le,{options:p,onChange:r=>{U(r.complete)}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Cryptogramme"}),e.jsx("div",{className:"p-2 border border-gray-300 rounded-md bg-white focus-within:ring-1 focus-within:ring-blue-500 focus-within:border-blue-500",children:e.jsx(ce,{options:p,onChange:r=>{$(r.complete)}})})]})]})]})]}),e.jsx(J,{type:"submit",disabled:!l||!x||v||!T,className:"w-full py-3 bg-gradient-to-r from-blue-600 to-primary hover:from-primary hover:to-blue-700 text-white font-medium rounded-md transition-all duration-300 hover:shadow-lg flex items-center justify-center h-auto text-base shadow-md",children:v?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"mr-2 h-5 w-5 animate-spin"}),e.jsx("span",{children:"Traitement en cours..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-5 w-5"}),e.jsx("span",{children:"Finaliser le paiement de 129,80€ TTC"})]})}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-4",children:[e.jsxs("div",{className:"flex items-center px-3 py-2 bg-white border border-gray-200 rounded-lg shadow-sm",children:[e.jsx(me,{className:"h-4 w-4 text-green-600 mr-2"}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Paiement sécurisé"})]}),e.jsxs("div",{className:"flex items-center px-3 py-2 bg-white border border-gray-200 rounded-lg shadow-sm",children:[e.jsx(Q,{className:"h-4 w-4 text-green-600 mr-2"}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Protection SSL"})]}),e.jsxs("div",{className:"flex items-center px-3 py-2 bg-white border border-gray-200 rounded-lg shadow-sm",children:[e.jsx(xe,{className:"h-4 w-4 text-green-600 mr-2"}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Données chiffrées"})]})]}),e.jsxs("div",{className:"text-center bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Vos informations bancaires sont protégées et ne sont jamais stockées sur nos serveurs."}),e.jsxs("p",{className:"text-xs text-gray-600",children:["En procédant au paiement, vous acceptez nos",e.jsxs(Z,{children:[e.jsx(R,{asChild:!0,children:e.jsx("button",{type:"button",className:"text-blue-600 hover:underline inline-flex items-center",children:" conditions générales de service"})}),e.jsxs(ee,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",children:[e.jsx(se,{children:e.jsx(te,{className:"text-xl font-bold text-blue-800 mb-4 flex items-center justify-between",children:e.jsx("span",{children:"Conditions Générales d'Utilisation"})})}),e.jsxs("div",{className:"prose prose-blue max-w-none text-sm",children:[e.jsxs("p",{className:"text-gray-600 mb-4",children:["Dernière mise à jour : ",new Date().toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]}),e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mt-6 mb-3",children:"1. Acceptation des conditions"}),e.jsx("p",{children:"En accédant et en utilisant ce site web, vous acceptez d'être lié par les présentes Conditions Générales d'Utilisation, tous les termes et conditions applicables, ainsi que toutes les lois et réglementations applicables. Si vous n'acceptez pas ces conditions, vous êtes prié de ne pas utiliser ce site."}),e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mt-6 mb-3",children:"2. Présentation des services"}),e.jsx("p",{children:"Notre service d'assistance à la demande de raccordement électrique est une prestation d'accompagnement qui vous aide à constituer votre dossier auprès d'Enedis (anciennement ERDF), le gestionnaire du réseau de distribution d'électricité en France. Nous ne sommes pas Enedis, mais un intermédiaire indépendant qui facilite vos démarches."}),e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mt-6 mb-3",children:"3. Prix et paiement"}),e.jsx("p",{children:"Le prix de notre prestation est de 129,80€ TTC. Ce montant est distinct des frais qui pourraient être demandés par Enedis pour la réalisation technique du raccordement. Le paiement s'effectue en ligne par carte bancaire avant l'exécution de la prestation."}),e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mt-6 mb-3",children:"4. Droits de rétractation"}),e.jsx("p",{children:"Conformément au Code de la consommation, vous acceptez expressément que l'exécution de notre prestation commence dès le paiement, avant l'expiration du délai de rétractation de 14 jours. En conséquence, vous reconnaissez que votre droit de rétractation ne s'applique pas une fois que nous avons commencé à traiter votre dossier."}),e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mt-6 mb-3",children:"5. Protection des données personnelles"}),e.jsx("p",{children:"Les informations que vous nous communiquez sont nécessaires au traitement de votre demande. Elles sont conservées de manière sécurisée et ne sont partagées qu'avec les services d'Enedis dans le cadre du traitement de votre raccordement. Vous disposez d'un droit d'accès, de rectification et de suppression de vos données."}),e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mt-6 mb-3",children:"6. Limitation de responsabilité"}),e.jsx("p",{children:"Notre service se limite à la constitution et à la transmission de votre dossier. Nous ne garantissons pas l'acceptation de votre demande par Enedis, ni les délais de traitement qui dépendent entièrement de leurs services. Notre responsabilité ne peut être engagée en cas de retard ou de refus émanant d'Enedis."}),e.jsx("h3",{className:"text-lg font-semibold text-blue-700 mt-6 mb-3",children:"7. Contact"}),e.jsx("p",{children:"Pour toute question concernant ces Conditions Générales d'Utilisation, veuillez nous contacter à l'adresse suivante : contact@demande-raccordement.fr ou par téléphone au 09 70 70 16 43."})]})]})]}),"."]})]})]})]})}function ye(){const[n,b]=B("/confirmation/:reference"),i=window.location.pathname;console.log("URL actuelle:",window.location.href),console.log("Pathname:",i),console.log("Match route ConfirmationPage:",n),console.log("Params route:",b);const m=(b==null?void 0:b.reference)||"",{toast:l}=F(),u=new URLSearchParams(window.location.search).get("nom")||"",[s,v]=t.useState(null),[N,c]=t.useState(!0),[y,T]=t.useState(null);return t.useEffect(()=>{if(!m)return;(async()=>{try{c(!0);const o=await S("GET",`/api/service-requests/${m}`);if(!o.ok)throw new Error(o.status===404?"Cette référence de demande n'existe pas":"Impossible de récupérer les détails de la demande");const h=await o.json();console.log("Données de la demande:",h);const p=h.serviceRequest||h.request||h;v(p),p&&p.paymentStatus==="paid"&&l({title:"Demande déjà payée",description:"Cette demande a déjà été payée."})}catch(o){T(o instanceof Error?o.message:"Une erreur est survenue"),l({title:"Erreur",description:o instanceof Error?o.message:"Une erreur est survenue lors du chargement des détails",variant:"destructive"})}finally{c(!1)}})()},[m,l]),t.useEffect(()=>{window.scrollTo(0,0)},[]),e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center py-10 px-4",children:e.jsxs("div",{className:"max-w-5xl w-full space-y-6",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h1",{className:"text-2xl font-bold text-blue-600",children:m}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Paiement sécurisé pour votre demande de raccordement électrique"}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.jsxs(H,{children:[e.jsxs("title",{children:["Raccordement électrique - Paiement pour demande ",m]}),e.jsx("meta",{name:"description",content:"Finalisez le paiement sécurisé pour votre demande de raccordement électrique référence {referenceNumber}"})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden p-6 border border-gray-100 h-full",children:[e.jsx("div",{className:"mb-5",children:e.jsxs("h2",{className:"text-lg font-bold mb-1",children:["Confirmation de demande ",m]})}),y?e.jsx("div",{className:"p-4 bg-red-50 text-red-700 rounded-md border border-red-100",children:y}):e.jsx(ae,{stripe:ue,children:e.jsx(pe,{referenceNumber:m,clientName:((s==null?void 0:s.name)||u)??"",serviceRequest:s,isLoadingRequest:N})})]})}),e.jsx("div",{className:"md:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden p-5 border border-gray-100 h-full",children:[e.jsx("h3",{className:"font-medium text-gray-800 mb-3 text-base",children:"Résumé de votre demande"}),!N&&s?e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"text-blue-600 mt-0.5",children:e.jsx(O,{size:16})}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsx("p",{className:"font-medium text-xs",children:"Email"}),e.jsx("p",{className:"text-gray-600 truncate text-xs",children:(s==null?void 0:s.email)||"h.haddaoui@outlook.fr"})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"text-blue-600 mt-0.5",children:e.jsx(G,{size:16})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-xs",children:"Téléphone"}),e.jsx("p",{className:"text-gray-600 text-xs",children:(s==null?void 0:s.phone)||"0654221144"})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"text-blue-600 mt-0.5",children:e.jsx(oe,{size:16})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-xs",children:"Adresse"}),e.jsxs("p",{className:"text-gray-600 text-xs",children:[(s==null?void 0:s.address)||"382 bir rami est",e.jsx("br",{}),(s==null?void 0:s.postalCode)||"14000"," ",(s==null?void 0:s.city)||"Caen"]})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"text-blue-600 mt-0.5",children:e.jsx(de,{size:16})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-xs",children:"Type de demande"}),e.jsx("p",{className:"text-gray-600 text-xs",children:(()=>{switch((s==null?void 0:s.requestType)||""){case"new_connection":return"Raccordement d'une habitation neuve";case"temporary_connection":return"Raccordement provisoire";case"power_upgrade":return"Augmentation de puissance";case"meter_relocation":return"Déplacement de compteur";case"other":return(s==null?void 0:s.otherRequestTypeDesc)||"Autre type de demande";default:return"Raccordement électrique"}})()})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"text-blue-600 mt-0.5",children:e.jsx(W,{size:16})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-xs",children:"Date de soumission"}),e.jsx("p",{className:"text-gray-600 text-xs",children:new Date().toLocaleDateString("fr-FR")})]})]}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"text-blue-600 mt-0.5",children:e.jsx(V,{size:16})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-xs",children:"Montant"}),e.jsx("p",{className:"text-gray-600 text-xs",children:"129,80€ TTC (108,17€ HT + 21,63€ TVA)"})]})]}),e.jsx("div",{className:"border-t border-gray-200 pt-3 mt-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"text-green-600 mt-0.5",children:e.jsx(X,{size:16})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-xs",children:"Sécurité garantie"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-gray-600 text-xs",children:"Toutes vos données sont sécurisées et chiffrées selon les normes bancaires les plus strictes (PCI DSS)."}),e.jsxs("ul",{className:"text-gray-600 text-xs list-disc pl-4 mt-1",children:[e.jsx("li",{children:"Paiement sécurisé SSL 256 bits"}),e.jsx("li",{children:"Authentification 3D Secure"}),e.jsx("li",{children:"Aucune donnée bancaire n'est conservée"})]}),e.jsx("p",{className:"text-xs text-blue-600 font-medium mt-1",children:"Plateforme certifiée aux normes européennes"})]})]})]})})]}):e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx(I,{className:"h-6 w-6 animate-spin text-blue-600"})})]})})]})]})})}export{ye as default};
