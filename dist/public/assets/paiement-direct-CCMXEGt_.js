import{b as k,a as _,r as i,j as e,Q as L,B as T,M as R,a3 as z,l as b,_ as V,u as F,L as I,a1 as M}from"./index-CGjOLLTa.js";import{E as D,u as O,a as U,C as S}from"./react-stripe.esm-BChSkfU_.js";import{C as E}from"./credit-card-D069cm3I.js";import{L as $}from"./lock-Bw4gSGAO.js";import"./index-vUmOlIlF.js";const B=async()=>{const{loadStripe:s}=await V(async()=>{const{loadStripe:n}=await import("./index-B0HAhLET.js");return{loadStripe:n}},[]);return s("pk_live_51MUY3KF0p2SYXeXzW4ebN4wdgqfmu9Mc8kTpm3XmBiyotz6kYZICKXNy73SWcmq1vCViETjWgcko8R6xd4TJbste00OL2WUCvP")};function W({referenceNumber:s,clientName:n}){const c=O(),m=U(),{toast:o}=_(),[,d]=F(),[p,v]=i.useState(!1),[u,x]=i.useState(n||""),[f,j]=i.useState(!1),[h,y]=i.useState(!0);i.useEffect(()=>{const t=setTimeout(()=>{y(!1)},1500);return()=>clearTimeout(t)},[]);const a=async t=>{if(t.preventDefault(),!c||!m){o({title:"Service de paiement non disponible",description:"Veuillez patienter ou actualiser la page.",variant:"destructive"});return}if(!s||s.trim()===""){o({title:"Erreur de référence",description:"La référence de la demande est invalide ou manquante.",variant:"destructive"});return}if(!u||u.trim()===""){o({title:"Informations manquantes",description:"Veuillez entrer le nom du titulaire de la carte.",variant:"destructive"});return}v(!0);try{const r=await b("GET",`/api/service-requests/${s}`);if(!r.ok)throw new Error("Cette référence de demande est invalide ou introuvable.");const l=await r.json();if(l.request&&l.request.paymentStatus==="paid"){o({title:"Demande déjà payée",description:"Cette demande a déjà été payée. Vous allez être redirigé."}),d(`/paiement-confirmation?reference=${s}&status=success`);return}const g=await b("POST","/api/create-payment-intent",{referenceNumber:s,amount:129.8});if(!g.ok){const P=await g.json();throw new Error(P.message||"Erreur lors de la préparation du paiement")}const{clientSecret:q}=await g.json(),w=await m.submit();if(w.error)throw new Error(w.error.message||"Informations de carte invalides");const{error:N,paymentIntent:C}=await c.confirmCardPayment(q,{payment_method:{card:m.getElement(S),billing_details:{name:u.trim()}}});if(N)throw N;C.status==="succeeded"?d(`/paiement-confirmation?reference=${s}&status=success`):d(`/paiement-confirmation?reference=${s}&payment_intent=${C.id}`)}catch(r){console.error("Erreur de paiement:",r);let l="Une erreur est survenue lors du traitement de votre paiement.";r.type==="card_error"&&(r.code==="card_declined"?l="Votre carte a été refusée. Veuillez vérifier vos informations ou essayer avec une autre carte.":r.code==="expired_card"?l="Votre carte est expirée.":r.code==="incorrect_cvc"?l="Le code de sécurité (CVC) est incorrect.":r.code==="processing_error"?l="Une erreur est survenue lors du traitement de votre carte. Veuillez réessayer.":r.code==="insufficient_funds"&&(l="Fonds insuffisants sur votre carte.")),o({title:"Échec du paiement",description:r.message||l,variant:"destructive"})}finally{v(!1)}};return h?e.jsxs("div",{className:"h-[400px] flex flex-col items-center justify-center space-y-8",children:[e.jsxs("div",{className:"relative w-24 h-24 rounded-full bg-blue-100 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 rounded-full animate-ping bg-blue-200 opacity-60"}),e.jsx("div",{className:"text-blue-600",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z"})})})]}),e.jsx("div",{className:"w-64 h-3 bg-blue-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-progress-bar"})}),e.jsxs("p",{className:"text-gray-600 text-center",children:["Référence: ",s]})]}):e.jsxs("form",{onSubmit:a,className:"space-y-6",children:[e.jsx("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-100 rounded-md",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"Frais d'étude de votre dossier"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Traitement et accompagnement"})]}),e.jsx("div",{children:e.jsx("span",{className:"font-bold text-lg text-blue-700",children:"129,8 € TTC"})})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"cardholderName",className:"block text-sm font-medium text-gray-700",children:"Titulaire de la carte"}),e.jsx("input",{type:"text",id:"cardholderName",className:"w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500",placeholder:"Nom complet tel qu'il apparaît sur la carte",required:!0,disabled:p,value:u,onChange:t=>x(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Numéro de carte"}),e.jsx("div",{className:"p-3 border border-gray-300 rounded-md bg-white shadow-sm focus-within:ring-1 focus-within:ring-blue-500 focus-within:border-blue-500",children:e.jsx(S,{options:{style:{base:{color:"#32325d",fontFamily:'"Inter", system-ui, -apple-system, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},hidePostalCode:!0},onChange:t=>{j(t.complete)}})})]})]}),e.jsx(T,{type:"submit",disabled:!c||!m||p||!f,className:`w-full py-6 text-base ${f?"bg-blue-600 hover:bg-blue-700":"opacity-50 cursor-not-allowed"}`,children:p?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"mr-2 h-5 w-5 animate-spin"}),"Traitement en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-5 w-5"}),"Finaliser le paiement de 129,80€ TTC"]})}),e.jsxs("div",{className:"mt-6 text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Paiement sécurisé. Vos informations bancaires sont chiffrées."}),e.jsxs("div",{className:"flex items-center justify-center space-x-6 mt-4",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"bg-blue-50 p-2 rounded-full mb-2",children:e.jsx(M,{className:"h-5 w-5 text-blue-600"})}),e.jsx("span",{className:"text-xs text-gray-500",children:"Transaction sécurisée"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"bg-blue-50 p-2 rounded-full mb-2",children:e.jsx($,{className:"h-5 w-5 text-blue-600"})}),e.jsx("span",{className:"text-xs text-gray-500",children:"Données chiffrées"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"bg-blue-50 p-2 rounded-full mb-2",children:e.jsx(E,{className:"h-5 w-5 text-blue-600"})}),e.jsx("span",{className:"text-xs text-gray-500",children:"Paiement vérifié"})]})]})]})]})}function J(){const[,s]=k("/paiement-direct/:reference"),n=(s==null?void 0:s.reference)||"",{toast:c}=_(),o=new URLSearchParams(window.location.search).get("nom")||"",[d,p]=i.useState(null),[v,u]=i.useState(!0),[x,f]=i.useState(null),[j,h]=i.useState(!1);return i.useEffect(()=>{if(!n)return;(async()=>{try{u(!0);const a=await b("GET",`/api/service-requests/${n}`);if(!a.ok)throw new Error(a.status===404?"Cette référence de demande n'existe pas":"Impossible de récupérer les détails de la demande");const t=await a.json();p(t.serviceRequest),t.serviceRequest&&t.serviceRequest.paymentStatus==="paid"&&c({title:"Demande déjà payée",description:"Cette demande a déjà été payée."})}catch(a){f(a instanceof Error?a.message:"Une erreur est survenue"),c({title:"Erreur",description:a instanceof Error?a.message:"Une erreur est survenue lors du chargement des détails",variant:"destructive"})}finally{u(!1)}})()},[n,c]),e.jsxs(L,{children:[e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center py-10 px-4",children:e.jsxs("div",{className:"max-w-lg w-full space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4 mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-blue-600",children:"Paiement sécurisé"}),e.jsxs("p",{className:"text-gray-600",children:["Référence : ",e.jsx("span",{className:"font-medium",children:n})]}),e.jsx("div",{className:"flex justify-center",children:e.jsxs(T,{variant:"outline",onClick:()=>h(!0),size:"sm",className:"mt-2",children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Besoin d'aide ? Contactez-nous"]})})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden p-6 border border-gray-100",children:x?e.jsx("div",{className:"p-4 bg-red-50 text-red-700 rounded-md border border-red-100",children:x}):e.jsx(D,{stripe:B(),children:e.jsx(W,{referenceNumber:n,clientName:((d==null?void 0:d.name)||o)??""})})})]})}),e.jsx(z,{defaultOpen:j,onOpenChange:h,source:"payment_page"})]})}export{J as default};
